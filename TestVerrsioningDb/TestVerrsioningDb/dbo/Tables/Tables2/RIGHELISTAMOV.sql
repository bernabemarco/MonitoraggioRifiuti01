CREATE TABLE [dbo].[RIGHELISTAMOV] (
    [IDTESTA]                    DECIMAL (10)    NOT NULL,
    [IDRIGA]                     INT             NOT NULL,
    [POSIZIONE]                  INT             NULL,
    [RIFTESTACOMM]               DECIMAL (10)    NULL,
    [RIFRIGAORD]                 INT             NULL,
    [RIFRIGAIMP]                 INT             NULL,
    [RIFMOVSP]                   DECIMAL (10)    NULL,
    [RIFMOVCOLLSP]               DECIMAL (10)    NULL,
    [CODART]                     VARCHAR (50)    NULL,
    [QTAMOVGESTIONE]             DECIMAL (16, 6) CONSTRAINT [DF__RIGHELIST__QTAMO__4826925F] DEFAULT (0) NOT NULL,
    [UMGEST]                     VARCHAR (3)     NOT NULL,
    [QTAMOVPREZZO]               DECIMAL (16, 6) CONSTRAINT [DF__RIGHELIST__QTAMO__491AB698] DEFAULT (0) NULL,
    [UMPREZZO]                   VARCHAR (3)     NOT NULL,
    [QTAPREZZOMAN]               SMALLINT        CONSTRAINT [DF__RIGHELIST__QTAPR__4A0EDAD1] DEFAULT (0) NULL,
    [QTAMOV1MAG]                 DECIMAL (16, 6) CONSTRAINT [DF__RIGHELIST__QTAMO__4BF72343] DEFAULT (0) NOT NULL,
    [QTA1MAGMAN]                 SMALLINT        CONSTRAINT [DF__RIGHELIST__QTA1M__4CEB477C] DEFAULT (0) NULL,
    [QTAMOV2MAG]                 DECIMAL (16, 6) CONSTRAINT [DF__RIGHELIST__QTAMO__4ED38FEE] DEFAULT (0) NOT NULL,
    [QTA2MAGMAN]                 SMALLINT        CONSTRAINT [DF__RIGHELIST__QTA2M__4FC7B427] DEFAULT (0) NULL,
    [UMSCARTO]                   VARCHAR (3)     NOT NULL,
    [QTAMOVSCARTO]               DECIMAL (16, 6) CONSTRAINT [DF__RIGHELIST__QTAMO__51AFFC99] DEFAULT (0) NOT NULL,
    [SALDORIGA]                  SMALLINT        CONSTRAINT [DF__RIGHELIST__SALDO__52A420D2] DEFAULT (0) NULL,
    [PARTITAASSEGNATA]           VARCHAR (15)    NULL,
    [CODCLIFOR]                  VARCHAR (7)     NULL,
    [CAUSALEMOV]                 DECIMAL (5)     NULL,
    [DEPOSITO]                   VARCHAR (10)    NULL,
    [UBICAZIONE]                 VARCHAR (10)    NULL,
    [CONTOCDC]                   VARCHAR (10)    NULL,
    [CAUSALEMOVCOLL]             DECIMAL (5)     NULL,
    [DEPOSITOCOLL]               VARCHAR (10)    NULL,
    [UBICAZIONECOLL]             VARCHAR (10)    NULL,
    [CONTOCDCCOLL]               VARCHAR (10)    NULL,
    [CAUSALESCARTO]              DECIMAL (5)     NULL,
    [DEPOSITOSCARTO]             VARCHAR (10)    NULL,
    [UBICAZIONESCARTO]           VARCHAR (10)    NULL,
    [CONTOCDCSCARTO]             VARCHAR (10)    NULL,
    [COSTOUNITMOV]               DECIMAL (19, 6) CONSTRAINT [DF__RIGHELIST__COSTO__548C6944] DEFAULT (0) NULL,
    [COSTOTOTMOV]                DECIMAL (19, 6) CONSTRAINT [DF__RIGHELIST__COSTO__55808D7D] DEFAULT (0) NULL,
    [COSTOUNITMOVEURO]           DECIMAL (19, 6) CONSTRAINT [DF__RIGHELIST__COSTO__5674B1B6] DEFAULT (0) NULL,
    [COSTOTOTMOVEURO]            DECIMAL (19, 6) CONSTRAINT [DF__RIGHELIST__COSTO__5768D5EF] DEFAULT (0) NULL,
    [STATORIGA]                  SMALLINT        CONSTRAINT [DF__RIGHELIST__STATO__585CFA28] DEFAULT (0) NULL,
    [NOTE]                       VARCHAR (100)   NULL,
    [DATAMODIFICA]               DATETIME        NOT NULL,
    [UTENTEMODIFICA]             VARCHAR (25)    CONSTRAINT [DF__RIGHELIST__UTENT__5A45429A] DEFAULT (0) NULL,
    [COSTOMATERIALE]             NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__63B99E3B] DEFAULT (0) NULL,
    [COSTOMATERIALEEURO]         NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__64ADC274] DEFAULT (0) NULL,
    [COSTOLAVINTERNA]            NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__65A1E6AD] DEFAULT (0) NULL,
    [COSTOLAVINTERNAEURO]        NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__66960AE6] DEFAULT (0) NULL,
    [COSTOLAVESTERNA]            NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__678A2F1F] DEFAULT (0) NULL,
    [COSTOLAVESTERNAEURO]        NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__687E5358] DEFAULT (0) NULL,
    [COSTOINDIRETTO]             NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__69727791] DEFAULT (0) NULL,
    [COSTOINDIRETTOEURO]         NUMERIC (19, 4) CONSTRAINT [DF__RigheList__COSTO__6A669BCA] DEFAULT (0) NULL,
    [FLAGRIGA]                   SMALLINT        NULL,
    [UM1MAG]                     VARCHAR (3)     NULL,
    [UM2MAG]                     VARCHAR (3)     NULL,
    [CAUSALESCARTOCOLL]          NUMERIC (5)     NULL,
    [DEPOSITOSCARTOCOLL]         VARCHAR (10)    NULL,
    [UBICAZIONESCARTOCOLL]       VARCHAR (10)    NULL,
    [CONTOCDCSCARTOCOLL]         VARCHAR (10)    NULL,
    [RIFCOMMCLI]                 VARCHAR (30)    NULL,
    [RIFCONSUNTIVO]              DECIMAL (10)    NULL,
    [DATAMOVIMENTO]              DATETIME        NULL,
    [FLGPRELEVARESIDUOIMPEGNATO] SMALLINT        NULL,
    [QTARIBALTACOSTI]            VARCHAR (255)   NULL,
    CONSTRAINT [PK_RIGHELISTAMOV] PRIMARY KEY CLUSTERED ([IDTESTA] ASC, [IDRIGA] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CKC_QTA1MAGMAN_RIGHELIS] CHECK ([QTA1MAGMAN] = 0 or [QTA1MAGMAN] = 1),
    CONSTRAINT [CKC_QTA2MAGMAN_RIGHELIS] CHECK ([QTA2MAGMAN] = 0 or [QTA2MAGMAN] = 1),
    CONSTRAINT [CKC_QTAPREZZOMAN_RIGHELIS] CHECK ([QTAPREZZOMAN] = 0 or [QTAPREZZOMAN] = 1),
    CONSTRAINT [CKC_SALDORIGA_RIGHELIS] CHECK ([SALDORIGA] = 0 or [SALDORIGA] = 1),
    CONSTRAINT [CKC_STATORIGA_RIGHELIS] CHECK ([STATORIGA] = 2 or [STATORIGA] = 1 or [STATORIGA] = 0)
);


GO
CREATE TRIGGER TD_RIGHELISTAMOV ON dbo.RIGHELISTAMOV FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN
    
    /*  DELETE ALL CHILDREN IN "RIGHELSTMOVMATRICOLE"  */
    DELETE RIGHELSTMOVMATRICOLE
    FROM   RIGHELSTMOVMATRICOLE T2, DELETED T1
    WHERE  T2.IDTESTA = T1.IDTESTA
     AND   T2.IDRIGA = T1.IDRIGA
    
    /*  DELETE ALL CHILDREN IN "PARTITELISTAMOV"  */
    DELETE PARTITELISTAMOV
    FROM   PARTITELISTAMOV T2, DELETED T1
    WHERE  T2.RIFTESTA = T1.IDTESTA
     AND   T2.RIFRIGA = T1.IDRIGA

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
/*  INSERT TRIGGER "TI_RIGHELISTAMOV" FOR TABLE "RIGHELISTAMOV"  */
CREATE TRIGGER TI_RIGHELISTAMOV ON dbo.RIGHELISTAMOV FOR INSERT AS
BEGIN
    DECLARE
       @MAXCARD  INT,
       @NUMROWS  INT,
       @NUMNULL  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  PARENT "TESTELISTAMOV" MUST EXIST WHEN INSERTING A CHILD IN "RIGHELISTAMOV"  */
    IF UPDATE(IDTESTA)
    BEGIN
       IF (SELECT COUNT(*)
           FROM   TESTELISTAMOV T1, INSERTED T2
           WHERE  T1.PROGRESSIVO = T2.IDTESTA) != @NUMROWS
          BEGIN
             SELECT @ERRNO  = 30002,
                    @ERRMSG = 'Parent does not exist in "TESTELISTAMOV". Cannot create child in "RIGHELISTAMOV".'
             GOTO ERROR
          END
    END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
/*  UPDATE TRIGGER "TU_RIGHELISTAMOV" FOR TABLE "RIGHELISTAMOV"  */
CREATE TRIGGER TU_RIGHELISTAMOV ON dbo.RIGHELISTAMOV FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  PARENT "TESTELISTAMOV" MUST EXIST WHEN UPDATING A CHILD IN "RIGHELISTAMOV"  */
      IF UPDATE(IDTESTA)
      BEGIN
         IF (SELECT COUNT(*)
             FROM   TESTELISTAMOV T1, INSERTED T2
             WHERE  T1.PROGRESSIVO = T2.IDTESTA) != @NUMROWS
            BEGIN
               SELECT @ERRNO  = 30003,
                      @ERRMSG = '"TESTELISTAMOV" does not exist. Cannot ALTER COLUMN child in "RIGHELISTAMOV".'
               GOTO ERROR
            END
      END

      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[RIGHELISTAMOV] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[RIGHELISTAMOV] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[RIGHELISTAMOV] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[RIGHELISTAMOV] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[RIGHELISTAMOV] TO [Metodo98]
    AS [dbo];

