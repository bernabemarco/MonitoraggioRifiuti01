CREATE TABLE [dbo].[RIGHECICLOORDINE] (
    [PROGRESSIVO]            DECIMAL (10)    NOT NULL,
    [NUMEROFASE]             INT             NOT NULL,
    [POSIZIONE]              INT             NULL,
    [FLAGRIGA]               SMALLINT        DEFAULT (0) NULL,
    [ANNOBOLLA]              SMALLINT        DEFAULT (0) NOT NULL,
    [NUMEROBOLLA]            INT             DEFAULT (0) NOT NULL,
    [TIPOFASE]               SMALLINT        DEFAULT (0) NULL,
    [SEGMENTOCONS]           VARCHAR (5)     NULL,
    [RIFSOVRAPP]             VARCHAR (9)     NULL,
    [INDICESOVRAPP]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [TIPOSOVRAPP]            SMALLINT        DEFAULT (0) NULL,
    [OPERAZIONE]             VARCHAR (5)     NULL,
    [TIPOOPERAZIONE]         SMALLINT        DEFAULT (0) NULL,
    [STATOOPERAZIONE]        SMALLINT        DEFAULT (0) NULL,
    [STATODOCUMENTAZIONE]    SMALLINT        DEFAULT (0) NULL,
    [CDLAVORO]               VARCHAR (5)     NULL,
    [MACCHINA]               VARCHAR (5)     NULL,
    [CODASTANDARD]           DECIMAL (15, 6) DEFAULT (0) NULL,
    [TEMPOMOVSTANDARD]       DECIMAL (15, 6) DEFAULT (0) NULL,
    [LOTTOSTANDARDMOV]       DECIMAL (15, 6) DEFAULT (0) NULL,
    [ARROTONDATEMPOMOV]      SMALLINT        DEFAULT (0) NULL,
    [CALCOLOTEMPOSETUP]      VARCHAR (255)   NULL,
    [UMTEMPOSETUP]           VARCHAR (1)     DEFAULT ('O') NULL,
    [LOTTOSTNSETUP]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [NUMOPERAISETUP]         SMALLINT        DEFAULT (0) NULL,
    [CALCOLOTEMPOMACCHINA]   VARCHAR (255)   NULL,
    [UMTEMPOMACCHINA]        VARCHAR (1)     DEFAULT ('O') NULL,
    [LOTTOSTNMACCHINA]       DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [FATTOREABBINAMENTO]     DECIMAL (16, 6) NULL,
    [CALCOLOTEMPOUOMO]       VARCHAR (255)   NULL,
    [LOTTOSTNUOMO]           DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [UMTEMPOUOMO]            VARCHAR (1)     DEFAULT ('O') NULL,
    [CALCOLOTEMPOTOTALE]     VARCHAR (255)   NULL,
    [UMTEMPOTOTALE]          VARCHAR (1)     DEFAULT ('O') NULL,
    [LOTTOSTNTOTALE]         DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [VALUTATEMPI]            VARCHAR (3)     NULL,
    [SOLOSE]                 VARCHAR (255)   NULL,
    [COSTOLAVORAZIONE]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [LOTTORIFCOSTO]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [COSTOTEMPOUNITARIO]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [TEMPORIFCOSTO]          VARCHAR (255)   NULL,
    [TEMPOATTRAVERSAMENTO]   DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [LOTTOATTRAVERSAMENTO]   DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [ARROTTEMPOATTR]         SMALLINT        DEFAULT (0) NULL,
    [VALUTATEMPOATTR]        SMALLINT        DEFAULT (0) NULL,
    [FOGLIOISTRUZIONI]       VARCHAR (80)    NULL,
    [ATTREZZATURA]           VARCHAR (80)    NULL,
    [STRUMENTICONTROLLO]     VARCHAR (80)    NULL,
    [PIANOCONTROLLO]         VARCHAR (80)    NULL,
    [NOTERIGA]               VARCHAR (100)   NULL,
    [DISPRISORSE]            SMALLINT        DEFAULT (1) NULL,
    [INDICECAPACITA]         SMALLINT        DEFAULT (1) NULL,
    [ORELAVOROGIORNO]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [TEMPOPREVSETUP]         VARCHAR (15)    NULL,
    [TEMPOPREVMACCHINA]      VARCHAR (15)    NULL,
    [TEMPOPREVUOMO]          VARCHAR (15)    NULL,
    [TEMPOPREVDURATA]        VARCHAR (15)    NULL,
    [TEMPOPREVMOV]           DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [TEMPOPREVCODA]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [TEMPOPREVATTRAV]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [TEMPOEFFSETUP]          VARCHAR (15)    NULL,
    [TEMPOEFFMACCHINA]       VARCHAR (15)    NULL,
    [TEMPOEFFUOMO]           VARCHAR (15)    NULL,
    [TEMPOEFFDURATA]         VARCHAR (15)    NULL,
    [TEMPOEFFMOV]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVSETUP]           DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVMACCHINA]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVUOMO]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVDURATA]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVMOV]             DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVCODA]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREPREVATTRAV]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREEFFSETUP]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREEFFMACCHINA]         DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREEFFUOMO]             DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREEFFDURATA]           DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [OREEFFMOV]              DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [FORNITOREASSEGNATO]     VARCHAR (7)     NULL,
    [LISTINOTRASF]           DECIMAL (5)     NULL,
    [UTENSILEASSEGNATO]      VARCHAR (15)    NULL,
    [QUC_ATTREZZAGGIO]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [UMC_ATTREZZAGGIO]       VARCHAR (1)     DEFAULT ('O') NULL,
    [CA_ATTREZZAGGIO]        VARCHAR (255)   NULL,
    [QUC_MACCHINA]           DECIMAL (19, 6) DEFAULT (0) NULL,
    [UMC_MACCHINA]           VARCHAR (1)     DEFAULT ('O') NULL,
    [CA_MACCHINA]            VARCHAR (255)   NULL,
    [QUC_UOMO]               DECIMAL (19, 6) DEFAULT (0) NULL,
    [UMC_UOMO]               VARCHAR (1)     DEFAULT ('O') NULL,
    [CA_UOMO]                VARCHAR (255)   NULL,
    [QUC_INDVARIABILE]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [UMC_INDVARIABILE]       VARCHAR (1)     DEFAULT ('O') NULL,
    [CA_INDVARIABILE]        VARCHAR (255)   NULL,
    [QUC_INDFISSO]           DECIMAL (19, 6) DEFAULT (0) NULL,
    [UMC_INDFISSO]           VARCHAR (1)     DEFAULT ('O') NULL,
    [ELEM_CA_INDFISSO]       SMALLINT        DEFAULT (0) NULL,
    [VALUTACOSTI]            VARCHAR (5)     DEFAULT ('12345') NULL,
    [CP_ATTREZZAGGIO]        DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_MACCHINA]            DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_UOMO]                DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_INDVARIABILE]        DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_INDFISSO]            DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_TOTESTERNI]          DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_ATTREZZAGGIO]        DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_MACCHINA]            DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_UOMO]                DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_INDVARIABILE]        DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_INDFISSO]            DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_TOTESTERNI]          DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_ATTREZZAGGIO]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_MACCHINA]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_UOMO]             DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_INDVARIABILE]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_INDFISSO]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [CP_EU_TOTESTERNI]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_ATTREZZAGGIO]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_MACCHINA]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_UOMO]             DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_INDVARIABILE]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_INDFISSO]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [CC_EU_TOTESTERNI]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [QTAPREVISTA]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTAVERSATA]             DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTASCARTATA]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [DATAINIZIOOPSCHEDULATA] DATETIME        NULL,
    [ORAINIZIOOPSCHEDULATA]  DATETIME        NULL,
    [DATAFINEOPSCHEDULATA]   DATETIME        NULL,
    [ORAFINEOPSCHEDULATA]    DATETIME        NULL,
    [DATAINIZIOOPEFFETTIVA]  DATETIME        NULL,
    [ORAINIZIOOPEFFETTIVA]   DATETIME        NULL,
    [DATAFINEOPEFFETTIVA]    DATETIME        NULL,
    [ORAFINEOPEFFETTIVA]     DATETIME        NULL,
    [VALORESOLOSE]           SMALLINT        DEFAULT ((-1)) NULL,
    [UTENTEMODIFICA]         VARCHAR (25)    NOT NULL,
    [DATAMODIFICA]           DATETIME        NOT NULL,
    [TIPOATTREZZAGGIO]       VARCHAR (5)     NULL,
    [SEGMENTOSCHED]          VARCHAR (5)     NULL,
    [UMFASE]                 VARCHAR (3)     DEFAULT ('') NOT NULL,
    [DSCOPERAZIONE]          VARCHAR (80)    NULL,
    [UMGEST]                 VARCHAR (3)     NULL,
    [QTAPREVISTAFASE]        DECIMAL (16, 6) CONSTRAINT [DF_RIGHECICLOORDINE_QTAPREVISTAFASE] DEFAULT (0) NULL,
    [QTATERZISTA]            DECIMAL (16, 6) CONSTRAINT [DF_RIGHECICLOORDINE_QTATERZISTA] DEFAULT (0) NULL,
    [QTAPRONTA]              DECIMAL (16, 6) CONSTRAINT [DF_RIGHECICLOORDINE_QTAPRONTA] DEFAULT (0) NULL,
    [QTATRASFERITA]          DECIMAL (16, 6) CONSTRAINT [DF_RIGHECICLOORDINE_QTATRASFERITA] DEFAULT (0) NULL,
    [QTALAVORATA]            DECIMAL (16, 6) CONSTRAINT [DF_RIGHECICLOORDINE_QTALAVORATA] DEFAULT (0) NULL,
    [FLGTEMPIFICACTRASF]     SMALLINT        NULL,
    PRIMARY KEY CLUSTERED ([PROGRESSIVO] ASC, [NUMEROFASE] ASC) WITH (FILLFACTOR = 90),
    CHECK ([UMC_ATTREZZAGGIO] is null or [UMC_ATTREZZAGGIO] = 'P' or [UMC_ATTREZZAGGIO] = 'T' or [UMC_ATTREZZAGGIO] = 'C' or [UMC_ATTREZZAGGIO] = 'S' or [UMC_ATTREZZAGGIO] = 'M' or [UMC_ATTREZZAGGIO] = 'O' or [UMC_ATTREZZAGGIO] = 'G'),
    CHECK ([UMC_INDFISSO] is null or [UMC_INDFISSO] = 'P' or [UMC_INDFISSO] = 'T' or [UMC_INDFISSO] = 'C' or [UMC_INDFISSO] = 'S' or [UMC_INDFISSO] = 'M' or [UMC_INDFISSO] = 'O' or [UMC_INDFISSO] = 'G'),
    CHECK ([UMC_INDVARIABILE] is null or [UMC_INDVARIABILE] = 'P' or [UMC_INDVARIABILE] = 'T' or [UMC_INDVARIABILE] = 'C' or [UMC_INDVARIABILE] = 'S' or [UMC_INDVARIABILE] = 'M' or [UMC_INDVARIABILE] = 'O' or [UMC_INDVARIABILE] = 'G'),
    CHECK ([UMC_MACCHINA] is null or [UMC_MACCHINA] = 'P' or [UMC_MACCHINA] = 'T' or [UMC_MACCHINA] = 'C' or [UMC_MACCHINA] = 'S' or [UMC_MACCHINA] = 'M' or [UMC_MACCHINA] = 'O' or [UMC_MACCHINA] = 'G'),
    CHECK ([UMC_UOMO] is null or [UMC_UOMO] = 'P' or [UMC_UOMO] = 'T' or [UMC_UOMO] = 'C' or [UMC_UOMO] = 'S' or [UMC_UOMO] = 'M' or [UMC_UOMO] = 'O' or [UMC_UOMO] = 'G'),
    CHECK ([UMTEMPOMACCHINA] is null or [UMTEMPOMACCHINA] = 'P' or [UMTEMPOMACCHINA] = 'T' or [UMTEMPOMACCHINA] = 'C' or [UMTEMPOMACCHINA] = 'S' or [UMTEMPOMACCHINA] = 'M' or [UMTEMPOMACCHINA] = 'O' or [UMTEMPOMACCHINA] = 'G'),
    CHECK ([UMTEMPOSETUP] is null or [UMTEMPOSETUP] = 'P' or [UMTEMPOSETUP] = 'T' or [UMTEMPOSETUP] = 'C' or [UMTEMPOSETUP] = 'S' or [UMTEMPOSETUP] = 'M' or [UMTEMPOSETUP] = 'O' or [UMTEMPOSETUP] = 'G'),
    CHECK ([UMTEMPOTOTALE] is null or [UMTEMPOTOTALE] = 'P' or [UMTEMPOTOTALE] = 'T' or [UMTEMPOTOTALE] = 'C' or [UMTEMPOTOTALE] = 'S' or [UMTEMPOTOTALE] = 'M' or [UMTEMPOTOTALE] = 'O' or [UMTEMPOTOTALE] = 'G'),
    CHECK ([UMTEMPOUOMO] is null or [UMTEMPOUOMO] = 'P' or [UMTEMPOUOMO] = 'T' or [UMTEMPOUOMO] = 'C' or [UMTEMPOUOMO] = 'S' or [UMTEMPOUOMO] = 'M' or [UMTEMPOUOMO] = 'O' or [UMTEMPOUOMO] = 'G'),
    CHECK ([VALUTATEMPOATTR] is null or [VALUTATEMPOATTR] = 0 or [VALUTATEMPOATTR] = 1)
);


GO
CREATE NONCLUSTERED INDEX [RIFBOLLALAVORO]
    ON [dbo].[RIGHECICLOORDINE]([ANNOBOLLA] ASC, [NUMEROBOLLA] ASC) WITH (FILLFACTOR = 90);


GO

/*  DELETE TRIGGER "TD_RIGHECICLOORDINE" FOR TABLE "RIGHECICLOORDINE"  */
CREATE TRIGGER TD_RIGHECICLOORDINE ON RIGHECICLOORDINE FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN
   
    /*  DELETE ALL CHILDREN IN "TABUTENSILICICLOORD"  */
    DELETE TABUTENSILICICLOORD
    FROM   TABUTENSILICICLOORD T2, DELETED T1
    WHERE  T2.PROGRESSIVO = T1.PROGRESSIVO
     AND   T2.NUMEROFASE = T1.NUMEROFASE
    
    /*  DELETE ALL CHILDREN IN "CAROPERAZIONEFASEORD"  */
    DELETE CAROPERAZIONEFASEORD
    FROM   CAROPERAZIONEFASEORD T2, DELETED T1
    WHERE  T2.PROGRESSIVO = T1.PROGRESSIVO
     AND   T2.NUMEROFASE = T1.NUMEROFASE
    
    /*  DELETE ALL CHILDREN IN "TABCOMPONENTIDBACICLOORD"  */
    DELETE TABCOMPONENTIDBACICLOORD
    FROM   TABCOMPONENTIDBACICLOORD T2, DELETED T1
    WHERE  T2.PROGRESSIVO = T1.PROGRESSIVO
     AND   T2.NUMEROFASE = T1.NUMEROFASE

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  INSERT TRIGGER "TI_RIGHECICLOORDINE" FOR TABLE "RIGHECICLOORDINE"  */
CREATE TRIGGER TI_RIGHECICLOORDINE ON RIGHECICLOORDINE FOR INSERT AS
BEGIN
    DECLARE
       @MAXCARD  INT,
       @NUMROWS  INT,
       @NUMNULL  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  PARENT "TESTACICLOORDINE" MUST EXIST WHEN INSERTING A CHILD IN "RIGHECICLOORDINE"  */
    IF UPDATE(PROGRESSIVO)
    BEGIN
       IF (SELECT COUNT(*)
           FROM   TESTACICLOORDINE T1, INSERTED T2
           WHERE  T1.PROGRESSIVO = T2.PROGRESSIVO) != @NUMROWS
          BEGIN
             SELECT @ERRNO  = 30002,
                    @ERRMSG = 'Parent does not exist in "TESTACICLOORDINE". Cannot create child in "RIGHECICLOORDINE".'
             GOTO ERROR
          END
    END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  UPDATE TRIGGER "TU_RIGHECICLOORDINE" FOR TABLE "RIGHECICLOORDINE"  */
CREATE TRIGGER TU_RIGHECICLOORDINE ON RIGHECICLOORDINE FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  PARENT "TESTACICLOORDINE" MUST EXIST WHEN UPDATING A CHILD IN "RIGHECICLOORDINE"  */
      IF UPDATE(PROGRESSIVO)
      BEGIN
         IF (SELECT COUNT(*)
             FROM   TESTACICLOORDINE T1, INSERTED T2
             WHERE  T1.PROGRESSIVO = T2.PROGRESSIVO) != @NUMROWS
            BEGIN
               SELECT @ERRNO  = 30003,
                      @ERRMSG = '"TESTACICLOORDINE" does not exist. Cannot modify child in "RIGHECICLOORDINE".'
               GOTO ERROR
            END
      END
      
      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[RIGHECICLOORDINE] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[RIGHECICLOORDINE] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[RIGHECICLOORDINE] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[RIGHECICLOORDINE] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[RIGHECICLOORDINE] TO [Metodo98]
    AS [dbo];

