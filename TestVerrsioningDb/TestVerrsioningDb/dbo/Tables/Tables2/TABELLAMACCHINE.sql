CREATE TABLE [dbo].[TABELLAMACCHINE] (
    [CODICE]                VARCHAR (5)     NOT NULL,
    [DESCRIZIONE]           VARCHAR (80)    NULL,
    [CODICEATTIVITA]        SMALLINT        DEFAULT (0) NULL,
    [CODICECDLAVORO]        VARCHAR (5)     NULL,
    [NOTE]                  VARCHAR (100)   NULL,
    [RESASTANDARD]          DECIMAL (8, 5)  DEFAULT (0) NOT NULL,
    [RESAMEDIA]             DECIMAL (8, 5)  DEFAULT (0) NOT NULL,
    [CALCOLOTEMPOSETUP]     VARCHAR (255)   NULL,
    [UMTEMPOSETUP]          VARCHAR (1)     DEFAULT ('O') NULL,
    [CALCOLOTEMPOMACCHINA]  VARCHAR (255)   NULL,
    [UMTEMPOMACCHINA]       VARCHAR (1)     DEFAULT ('O') NULL,
    [CALCOLOTEMPOUOMO]      VARCHAR (255)   NULL,
    [UMTEMPOUOMO]           VARCHAR (1)     DEFAULT ('O') NULL,
    [CALCOLOTEMPOTOTALE]    VARCHAR (255)   NULL,
    [UMTEMPOTOTALE]         VARCHAR (1)     DEFAULT ('O') NULL,
    [QODIRETTASETUP]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [CALCCOSTODSETUP]       VARCHAR (255)   NULL,
    [UMTCOSTOSETUP]         VARCHAR (1)     DEFAULT ('O') NULL,
    [QODIRETTAMACCHINA]     DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [CALCCOSTODMACCHINA]    VARCHAR (255)   NULL,
    [UMTCOSTOMACCHINA]      VARCHAR (1)     DEFAULT ('O') NULL,
    [QODIRETTAUOMO]         DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [CALCCOSTODUOMO]        VARCHAR (255)   NULL,
    [UMTCOSTOUOMO]          VARCHAR (1)     DEFAULT ('O') NULL,
    [QOINDVARIABILE]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [CALCCOSTOINDVAR]       VARCHAR (255)   NULL,
    [QOINDFISSA]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [ELEMENTICOSTOINDFISSO] SMALLINT        DEFAULT (0) NULL,
    [STDQODIRETTASETUP]     DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [STDQODIRETTAMACCHINA]  DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [STDQODIRETTAUOMO]      DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [STDQOINDIRETTAVAR]     DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [STDQOINDIRETTAFISSA]   DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [VALUTATEMPI]           VARCHAR (3)     DEFAULT ('123') NULL,
    [VALUTAQUOTEORARIE]     VARCHAR (5)     DEFAULT ('12345') NULL,
    [INDICECAPACITA]        SMALLINT        DEFAULT (1) NULL,
    [INDICECAPACITACM]      SMALLINT        DEFAULT (1) NULL,
    [UTENTEMODIFICA]        VARCHAR (25)    NOT NULL,
    [DATAMODIFICA]          DATETIME        NOT NULL,
    [UMTCOSTOINDVAR]        VARCHAR (1)     NULL,
    [UMTCOSTOINDFISSA]      VARCHAR (1)     NULL,
    [FLGQUALITY]            SMALLINT        CONSTRAINT [DF_TABELLAMACCHINE_FLGQUALITY] DEFAULT ((0)) NOT NULL,
    CONSTRAINT [PK_TABELLAMACCHINE] PRIMARY KEY CLUSTERED ([CODICE] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CKC_CODICEATTIVITA_TABELLAM] CHECK ([CODICEATTIVITA] = 2 or [CODICEATTIVITA] = 1 or [CODICEATTIVITA] = 0),
    CONSTRAINT [CKC_ELEMENTICOSTOINDF_TABELLAM] CHECK ([ELEMENTICOSTOINDFISSO] >= 0 and [ELEMENTICOSTOINDFISSO] <= 15),
    CONSTRAINT [CKC_UMTCOSTOINDFISSA_TABELLAM] CHECK ([UMTCOSTOINDFISSA] = 'P' or [UMTCOSTOINDFISSA] = 'T' or [UMTCOSTOINDFISSA] = 'C' or [UMTCOSTOINDFISSA] = 'S' or [UMTCOSTOINDFISSA] = 'M' or [UMTCOSTOINDFISSA] = 'O' or [UMTCOSTOINDFISSA] = 'G'),
    CONSTRAINT [CKC_UMTCOSTOINDVAR_TABELLAM] CHECK ([UMTCOSTOINDVAR] = 'P' or [UMTCOSTOINDVAR] = 'T' or [UMTCOSTOINDVAR] = 'C' or [UMTCOSTOINDVAR] = 'S' or [UMTCOSTOINDVAR] = 'M' or [UMTCOSTOINDVAR] = 'O' or [UMTCOSTOINDVAR] = 'G'),
    CONSTRAINT [CKC_UMTCOSTOMACCHINA_TABELLAM] CHECK ([UMTCOSTOMACCHINA] = 'P' or [UMTCOSTOMACCHINA] = 'T' or [UMTCOSTOMACCHINA] = 'C' or [UMTCOSTOMACCHINA] = 'S' or [UMTCOSTOMACCHINA] = 'M' or [UMTCOSTOMACCHINA] = 'O' or [UMTCOSTOMACCHINA] = 'G'),
    CONSTRAINT [CKC_UMTCOSTOSETUP_TABELLAM] CHECK ([UMTCOSTOSETUP] = 'P' or [UMTCOSTOSETUP] = 'T' or [UMTCOSTOSETUP] = 'C' or [UMTCOSTOSETUP] = 'S' or [UMTCOSTOSETUP] = 'M' or [UMTCOSTOSETUP] = 'O' or [UMTCOSTOSETUP] = 'G'),
    CONSTRAINT [CKC_UMTCOSTOUOMO_TABELLAM] CHECK ([UMTCOSTOUOMO] = 'P' or [UMTCOSTOUOMO] = 'T' or [UMTCOSTOUOMO] = 'C' or [UMTCOSTOUOMO] = 'S' or [UMTCOSTOUOMO] = 'M' or [UMTCOSTOUOMO] = 'O' or [UMTCOSTOUOMO] = 'G'),
    CONSTRAINT [CKC_UMTEMPOMACCHINA_TABELLAM] CHECK ([UMTEMPOMACCHINA] = 'P' or [UMTEMPOMACCHINA] = 'T' or [UMTEMPOMACCHINA] = 'C' or [UMTEMPOMACCHINA] = 'S' or [UMTEMPOMACCHINA] = 'M' or [UMTEMPOMACCHINA] = 'O' or [UMTEMPOMACCHINA] = 'G'),
    CONSTRAINT [CKC_UMTEMPOSETUP_TABELLAM] CHECK ([UMTEMPOSETUP] = 'P' or [UMTEMPOSETUP] = 'T' or [UMTEMPOSETUP] = 'C' or [UMTEMPOSETUP] = 'S' or [UMTEMPOSETUP] = 'M' or [UMTEMPOSETUP] = 'O' or [UMTEMPOSETUP] = 'G'),
    CONSTRAINT [CKC_UMTEMPOTOTALE_TABELLAM] CHECK ([UMTEMPOTOTALE] = 'P' or [UMTEMPOTOTALE] = 'T' or [UMTEMPOTOTALE] = 'C' or [UMTEMPOTOTALE] = 'S' or [UMTEMPOTOTALE] = 'M' or [UMTEMPOTOTALE] = 'O' or [UMTEMPOTOTALE] = 'G'),
    CONSTRAINT [CKC_UMTEMPOUOMO_TABELLAM] CHECK ([UMTEMPOUOMO] = 'P' or [UMTEMPOUOMO] = 'T' or [UMTEMPOUOMO] = 'C' or [UMTEMPOUOMO] = 'S' or [UMTEMPOUOMO] = 'M' or [UMTEMPOUOMO] = 'O' or [UMTEMPOUOMO] = 'G')
);


GO

/*  UPDATE TRIGGER "TU_TABELLAMACCHINE" FOR TABLE "TABELLAMACCHINE"  */
CREATE TRIGGER TU_TABELLAMACCHINE ON TABELLAMACCHINE FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  ALTER COLUMN PARENT CODE OF "TABELLAMACCHINE" FOR ALL CHILDREN IN "EXTRAMACCHINE"  */
      IF UPDATE(CODICE)
      BEGIN
         UPDATE EXTRAMACCHINE
          SET   CODMAC = I1.CODICE
         FROM   EXTRAMACCHINE T2, INSERTED I1, DELETED D1
         WHERE  T2.CODMAC = D1.CODICE
          AND  (I1.CODICE != D1.CODICE)
      END
      
      /*  ALTER COLUMN PARENT CODE OF "TABELLAMACCHINE" FOR ALL CHILDREN IN "CALMACCHINE"  */
      IF UPDATE(CODICE)
      BEGIN
         UPDATE CALMACCHINE
          SET   CODMAC = I1.CODICE
         FROM   CALMACCHINE T2, INSERTED I1, DELETED D1
         WHERE  T2.CODMAC = D1.CODICE
          AND  (I1.CODICE != D1.CODICE)
      END
      
      /*  ALTER COLUMN PARENT CODE OF "TABELLAMACCHINE" FOR ALL CHILDREN IN "ANACARMACCHINE"  */
      IF UPDATE(CODICE)
      BEGIN
         UPDATE ANACARMACCHINE
          SET   CODMACCHINA = I1.CODICE
         FROM   ANACARMACCHINE T2, INSERTED I1, DELETED D1
         WHERE  T2.CODMACCHINA = D1.CODICE
          AND  (I1.CODICE != D1.CODICE)
      END

      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
CREATE TRIGGER TD_TABELLAMACCHINE ON TABELLAMACCHINE FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  DELETE ALL CHILDREN IN "EXTRAMACCHINE"  */
    DELETE EXTRAMACCHINE
    FROM   EXTRAMACCHINE T2, DELETED T1
    WHERE  T2.CODMAC = T1.CODICE
    
    /*  DELETE ALL CHILDREN IN "CALMACCHINE"  */
    DELETE CALMACCHINE
    FROM   CALMACCHINE T2, DELETED T1
    WHERE  T2.CODMAC = T1.CODICE
    
    /*  DELETE ALL CHILDREN IN "ANACARMACCHINE"  */
    DELETE ANACARMACCHINE
    FROM   ANACARMACCHINE T2, DELETED T1
    WHERE  T2.CODMACCHINA = T1.CODICE

    /*  DELETE ALL CHILDREN IN "PROFILOORARIOSTANDARD"  */
    DELETE PROFILOORARIOSTANDARD
    FROM   PROFILOORARIOSTANDARD T2, DELETED T1
    WHERE  T2.CODICE = T1.CODICE AND TIPOPO=2
    
    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[TABELLAMACCHINE] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[TABELLAMACCHINE] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[TABELLAMACCHINE] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[TABELLAMACCHINE] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[TABELLAMACCHINE] TO [Metodo98]
    AS [dbo];

