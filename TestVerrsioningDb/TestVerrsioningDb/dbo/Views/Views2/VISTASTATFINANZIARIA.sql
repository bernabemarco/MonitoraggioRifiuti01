CREATE VIEW VISTASTATFINANZIARIA AS
SELECT 1 AS TIPOREC,
    TABSCADENZE.PROGRESSIVO,
    TABSCADENZE.ESERCIZIO,
    TABSCADENZE.ANNODOC,
    TABSCADENZE.TIPODOC,
    TABSCADENZE.NUMDOC,
    TABSCADENZE.BIS,
    TABSCADENZE.NUMSCAD,
    TABSCADENZE.DATASCADENZA,
    TABSCADENZE.CODCLIFOR,
    TABSCADENZE.DATAFATTURA,
    TABSCADENZE.BANCAINC,
    TABSCADENZE.BANCAAPPOGGIO,
    TABSCADENZE.NUMRIF,
    TABSCADENZE.NUMEROPROT,
    TABSCADENZE.CODAGE1,
    TABSCADENZE.CODAGE2,
    TABSCADENZE.CODAGE3,
    TABSCADENZE.IMPPROVLIT1,
    TABSCADENZE.IMPPROVLIT2,
    TABSCADENZE.IMPPROVLIT3,
    TABSCADENZE.IMPPROVVAL1,
    TABSCADENZE.IMPPROVVAL2,
    TABSCADENZE.IMPPROVVAL3,
    TABSCADENZE.IMPPROVEURO1,
    TABSCADENZE.IMPPROVEURO2,
    TABSCADENZE.IMPPROVEURO3,
    TABSCADENZE.LIQPROV1,
    TABSCADENZE.LIQPROV2,
    TABSCADENZE.LIQPROV3,
    TABSCADENZE.IMPORTOSCLIT,
    TABSCADENZE.IMPORTOSCVAL,
    TABSCADENZE.IMPORTOSCEURO,
    TABSCADENZE.IMPONIBSCLIT,
    TABSCADENZE.IMPONIBSCVAL,
    TABSCADENZE.IMPONIBSCEURO,
    TABSCADENZE.TOTFATTLIT,
    TABSCADENZE.TOTFATTVAL,
    TABSCADENZE.TOTFATTEURO,
    TABSCADENZE.IMPFATTLIT,
    TABSCADENZE.IMPFATTVAL,
    TABSCADENZE.IMPFATTEURO,
    TABSCADENZE.FLAGCONT,
    TABSCADENZE.TIPOEFFETTO,
    TABSCADENZE.ESITO,
    TABSCADENZE.LIVSOLL,
    TABSCADENZE.LIQINS1,
    TABSCADENZE.LIQINS2,
    TABSCADENZE.LIQINS3,
    TABSCADENZE.CODCAMBIO,
    TABSCADENZE.VALCAMBIO,
    TABSCADENZE.NRDISTINTA,
    TABSCADENZE.NUMRAGGR,
    TABSCADENZE.DATAPAGEFF,
    TABSCADENZE.SCADATTPASS,
    TABSCADENZE.NUMRIFPARTCONT,
    TABSCADENZE.CODPAG,
    TABSCADENZE.DATADEC,
    TABSCADENZE.NOTE,
    TABSCADENZE.NRGIORNALE,
    TABSCADENZE.UTENTEMODIFICA,
    TABSCADENZE.DATAMODIFICA,
    (SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS CONTORIFBANCA,
    (SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO=CODCLIFOR) AS DSCCONTO1,
    (SELECT DSCBANCA FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS DSCBANCA,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCLIT*-1) ELSE IMPORTOSCLIT END) AS IMPORTOSCADLIRE,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCEURO*-1) ELSE IMPORTOSCEURO END) AS IMPORTOSCADEURO,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCVAL*-1) ELSE IMPORTOSCVAL END) AS IMPORTOSCADVALUTA,    
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOPN,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOPNVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOPNEURO,
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOBANCA,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOBANCAVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=TABSCADENZE.NRGIORNALE) AS SALDOBANCAEURO,
    (CASE WHEN (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=TABSCADENZE.TIPOEFFETTO)='D' THEN 0 ELSE 1 END) AS TIPOEFF
    FROM TABSCADENZE UNION ALL
  SELECT 2 AS TIPOREC,
    SCADENZEPREVISIONALI.PROGRESSIVO,
    SCADENZEPREVISIONALI.ESERCIZIO,
    SCADENZEPREVISIONALI.ANNODOC,
    SCADENZEPREVISIONALI.TIPODOC,
    SCADENZEPREVISIONALI.NUMDOC,
    SCADENZEPREVISIONALI.BIS,
    SCADENZEPREVISIONALI.NUMSCAD,
    SCADENZEPREVISIONALI.DATASCADENZA,
    SCADENZEPREVISIONALI.CODCLIFOR,
    SCADENZEPREVISIONALI.DATAFATTURA,
    SCADENZEPREVISIONALI.BANCAINC,
    SCADENZEPREVISIONALI.BANCAAPPOGGIO,
    SCADENZEPREVISIONALI.NUMRIF,
    SCADENZEPREVISIONALI.NUMEROPROT,
    SCADENZEPREVISIONALI.CODAGE1,
    SCADENZEPREVISIONALI.CODAGE2,
    SCADENZEPREVISIONALI.CODAGE3,
    SCADENZEPREVISIONALI.IMPPROVLIT1,
    SCADENZEPREVISIONALI.IMPPROVLIT2,
    SCADENZEPREVISIONALI.IMPPROVLIT3,
    SCADENZEPREVISIONALI.IMPPROVVAL1,
    SCADENZEPREVISIONALI.IMPPROVVAL2,
    SCADENZEPREVISIONALI.IMPPROVVAL3,
    SCADENZEPREVISIONALI.IMPPROVEURO1,
    SCADENZEPREVISIONALI.IMPPROVEURO2,
    SCADENZEPREVISIONALI.IMPPROVEURO3,
    SCADENZEPREVISIONALI.LIQPROV1,
    SCADENZEPREVISIONALI.LIQPROV2,
    SCADENZEPREVISIONALI.LIQPROV3,
    SCADENZEPREVISIONALI.IMPORTOSCLIT,
    SCADENZEPREVISIONALI.IMPORTOSCVAL,
    SCADENZEPREVISIONALI.IMPORTOSCEURO,
    SCADENZEPREVISIONALI.IMPONIBSCLIT,
    SCADENZEPREVISIONALI.IMPONIBSCVAL,
    SCADENZEPREVISIONALI.IMPONIBSCEURO,
    SCADENZEPREVISIONALI.TOTFATTLIT,
    SCADENZEPREVISIONALI.TOTFATTVAL,
    SCADENZEPREVISIONALI.TOTFATTEURO,
    SCADENZEPREVISIONALI.IMPFATTLIT,
    SCADENZEPREVISIONALI.IMPFATTVAL,
    SCADENZEPREVISIONALI.IMPFATTEURO,
    SCADENZEPREVISIONALI.FLAGCONT,
    SCADENZEPREVISIONALI.TIPOEFFETTO,
    SCADENZEPREVISIONALI.ESITO,
    SCADENZEPREVISIONALI.LIVSOLL,SCADENZEPREVISIONALI.LIQINS1,
    SCADENZEPREVISIONALI.LIQINS2,
    SCADENZEPREVISIONALI.LIQINS3,
    SCADENZEPREVISIONALI.CODCAMBIO,
    SCADENZEPREVISIONALI.VALCAMBIO,
    SCADENZEPREVISIONALI.NRDISTINTA,
    SCADENZEPREVISIONALI.NUMRAGGR,
    SCADENZEPREVISIONALI.DATAPAGEFF,
    SCADENZEPREVISIONALI.SCADATTPASS,
    SCADENZEPREVISIONALI.NUMRIFPARTCONT,
    SCADENZEPREVISIONALI.CODPAG,
    SCADENZEPREVISIONALI.DATADEC,
    SCADENZEPREVISIONALI.NOTE,
    SCADENZEPREVISIONALI.NRGIORNALE,
    SCADENZEPREVISIONALI.UTENTEMODIFICA,
    SCADENZEPREVISIONALI.DATAMODIFICA,
    (SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS CONTORIFBANCA,
    (SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO=CODCLIFOR) AS DSCCONTO1,
    (SELECT DSCBANCA FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS DSCBANCA,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCLIT*-1) ELSE IMPORTOSCLIT END) AS IMPORTOSCADLIRE,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCEURO*-1) ELSE IMPORTOSCEURO END) AS IMPORTOSCADEURO,
    (CASE WHEN ((SCADATTPASS<>0 AND LEFT(CODCLIFOR,1)<>'C') OR (SCADATTPASS=0 AND LEFT(CODCLIFOR,1)='C')) THEN (IMPORTOSCVAL*-1) ELSE IMPORTOSCVAL END) AS IMPORTOSCADVALUTA,
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOPN,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOPNVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOPNEURO,
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOBANCA,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOBANCAVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND VISTASALDOCONTIPN.PROVVISORIO=0 AND VISTASALDOCONTIPN.NRGIORNALE=SCADENZEPREVISIONALI.NRGIORNALE) AS SALDOBANCAEURO,
    (CASE WHEN (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SCADENZEPREVISIONALI.TIPOEFFETTO)='D' THEN 0 ELSE 1 END) AS TIPOEFF
    FROM SCADENZEPREVISIONALI


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASTATFINANZIARIA] TO [Metodo98]
    AS [dbo];

