CREATE VIEW VISTAPARTITARIPN1 AS
SELECT
 	TC.PROGRESSIVO,
	TC.ESERCIZIO,
	TC.DATAREG,
	TC.DATARIF,
	TC.NRRIFER,
	TC.MOVIVA,
	TC.PROVVISORIO,
	TC.CAUSALE,
	TC.MESEPLAFOND,
	TC.DESCRIZIONE,
	TC.APPUNTI,
	TC.TOTDOCLIRE,
	TC.TOTDOCVALUTA,
	TC.TOTDOCEURO,
	TC.NRGIORNALE,
	TC.IDTESTADOC,
	TC.UTENTEMODIFICA,
	TC.DATAMODIFICA,
	TC.ANNOPLAFOND,
	RC.CONTO,
	RC.CODCAMBIO,
	RC.VALORECAMBIO,
	RC.CODCOMMESSA,
	RC.SEGNO,
	RC.NRRIGA,
	RC.POSIZIONE,
    RC.CPARTITA,
	RC.DESCRIZIONE DSCRIGA,
	(CASE WHEN  RC.SEGNO=0 THEN IMPORTO ELSE 0 END) DARE,
	(CASE WHEN  RC.SEGNO=0 THEN IMPORTOEURO ELSE 0 END) DAREEURO,
	(CASE WHEN  RC.SEGNO=0 THEN IMPORTOVALUTA ELSE 0 END) DAREVALUTA,
	(CASE WHEN  RC.SEGNO=1 THEN IMPORTO ELSE 0 END) AVERE,
	(CASE WHEN  RC.SEGNO=1 THEN IMPORTOEURO ELSE 0 END) AVEREEURO,
	(CASE WHEN  RC.SEGNO=1 THEN IMPORTOVALUTA ELSE 0 END) AVEREVALUTA,
	TABCFG.DSCCONTO1 DSCCONTO1,
	TABCFG.CODMASTRO CODMASTRO,
	(SELECT TOP 1 NUMDOC FROM RIGHEIVA WHERE NRREG=TC.PROGRESSIVO AND TIPOREGISTRO=TC.MOVIVA) NUMDOC,
	(SELECT TOP 1 DATADOC FROM RIGHEIVA WHERE NRREG=TC.PROGRESSIVO AND TIPOREGISTRO=TC.MOVIVA) DATADOC,
	(SELECT TOP 1 MESELIQUIDAZ FROM RIGHEIVA WHERE NRREG=TC.PROGRESSIVO AND TIPOREGISTRO=TC.MOVIVA) MESELIQUIDAZ,
	TC.ESERCIZIO-1 ESERCIZIOSI,
	(SELECT SUM(SALDO) FROM VISTABILANCI1 WHERE CODCONTO=RC.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TC.NRGIORNALE) AS SALDOINIZ,
	(SELECT SUM(SALDOEURO) FROM VISTABILANCI1 WHERE CODCONTO=RC.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TC.NRGIORNALE) AS SALDOINIZEURO,
	(SELECT SUM(SALDOVALUTA) FROM VISTABILANCI1 WHERE CODCONTO=RC.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TC.NRGIORNALE) AS SALDOINIZVALUTA,
	(CASE WHEN TU.SUPERVISOR=1 THEN 1 ELSE
        (CASE WHEN (SELECT COUNT(NOMEUTENTE) FROM ACCESSICAUSCONT WHERE CODCAUSALE = CAUSALE AND FLAGVISUALIZZA=1 AND NOMEUTENTE=TU.USERID)>0 THEN 1 ELSE 0 END) END) AS ACCESSOUTENTE
	FROM (RIGHECONTABILITA RC INNER JOIN TABCFG ON RC.CONTO=TABCFG.CODCONTO) INNER JOIN TESTECONTABILITA TC ON TC.PROGRESSIVO=RC.NRREG,TABUTENTI TU
	WHERE 
	     (TU.USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND
	     TC.CAUSALE <> (SELECT GIC.CAUSCONTAP FROM TABVINCOLIGIC GIC WHERE GIC.ESERCIZIO = TC.ESERCIZIO)
UNION ALL
SELECT 
 	0 PROGRESSIVO,
	TCONT.ESERCIZIO,
	NULL AS DATAREG,
	TCONT.DATARIF,
	TCONT.NRRIFER,
	TCONT.MOVIVA,
	TCONT.PROVVISORIO,
	TCONT.CAUSALE,
	TCONT.MESEPLAFOND,
	TCONT.DESCRIZIONE,
	TCONT.APPUNTI,
	TCONT.TOTDOCLIRE,
	TCONT.TOTDOCVALUTA,
	TCONT.TOTDOCEURO,
	TCONT.NRGIORNALE,
	TCONT.IDTESTADOC,
	TCONT.UTENTEMODIFICA,
	TCONT.DATAMODIFICA,
	TCONT.ANNOPLAFOND,
	RCONT.CONTO,
	RCONT.CODCAMBIO,
	RCONT.VALORECAMBIO,
	RCONT.CODCOMMESSA,
	RCONT.SEGNO,
	RCONT.NRRIGA,
	RCONT.POSIZIONE,
    RCONT.CPARTITA,
	RCONT.DESCRIZIONE DSCRIGA,
        (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTO ELSE 0 END) DARE,
    	(CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOEURO ELSE 0 END) DAREEURO,
    	(CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOVALUTA ELSE 0 END) DAREVALUTA,
    	(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTO ELSE 0 END) AVERE,
    	(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOEURO ELSE 0 END) AVEREEURO,
    	(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOVALUTA ELSE 0 END) AVEREVALUTA,
	TABCFG.DSCCONTO1 DSCCONTO1,
	TABCFG.CODMASTRO CODMASTRO,
	(SELECT TOP 1 NUMDOC FROM RIGHEIVA WHERE NRREG=TCONT.PROGRESSIVO AND TIPOREGISTRO=TCONT.MOVIVA) NUMDOC,
	(SELECT TOP 1 DATADOC FROM RIGHEIVA WHERE NRREG=TCONT.PROGRESSIVO AND TIPOREGISTRO=TCONT.MOVIVA) DATADOC,
	(SELECT TOP 1 MESELIQUIDAZ FROM RIGHEIVA WHERE NRREG=TCONT.PROGRESSIVO AND TIPOREGISTRO=TCONT.MOVIVA) MESELIQUIDAZ,
	TCONT.ESERCIZIO-1 ESERCIZIOSI,
	(SELECT SUM(SALDO) FROM VISTABILANCI1 WHERE CODCONTO=RCONT.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TCONT.NRGIORNALE) AS SALDOINIZ,
	(SELECT SUM(SALDOEURO) FROM VISTABILANCI1 WHERE CODCONTO=RCONT.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TCONT.NRGIORNALE) AS SALDOINIZEURO,
	(SELECT SUM(SALDOVALUTA) FROM VISTABILANCI1 WHERE CODCONTO=RCONT.CONTO AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND PROGRESSIVO=0 AND NRGIORNALE=TCONT.NRGIORNALE) AS SALDOINIZVALUTA,
	1 AS ACCESSOUTENTE
    FROM (RIGHECONTABILITA RCONT INNER JOIN TABCFG ON RCONT.CONTO=TABCFG.CODCONTO) INNER JOIN TESTECONTABILITA TCONT ON TCONT.PROGRESSIVO=RCONT.NRREG
    WHERE TCONT.CAUSALE=(SELECT GIC.CAUSCONTAP FROM TABVINCOLIGIC GIC WHERE GIC.ESERCIZIO=TCONT.ESERCIZIO)


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAPARTITARIPN1] TO [Metodo98]
    AS [dbo];

