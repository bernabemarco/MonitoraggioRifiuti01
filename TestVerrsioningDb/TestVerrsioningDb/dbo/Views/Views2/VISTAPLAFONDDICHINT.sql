
------------------------------------------------SVILUPPO INVIO STATISTICHE-----------------------------------------------------

-- SVILUPPO 3986 --------------------------------------------------------------------------------------------------------------
CREATE VIEW VISTAPLAFONDDICHINT AS
SELECT DI.CODCLIFOR,DI.ESERCIZIO,
(SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO=DI.CODCLIFOR) AS DSCCONTO1,
(SELECT TOP 1 PLAFONDLIRE FROM TABPLAFOND WHERE ANNO=DI.ESERCIZIO) AS PLAFINIZIALE,
(SELECT TOP 1 PLAFONDEURO FROM TABPLAFOND WHERE ANNO=DI.ESERCIZIO) AS PLAFINIZIALEEURO,
(SELECT SUM(IMPORTOPERIODO) FROM DICHIARAZIONEINTENTO WHERE DICHIARAZIONEINTENTO.ESERCIZIO=DI.ESERCIZIO AND DICHIARAZIONEINTENTO.CODCLIFOR=DI.CODCLIFOR AND DICHIARAZIONEINTENTO.DEFINITIVO=1 AND ISNULL(DICHIARAZIONEINTENTO.REVOCA,0)=0) AS TOTDICHEMESSENOREV,
(SELECT SUM(IMPORTOPERIODOEURO) FROM DICHIARAZIONEINTENTO WHERE DICHIARAZIONEINTENTO.ESERCIZIO=DI.ESERCIZIO AND DICHIARAZIONEINTENTO.CODCLIFOR=DI.CODCLIFOR AND DICHIARAZIONEINTENTO.DEFINITIVO=1 AND ISNULL(DICHIARAZIONEINTENTO.REVOCA,0)=0) AS TOTDICHEMESSEEURONOREV,
(SELECT SUM(IMPORTOPERIODO) FROM DICHIARAZIONEINTENTO WHERE DICHIARAZIONEINTENTO.ESERCIZIO=DI.ESERCIZIO AND DICHIARAZIONEINTENTO.CODCLIFOR=DI.CODCLIFOR AND DICHIARAZIONEINTENTO.DEFINITIVO=1) AS TOTDICHEMESSE,
(SELECT SUM(IMPORTOPERIODOEURO) FROM DICHIARAZIONEINTENTO WHERE DICHIARAZIONEINTENTO.ESERCIZIO=DI.ESERCIZIO AND DICHIARAZIONEINTENTO.CODCLIFOR=DI.CODCLIFOR AND DICHIARAZIONEINTENTO.DEFINITIVO=1) AS TOTDICHEMESSEEURO,
(SELECT SUM(TOTIMPONIBILERES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='O' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCLIFOR=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS ORDINIAPERTIRES,
(SELECT SUM(TOTIMPONIBILEEURORES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='O' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCLIFOR=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS ORDINIAPERTIRESEURO,
(SELECT SUM(TOTIMPONIBILERES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='B' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCLIFOR=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS DDTAPERTIRES,
(SELECT SUM(TOTIMPONIBILEEURORES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='B' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCLIFOR=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS DDTAPERTIRESEURO,
(SELECT SUM(TOTIMPONIBILERES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='O' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCFFATT=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS ORDINIAPERTICFFATT,
(SELECT SUM(TOTIMPONIBILEEURORES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='O' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCFFATT=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS ORDINIAPERTICFFATTEURO,
(SELECT SUM(TOTIMPONIBILERES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='B' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCFFATT=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS DDTAPERTICFFATT,
(SELECT SUM(TOTIMPONIBILEEURORES) FROM TESTEDOCUMENTI WHERE (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=TIPODOC)='B' AND DOCCHIUSO=0 AND TESTEDOCUMENTI.CODCFFATT=DI.CODCLIFOR AND TIPODOC IN (SELECT CODICE FROM DICHIARAZIONEINTENTO_TABDOC)) AS DDTAPERTICFFATTEURO
FROM DICHIARAZIONEINTENTO DI 
WHERE DEFINITIVO=1
GROUP BY DI.CODCLIFOR,DI.ESERCIZIO
GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAPLAFONDDICHINT] TO [Metodo98]
    AS [dbo];

