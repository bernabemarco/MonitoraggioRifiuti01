CREATE VIEW VISTASCADENZEPREV AS
SELECT 1 AS TIPOREC,
    TS.PROGRESSIVO,
    TS.ESERCIZIO,
    TS.ANNODOC,
    TS.TIPODOC,
    TS.NUMDOC,
    TS.BIS,
    TS.NUMSCAD,
    TS.DATASCADENZA,
    TS.CODCLIFOR,
    TS.DATAFATTURA,
    TS.BANCAINC,
    TS.BANCAAPPOGGIO,
    TS.NUMRIF,
    TS.NUMEROPROT,
    TS.CODAGE1,
    TS.CODAGE2,
    TS.CODAGE3,
    TS.IMPPROVLIT1,
    TS.IMPPROVLIT2,
    TS.IMPPROVLIT3,
    TS.IMPPROVVAL1,
    TS.IMPPROVVAL2,
    TS.IMPPROVVAL3,
    TS.IMPPROVEURO1,
    TS.IMPPROVEURO2,
    TS.IMPPROVEURO3,
    TS.LIQPROV1,
    TS.LIQPROV2,
    TS.LIQPROV3,
    TS.IMPORTOSCLIT,
    TS.IMPORTOSCVAL,
    TS.IMPORTOSCEURO,
    TS.IMPONIBSCLIT,
    TS.IMPONIBSCVAL,
    TS.IMPONIBSCEURO,
    TS.TOTFATTLIT,
    TS.TOTFATTVAL,
    TS.TOTFATTEURO,
    TS.IMPFATTLIT,
    TS.IMPFATTVAL,
    TS.IMPFATTEURO,
    TS.FLAGCONT,
    TS.TIPOEFFETTO,
    TS.ESITO,
    TS.LIVSOLL,
    TS.LIQINS1,
    TS.LIQINS2,
    TS.LIQINS3,
    TS.CODCAMBIO,
    TS.VALCAMBIO,
    TS.NRDISTINTA,
    TS.NUMRAGGR,
    TS.DATAPAGEFF,
    TS.SCADATTPASS,
    TS.NUMRIFPARTCONT,
    TS.CODPAG,
    TS.DATADEC,
    TS.NOTE,
    TS.NRGIORNALE,
    TS.UTENTEMODIFICA,
    TS.DATAMODIFICA,
    AB.CODCONTORIF AS CONTORIFBANCA,
    CFG.DSCCONTO1 AS DSCCONTO1,
    AB.DSCBANCA AS DSCBANCA,
    TE.DESCRIZIONE AS DSCTIPOEFFETTO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCLIT*-1) ELSE TS.IMPORTOSCLIT END) AS IMPORTOSCADLIRE,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCEURO*-1) ELSE TS.IMPORTOSCEURO END) AS IMPORTOSCADEURO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCVAL*-1) ELSE TS.IMPORTOSCVAL END) AS IMPORTOSCADVALUTA,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTLIT*-1) ELSE TS.TOTFATTLIT END) AS TOTFATTURALIRE,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTEURO*-1) ELSE TS.TOTFATTEURO END) AS TOTFATTURAEURO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTVAL*-1) ELSE TS.TOTFATTVAL END) AS TOTFATTURAVALUTA,
    AG1.DSCAGENTE AS DSCAGENTE1,
    AG2.DSCAGENTE AS DSCAGENTE2,
    AG3.DSCAGENTE AS DSCAGENTE3,
    AC.CODNAZIONE AS NAZIONE,
    AR.CODSETTORE AS SETTORE,
    AR.CODZONA AS ZONA,
    AR.CODCATEGORIA AS CATEGORIA,
    TE.TIPO AS DSCEFFETTO,
    ES.DESCRIZIONE AS DSCESITO,
    SUBSTRING('Attivi Passivi',(1-SCADATTPASS)*7+1,7) AS DESSCADATTPASS,
    SUBSTRING('01-GEN02-FEB03-MAR04-APR05-MAG06-GIU07-LUG08-AGO09-SET10-OTT11-NOV12-DIC',((MONTH(DATASCADENZA))-1)*6+1,6) AS MESE,
    YEAR(DATASCADENZA) AS ANNO
    FROM (((((((((SCADENZEPREVISIONALI TS
    		LEFT OUTER JOIN ANAGRAFICACF AC          ON AC.CODCONTO=TS.CODCLIFOR)
    		LEFT OUTER JOIN TABCFG CFG               ON CFG.CODCONTO=TS.CODCLIFOR)
    		LEFT OUTER JOIN ANAGRAFICARISERVATICF AR ON AR.CODCONTO=TS.CODCLIFOR AND AR.ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) 
		LEFT OUTER JOIN ANAGRAFICAAGENTI AG1     ON AG1.CODAGENTE=TS.CODAGE1)
		LEFT OUTER JOIN ANAGRAFICAAGENTI AG2     ON AG2.CODAGENTE=TS.CODAGE2)
		LEFT OUTER JOIN ANAGRAFICAAGENTI AG3     ON AG3.CODAGENTE=TS.CODAGE3)
		LEFT OUTER JOIN ANAGRAFICABANCHE AB      ON AB.CODBANCA=TS.BANCAINC)
		LEFT OUTER JOIN TIPIEFFETTI TE           ON TE.EFFETTO=TS.TIPOEFFETTO)
		LEFT OUTER JOIN ESITI ES                 ON ES.ESITO=TS.ESITO)


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASCADENZEPREV] TO [Metodo98]
    AS [dbo];

