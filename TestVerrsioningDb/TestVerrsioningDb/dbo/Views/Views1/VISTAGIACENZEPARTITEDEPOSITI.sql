CREATE VIEW VISTAGIACENZEPARTITEDEPOSITI
AS
SELECT 
	ANAGRAFICALOTTI.CODARTICOLO,
	ANAGRAFICALOTTI.CODLOTTO,
	ANAGRAFICALOTTI.BLOCCATO,
	(SELECT UM FROM ARTICOLIUMPREFERITE WHERE TIPOUM=1 AND COdart=ANAGRAFICALOTTI.CODARTICOLO) AS UM1,
	(SELECT UM FROM ARTICOLIUMPREFERITE WHERE TIPOUM=2 AND COdart=ANAGRAFICALOTTI.CODARTICOLO) AS UM2,
	(CASE WHEN VISTAGIACENZE.CODDEPOSITO IS NULL 
		THEN (SELECT CODICE FROM ANAGRAFICADEPOSITI WHERE PRINCIPALE = 1) 
		ELSE VISTAGIACENZE.CODDEPOSITO END) AS CODDEPOSITO,	
	SUM(ORDINATO) ORDINATO,SUM(ORDINATO2UM) ORDINATO2UM,
	SUM(IMPEGNATO) IMPEGNATO,SUM(IMPEGNATO2UM) IMPEGNATO2UM,	
	SUM(CARICO) CARICO,SUM(CARICO2UM) CARICO2UM,

	SUM(SCARICO) SCARICO,SUM(SCARICO2UM) SCARICO2UM,
	SUM(RESODACARICO) RESODACARICO,SUM(RESODACARICO2UM) RESODACARICO2UM,
	SUM(RESODASCARICO) RESODASCARICO,SUM(RESODASCARICO2UM) RESODASCARICO2UM,
	(SUM(CARICO)+SUM(RESODASCARICO)-SUM(SCARICO)-SUM(RESODACARICO)) AS GIACENZA,
	(SUM(CARICO2UM)+SUM(RESODASCARICO2UM)-SUM(SCARICO2UM)-SUM(RESODACARICO2UM)) AS GIACENZA2UM,
	(SUM(CARICO)+SUM(RESODASCARICO)-SUM(SCARICO)-SUM(RESODACARICO)+SUM(ORDINATO)-SUM(IMPEGNATO)) AS DISPONIBILITA,
	(SUM(CARICO2UM)+SUM(RESODASCARICO2UM)-SUM(SCARICO2UM)-SUM(RESODACARICO2UM)+SUM(ORDINATO2UM)-SUM(IMPEGNATO2UM)) AS DISPONIBILITA2UM
FROM 
	ANAGRAFICALOTTI LEFT OUTER JOIN VISTAGIACENZE
	ON ANAGRAFICALOTTI.CODARTICOLO = VISTAGIACENZE.CODART
	AND ANAGRAFICALOTTI.CODLOTTO = VISTAGIACENZE.NRIFPARTITA
GROUP BY
	ANAGRAFICALOTTI.CODARTICOLO,ANAGRAFICALOTTI.CODLOTTO,CODDEPOSITO,ANAGRAFICALOTTI.BLOCCATO

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAGIACENZEPARTITEDEPOSITI] TO [Metodo98]
    AS [dbo];

