CREATE VIEW VISTADOCNAV AS
    SELECT
    1 AS ORIGINE,
    TD.PROGRESSIVO AS IDTESTA,RD.IDRIGA,0 AS IDIMPEGNO,
    TD.ESERCIZIO,TD.TIPODOC AS TIPO, TD.NUMERODOC AS NUMERO, TD.BIS, 
    TD.DATADOC AS DATAEMISSIONE,
    TD.CODCLIFOR,
    (SELECT DSCCONTO1 FROM AnagraficaCF WHERE AnagraficaCF.CodConto=TD.CODCLIFOR) AS RagSocCliFor,
    RD.CODART,RD.DESCRIZIONEART,
    RD.DATACONSEGNA, 
    RD.UMGEST,RD.QTAGEST * TD.SEGNO AS QTAGESTIONE,RD.QTAGESTRES * TD.SEGNO AS QTAGESTIONERES,RD.QTAGESTPRELEVATA * TD.SEGNO AS QTAGESTIONEVERS,
    RD.UMPREZZO,
    RD.QTAPREZZO * TD.SEGNO AS QTAPREZZO,
    RD.QTAPREZZORES * TD.SEGNO AS QTAPREZZORES,
    (SELECT UM FROM ARTICOLIUMPREFERITE AUM WHERE AUM.CODART = RD.CODART AND AUM.TIPOUM = 1) UM1MAG,
    RD.QTA1MAG * TD.SEGNO AS QTA1MAG,RD.QTA1MAGRES * TD.SEGNO AS QTA1MAGRES,
    (SELECT UM FROM ARTICOLIUMPREFERITE AUM WHERE AUM.CODART = RD.CODART AND AUM.TIPOUM = 2) UM2MAG,
    RD.QTA2MAG * TD.SEGNO AS QTA2MAG,RD.QTA2MAGRES * TD.SEGNO AS QTA2MAGRES,
    RD.CODDEPOSITO, RD.CODDEPOSITOCOLL,
    RD.UBICAZIONE,RD.UBICAZIONECOLL,
    RD.NRRIFPARTITA AS PARTITAASSEGNATA,
    (CASE WHEN TD.CODCAMBIO=0 THEN RD.PREZZOUNITNETTO ELSE RD.PREZZOUNITNETTOEURO * TCAM.CAMBIOEURO END ) AS COSTOUNITARIO,
     RD.PREZZOUNITNETTOEURO AS COSTOUNITARIOEURO,
    (CASE WHEN TD.CODCAMBIO=0 THEN RD.TOTNETTORIGA * TD.SEGNO ELSE RD.TOTNETTORIGAEURO * TCAM.CAMBIOEURO * TD.SEGNO END) AS COSTOTOTALE,
     RD.TOTNETTORIGAEURO * TD.SEGNO AS COSTOTOTALEEURO,
     RD.RIFRELAZIONECF
FROM
    ((TESTEDOCUMENTI TD INNER JOIN  RIGHEDOCUMENTI RD ON TD.PROGRESSIVO = RD.IDTESTA)
    INNER JOIN ANAGRAFICARISERVATICF ON CODCLIFOR = ANAGRAFICARISERVATICF.CODCONTO),
    TABCAMBI TCAM
    WHERE (TCAM.CODICE = 0) AND (ANAGRAFICARISERVATICF.ESERCIZIO = TD.ESERCIZIO)

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTADOCNAV] TO [Metodo98]
    AS [dbo];

