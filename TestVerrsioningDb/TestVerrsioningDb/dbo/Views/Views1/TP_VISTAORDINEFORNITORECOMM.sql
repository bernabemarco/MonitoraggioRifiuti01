
CREATE VIEW [dbo].[TP_VISTAORDINEFORNITORECOMM]
AS
SELECT  OFN_RECORDSET.CODART,
        OFN_RECORDSET.CODART AS CODICE,
        OFN_RECORDSET.TP_FORNFATTURAZIONE,
        OFN_RECORDSET.DESCFORNITOREFATTURAZIONE,
        OFN_RECORDSET.CODFOR,
        OFN_RECORDSET.DESCFORNITORE,              
        OFN_RECORDSET.IVAFOR,
        OFN_RECORDSET.LISTINOFOR,
        OFN_RECORDSET.CODZONAFOR,
        OFN_RECORDSET.CODSETTOREFOR,
        OFN_RECORDSET.CODCATEGORIACF, 
        OFN_RECORDSET.CODPAGCF,
        OFN_RECORDSET.RIVIVAOMAGGI,
        OFN_RECORDSET.TP_CODDEP,
        OFN_RECORDSET.DESCMAGAZZINO,
        OFN_RECORDSET.DISPONIBILE,
        OFN_RECORDSET.GGAPPROVV,
        OFN_RECORDSET.GGAPPRONT,
        OFN_RECORDSET.QTAMASSIMA,
        OFN_RECORDSET.QTAMINIMA,
        OFN_RECORDSET.TP_SCORPORO,
        OFN_RECORDSET.TP_CODICEINTERNO,
        OFN_RECORDSET.CODICEOMOGENEOPASSIVO,
        OFN_RECORDSET.GESTSTAG,
        OFN_RECORDSET.OFTIPOPREVISIONALE,
        OFN_RECORDSET.OFSMOOTHINGSTAGIONALE,
        OFN_RECORDSET.TEMPOSICUREZZA,
        ISNULL(TP_STATO_ARTICOLI.DESCRIZIONE,'') AS STATOARTICOLO,
        ISNULL(OFN_RECORDSET.OFARRQTAINORD,1) AS OFARRQTAINORD,
        OFN_RECORDSET.RAEEGESTIONE,
        OFN_RECORDSET.RAEEVALORE,
        OFN_RECORDSET.RAEEUM,
        OFN_RECORDSET.RAEEGENERICOACQ,
        OFN_RECORDSET.RAEEGENERICOVEN,
        OFN_RECORDSET.DESCARTICOLO,
        OFN_RECORDSET.DESCARTICOLO AS DESCRIZIONEART,
        OFN_RECORDSET.GRUPPO,
        OFN_RECORDSET.CATEGORIA,
        OFN_RECORDSET.CODCATEGORIASTAT,
        OFN_RECORDSET.GRUPPOPRZPART,
        OFN_RECORDSET.CODFAMIGLIAPOS,
        OFN_RECORDSET.CODREPARTOPOS,
        OFN_RECORDSET.VARESPLICITE,
        (SELECT TOP 1 TLA.CODLIVELLOINTERNO FROM TP_LIVELLIARTICOLI TLA WHERE TLA.CODICE = OFN_RECORDSET.CODART) AS LIVELLOMERCEOLOGICO,
        OFN_RECORDSET.NRPEZZIIMBALLO,
        TABIMBALLI.PESOIMBALLO,
        OFN_RECORDSET.PESONETTO,
        OFN_RECORDSET.IVAART,
        OFN_RECORDSET.FATTORESICUREZZA,
        OFN_RECORDSET.SCORTAMINIMA,
        OFN_RECORDSET.SCORTAMASSIMA,
        OFN_RECORDSET.LOTTORIORDINO,
        OFN_RECORDSET.LIVELLORIORDINO,
        OFN_RECORDSET.UMBASE,
        OFN_RECORDSET.PERIODOOSSERVAZIONE,
        OFN_RECORDSET.GIORNILAVOROPREVISTI,
        OFN_RECORDSET.DESCRIZIONEPERIODO,
        TRATTAMENTOIVAART.ALIQUOTA AS ALIQUOTAART,
        TRATTAMENTOIVA.ALIQUOTA AS ALIQUOTAFOR,
        LISTINIFORNITORE.DESCRIZIONE AS DESCRIZIONELISTINOFOR,
        OFN_RECORDSET.CODCAMBIO,
        CAMBIFORNITORE.DIVISA AS CODDIVISA,
        CAMBIFORNITORE.DESCRIZIONE AS DSCDIVISA,
        CAMBIFORNITORE.NDECIMALIUNITARIO AS NDECIMALIUNITARIOFOR,
        CAMBIFORNITORE.NDECIMALITOTALE AS NDECIMALITOTALEFOR,
        CAMBIFORNITORE.CAMBIOEURO AS VALCAMBIO,
        CAMBIFORNITORE.TIPOEURO,
        TP_TABMAGAZZINI.PROGRESSIVO AS PROGRMULTIDEPOSITO,  
        TP_EXTRAFORNITORI.TP_FMCASA AS MOLTIPLICATIVOFORNITORE,
        TP_EXTRAFORNITORI.TP_FMTAB AS MOLTIPLICATIVOTABELLA,
        TP_EXTRAFORNITORI.TP_TREV AS TEMPOREVISIONE, 
        TP_EXTRAFORNITORI.TP_TIPOFOR,
        TP_EXTRAFORNITORI.TP_OFPREZSCM,
        ISNULL(TP_EXTRAFORNITORI.TP_USAPREZZIPART,0) AS TP_USAPREZZIPART,
        (
            CASE OFN_RECORDSET.MODALITACALCOLO
                WHEN 0 THEN EOQ.SCORTASICUREZZA
                WHEN 1 THEN PFR.SCORTASICUREZZA
                WHEN 2 THEN SCRT.SCORTASICUREZZA
                WHEN 3 THEN PERS.SCORTASICUREZZA
            END
        ) AS SCORTASICUREZZAMAG,
        (
            CASE OFN_RECORDSET.MODALITACALCOLO
                WHEN 0 THEN EOQ.LOTTORIORDINO
                WHEN 1 THEN PFR.LOTTORIORDINO
                WHEN 2 THEN LOTTORIF
                WHEN 3 THEN PERS.LOTTORIORDINO
            END
        ) AS LOTTORIORDINOMAG,
        (
            CASE OFN_RECORDSET.MODALITACALCOLO
                WHEN 0 THEN EOQ.LIVELLORIORDINO
                WHEN 1 THEN PFR.LIVELLORIORDINO
                WHEN 2 THEN SCRT.LIVELLORIORDINO
                WHEN 3 THEN PERS.LIVELLORIORDINO
            END
        ) AS LIVELLORIORDINOMAG,
        OFN_RECORDSET.LIVELLOSERVIZIO AS LIVELLOSERVIZIOMAG,
        ISNULL(
                (
                CASE OFN_RECORDSET.MODALITACALCOLO
                    WHEN 0 THEN EOQ.CodFornPref
                    WHEN 1 THEN PFR.CodFornPref
                    WHEN 2 THEN SCRT.CodFornPref
                    WHEN 3 THEN PERS.CodFornPref
                END
                )
            ,'') AS FORNITOREPREFERENZIALEMAG,
        OFN_RECORDSET.MODALITACALCOLO,
        '' As NOMEPIANIF,
        '' as PROG_ID,
        getdate() AS DATACONSEGNA,
        '' as RIFCOMMESSA,
        0 as QTAPROPOSTA,
        0 as PREVISIONE,
        OFN_RECORDSET.USAPREVISIONIFORZATE,
        OFN_RECORDSET.QTAPREVISIONIFORZATE,
        OFN_RECORDSET.UMPREVISIONIFORZATE,
        OFN_RECORDSET.UTENTEPREVISIONIFORZATE,
        OFN_RECORDSET.DATAPREVISIONIFORZATE,
        OFN_RECORDSET.CODMARCHIO,
        TP_ORF_EXTRAMAG.*,
        TP_ORF_EXTRAFOR.*
FROM
(
    SELECT DISTINCT TLRRD.CODART,
                    TLRRD.TP_FORNFATTURAZIONE,
                    ANAFRNFTT.DSCCONTO1 AS DESCFORNITOREFATTURAZIONE,
                    TLRRD.CODFOR,
                    ANAFRN.DSCCONTO1 AS DESCFORNITORE,              
                    ANAFRNCF.CODIVA AS IVAFOR,
                    ANAFRNCF.LISTINO AS LISTINOFOR,
                    ANAFRNCF.CODZONA AS CODZONAFOR,
                    ANAFRNCF.CODSETTORE AS CODSETTOREFOR,
                    ANAFRNCF.CODCATEGORIA AS CODCATEGORIACF, 
                    ANAFRNCF.CODPAG AS CODPAGCF,
                    ANAFRNCF.RIVIVAOMAGGI,
                    ANAFRNCF.CODCAMBIO,
                    TLRRD.TP_CODDEP,
                    ANADEP.DESCRIZIONE AS DESCMAGAZZINO,
                    ANADEP.DISPONIBILE,
                    TLRRD.GGAPPROVV,
                    TLRRD.GGAPPRONT,
                    TLRRD.QTAMASSIMA,
                    TLRRD.QTAMINIMA,
                    TXMAG.TP_SCORPORO,
                    TXMAG.TP_CODICEINTERNO,
                    TXMAG.CODICEOMOGENEOPASSIVO,
                    TXMAG.GESTSTAG,
                    TXMAG.OFTIPOPREVISIONALE,
                    TXMAG.OFSMOOTHINGSTAGIONALE,
                    TXMAG.TP_TSICUR AS TEMPOSICUREZZA,
                    TXMAG.STATO_REV_SOS_ESA,
                    TXMAG.OFARRQTAINORD,
                    TXMAG.RAEEGESTIONE,
                    TXMAG.RAEEVALORE,
                    TXMAG.RAEEUM,
                    TXMAG.RAEEGENERICOACQ,
                    TXMAG.RAEEGENERICOVEN,
                    ANAGA.DESCRIZIONE AS DESCARTICOLO,
                    ANAGA.GRUPPO,
                    ANAGA.CATEGORIA,
                    ANAGA.CODCATEGORIASTAT,
                    ANAGC.GRUPPOPRZPART,
                    TXMAG.CODFAMIGLIAPOS,
                    TXMAG.CODREPARTOPOS,
                    ANAGA.VARESPLICITE,
                    ANAGA.NRPEZZIIMBALLO,
                    ANAGA.RIFERIMIMBALLO,
                    ANAGA.PESONETTO,
                    ANAGC.CODIVA AS IVAART,
                    ANAGP.FATTORESICUREZZA,
                    ANAGP.SCORTAMIN AS SCORTAMINIMA,
                    ANAGP.SCORTAMAX AS SCORTAMASSIMA,
                    ANAGP.LOTTORIORDINO AS LOTTORIORDINO,  
                    ANAGP.LIVRIORDINO AS LIVELLORIORDINO,
                    UMPRF.UM AS UMBASE,
                    TPOSS.PROGRESSIVO AS PERIODOOSSERVAZIONE,
                    TPOSS.GIORNI AS GIORNILAVOROPREVISTI,
                    TPOSS.DESCRIZIONE AS DESCRIZIONEPERIODO,
                    TXMAG.LIVELLOSERVIZIO,
                    TXMAG.USAPREVISIONIFORZATE,
                    TXMAG.QTAPREVISIONIFORZATE,
                    TXMAG.UMPREVISIONIFORZATE,
                    TXMAG.UTENTEPREVISIONIFORZATE,
                    TXMAG.DATAPREVISIONIFORZATE,
                    TXMAG.CODMARCHIO,
                    TXMAG.MODALITACALCOLO,
                    TXMAG.LIVELLOSERVIZIO AS LIVELLOSERVIZIOMAG,
                    TLRRD.LOTTORIF
    FROM    (SELECT DISTINCT
                CODART, 
                CODFOR,
                TP_CODDEP, 
                TP_FORNFATTURAZIONE,
                GGAPPROVV,
                GGAPPRONT,
                QTAMASSIMA,
                QTAMINIMA,
                LOTTORIF
             FROM TABLOTTIRIORDINO) TLRRD, 
            TP_EXTRAMAG TXMAG, 
            ANAGRAFICAARTICOLI ANAGA,
            ANAGRAFICAARTICOLICOMM ANAGC,
            ANAGRAFICAARTICOLIPROD ANAGP,
            TP_PERIODO_OSSERVAZIONE TPOSS,
            ARTICOLIUMPREFERITE UMPRF,
            ANAGRAFICADEPOSITI ANADEP,
            ANAGRAFICACF ANAFRNFTT,
            ANAGRAFICACF ANAFRN,
            ANAGRAFICARISERVATICF ANAFRNCF
    WHERE   TXMAG.CODART = TLRRD.CODART AND 
            TXMAG.CONSIDACQ = 1 AND 
            ANAGA.CODICE = TXMAG.CODART AND ANAGA.ARTTIPOLOGIA = 0 AND
            ((ANAGC.CODICEART=ANAGA.CODICE AND ANAGC.ESERCIZIO = (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME()))) AND
            ((ANAGP.CODICEART=ANAGA.CODICE AND ANAGP.ESERCIZIO = (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME()))) AND
            TPOSS.PROGRESSIVO=TXMAG.TP_PERIODODIOSSERVAZIONE AND
            UMPRF.TIPOUM = 1 AND UMPRF.CODART = TLRRD.CODART AND
            ANADEP.CODICE = TLRRD.TP_CODDEP AND
            ANAFRNFTT.CODCONTO=TLRRD.TP_FORNFATTURAZIONE AND
            ANAFRN.CODCONTO = TLRRD.CODFOR AND
            ANAFRNCF.CODCONTO = ANAFRN.CODCONTO AND ANAFRNCF.ESERCIZIO = (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME())
) AS OFN_RECORDSET
LEFT JOIN TRATTAMENTOIVA AS TRATTAMENTOIVAART
    ON TRATTAMENTOIVAART.CODICE = OFN_RECORDSET.IVAART
LEFT JOIN TABLISTINI AS LISTINIFORNITORE
    ON LISTINIFORNITORE.NRLISTINO = OFN_RECORDSET.LISTINOFOR AND LISTINIFORNITORE.CODCAMBIO = OFN_RECORDSET.CODCAMBIO
LEFT JOIN TRATTAMENTOIVA
    ON TRATTAMENTOIVA.CODICE = OFN_RECORDSET.IVAFOR
LEFT JOIN TP_EXTRAFORNITORI
    ON TP_EXTRAFORNITORI.CODCONTO = OFN_RECORDSET.CODFOR
INNER JOIN TP_TABMAGAZZINI
    ON TP_TABMAGAZZINI.CODDEPOSITO=OFN_RECORDSET.TP_CODDEP AND TP_TABMAGAZZINI.USAPERORDINE = 1
LEFT JOIN EXTRAMAG
    ON EXTRAMAG.CODART=OFN_RECORDSET.CODART
LEFT JOIN TABCAMBI AS CAMBIFORNITORE
    ON CAMBIFORNITORE.CODICE = LISTINIFORNITORE.CODCAMBIO
LEFT JOIN TP_STATO_ARTICOLI
    ON TP_STATO_ARTICOLI.CODICE = OFN_RECORDSET.STATO_REV_SOS_ESA
LEFT JOIN TABIMBALLI
    ON TABIMBALLI.CODICE = OFN_RECORDSET.RIFERIMIMBALLO
LEFT JOIN
    TP_ConfigSconti ScontiListino
ON
    ScontiListino.Attiva = 1 And ScontiListino.CodFor = OFN_RECORDSET.CODFOR AND ((GETDATE() BETWEEN ScontiListino.DaData AND ScontiListino.AData) OR (GETDATE() >= ScontiListino.DaData and ScontiListino.AData IS NULL))
LEFT JOIN
    (
    SELECT
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTAMINIMACALCOLATA ELSE SCORTAMINIMAFORZATO END) AS SCORTASICUREZZA,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LOTTORIORDINOCALCOLATO ELSE LOTTORIORDINOFORZATO END) AS LOTTORIORDINO,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LIVELLORIORDINOCALCOLATO ELSE LIVELLORIORDINOFORZATO END) AS LIVELLORIORDINO
    FROM TP_APPROVV_DEPOSITI
    ) EOQ
ON
    EOQ.CODARTICOLO = OFN_RECORDSET.CODART AND
    EOQ.CODDEPOSITO = OFN_RECORDSET.TP_CODDEP
LEFT JOIN
    (
    SELECT 
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTASICUREZZACALCOLATA ELSE SCORTASICUREZZAFORZATO END) AS SCORTASICUREZZA,
        0 AS LOTTORIORDINO,
        (CASE WHEN USAVALOREFORZATO = 0 THEN QTAOBIETTIVOCALCOLATA ELSE QTAOBIETTIVOFORZATO END) AS LIVELLORIORDINO
    FROM TP_PUNTOFISSORIORDINO
    ) PFR
ON
    PFR.CODARTICOLO = OFN_RECORDSET.CODART AND
    PFR.CODDEPOSITO = OFN_RECORDSET.TP_CODDEP
LEFT JOIN
    (
    SELECT
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTASICUREZZA ELSE SCORTASICUREZZAFORZATO END) AS SCORTASICUREZZA,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LIVELLORIORDINOCALCOLATO ELSE LIVELLORIORDINOFORZATO END) AS LIVELLORIORDINO
    FROM TP_SCORTA
    ) SCRT
ON
    SCRT.CODARTICOLO = OFN_RECORDSET.CODART AND
    SCRT.CODDEPOSITO = OFN_RECORDSET.TP_CODDEP
LEFT JOIN
    (
    SELECT 
        CodArticolo,
        CodDeposito,
        CodFornPref,
        0 AS SCORTASICUREZZA,
        0 AS LOTTORIORDINO,
        0 AS LIVELLORIORDINO
    FROM TP_PERSONALIZZATOLIBERO
    ) PERS
ON
    PERS.CODARTICOLO = OFN_RECORDSET.CODART AND
    PERS.CODDEPOSITO = OFN_RECORDSET.TP_CODDEP
LEFT JOIN TP_ORF_EXTRAMAG
    ON  TP_ORF_EXTRAMAG.TOEM_CODARTICOLO = OFN_RECORDSET.CODART AND
        TP_ORF_EXTRAMAG.TOEM_CODDEPOSITO = OFN_RECORDSET.TP_CODDEP
LEFT JOIN TP_ORF_EXTRAFOR
    ON  TP_ORF_EXTRAFOR.TOEF_CODARTICOLO = OFN_RECORDSET.CODART AND
        TP_ORF_EXTRAFOR.TOEF_CODFORNITORE = OFN_RECORDSET.CODFOR

GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTAORDINEFORNITORECOMM] TO [Metodo98]
    AS [dbo];

