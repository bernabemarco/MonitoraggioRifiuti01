CREATE VIEW VISTACOSTIMATERIALICC AS
SELECT 
	IDCOMMCLI,
	NRRIGA,
	IDTESTADOC,
	IDRIGADOC,
	(CASE ORIGINEEVENTO WHEN 3 THEN 
		(SELECT POSIZIONE FROM RIGHEORDPROD WHERE IDTESTA=CC.IDTESTADOC AND IDRIGA=CC.IDRIGADOC) 
		ELSE (SELECT POSIZIONE FROM RIGHEDOCUMENTI WHERE IDTESTA=CC.IDTESTADOC AND IDRIGA=CC.IDRIGADOC) END) AS POSDOC,
	IDIMPEGNO,
	(SELECT POSIZIONE FROM IMPEGNIORDPROD WHERE IDTESTA=CC.IDTESTADOC AND IDRIGA=CC.IDRIGADOC AND IDIMPEGNO=CC.IDIMPEGNO) AS POSIMPEGNO,
	IDTESTAFATT,
	IDRIGAFATT,
	(SELECT POSIZIONE FROM RIGHEDOCUMENTI WHERE IDTESTA=CC.IDTESTAFATT AND IDRIGA=CC.IDRIGAFATT) AS POSFATT,
	CODART,
	UMBASE,
	QUANTITA,
	UMVAL,
	QTAVAL,
	COSTOUNITARIO,
	NATURARILEVAZIONE,
	TIPOREC,
	UTENTEMODIFICA,
	DATAMODIFICA,
	VOCEBASE,
	IDVOCE,
	COSTOUNITARIOEURO,
	TIPOCOSTO,
	IDTABELLA,
	IDSTORICOMAG,
	ORIGINEEVENTO,
	TIPOINSERIMENTO,
	DATAELAB_CONS,
	DATAELAB_VAL,
	DATAMOVIMENTO,
	DATADISPONIBILITA,
	DATACOMPETENZA,
	DATARIFVALORIZ,
	TIPORECDETT,
	CONTOCDC,
	QTABUDGET,
	PESO,
	FLGMOVPROD,
	ESERCIZIOMOV,
	NUMEROMOV,
	NOTE,
	IDTESTA_DEST,
	IDRIGA_DEST,
	(CASE ORIGINEEVENTO_DEST WHEN 3 THEN 
		(SELECT POSIZIONE FROM RIGHEORDPROD WHERE IDTESTA=CC.IDTESTA_DEST AND IDRIGA=CC.IDRIGA_DEST) 
		ELSE (SELECT POSIZIONE FROM RIGHEDOCUMENTI WHERE IDTESTA=CC.IDTESTA_DEST AND IDRIGA=CC.IDRIGA_DEST) END) AS POSDOC_DEST,
	IDIMPEGNO_DEST,
	(SELECT POSIZIONE FROM IMPEGNIORDPROD WHERE IDTESTA=CC.IDTESTA_DEST AND IDRIGA=CC.IDRIGA_DEST AND IDIMPEGNO=CC.IDIMPEGNO_DEST) AS POSIMPEGNO_DEST,
	ORIGINEEVENTO_DEST,
	TIPORECVAL_DEST,
	IDTESTAFATT_DEST,
	IDRIGAFATT_DEST,
	(SELECT POSIZIONE FROM RIGHEDOCUMENTI WHERE IDTESTA=CC.IDTESTAFATT_DEST AND IDRIGA=CC.IDRIGAFATT_DEST) AS POSFATT_DEST,
	TIPODOC,
	NUMERODOC,
	BIS,
	ESERCIZIO,
	CODCLIFOR,
	TIPODOCFATT,
	NUMERODOCFATT,
	BISFATT,
	ESERCIZIOFATT,
	CODCLIFORFATT,
	TIPODOC_DEST,
	NUMERODOC_DEST,
	BIS_DEST,
	ESERCIZIO_DEST,
	CODCLIFOR_DEST,
	TIPODOCFATT_DEST,
	NUMERODOCFATT_DEST,
	BISFATT_DEST,
	ESERCIZIOFATT_DEST,
	CODCLIFORFATT_DEST,
	ESERCIZIOMOV_DEST,
	NUMEROMOV_DEST,
	FLGMOVPROD_DEST
FROM 
    CCBILANCIOCONSCOSTIMATERIALE CC

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTACOSTIMATERIALICC] TO [Metodo98]
    AS [dbo];

