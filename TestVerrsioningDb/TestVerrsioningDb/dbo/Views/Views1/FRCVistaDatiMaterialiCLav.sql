
CREATE VIEW FRCVistaDatiMaterialiCLav AS 
	SELECT ID, AMBIENTE AS Ambiente, ISNULL((SELECT DESCRIZIONE FROM CGesAmbienti WHERE Codice = FRCDatiMaterialiCLav.AMBIENTE), '') AS Descrizione_Ambiente, ANNO AS Anno, 
		   MESEDOC AS Mese, COMPOSTO AS Composto, DSCCOMPOSTO AS Descrizione_Composto, UMGEST AS UM_Gestione, QTAGEST AS [Quantita'_Gestione], 
		   UMPREZZO AS UM_Prezzo, QTAPREZZO AS [Quantita'_Prezzo], FATTORE AS Fattore_Conversione, QUANTITA AS [Quantita'], 
		   CDRMercato AS CDR_Mercato, ISNULL((SELECT DESCRIZIONE FROM TABCENTRICOSTO WHERE CODICE = FRCDatiMaterialiCLav.CDRMercato), '') AS Descrizione_CDR_Mercato, 
		   CDRProdotto AS CDR_Prodotto, ISNULL((SELECT DESCRIZIONE FROM TABCENTRICOSTO WHERE CODICE = FRCDatiMaterialiCLav.CDRProdotto), '') AS Descrizione_CDR_Prodotto, 
		   COMPONENTE AS Componente, DSCCOMPONENTE AS Descrizione_Componente, UMCOMPONENTE AS UM_Componente, QUANTITAUNI AS [Quantita'_Unitaria], COSTOUNIEURO AS Costo_Lavorazione_Esterna_Unitario, 
		   QUANTITATOT AS [Quantita'_Totale], COSTOTOTEURO AS Costo_Lavorazione_Esterna_Totale, 
		   CASE WHEN EXISTS (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDatiMaterialiCLav.COMPONENTE AND ESERCIZIO = FRCDatiMaterialiCLav.ANNO) THEN
		   (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDatiMaterialiCLav.COMPONENTE AND ESERCIZIO = FRCDatiMaterialiCLav.ANNO) ELSE
		   (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDatiMaterialiCLav.COMPONENTE AND ESERCIZIO = (FRCDatiMaterialiCLav.ANNO - 1)) END AS Fornitore, 
		   ISNULL(CASE WHEN EXISTS (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDatiMaterialiCLav.COMPONENTE AND ESERCIZIO = FRCDatiMaterialiCLav.ANNO) THEN
		   (SELECT DSCCONTO1 FROM ANAGRAFICAARTICOLIPROD TT1 INNER JOIN ANAGRAFICACF TT2 ON TT1.FORNPREFLAV = TT2.CODCONTO WHERE TT1.CODICEART = FRCDatiMaterialiCLav.COMPONENTE 
		   AND TT1.ESERCIZIO = FRCDatiMaterialiCLav.ANNO) ELSE
		   (SELECT DSCCONTO1 FROM ANAGRAFICAARTICOLIPROD TT1 INNER JOIN ANAGRAFICACF TT2 ON TT1.FORNPREFLAV = TT2.CODCONTO WHERE TT1.CODICEART = FRCDatiMaterialiCLav.COMPONENTE 
		   AND TT1.ESERCIZIO = (FRCDatiMaterialiCLav.ANNO - 1)) END, '') AS Ragione_Sociale 
	FROM FRCDatiMaterialiCLav

GO
GRANT SELECT
    ON OBJECT::[dbo].[FRCVistaDatiMaterialiCLav] TO [Metodo98]
    AS [dbo];

