create view
  VISTALOTTICOMMESSEPROD
  as select TESTEORDINIPROD.TIPOCOM+'/'+cast(TESTEORDINIPROD.ESERCIZIO as varchar)+'/'+right('0000000000'+cast(TESTEORDINIPROD.NUMEROCOM as varchar),10)+'/'+right('00000'+cast(RIGHEORDPROD.IDRIGA as varchar),5) as RIFORDINE,
    TESTEORDINIPROD.TIPOCOM+'/'+cast(TESTEORDINIPROD.ESERCIZIO as varchar)+'/'+right('0000000000'+cast(TESTEORDINIPROD.NUMEROCOM as varchar),10)+'/'+right('00000'+cast(RIGHEORDPROD.IDRIGA as varchar),5)+'/'+right('00000'+cast(IMPEGNIORDPROD.IDIMPEGNO as varchar),5) as RIFIMPEGNO,
    TESTEORDINIPROD.ESERCIZIO,
    TESTEORDINIPROD.TIPOCOM,
    TESTEORDINIPROD.NUMEROCOM,
    TESTEORDINIPROD.DATAEMISSIONE,
    TESTEORDINIPROD.PIANOPRODRIF,
    TESTEORDINIPROD.CODCLIENTE,
    TESTEORDINIPROD.ANNOTAZIONI,
    TESTEORDINIPROD.STATOCHIUSO,
    TESTEORDINIPROD.STATOBLOCCATO,
    RIGHEORDPROD.IDTESTA,
    RIGHEORDPROD.IDRIGA,
    RIGHEORDPROD.CODICEORD,
    (select TIPOORDINE from PARAMETRIORDPROD where
      PARAMETRIORDPROD.CODICE = RIGHEORDPROD.CODICEORD) as TIPOORD,
    RIGHEORDPROD.CODART as CODARTORD,
    RIGHEORDPROD.DESCRIZIONEART,
    RIGHEORDPROD.VERSIONEDBA,
    RIGHEORDPROD.VERSIONECICLO,
    RIGHEORDPROD.UMGEST,
    RIGHEORDPROD.QTAGESTIONE,
    RIGHEORDPROD.QTAGESTIONEVERS,
    RIGHEORDPROD.QTAGESTIONERES,
    RIGHEORDPROD.QTAPREZZO,
    RIGHEORDPROD.UMPREZZO,
    RIGHEORDPROD.QTA1MAG,
    RIGHEORDPROD.UM1MAG as UM1ORD,
    RIGHEORDPROD.QTA2MAG,
    RIGHEORDPROD.UM2MAG as UM2ORD,
    RIGHEORDPROD.QTA1MAGRES,
    RIGHEORDPROD.QTA2MAGRES,
    RIGHEORDPROD.QTASCARTO,
    RIGHEORDPROD.UMSCARTO,
    RIGHEORDPROD.IDCOSTOSTD,
    RIGHEORDPROD.CODCLIDEST,
    RIGHEORDPROD.PARTITAASSEGNATA,
    RIGHEORDPROD.PARTITAVINCOLATA,
    RIGHEORDPROD.CODFORDEST,
    RIGHEORDPROD.DATAEMISSIONE as DATAEMISSIONEORD,
    RIGHEORDPROD.TIPOSCHEDULAZIONE,
    RIGHEORDPROD.STATOORDINE,
    RIGHEORDPROD.FASERILASCIO,
    RIGHEORDPROD.DATARILASCIO,
    RIGHEORDPROD.DATAINIZIORICH,RIGHEORDPROD.DATAFINERICH,
    RIGHEORDPROD.CAUSALEMAG,RIGHEORDPROD.DEPOSITO,RIGHEORDPROD.UBICAZIONE,
    RIGHEORDPROD.CONTOCDC,RIGHEORDPROD.CAUSALEMAGCOLL,RIGHEORDPROD.DEPOSITOCOLL,
    RIGHEORDPROD.UBICAZIONECOLL,RIGHEORDPROD.CONTOCDCCOLL,
    RIGHEORDPROD.VALOREPRIORITA,
    RIGHEORDPROD.RAPPORTOCRITICO,
    RIGHEORDPROD.SLACKTIME,RIGHEORDPROD.NOTE,
    IMPEGNIORDPROD.IDIMPEGNO,
    IMPEGNIORDPROD.IDRIGA as IDRIGAIMP,
    IMPEGNIORDPROD.CODART as CODARTIMP,
    IMPEGNIORDPROD.DESCRIZIONEART as DESCRIZIONEARTIMP,
    IMPEGNIORDPROD.UMGEST as UMGESTIMP,
    IMPEGNIORDPROD.QTAUNITARIA,   
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTAGESTIONE else PARTITEIMPEGNIORDPROD.QTAGESTIONE end) as QTAGESTIONEIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTAGESTIONEVERS else PARTITEIMPEGNIORDPROD.QTAGESTIONEPREL end) as QTAGESTIONEPRELIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTAGESTIONERES else PARTITEIMPEGNIORDPROD.QTAGESTIONERES end) as QTAGESTIONERESIMP,
    IMPEGNIORDPROD.QTAPREZZO as QTAPREZZOIMP,
    IMPEGNIORDPROD.UMPREZZO as UMPREZZOIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTA1MAG else PARTITEIMPEGNIORDPROD.QTA1MAG end) as QTA1MAGIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTA2MAG else PARTITEIMPEGNIORDPROD.QTA2MAG end) as QTA2MAGIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTA1MAGRES else PARTITEIMPEGNIORDPROD.QTA1MAGRES end) as QTA1MAGRESIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTA2MAGRES else PARTITEIMPEGNIORDPROD.QTA2MAGRES end) as QTA2MAGRESIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.QTAGESTIONETRASF else PARTITEIMPEGNIORDPROD.QTAGESTIONETRASF end) as QTAGESTIONETRASFIMP,
    IMPEGNIORDPROD.UM1MAG as UM1IMP,
    IMPEGNIORDPROD.UM2MAG as UM2IMP,
    IMPEGNIORDPROD.CODFORIMP,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.PARTITAASSEGNATA else PARTITEIMPEGNIORDPROD.PARTITA end) as PARTITAASSEGNATAIMP,
    IMPEGNIORDPROD.PARTITAVINCOLATA as PARTITAVINCOLATAIMP,
    IMPEGNIORDPROD.CAUSALEMAG as CAUSALEMAGIMP,IMPEGNIORDPROD.DEPOSITO as DEPOSITOIMP,
    IMPEGNIORDPROD.UBICAZIONE as UBICAZIONEIMP,IMPEGNIORDPROD.CONTOCDC as CONTOCDCIMP,
    IMPEGNIORDPROD.CAUSALEMAGCOLL as CAUSALEMAGCOLLIMP,IMPEGNIORDPROD.DEPOSITOCOLL as DEPOSITOCOLLIMP,
    IMPEGNIORDPROD.UBICAZIONECOLL as UBICAZIONECOLLIMP,IMPEGNIORDPROD.CONTOCDCCOLL as CONTOCDCCOLLIMP,
    IMPEGNIORDPROD.CODCLIIMP,
    IMPEGNIORDPROD.DATAEMISSIONE as DATAEMISSIONEIMP,
    IMPEGNIORDPROD.DATAIMPEGNORICH,
    IMPEGNIORDPROD.DATAIMPEGNOSCH,
    IMPEGNIORDPROD.STATOIMPEGNO,
    IMPEGNIORDPROD.TIPOIMPEGNO,
    IMPEGNIORDPROD.NOTE as NOTEIMP,
    IMPEGNIORDPROD.DATACALCCSTEFF,
    IMPEGNIORDPROD.DATACALCCSTPREV,
    IMPEGNIORDPROD.COSTOPREV,
    IMPEGNIORDPROD.COSTOUNITIMPPREV,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.COSTOTOTIMPPREV else (IMPEGNIORDPROD.COSTOUNITIMPPREV * PARTITEIMPEGNIORDPROD.QTAGESTIONE) end) as COSTOTOTIMPPREV,
    IMPEGNIORDPROD.COSTOPREVEURO,
    IMPEGNIORDPROD.COSTOUNITIMPPREVEURO,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.COSTOTOTIMPPREVEURO else (IMPEGNIORDPROD.COSTOUNITIMPPREVEURO * PARTITEIMPEGNIORDPROD.QTAGESTIONE) end) as COSTOTOTIMPPREVEURO,
    IMPEGNIORDPROD.COSTOEFF,
    IMPEGNIORDPROD.COSTOUNITIMPEFF,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.COSTOTOTIMPEFF else (IMPEGNIORDPROD.COSTOUNITIMPEFF * PARTITEIMPEGNIORDPROD.QTAGESTIONE) end) as COSTOTOTIMPEFF,
    IMPEGNIORDPROD.COSTOEFFEURO,
    IMPEGNIORDPROD.COSTOUNITIMPEFFEURO,
    (case when PARTITEIMPEGNIORDPROD.PARTITA is null then IMPEGNIORDPROD.COSTOTOTIMPEFFEURO else (IMPEGNIORDPROD.COSTOUNITIMPEFFEURO * PARTITEIMPEGNIORDPROD.QTAGESTIONE) end) as COSTOTOTIMPEFFEURO,
    VISTAANAGRAFICAARTICOLI.GRUPPO,
    VISTAANAGRAFICAARTICOLI.CATEGORIA,
    VISTAANAGRAFICAARTICOLI.VARESPLICITE,
    VISTAANAGRAFICAARTICOLI.TIPOGESTIONE,
    DATEDIFF(DAY,IMPEGNIORDPROD.DATAIMPEGNOSCH,IMPEGNIORDPROD.DATAIMPEGNORICH) as RITARDO,    
    IMPEGNIORDPROD.RIFCOMMCLI,
    (case when IMPEGNIORDPROD.QTAGESTIONE <> 0 then IMPEGNIORDPROD.QTAGESTIONEVERS/IMPEGNIORDPROD.QTAGESTIONE*100 else 0 end) as AVANZQTAIMP,
    (case when IMPEGNIORDPROD.COSTOTOTIMPPREV <> 0 then IMPEGNIORDPROD.COSTOTOTIMPEFF/IMPEGNIORDPROD.COSTOTOTIMPPREV*100 else 0 end) as AVANZCOSTIIMP,
    IMPEGNIORDPROD.DATAMODIFICA as DATAULTIMAATTIMP,
    RIGHEORDPROD.STATOLANCIO,
    RIGHEORDPROD.STATOSTAMPA,
    RIGHEORDPROD.DATALANCIO 
    from
   	(( TESTEORDINIPROD left outer join
   		(RIGHEORDPROD left outer join
   			(IMPEGNIORDPROD left outer join VISTAANAGRAFICAARTICOLI 
    on IMPEGNIORDPROD.CODART = VISTAANAGRAFICAARTICOLI.CODICE) 
    on IMPEGNIORDPROD.IDTESTA = RIGHEORDPROD.IDTESTA and IMPEGNIORDPROD.IDRIGA = RIGHEORDPROD.IDRIGA) 
    on RIGHEORDPROD.IDTESTA = TESTEORDINIPROD.PROGRESSIVO) 
    left outer join PARTITEIMPEGNIORDPROD 
    on IMPEGNIORDPROD.IDTESTA = PARTITEIMPEGNIORDPROD.IDTESTA and IMPEGNIORDPROD.IDRIGA = PARTITEIMPEGNIORDPROD.IDRIGA and IMPEGNIORDPROD.IDIMPEGNO = PARTITEIMPEGNIORDPROD.IDIMPEGNO)

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTALOTTICOMMESSEPROD] TO [Metodo98]
    AS [dbo];

