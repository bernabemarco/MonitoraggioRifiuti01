
CREATE VIEW DIMDOCUMENTI AS
SELECT
	PAR.TIPO 		TIPO_DOCUMENTO,
	TEST.TIPODOC 	CODICE_DOCUMENTO,
	PAR.DESCRIZIONE DESCRIZIONE_DOCUMENTO,
	TEST.DATADOC 	DATA_DOCUMENTO,
	CF.TIPOCONTO 	CLIFOR,
	TEST.CODCLIFOR 	CODICE_CLIFOR,
	CF.DSCCONTO1 	RAGIONE_SOCIALE,
    (CASE WHEN TABNAZIONI.CODICE IS NULL THEN -1 ELSE TABNAZIONI.CODICE END) CODICE_NAZIONE,
    (CASE WHEN TABNAZIONI.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABNAZIONI.DESCRIZIONE END) NAZIONE,
    (CASE WHEN TABZONE.CODICE IS NULL THEN -1 ELSE TABZONE.CODICE END) CODICE_ZONA,
    (CASE WHEN TABZONE.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABZONE.DESCRIZIONE END) ZONA,
	CF.PROVINCIA,
    (CASE WHEN CATEGORIECF.CODCATEGORIA IS NULL THEN -1 ELSE CATEGORIECF.CODCATEGORIA END) CODICE_CATEGORIA_CF,
    (CASE WHEN CATEGORIECF.DSCCATEGORIA IS NULL THEN '- Non Specificato' ELSE CATEGORIECF.DSCCATEGORIA END) CATEGORIA_CF,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE1) IS NULL THEN '-' ELSE TEST.CODAGENTE1 END) CODICE_AGENTE_1,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE1) IS NULL THEN '- Non Specificato' ELSE (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE1) END) AGENTE_1,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE2) IS NULL THEN '-' ELSE TEST.CODAGENTE1 END) CODICE_AGENTE_2,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE2) IS NULL THEN '- Non Specificato' ELSE (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE2) END) AGENTE_2,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE3) IS NULL THEN '-' ELSE TEST.CODAGENTE1 END) CODICE_AGENTE_3,
	(CASE WHEN (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE3) IS NULL THEN '- Non Specificato' ELSE (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=TEST.CODAGENTE3) END) AGENTE_3,
    TEST.NUMDESTDIVERSAMERCI DESTINAZIONE_MERCI,
	RIG.CODART 		CODICE_ARTICOLO,
    (CASE WHEN ANAGRAFICAARTICOLI.DESCRIZIONE IS NULL THEN RIG.DESCRIZIONEART ELSE ANAGRAFICAARTICOLI.DESCRIZIONE END) DESCRIZIONE_ARTICOLO,
    (CASE WHEN TABGRUPPI.CODICE IS NULL THEN -1 ELSE TABGRUPPI.CODICE END) CODICE_GRUPPO_ARTICOLO,
    (CASE WHEN TABGRUPPI.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABGRUPPI.DESCRIZIONE END) GRUPPO_ARTICOLO,
    (CASE WHEN TABCATEGORIE.CODICE IS NULL THEN -1 ELSE TABCATEGORIE.CODICE END)CODICE_CATEGORIA_ARTICOLO,
    (CASE WHEN TABCATEGORIE.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABCATEGORIE.DESCRIZIONE END) CATEGORIA_ARTICOLO,
    (CASE WHEN TABCATEGORIESTAT.CODICE IS NULL THEN -1 ELSE TABCATEGORIESTAT.CODICE END) CODICE_CATEGORIA_STAT_ARTICOLO,
    (CASE WHEN TABCATEGORIESTAT.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABCATEGORIESTAT.DESCRIZIONE END)CATEGORIA_STAT_ARTICOLO,
	(CASE WHEN AFUM.UM2 IS NULL THEN '--' ELSE AFUM.UM2 END) UM_STATISTICA,
    (CASE WHEN AFUM.UM2 IS NULL THEN CAST(RIG.QTAGEST*TEST.SEGNO AS DECIMAL(19,4)) ELSE CAST(RIG.QTAGEST*AFUM.FATTORE*TEST.SEGNO AS DECIMAL(19,4)) END) QUANTITA,
    (CASE WHEN AFUM.UM2 IS NULL THEN CAST(RIG.QTAGESTRES*TEST.SEGNO AS DECIMAL(19,4)) ELSE CAST(RIG.QTAGESTRES*AFUM.FATTORE*TEST.SEGNO AS DECIMAL(19,4)) END) QUANTITA_RESIDUA,
    (CASE WHEN TABCAMBI.CODICE IS NULL THEN '-' ELSE TABCAMBI.DIVISA END) CODICE_DIVISA,
    (CASE WHEN TABCAMBI.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABCAMBI.DESCRIZIONE END) DIVISA,
    CAST(RIG.TOTNETTORIGAEURO*TEST.SEGNO*TABCAMBI.CAMBIOEURO AS DECIMAL(19,4)) IMPORTO,
    CAST(RIG.TOTNETTORIGA*TEST.SEGNO as decimal(19,4)) IMPORTO_VALUTA,
    CAST(RIG.TOTNETTORIGAEURO*TEST.SEGNO as decimal(19,4)) IMPORTO_EURO,
    CAST(RIG.TOTNETTORIGAEURORES*TEST.SEGNO*TABCAMBI.CAMBIOEURO as decimal(19,4)) IMPORTO_RESIDUO,
    CAST(RIG.TOTNETTORIGARES*TEST.SEGNO as decimal(19,4)) IMPORTO_RESIDUO_VALUTA,
    CAST(RIG.TOTNETTORIGAEURORES*TEST.SEGNO as decimal(19,4)) IMPORTO_RESIDUO_EURO,
    RIG.DATACONSEGNA DATA_CONSEGNA,
	(CASE WHEN ANADEP.CODICE IS NULL THEN '-' ELSE ANADEP.CODICE END) CODICE_DEPOSITO,
	(CASE WHEN ANADEP.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE ANADEP.DESCRIZIONE END) DEPOSITO,
	(CASE WHEN TABSETTORI.CODICE IS NULL THEN -1 ELSE TABSETTORI.CODICE END) CODICE_SETTORE_CF,
	(CASE WHEN TABSETTORI.DESCRIZIONE IS NULL THEN '- Non Specificato' ELSE TABSETTORI.DESCRIZIONE END) SETTORE_CF
	FROM
	(((((((TESTEDOCUMENTI TEST INNER JOIN ANAGRAFICACF CF ON  TEST.CODCLIFOR=CF.CODCONTO)
	LEFT OUTER JOIN ANAGRAFICARISERVATICF RCF ON RCF.CODCONTO=TEST.CODCLIFOR AND RCF.ESERCIZIO=TEST.ESERCIZIO)
	INNER JOIN PARAMETRIDOC PAR ON TEST.TIPODOC=PAR.CODICE)
	LEFT OUTER JOIN TABNAZIONI ON CF.CODNAZIONE=TABNAZIONI.CODICE)
	LEFT OUTER JOIN TABSETTORI ON RCF.CODSETTORE=TABSETTORI.CODICE)
	LEFT OUTER JOIN TABZONE ON RCF.CODZONA=TABZONE.CODICE)
	LEFT OUTER JOIN CATEGORIECF ON RCF.CODCATEGORIA=CATEGORIECF.CODCATEGORIA)
    INNER JOIN 
	((((((RIGHEDOCUMENTI RIG INNER JOIN ANAGRAFICAARTICOLI ON RIG.CODART=ANAGRAFICAARTICOLI.CODICE)
    LEFT OUTER JOIN ARTICOLIFATTORICONVERSIONE AFUM ON RIG.CODART = AFUM.CODART AND RIG.UMGEST=AFUM.UM1 AND AFUM.UM2=(SELECT UM FROM ARTICOLIUMPREFERITE WHERE ARTICOLIUMPREFERITE.CODART=RIG.CODART AND ARTICOLIUMPREFERITE.TIPOUM=8))
	LEFT OUTER JOIN ANAGRAFICADEPOSITI ANADEP ON RIG.CODDEPOSITO=ANADEP.CODICE)
	LEFT OUTER JOIN TABGRUPPI ON ANAGRAFICAARTICOLI.GRUPPO=TABGRUPPI.CODICE)
	LEFT OUTER JOIN TABCATEGORIE ON ANAGRAFICAARTICOLI.CATEGORIA=TABCATEGORIE.CODICE)
	LEFT OUTER JOIN TABCATEGORIESTAT ON ANAGRAFICAARTICOLI.CODCATEGORIASTAT=TABCATEGORIESTAT.CODICE) ON TEST.PROGRESSIVO=RIG.IDTESTA,
	TABCAMBI
	WHERE TABCAMBI.CODICE=0	AND RIG.CODART IS NOT NULL

GO
GRANT SELECT
    ON OBJECT::[dbo].[DIMDOCUMENTI] TO [Metodo98]
    AS [dbo];

