
CREATE VIEW FRCVistaDistinteBasiEsploseCLav AS 
	SELECT ID, ANNO AS Anno, RIFDISTINTA AS Riferimento_Distinta, RIFNRRIGA AS Riga_Distinta, COMPOSTO AS Composto, DSCCOMPOSTO AS Descrizione_Composto, 
		   QUANTITACOMPOSTO AS [Quantita'_Composto], DATAVALUTAZIONE AS Data_Valutazione, UMCOMPOSTO AS UM_Composto, LIVPRODUZIONECOMPOSTO AS Liv_Prod_Composto, 
		   COMPONENTE AS Componente, DSCCOMPONENTE AS Descrizione_Componente, TIPO AS Tipo_Componente, LIVELLO AS Livello_Componente, 
		   LIVPRODUZIONE AS Liv_Prod_Componente, UMCOMPONENTE AS UM_Componente, QUANTITA AS [Quantita'_Componente], COSTOTOTEURO AS Costo_Lavorazione_Esterna, 
		   ISNULL((SELECT PESONETTO FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPOSTO), 0) AS Peso_Netto_Composto, 
		   ISNULL((SELECT SUPERFICIE FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPOSTO), 0) AS Superficie_Composto, 
		   ISNULL((SELECT CUBATURA FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPOSTO), 0) AS Cubatura_Composto, 
		   ISNULL((SELECT PESONETTO FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPONENTE), 0) AS Peso_Netto_Componente, 
		   ISNULL((SELECT SUPERFICIE FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPONENTE), 0) AS Superficie_Componente, 
		   ISNULL((SELECT CUBATURA FROM ANAGRAFICAARTICOLI WHERE CODICE = FRCDistinteBasiEsploseCLav.COMPONENTE), 0) AS Cubatura_Componente, 
		   CASE WHEN EXISTS (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE AND ESERCIZIO = FRCDistinteBasiEsploseCLav.ANNO) THEN
		   (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE AND ESERCIZIO = FRCDistinteBasiEsploseCLav.ANNO) ELSE
		   (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE AND ESERCIZIO = (FRCDistinteBasiEsploseCLav.ANNO - 1)) END AS Fornitore, 
		   ISNULL(CASE WHEN EXISTS (SELECT FORNPREFLAV FROM ANAGRAFICAARTICOLIPROD WHERE CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE AND ESERCIZIO = FRCDistinteBasiEsploseCLav.ANNO) THEN
		   (SELECT DSCCONTO1 FROM ANAGRAFICAARTICOLIPROD TT1 INNER JOIN ANAGRAFICACF TT2 ON TT1.FORNPREFLAV = TT2.CODCONTO WHERE TT1.CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE 
		   AND TT1.ESERCIZIO = FRCDistinteBasiEsploseCLav.ANNO) ELSE
		   (SELECT DSCCONTO1 FROM ANAGRAFICAARTICOLIPROD TT1 INNER JOIN ANAGRAFICACF TT2 ON TT1.FORNPREFLAV = TT2.CODCONTO WHERE TT1.CODICEART = FRCDistinteBasiEsploseCLav.COMPONENTE 
		   AND TT1.ESERCIZIO = (FRCDistinteBasiEsploseCLav.ANNO - 1)) END, '') AS Ragione_Sociale 
	FROM FRCDistinteBasiEsploseCLav

GO
GRANT SELECT
    ON OBJECT::[dbo].[FRCVistaDistinteBasiEsploseCLav] TO [Metodo98]
    AS [dbo];

