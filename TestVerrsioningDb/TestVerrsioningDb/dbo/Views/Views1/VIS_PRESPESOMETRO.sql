CREATE VIEW [dbo].[VIS_PRESPESOMETRO]
AS
SELECT     (SELECT     DESBREVE
                       FROM          TABDITTE) AS CodiceAzienda, CF.TIPOCONTO AS TipoCF, CF.CODCONTO AS CodiceCF, CF.PARTITAIVA AS PartitaIVA, 
                      CF.CODFISCALE AS CodiceFiscale, (CASE WHEN CF.FLGPERSFISICA = 0 THEN 'N' ELSE 'S' END) AS PersonaFisica, 
                      CF.COGNOMEPERSFIS AS Cognome, CF.NOMEPERSFIS AS Nome, CF.DATANASCITAPERSFIS AS DataNascita, 
                      CF.COMNASCITAPERSFIS AS ComuneNascita, CF.PROVNASCITAPERSFIS AS ProvinciaNascita, CF.CODSTATOESTERO AS CodStatoEsteroSedeLegale, 
                      CF.CODSTATOESTERO AS CodStatoEsteroResidenza, CF.CODSTATOESTERO AS CodStatoDomicilio, CF.DSCCONTO1 AS RagioneSociale, 
                      CF.STATOPROVCONTEA AS CittaEsteraSedeLegale, CF.INDIRIZZOESTERO AS IndirizzoSedeLegale, CF.CODICEISO AS CodiceISO, 
                      CF.PARTITAIVA AS CodiceIdentificativoIVA, (CASE WHEN CC.NOTAACCRADD = 0 THEN 'N' ELSE 'S' END) AS NotaDiVariazione, 
                      'N' AS DocumentoRiepilogativo, (CASE WHEN CC.NOTAACCRADD = 0 THEN 'F' ELSE 'N' END) AS TipoDocumento, 
                      (CASE WHEN TI.TIPOINTRACEE = 3 THEN 'S' ELSE 'N' END) AS AutoFattura, 'N' AS LeasingNoleggio, '' AS Noleggio, 'N' AS IvaNonEsposta, 
                      (CASE WHEN TI.TIPOINTRACEE = 2 THEN 'S' ELSE 'N' END) AS ReverseCharge, TC.ESERCIZIO, TC.DATAREG AS DataRegistrazione, 
                      RI.DATADOC AS DataDocumento, TC.PROGRESSIVO as NRRIFER, RI.NUMDOC AS NProtocollo, 
                      (CASE WHEN TI.FLGBENISERVIZI = 0 AND (TI.CODICE < 100 OR (TI.CODICE > 399 aND TI.CODICE < 500)) THEN RI.IMPONIBILEEURO ELSE 0 END) AS ImportoBeni, 
                      (CASE WHEN TI.FLGBENISERVIZI = 0 AND (TI.CODICE < 100 OR (TI.CODICE > 399 aND TI.CODICE < 500)) THEN RI.IMPOSTAEURO ELSE 0 END) AS ImpostaBeni, 
                      (CASE WHEN TI.FLGBENISERVIZI = 0 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 0 THEN RI.IMPONIBILEEURO ELSE 0 END) AS NonImponibileBeni, 
                      (CASE WHEN TI.FLGBENISERVIZI = 0 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 1 THEN RI.IMPONIBILEEURO ELSE 0 END) AS EsentiBeni, 
                      (CASE WHEN TI.FLGBENISERVIZI = 0 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 2 THEN RI.IMPONIBILEEURO ELSE 0 END) AS FuoriCampoBeni, 
                      (CASE WHEN TI.FLGBENISERVIZI = 1 AND (TI.CODICE < 100 OR (TI.CODICE > 399 aND TI.CODICE < 500)) THEN RI.IMPONIBILEEURO ELSE 0 END) AS ImportoServizi, 
                      (CASE WHEN TI.FLGBENISERVIZI = 1 AND (TI.CODICE < 100 OR (TI.CODICE > 399 aND TI.CODICE < 500)) THEN RI.IMPOSTAEURO ELSE 0 END) AS ImpostaServizi, 
                      (CASE WHEN TI.FLGBENISERVIZI = 1 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 0 THEN RI.IMPONIBILEEURO ELSE 0 END) AS NonImponibileServizi,
                      (CASE WHEN TI.FLGBENISERVIZI = 1 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 1 THEN RI.IMPONIBILEEURO ELSE 0 END) AS EsentiServizi, 
                      (CASE WHEN TI.FLGBENISERVIZI = 1 AND TI.CODICE > 199 AND TI.CODICE <= 300 AND TI.TIPOESENZ = 2 THEN RI.IMPONIBILEEURO ELSE 0 END) AS FuoriCampoServizi, 
                      RI.NRREG , RI.NRRIGA, RI.POSIZIONE, 
                      TIPOREGISTROIVA.DESCRIZIONE, TIPOREGISTROIVA.CODICE
FROM         RIGHEIVA AS RI INNER JOIN
                      TRATTAMENTOIVA AS TI ON RI.CODIVA = TI.CODICE INNER JOIN
                      TESTECONTABILITA AS TC ON RI.NRREG = TC.PROGRESSIVO INNER JOIN
                      CAUSALICONTABILI AS CC ON TC.CAUSALE = CC.CODICECAUSALE INNER JOIN
                      RIGHECONTABILITA AS RC ON RC.NRREG = TC.PROGRESSIVO AND RC.NRRIGA = 1 INNER JOIN
                      ANAGRAFICACF AS CF ON CF.CODCONTO = RC.CONTO INNER JOIN
                      TIPOREGISTROIVA ON RI.TIPOREGISTRO = TIPOREGISTROIVA.CODICE
WHERE     (TC.MOVIVA > 0) and CF.FLGELENCOCF=1 

GO
GRANT REFERENCES
    ON OBJECT::[dbo].[VIS_PRESPESOMETRO] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[VIS_PRESPESOMETRO] TO [Metodo98]
    AS [dbo];

