CREATE VIEW VISTACAUZIONIPA AS
SELECT 
   MOVIMENTICAUZIONI.*,
   (SELECT DESCRIZIONE FROM ANAGRAFICAARTICOLI WHERE CODICE=CODICEVUOTO) AS DSCART,
   (IMPORTOUNITCONS*QTACONS) AS IMPORTOTOTCONS,
   COALESCE((SELECT ALIQUOTA FROM TRATTAMENTOIVA WHERE CODICE=(SELECT TOP 1 CODIVA FROM PARDOCCC WHERE CODDOC=(SELECT TIPODOC FROM TESTEDOCUMENTI WHERE PROGRESSIVO=IDTESTA) AND CODSPESA=4)),0) AS ALIQIVA,
   (CASE WHEN COALESCE((SELECT TOP 1 CODIVA FROM PARDOCCC WHERE CODDOC=(SELECT TIPODOC FROM TESTEDOCUMENTI WHERE PROGRESSIVO=IDTESTA) AND CODSPESA=4),0)=0 THEN 'N2' ELSE
     COALESCE((SELECT NATURAESENZPA FROM TRATTAMENTOIVA WHERE CODICE=(SELECT TOP 1 CODIVA FROM PARDOCCC WHERE CODDOC=(SELECT TIPODOC FROM TESTEDOCUMENTI WHERE PROGRESSIVO=IDTESTA) AND CODSPESA=4)),'') END) AS NATURAESENZ
    FROM MOVIMENTICAUZIONI
GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTACAUZIONIPA] TO [Metodo98]
    AS [dbo];

