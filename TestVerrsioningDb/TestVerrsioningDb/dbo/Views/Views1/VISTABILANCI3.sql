
CREATE VIEW VISTABILANCI3 AS
SELECT 
    TABCFG.CODCONTO AS CODCONTO,
    TABCFG.TIPOCONTO,
    TCONT.ESERCIZIO,
    TCONT.PROGRESSIVO,
    RCONT.SEGNO,
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTO ELSE 0 END) AS DARE,
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOEURO ELSE 0 END) AS DAREEURO,
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOVALUTA ELSE 0 END) AS DAREVALUTA,
    (CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTO ELSE 0 END) AS AVERE,
    (CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOEURO ELSE 0 END) AS AVEREEURO,
    (CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOVALUTA ELSE 0 END) AS AVEREVALUTA,
    TABCFG.DSCCONTO1,
    TABCFG.CODMASTRO, 
    TABCFG.TIPOMASTRO, 
    TABCFG.DSCMASTRO,
    TCONT.NRGIORNALE, 
    TCONT.CAUSALE,
    TCONT.PROVVISORIO,
    TCONT.DATAREG,
    NULL AS SALDO,
    NULL AS SALDOEURO,
    NULL AS SALDOVALUTA,
    RCONT.ESERCIZIO-1 AS ESERCIZIOSI,
    (CASE WHEN TU.SUPERVISOR=1 THEN 1 ELSE
        (CASE WHEN (SELECT COUNT(NOMEUTENTE) FROM ACCESSICAUSCONT WHERE CODCAUSALE = CAUSALE AND FLAGVISUALIZZA=1 AND NOMEUTENTE=TU.USERID)>0 THEN 1 ELSE 0 END) END) AS ACCESSOUTENTE,
    (SELECT TOP 1 CAUSCONTCH FROM TABVINCOLIGIC WHERE TABVINCOLIGIC.ESERCIZIO=RCONT.ESERCIZIO) AS CAUSCONTCHIUSURA,
    (SELECT TOP 1 CAUSCONTRILUTPERD FROM TABVINCOLIGIC WHERE TABVINCOLIGIC.ESERCIZIO=RCONT.ESERCIZIO) AS CAUSCONTRILUTPERD
  FROM 
    TABCFG LEFT OUTER JOIN (RIGHECONTABILITA RCONT INNER JOIN TESTECONTABILITA TCONT ON TCONT.PROGRESSIVO=RCONT.NRREG)
    ON TABCFG.CODCONTO=RCONT.CONTO,TABUTENTI TU
  WHERE 
        (TU.USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND
        (TCONT.CAUSALE<>(SELECT TOP 1 GIC.CAUSCONTAP FROM TABVINCOLIGIC AS GIC WHERE GIC.ESERCIZIO=RCONT.ESERCIZIO) OR TCONT.CAUSALE IS NULL)
UNION ALL
SELECT 
    TABCFG.CODCONTO AS CODCONTO,
    TABCFG.TIPOCONTO,
    RCONT.ESERCIZIO+1,
    0 AS PROGRESSIVO,
    NULL AS SEGNO,
    NULL AS DARE,
    NULL AS DAREEURO,
    NULL AS DAREVALUTA,
    NULL AS AVERE,
    NULL AS AVEREEURO,
    NULL AS AVEREVALUTA,
    TABCFG.DSCCONTO1, 
    TABCFG.CODMASTRO,
    TABCFG.TIPOMASTRO, 
    TABCFG.DSCMASTRO,
    TCONT.NRGIORNALE,
    NULL AS CAUSALE,
    TCONT.PROVVISORIO AS PROVVISORIO,
    NULL AS DATAREG, 
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTO ELSE 0 END)-(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTO ELSE 0 END) AS SALDO,
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOEURO ELSE 0 END)-(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOEURO ELSE 0 END) AS SALDOEURO,
    (CASE WHEN RCONT.SEGNO=0 THEN RCONT.IMPORTOVALUTA ELSE 0 END)-(CASE WHEN RCONT.SEGNO=1 THEN RCONT.IMPORTOVALUTA ELSE 0 END) AS SALDOVALUTA,
    RCONT.ESERCIZIO ESERCIZIOSI,
    1 AS ACCESSOUTENTE,
    (SELECT TOP 1 CAUSCONTCH FROM TABVINCOLIGIC WHERE TABVINCOLIGIC.ESERCIZIO=RCONT.ESERCIZIO) AS CAUSCONTCHIUSURA,
    (SELECT TOP 1 CAUSCONTRILUTPERD FROM TABVINCOLIGIC WHERE TABVINCOLIGIC.ESERCIZIO=RCONT.ESERCIZIO) AS CAUSCONTRILUTPERD
  FROM 
        TABCFG LEFT OUTER JOIN (RIGHECONTABILITA RCONT INNER JOIN TESTECONTABILITA TCONT ON TCONT.PROGRESSIVO=RCONT.NRREG)
    ON TABCFG.CODCONTO=RCONT.CONTO
  WHERE TABCFG.TIPOMASTRO<>'E'


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTABILANCI3] TO [Metodo98]
    AS [dbo];

