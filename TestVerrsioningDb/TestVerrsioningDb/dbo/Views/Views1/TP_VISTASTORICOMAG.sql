
CREATE VIEW TP_VISTASTORICOMAG
AS
SELECT
	ROW_NUMBER() OVER (ORDER BY CODART ASC) AS PROGRESSIVO,
	CODART,
	QUANTITACARICO,
	VALORECARICO,
	GIACENZA,
	ORDINATO,
	IMPEGNATO,
	QUANTITASCARICO,
	VALORESCARICO,
	GIACENZA2UM,
	ORDINATO2UM,
	IMPEGNATO2UM,
	QTA1UM,
	QTA2UM,
	CAST(CONVERT(VARCHAR(10),GETDATE(),112) AS DATETIME) AS DATAMOV,
	CODDEPOSITO
FROM
(
	SELECT 
		GIACENZA.CODART,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END)) >= 0
			 THEN 1 ELSE 0 END AS QUANTITACARICO,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END)) >= 0
			 THEN 1 ELSE 0 END AS VALORECARICO,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END)) >= 0
			 THEN 1 ELSE -1 END AS GIACENZA,
		0 AS ORDINATO,
		0 AS IMPEGNATO,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END)) >= 0
			 THEN 1 ELSE 0 END AS QUANTITASCARICO,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END)) >= 0
			 THEN 1 ELSE 0 END AS VALORESCARICO,
		CASE WHEN SUM((CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) -
					 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END)) >= 0
			 THEN 1 ELSE -1 END AS GIACENZA2UM,
		0 AS ORDINATO2UM,
		0 AS IMPEGNATO2UM,
		ABS(SUM ((CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END) -
			 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA1UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA1UM ELSE 0 END))) AS QTA1UM,
		ABS(SUM ((CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) +
				 (CASE WHEN GIACENZA.GIACENZA2UM=1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 0 THEN GIACENZA.QTA2UM ELSE 0 END) -
				 (CASE WHEN GIACENZA.GIACENZA2UM=-1 and GIACENZA.RESO = 1 THEN GIACENZA.QTA2UM ELSE 0 END))) AS QTA2UM,
		GIACENZA.CODDEPOSITO
	FROM STORICOMAG AS GIACENZA
	WHERE GIACENZA.GIACENZA <> 0
	GROUP BY 	GIACENZA.CODART,
			GIACENZA.CODDEPOSITO
	UNION
	SELECT 
		CODART,
		QUANTITACARICO,
		VALORECARICO,
		GIACENZA,
		(CASE 
			WHEN QTA1UM > 0 THEN 1 
			WHEN QTA1UM = 0 THEN 0 
			WHEN QTA1UM < 0 THEN -1 
		END) AS ORDINATO,
		IMPEGNATO,
		QUANTITASCARICO,
		VALORESCARICO,
		GIACENZA2UM,
		(CASE 
			WHEN QTA2UM > 0 THEN 1 
			WHEN QTA2UM = 0 THEN 0 
			WHEN QTA2UM < 0 THEN -1 
		END) AS ORDINATO2UM,
		IMPEGNATO2UM,
		ABS(QTA1UM) AS QTA1UM,
		ABS(QTA2UM) AS QTA2UM,
		CODDEPOSITO
	FROM
	(
	SELECT 
		ORDINATO.CODART,
		0 AS QUANTITACARICO,
		0 AS VALORECARICO,
		0 AS GIACENZA,
		0 AS ORDINATO,
		0 AS IMPEGNATO,
		0 AS QUANTITASCARICO,
		0 AS VALORESCARICO,
		0 AS GIACENZA2UM,
		0 AS ORDINATO2UM,
		0 AS IMPEGNATO2UM,
		SUM(ORDINATO.ORDINATO * ORDINATO.QTA1UM) AS QTA1UM,
		SUM(ORDINATO.ORDINATO * ORDINATO.QTA2UM) AS QTA2UM,
		ORDINATO.CODDEPOSITO
	FROM STORICOMAG AS ORDINATO
	WHERE ORDINATO.ORDINATO <> 0
	GROUP BY 	ORDINATO.CODART,
			ORDINATO.CODDEPOSITO
	) AS ORDINATO
	UNION
	SELECT
		CODART,
		QUANTITACARICO,
		VALORECARICO,
		GIACENZA,
		ORDINATO,
		(CASE 
			WHEN QTA1UM > 0 THEN 1 
			WHEN QTA1UM = 0 THEN 0 
			WHEN QTA1UM < 0 THEN -1 
		END) AS IMPEGNATO,
		QUANTITASCARICO,
		VALORESCARICO,
		GIACENZA2UM,
		ORDINATO2UM,
		(CASE 
			WHEN QTA2UM > 0 THEN 1 
			WHEN QTA2UM = 0 THEN 0 
			WHEN QTA2UM < 0 THEN -1 
		END) AS IMPEGNATO2UM,
		ABS(QTA1UM) AS QTA1UM,
		ABS(QTA2UM) AS QTA2UM,
		CODDEPOSITO
	FROM
	(
	SELECT 
		IMPEGNATO.CODART,
		0 AS QUANTITACARICO,
		0 AS VALORECARICO,
		0 AS GIACENZA,
		0 AS ORDINATO,
		0 AS IMPEGNATO,
		0 AS QUANTITASCARICO,
		0 AS VALORESCARICO,
		0 AS GIACENZA2UM,
		0 AS ORDINATO2UM,
		0 AS IMPEGNATO2UM,
		SUM(IMPEGNATO.IMPEGNATO * IMPEGNATO.QTA1UM) AS QTA1UM,
		SUM(IMPEGNATO.IMPEGNATO * IMPEGNATO.QTA2UM) AS QTA2UM,
		IMPEGNATO.CODDEPOSITO
	FROM STORICOMAG AS IMPEGNATO
	WHERE IMPEGNATO.IMPEGNATO <> 0
	GROUP BY 	IMPEGNATO.CODART,
			IMPEGNATO.CODDEPOSITO
	) AS IMPEGNATO
) AS STRMAG


GO
GRANT DELETE
    ON OBJECT::[dbo].[TP_VISTASTORICOMAG] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[TP_VISTASTORICOMAG] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTASTORICOMAG] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[TP_VISTASTORICOMAG] TO [Metodo98]
    AS [dbo];

