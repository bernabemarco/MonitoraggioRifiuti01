

CREATE PROCEDURE [dbo].[CAD_ProcDuplicaTrasporto](@PROGRESSIVO_CFG_CUR DECIMAL(10,0),
                                                   @CODICE VARCHAR(10),
                                                    @DADATA_CFG_NEW DATETIME,
                                                     @ADATA_CFG_NEW DATETIME,
                                                      @TIPO SMALLINT,
                                                       @PROGRESSIVO_CFG_NEW DECIMAL(10,0) OUTPUT)
AS

BEGIN

-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;

DECLARE @PROGRESSIVO_CFG_TMP        DECIMAL(10,0)
    
    BEGIN TRAN
    EXEC NUOVOPROGRESSIVO 'TRASPORTO_CAD',1,@PROGRESSIVO_CFG_TMP OUTPUT
    
    /*TRASPORTO_CAD*/
    IF @TIPO = 0 /*TRASPORTO*/
    INSERT INTO [TRASPORTO_CAD]([PROGRESSIVO],[CODSPEDIZ],[CODCONTO],[DADATA],[ADATA],[TIPO],[UTENTEMODIFICA],[DATAMODIFICA],[CONTRIBGASOLIO],[CODDEPOSITO],[TIPODEPOSITO],[CODTIPOSERVIZIO],[UM],[RAPPORTOPESOVOLUME])
                         SELECT @PROGRESSIVO_CFG_TMP,CAST(@CODICE AS DECIMAL(5,0)),[CODCONTO],@DADATA_CFG_NEW,@ADATA_CFG_NEW,[TIPO],USER_NAME(),GETDATE(),[CONTRIBGASOLIO],[CODDEPOSITO],[TIPODEPOSITO],[CODTIPOSERVIZIO],[UM],[RAPPORTOPESOVOLUME] FROM [TRASPORTO_CAD] WHERE [PROGRESSIVO] = @PROGRESSIVO_CFG_CUR
    
    IF @TIPO = 1 /*LOGISTICA*/
    INSERT INTO [TRASPORTO_CAD]([PROGRESSIVO],[CODSPEDIZ],[CODCONTO],[DADATA],[ADATA],[TIPO],[UTENTEMODIFICA],[DATAMODIFICA],[CONTRIBGASOLIO],[CODDEPOSITO],[TIPODEPOSITO],[CODTIPOSERVIZIO],[UM],[RAPPORTOPESOVOLUME],[VALOREEFFETTIVO],[VALORIANNOPRECEDENTE],[ELABORATO])
                         SELECT @PROGRESSIVO_CFG_TMP,[CODSPEDIZ],[CODCONTO],@DADATA_CFG_NEW,@ADATA_CFG_NEW,[TIPO],USER_NAME(),GETDATE(),[CONTRIBGASOLIO],@CODICE,[TIPODEPOSITO],[CODTIPOSERVIZIO],[UM],[RAPPORTOPESOVOLUME],[VALOREEFFETTIVO],[VALORIANNOPRECEDENTE],[ELABORATO] FROM [TRASPORTO_CAD] WHERE [PROGRESSIVO] = @PROGRESSIVO_CFG_CUR
                         
    /*TRASPORTO_CAD_SMALTIMENTO*/
    /*INSERT INTO [TRASPORTO_CAD_SMALTIMENTO]([RIFPROGRESSIVO],[DADATA],[ADATA],[VALOREBUDGET],[VALOREEFFETTIVO],[UTENTEMODIFICA],[DATAMODIFICA])
                                     SELECT @PROGRESSIVO_CFG_TMP,[DADATA],[ADATA],[VALOREBUDGET],[VALOREEFFETTIVO],USER_NAME(),GETDATE() FROM [TRASPORTO_CAD_SMALTIMENTO] WHERE [RIFPROGRESSIVO] = @PROGRESSIVO_CFG_CUR*/
    
    /*TRASPORTO_CAD_INCASSI*/
    INSERT INTO [TRASPORTO_CAD_INCASSI]([RIFPROGRESSIVO],[CODPAGAMENTO],[VALORE],[CODICE],[CODTIPOCOSTO],[VALOREMINIMO],[UTENTEMODIFICA],[DATAMODIFICA])
                                 SELECT @PROGRESSIVO_CFG_TMP,[CODPAGAMENTO],[VALORE],[CODICE],[CODTIPOCOSTO],[VALOREMINIMO],[UTENTEMODIFICA],[DATAMODIFICA] FROM [TRASPORTO_CAD_INCASSI] WHERE [RIFPROGRESSIVO] = @PROGRESSIVO_CFG_CUR
                             
    /*TRASPORTO_CAD_TREEVIEW*/
    EXEC CAD_ProcDuplicaTrasportoTreeview_NodoPadre @PROGRESSIVO_CFG_CUR, @PROGRESSIVO_CFG_TMP
    
    

    IF @@ERROR <> 0 GOTO ErrorHandler
    COMMIT TRAN
    SET @PROGRESSIVO_CFG_NEW = @PROGRESSIVO_CFG_TMP
    RETURN(0)
  
ErrorHandler:
    ROLLBACK TRAN
    SET @PROGRESSIVO_CFG_NEW = 0
    RETURN(@@ERROR)
END




GO
GRANT EXECUTE
    ON OBJECT::[dbo].[CAD_ProcDuplicaTrasporto] TO [Metodo98]
    AS [dbo];

