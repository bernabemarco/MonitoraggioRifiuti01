
CREATE PROCEDURE [dbo].[GEM_METSIC_TO_INT_SEZIONECONTRATTORAPPORTIMEZZI] (@IDRAPPORTO as varchar(14),@TIPOOPERAZIONE as char(1),@Progressivo as decimal(10,0),@Stato as varchar(1)) 
AS
BEGIN
	declare @IdAzienda varchar(3)

	select @IdAzienda = IdSocieta
	from GEM_TabParametriAziendaGemma
	
	-- UPDATE PER AZIENDA METODO SICURA
	IF @Stato = 'T'
	BEGIN
		
		-- aggiorno i dati con i dati provenienti da interscambio
		UPDATE INS 
			SET INS.[IDRAPPORTOAGGREGATO] = MET.[IDRAPPORTOAGGREGATO]
			  ,INS.[CodMezzo] = MET.[CodMezzo]
			  ,INS.[DataInserimento] = MET.[DataInserimento]
			  ,INS.[DataEliminazione] = MET.[DataEliminazione]
			  ,INS.[ELIMINATO] = CASE WHEN isnull(MET.[ELIMINATO], '0') <> '' THEN isnull(MET.[ELIMINATO], '0') ELSE '0' END
			  ,INS.[POSIZIONE] = MET.[POSIZIONE]
			  ,INS.[SUBPOSIZIONE] = MET.[SUBPOSIZIONE]
			  ,INS.[UBICAZIONE] = MET.[UBICAZIONE]
			  ,INS.[POSCLIENTE] = MET.[POSCLIENTE]
			  ,INS.[NOTE] = MET.[NOTE] 
			  ,INS.[ORDINE] = MET.[ORDINE] 
			  ,INS.[CarTesto1] = MET.[CarTesto1] 
			  ,INS.[CarTesto2] = MET.[CarTesto2] 
			  ,INS.[CarTesto3] = MET.[CarTesto3] 
			  ,INS.[CarTesto4] = MET.[CarTesto4] 
			  ,INS.[CarTesto5] = MET.[CarTesto5]
			  ,INS.[CarTesto6] = MET.[CarTesto6] 
			  ,INS.[CarTesto7] = MET.[CarTesto7] 
			  ,INS.[CarTesto8] = MET.[CarTesto8] 
			  ,INS.[CarTesto9] = MET.[CarTesto9] 
			  ,INS.[CodiceBarre] = MET.[CodiceBarre] 
			  ,INS.[OMOLOGATO] = MET.[OMOLOGATO] 
			  ,INS.[ANNO] = MET.[ANNO] 
			  ,INS.[FLAG_INST] = MET.[FLAG_INST] 
			  ,INS.[STATO] = MET.[STATO] 
			  ,INS.[POSQLIK] = MET.[POSQLIK] 
			  ,INS.[QUANTITA] = MET.[QUANTITA] 
			  ,INS.[TEMPO_MAN] = MET.[TEMPO_MAN] 
			  ,INS.[IMPORTOAT1] = MET.[IMPORTOAT1] 
			  ,INS.[IMPORTOAT2] = MET.[IMPORTOAT2] 
			  ,INS.[IMPORTOAT3] = MET.[IMPORTOAT3] 
			  ,INS.[IMPORTOAT4] = MET.[IMPORTOAT4] 
			  ,INS.[IMPORTOAT5] = MET.[IMPORTOAT5] 
			  ,INS.[SCONTOAT1] = MET.[SCONTOAT1] 
			  ,INS.[SCONTOAT2] = MET.[SCONTOAT2] 
			  ,INS.[SCONTOAT3] = MET.[SCONTOAT3] 
			  ,INS.[SCONTOAT4] = MET.[SCONTOAT4] 
			  ,INS.[SCONTOAT5] = MET.[SCONTOAT5] 
			  ,INS.[PROV1AT1] = MET.[PROV1AT1] 
			  ,INS.[PROV1AT2] = MET.[PROV1AT2]
			  ,INS.[PROV1AT3] = MET.[PROV1AT3] 
			  ,INS.[PROV1AT4] = MET.[PROV1AT4] 
			  ,INS.[PROV1AT5] = MET.[PROV1AT5] 
			  ,INS.[PROV2AT1] = MET.[PROV2AT1]
			  ,INS.[PROV2AT2] = MET.[PROV2AT2] 
			  ,INS.[PROV2AT3] = MET.[PROV2AT3] 
			  ,INS.[PROV2AT4] = MET.[PROV2AT4] 
			  ,INS.[PROV2AT5] = MET.[PROV2AT5] 
			  ,INS.[PROV3AT1] = MET.[PROV3AT1] 
			  ,INS.[PROV3AT2] = MET.[PROV3AT2] 
			  ,INS.[PROV3AT3] = MET.[PROV3AT3] 
			  ,INS.[PROV3AT4] = MET.[PROV3AT4] 
			  ,INS.[PROV3AT5] = MET.[PROV3AT5] 
			  ,INS.[StatoFuoriSede] = MET.[StatoFuoriSede] 
			  ,INS.[StatoAttivita] = MET.[StatoAttivita] 
			  ,INS.[FLAGAT1] = isnull(MET.[FLAGAT1], '0')
			  ,INS.[FLAGAT2] = isnull(MET.[FLAGAT2], '0')
			  ,INS.[FLAGAT3] = isnull(MET.[FLAGAT3], '0')
			  ,INS.[FLAGAT4] = isnull(MET.[FLAGAT4], '0')
			  ,INS.[FLAGAT5] = isnull(MET.[FLAGAT5], '0')
			  ,INS.[FLAGRICARICA] = isnull(MET.[FLAGRICARICA], '0')
			  ,INS.[DATA_REV] = MET.[DATA_REV] 
			  ,INS.[DATA_PREV] = MET.[DATA_PREV] 
			  ,INS.[DATA_COLL] = MET.[DATA_COLL] 
			  ,INS.[DATA_PCOLL] = MET.[DATA_PCOLL] 
			  ,INS.[PRESSIONE_DIN] = MET.[PRESSIONE_DIN] 
			  ,INS.[PRESSIONE_STA] = MET.[PRESSIONE_STA] 
			  ,INS.[CAMPO01] = MET.[CAMPO01] 
			  ,INS.[CAMPO02] = MET.[CAMPO02] 
			  ,INS.[CAMPO03] = MET.[CAMPO03] 
			  ,INS.[CAMPO04] = MET.[CAMPO04] 
			  ,INS.[CAMPO05] = MET.[CAMPO05] 
			  ,INS.[CAMPO06] = MET.[CAMPO06] 
			  ,INS.[CAMPO07] = MET.[CAMPO07] 
			  ,INS.[CAMPO08] = MET.[CAMPO08] 
			  ,INS.[CAMPO09] = MET.[CAMPO09] 
			  ,INS.[CAMPO10] = MET.[CAMPO10] 
			  ,INS.[CAMPO11] = MET.[CAMPO11] 
			  ,INS.[CAMPO12] = MET.[CAMPO12] 
			  ,INS.[CAMPO13] = MET.[CAMPO13] 
			  ,INS.[CAMPO14] = MET.[CAMPO14] 
			  ,INS.[CAMPO15] = MET.[CAMPO15] 
			  ,INS.[CAMPO16] = MET.[CAMPO16] 
			  ,INS.[CAMPO17] = MET.[CAMPO17] 
			  ,INS.[CAMPO18] = MET.[CAMPO18] 
			  ,INS.[CAMPO19] = MET.[CAMPO19] 
			  ,INS.[CAMPO20] = MET.[CAMPO20] 
			  ,INS.[CAMPO21] = MET.[CAMPO21] 
			  ,INS.[CAMPO22] = MET.[CAMPO22] 
			  ,INS.[CAMPO23] = MET.[CAMPO23] 
			  ,INS.[CAMPO24] = MET.[CAMPO24] 
			  ,INS.[CAMPO25] = MET.[CAMPO25] 
			  ,INS.[CAMPO26] = MET.[CAMPO26] 
			  ,INS.[CAMPO27] = MET.[CAMPO27] 
			  ,INS.[CAMPO28] = MET.[CAMPO28] 
			  ,INS.[CAMPO29] = MET.[CAMPO29] 
			  ,INS.[CAMPO30] = MET.[CAMPO30] 
			  ,INS.[CAMPO31] = MET.[CAMPO31] 
			  ,INS.[CAMPO32] = MET.[CAMPO32] 
			  ,INS.[CAMPO33] = MET.[CAMPO33] 
			  ,INS.[CAMPO34] = MET.[CAMPO34] 
			  ,INS.[CAMPO35] = MET.[CAMPO35] 
			  ,INS.[CAMPO36] = MET.[CAMPO36] 
			  ,INS.[CAMPO37] = MET.[CAMPO37] 
			  ,INS.[CAMPO38] = MET.[CAMPO38] 
			  ,INS.[CAMPO39] = MET.[CAMPO39] 
			  ,INS.[CAMPO40] = MET.[CAMPO40] 
			  ,INS.[CAMPO41] = MET.[CAMPO41] 
			  ,INS.[CAMPO42] = MET.[CAMPO42] 
			  ,INS.[CAMPO43] = MET.[CAMPO43] 
			  ,INS.[CAMPO44] = MET.[CAMPO44] 
			  ,INS.[CAMPO45] = MET.[CAMPO45] 
			  ,INS.[CAMPO46] = MET.[CAMPO46] 
			  ,INS.[CAMPO47] = MET.[CAMPO47] 
			  ,INS.[CAMPO48] = MET.[CAMPO48] 
			  ,INS.[CAMPO49] = MET.[CAMPO49] 
			  ,INS.[CAMPO50] = MET.[CAMPO50] 
			  ,INS.[SEGNALATO] = MET.[SEGNALATO] 
			  ,INS.[NUOVARIGA] = MET.[NUOVARIGA] 
			  ,INS.[UTENTEMODIFICA] = MET.[UTENTEMODIFICA] 
			  ,INS.[DATAMODIFICA] = MET.[DATAMODIFICA] 
			  ,INS.[AZRIF] = @IdAzienda
			  ,INS.UltimaAttivitaEseg = MET.UltimaAttivitaEseg
			  -- Rif. Ns. SF TV1272869 del 01.01.2013 - Revisione Impianti e CheckList			  
			  ,INS.[CodiceMezzoChekList] = MET.[CodiceMezzoChekList]
			  ,INS.[VersioneChekList] = MET.[VersioneChekList]
			  ,INS.[TitoloChekList] = MET.[TitoloChekList]
			  ,INS.[AnnotazioniTecnica] = MET.[AnnotazioniTecnica]
              ,INS.[RifLinkImmagine] = MET.[RifLinkImmagine]
			  ,INS.[CodiceEdificio] = MET.[CodiceEdificio]
			  ,INS.[CodiceLivello] = MET.[CodiceLivello]
			  ,INS.[CodiceVano] = MET.[CodiceVano]
			  ,INS.[PosizioneMappa] = MET.[PosizioneMappa]
              ,INS.[CodBarCoord] = MET.[CodBarCoord]
			  ,INS.[TipologiaBarre] = MET.[TipologiaBarre]
			FROM GemmaSync.dbo.GEM_SEZIONECONTRATTORAPPORTIMEZZI INS
			INNER JOIN GEM_SEZIONECONTRATTORAPPORTIMEZZI MET ON
			INS.IDRAPPORTO = MET.IDRAPPORTO COLLATE Latin1_General_CI_AS 
			AND INS.SEZIONECONTRATTO = MET.SEZIONECONTRATTO  
			AND INS.IDCONTRATTO = MET.IDCONTRATTO COLLATE Latin1_General_CI_AS 
			AND INS.IDRAPPORTO = MET.IDRAPPORTO  COLLATE Latin1_General_CI_AS 
			AND INS.IDRIGAMEZZO = MET.IDRIGAMEZZO  
			AND INS.AZRIF = @IdAzienda COLLATE Latin1_General_CI_AS 
			WHERE INS.IDRAPPORTO = @IDRAPPORTO 
              AND INS.Progressivo = @Progressivo
	END
	ELSE
	BEGIN
		INSERT INTO GemmaSync.dbo.GEM_SEZIONECONTRATTORAPPORTIMEZZI
		(
		[PROGRESSIVO]
		,[IdRigaMezzo]
		,[IDCONTRATTO]
		,[SEZIONECONTRATTO]
		,[IDRAPPORTO]
		,[IDRAPPORTOAGGREGATO]
		,[CodMezzo]
		,[DataInserimento]
		,[DataEliminazione]
		,[ELIMINATO]
		,[POSIZIONE]
		,[SUBPOSIZIONE]
		,[UBICAZIONE]
		,[POSCLIENTE]
		,[NOTE]
		,[ORDINE]
		,[CarTesto1]
		,[CarTesto2]
		,[CarTesto3]
		,[CarTesto4]
		,[CarTesto5]
		,[CarTesto6]
		,[CarTesto7]
		,[CarTesto8]
		,[CarTesto9]
		,[CodiceBarre]
		,[OMOLOGATO]
		,[ANNO]
		,[FLAG_INST]
		,[STATO]
		,[POSQLIK]
		,[QUANTITA]
		,[TEMPO_MAN]
		,[IMPORTOAT1]
		,[IMPORTOAT2]
		,[IMPORTOAT3]
		,[IMPORTOAT4]
		,[IMPORTOAT5]
		,[SCONTOAT1]
		,[SCONTOAT2]
		,[SCONTOAT3]
		,[SCONTOAT4]
		,[SCONTOAT5]
		,[PROV1AT1]
		,[PROV1AT2]
		,[PROV1AT3]
		,[PROV1AT4]
		,[PROV1AT5]
		,[PROV2AT1]
		,[PROV2AT2]
		,[PROV2AT3]
		,[PROV2AT4]
		,[PROV2AT5] 
		,[PROV3AT1]
		,[PROV3AT2] 
		,[PROV3AT3]
		,[PROV3AT4]
		,[PROV3AT5]
		,[StatoFuoriSede] 
		,[StatoAttivita]
		,[FLAGAT1]
		,[FLAGAT2]
		,[FLAGAT3]
		,[FLAGAT4]
		,[FLAGAT5]
		,[FLAGRICARICA]
		,[DATA_REV]
		,[DATA_PREV]
		,[DATA_COLL]
		,[DATA_PCOLL]
		,[PRESSIONE_DIN]
		,[PRESSIONE_STA]
		,[CAMPO01]
		,[CAMPO02]
		,[CAMPO03]
		,[CAMPO04]
		,[CAMPO05]
		,[CAMPO06]
		,[CAMPO07]
		,[CAMPO08]
		,[CAMPO09]
		,[CAMPO10]
		,[CAMPO11]
		,[CAMPO12]
		,[CAMPO13]
		,[CAMPO14]
		,[CAMPO15]
		,[CAMPO16]
		,[CAMPO17]
		,[CAMPO18]
		,[CAMPO19] 
		,[CAMPO20]
		,[CAMPO21]
		,[CAMPO22]
		,[CAMPO23] 
		,[CAMPO24]
		,[CAMPO25]
		,[CAMPO26] 
		,[CAMPO27] 
		,[CAMPO28] 
		,[CAMPO29] 
		,[CAMPO30] 
		,[CAMPO31]
		,[CAMPO32] 
		,[CAMPO33] 
		,[CAMPO34] 
		,[CAMPO35] 
		,[CAMPO36] 
		,[CAMPO37] 
		,[CAMPO38] 
		,[CAMPO39] 
		,[CAMPO40] 
		,[CAMPO41]
		,[CAMPO42] 
		,[CAMPO43] 
		,[CAMPO44] 
		,[CAMPO45] 
		,[CAMPO46] 
		,[CAMPO47] 
		,[CAMPO48] 
		,[CAMPO49] 
		,[CAMPO50]
		,[SEGNALATO] 
		,[NUOVARIGA] 
		,[UTENTEMODIFICA]
		,[DATAMODIFICA] 
		,[AZRIF]
		,UltimaAttivitaEseg
		-- Rif. Ns. SF TV1272869 del 01.01.2013 - Revisione Impianti e CheckList
		,[CodiceMezzoChekList]
		,[VersioneChekList]
		,[TitoloChekList]
		,[AnnotazioniTecnica]	
        ,[RifLinkImmagine]
		,[CodiceEdificio]
		,[CodiceLivello]
		,[CodiceVano]
		,[PosizioneMappa] 
        ,[CodBarCoord]
		,[TipologiaBarre]
		)
		SELECT
		@Progressivo
		,MET.[IdRigaMezzo]
		,MET.[IDCONTRATTO]
		,MET.[SEZIONECONTRATTO]
		,MET.[IDRAPPORTO]
		,MET.[IDRAPPORTOAGGREGATO]
		,MET.[CodMezzo]
		,MET.[DataInserimento]
		,MET.[DataEliminazione]
		,CASE WHEN isnull(MET.[ELIMINATO], '0') <> '' THEN isnull(MET.[ELIMINATO], '0') ELSE '0' END
		,MET.[POSIZIONE]
		,MET.[SUBPOSIZIONE]
		,MET.[UBICAZIONE]
		,MET.[POSCLIENTE]
		,MET.[NOTE]
		,MET.[ORDINE]
		,MET.[CarTesto1]
		,MET.[CarTesto2]
		,MET.[CarTesto3]
		,MET.[CarTesto4]
		,MET.[CarTesto5]
		,MET.[CarTesto6]
		,MET.[CarTesto7]
		,MET.[CarTesto8]
		,MET.[CarTesto9]
		,MET.[CodiceBarre]
		,MET.[OMOLOGATO]
		,MET.[ANNO]
		,MET.[FLAG_INST]
		,MET.[STATO]
		,MET.[POSQLIK]
		,MET.[QUANTITA]
		,MET.[TEMPO_MAN]
		,MET.[IMPORTOAT1]
		,MET.[IMPORTOAT2]
		,MET.[IMPORTOAT3]
		,MET.[IMPORTOAT4]
		,MET.[IMPORTOAT5]
		,MET.[SCONTOAT1]
		,MET.[SCONTOAT2]
		,MET.[SCONTOAT3]
		,MET.[SCONTOAT4]
		,MET.[SCONTOAT5]
		,MET.[PROV1AT1]
		,MET.[PROV1AT2]
		,MET.[PROV1AT3]
		,MET.[PROV1AT4]
		,MET.[PROV1AT5]
		,MET.[PROV2AT1]
		,MET.[PROV2AT2]
		,MET.[PROV2AT3]
		,MET.[PROV2AT4]
		,MET.[PROV2AT5] 
		,MET.[PROV3AT1]
		,MET.[PROV3AT2] 
		,MET.[PROV3AT3]
		,MET.[PROV3AT4]
		,MET.[PROV3AT5]
		,MET.[StatoFuoriSede] 
		,MET.[StatoAttivita]
		,isnull(MET.[FLAGAT1], '0')
		,isnull(MET.[FLAGAT2], '0')
		,isnull(MET.[FLAGAT3], '0')
		,isnull(MET.[FLAGAT4], '0')
		,isnull(MET.[FLAGAT5], '0')
		,isnull(MET.[FLAGRICARICA], '0')
		,MET.[DATA_REV]
		,MET.[DATA_PREV]
		,MET.[DATA_COLL]
		,MET.[DATA_PCOLL]
		,MET.[PRESSIONE_DIN]
		,MET.[PRESSIONE_STA]
		,MET.[CAMPO01]
		,MET.[CAMPO02]
		,MET.[CAMPO03]
		,MET.[CAMPO04]
		,MET.[CAMPO05]
		,MET.[CAMPO06]
		,MET.[CAMPO07]
		,MET.[CAMPO08]
		,MET.[CAMPO09]
		,MET.[CAMPO10]
		,MET.[CAMPO11]
		,MET.[CAMPO12]
		,MET.[CAMPO13]
		,MET.[CAMPO14]
		,MET.[CAMPO15]
		,MET.[CAMPO16]
		,MET.[CAMPO17]
		,MET.[CAMPO18]
		,MET.[CAMPO19] 
		,MET.[CAMPO20]
		,MET.[CAMPO21]
		,MET.[CAMPO22]
		,MET.[CAMPO23] 
		,MET.[CAMPO24]
		,MET.[CAMPO25]
		,MET.[CAMPO26] 
		,MET.[CAMPO27] 
		,MET.[CAMPO28] 
		,MET.[CAMPO29] 
		,MET.[CAMPO30] 
		,MET.[CAMPO31]
		,MET.[CAMPO32] 
		,MET.[CAMPO33] 
		,MET.[CAMPO34] 
		,MET.[CAMPO35] 
		,MET.[CAMPO36] 
		,MET.[CAMPO37] 
		,MET.[CAMPO38] 
		,MET.[CAMPO39] 
		,MET.[CAMPO40] 
		,MET.[CAMPO41]
		,MET.[CAMPO42] 
		,MET.[CAMPO43] 
		,MET.[CAMPO44] 
		,MET.[CAMPO45] 
		,MET.[CAMPO46] 
		,MET.[CAMPO47] 
		,MET.[CAMPO48] 
		,MET.[CAMPO49] 
		,MET.[CAMPO50]
		,MET.[SEGNALATO] 
		,MET.[NUOVARIGA] 
		,MET.[UTENTEMODIFICA]
		,MET.[DATAMODIFICA] 
		,@IdAzienda
		,MET.UltimaAttivitaEseg
		-- Rif. Ns. SF TV1272869 del 01.01.2013 - Revisione Impianti e CheckList
		,MET.[CodiceMezzoChekList]
		,MET.[VersioneChekList]
		,MET.[TitoloChekList]
		,MET.[AnnotazioniTecnica]	
        ,MET.[RifLinkImmagine]
		,MET.[CodiceEdificio]
		,MET.[CodiceLivello]
		,MET.[CodiceVano]
		,MET.[PosizioneMappa]
        ,MET.[CodBarCoord]
		,MET.[TipologiaBarre]
		FROM GEM_SEZIONECONTRATTORAPPORTIMEZZI MET 
		WHERE MET.IDRAPPORTO = @IDRAPPORTO
	END	
END


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[GEM_METSIC_TO_INT_SEZIONECONTRATTORAPPORTIMEZZI] TO [Metodo98]
    AS [dbo];

