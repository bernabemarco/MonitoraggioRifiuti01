
CREATE PROCEDURE GEM_GET_CODART ( @CODICEMEZZO VARCHAR(50), @CODICEARTICOLO VARCHAR(50), @IDMODFATT DECIMAL(5,0), @IDATTIVITA DECIMAL(5,0) ,  @OUT_CODART VARCHAR(50) OUTPUT )
AS

DECLARE @SERVZIOPUNTUALE	AS VARCHAR(50) 
DECLARE @TMP_CODART			AS VARCHAR(50) 

DECLARE @RADICESERVIZIO		AS VARCHAR(50)
DECLARE @TIPOLOGIA			AS VARCHAR(50)
DECLARE @VARIANTE			AS VARCHAR(50)

	--AZZERO VARIABILE OUTPUT
	SET @OUT_CODART = ''
	SET @TMP_CODART = ''

	--LEGGO VISTA GENEARALE CON IL CODICE MEZZO PASSATO IN INPUT
	SELECT @TMP_CODART = ISNULL(MAX(SERVIZIOPUNTUALE),'')  
	FROM dbo.GEM_Vista_T_DeterminaAttivita
	WHERE CODICEMEZZO = @CODICEMEZZO
		AND IDMODFATT = @IDMODFATT
		AND IDATTIVITA = @IDATTIVITA


	-- SE NON TROVATO RECORD 'PUNTUALE' ALLORA CERCO SERVIZIO CON CODICE ARTICOLO DA COMPORRE
	IF @TMP_CODART = '' BEGIN
		DECLARE CURR_MEZZI CURSOR  LOCAL  FAST_FORWARD FOR
		SELECT RADICESERVIZIO, TIPOLOGIA 
		FROM dbo.GEM_Vista_T_DeterminaAttivita
		WHERE CODICEMEZZO = @CODICEMEZZO 
			AND IDMODFATT = @IDMODFATT
			AND IDATTIVITA = @IDATTIVITA
		order by idRigaDetAttivita, idriga

		OPEN CURR_MEZZI
		FETCH NEXT FROM CURR_MEZZI INTO @RADICESERVIZIO, @TIPOLOGIA
		WHILE @@FETCH_STATUS = 0
		BEGIN

			IF @TMP_CODART = '' BEGIN
				SET @TMP_CODART = @RADICESERVIZIO + '#'
			END

			EXECUTE [dbo].[GEM_GET_CODVARIANTE] 
			   @CODICEARTICOLO 
			  ,@TIPOLOGIA
			  ,@VARIANTE OUTPUT

			SET @TMP_CODART = @TMP_CODART + @VARIANTE
			FETCH NEXT FROM CURR_MEZZI INTO @RADICESERVIZIO, @TIPOLOGIA
		END

		CLOSE CURR_MEZZI
		DEALLOCATE CURR_MEZZI
	END 

	
	SET @OUT_CODART = @TMP_CODART


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[GEM_GET_CODART] TO [Metodo98]
    AS [dbo];

