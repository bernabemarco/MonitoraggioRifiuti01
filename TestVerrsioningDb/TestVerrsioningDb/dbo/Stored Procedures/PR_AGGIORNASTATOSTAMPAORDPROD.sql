
-- FINE A#9885



-- INIZIO A#9936
CREATE PROCEDURE [dbo].[PR_AGGIORNASTATOSTAMPAORDPROD](@strW NVARCHAR(4000)) AS
BEGIN
    DECLARE @SQL NVARCHAR(4000)
    DECLARE @SQLUPD NVARCHAR(4000)
    DECLARE @STRWHERE NVARCHAR(4000)
    DECLARE @IDTESTA DECIMAL(10,0)
    DECLARE @IDRIGA DECIMAL(10,0)

    -- creo la tabella temporanea
    CREATE TABLE #TEMPAGGIORNAORDPROD
    (
        IDTESTA DECIMAL(10,0) NOT NULL,
        IDRIGA DECIMAL(10,0) NOT NULL,
        CONSTRAINT PK_AGGIORNAORDPROD PRIMARY KEY (IDTESTA,IDRIGA)
    )

    --Nel caso di campi data rimetto un apice singolo, altrimenti v� in errore la query
    SET @STRWHERE = Replace(@strW, '{d '+char(39)+char(39), '{d '+char(39))
    SET @STRWHERE = Replace(@STRWHERE, char(39)+char(39)+'}', char(39)+'}')

    SET @SQL = 'insert into #TEMPAGGIORNAORDPROD (IDTESTA,IDRIGA) (select IDTESTA,IDRIGA from TESTEORDINIPROD inner join RIGHEORDPROD on TESTEORDINIPROD.PROGRESSIVO=RIGHEORDPROD.IDTESTA inner join PARAMETRIORDPROD on PARAMETRIORDPROD.CODICE=RIGHEORDPROD.CODICEORD inner join ANAGRAFICAARTICOLI on RIGHEORDPROD.CODART=ANAGRAFICAARTICOLI.CODICE'
    IF (@STRWHERE<>'')
        SET @SQL = @SQL + ' where ' + @STRWHERE 
    SET @SQL = @SQL + ')'
    EXEC (@SQL)

    DECLARE CURAGG CURSOR FOR select IDTESTA,IDRIGA from #TEMPAGGIORNAORDPROD
    OPEN CURAGG
    FETCH NEXT FROM CURAGG INTO @IDTESTA,@IDRIGA
    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQLUPD='update RIGHEORDPROD set STATOSTAMPA=1 where IDTESTA=' + cast(@IDTESTA as VARCHAR(10)) + ' and IDRIGA=' + cast(@IDRIGA as VARCHAR(10))
        EXEC (@SQLUPD)
            
        FETCH NEXT FROM CURAGG INTO @IDTESTA,@IDRIGA
    END
        
    CLOSE CURAGG
    DEALLOCATE CURAGG
END


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[PR_AGGIORNASTATOSTAMPAORDPROD] TO [Metodo98]
    AS [dbo];

