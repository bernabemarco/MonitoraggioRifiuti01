


CREATE PROCEDURE [dbo].[NUOVORAPPORTO] @PESERCIZIO DECIMAL(5), @PUTENTE VARCHAR(25), @PAGGIORNA SMALLINT, @PTIPORAPPORTO AS VARCHAR(1), @PPROGRESSIVO VARCHAR(20) OUTPUT AS
BEGIN
      DECLARE @PP       DECIMAL(10);
      DECLARE @SIGLARAPPORTI  VARCHAR(2);
      DECLARE @SIGLASOCIETA   VARCHAR(2)

      SET @PP=-1
      SET @PPROGRESSIVO = ''
      SET @SIGLARAPPORTI = ''
      SET @SIGLASOCIETA = ''

      IF @PAGGIORNA=0
      BEGIN
            DECLARE CUR_ICONT CURSOR FOR  
            SELECT      PROGR,SIGLARAPPORTI,SIGLASOCIETA
            FROM  (TABCONTATORI t1 JOIN GEM_TabParametriAziendaGemmaContatori t2 ON (t1.CODICE=t2.CONTATORERAPPORTI and t1.ESERCIZIO=@PESERCIZIO and t2.TIPORAPPORTO=@PTIPORAPPORTO))
                  JOIN GEM_TabParametriAziendaGemma t3 ON (t3.IDSOCIETA=t2.IDSOCIETA)

            OPEN CUR_ICONT FETCH NEXT FROM CUR_ICONT INTO @PP,@SIGLARAPPORTI,@SIGLASOCIETA

                  IF @@FETCH_STATUS<>0   SET  @PP = 0

                  SET @PP=@PP + 1
                  SET @PPROGRESSIVO = cast(@PESERCIZIO AS VARCHAR(4))+@SIGLARAPPORTI+right('000000'+cast(@PP as varchar(6)),6)+@SIGLASOCIETA

            CLOSE CUR_ICONT
            DEALLOCATE CUR_ICONT
      END
      ELSE
      BEGIN
            DECLARE CUR_ICONT CURSOR SCROLL SCROLL_LOCKS FOR
            SELECT      PROGR,SIGLARAPPORTI,SIGLASOCIETA
            FROM  (TABCONTATORI t1 JOIN GEM_TabParametriAziendaGemmaContatori t2 ON (t1.CODICE=t2.CONTATORERAPPORTI and t1.ESERCIZIO=@PESERCIZIO and t2.TIPORAPPORTO=@PTIPORAPPORTO))
                  JOIN GEM_TabParametriAziendaGemma t3 ON (t3.IDSOCIETA=t2.IDSOCIETA)
            FOR UPDATE

            OPEN CUR_ICONT FETCH FROM CUR_ICONT INTO @PP,@SIGLARAPPORTI,@SIGLASOCIETA

                  IF @@FETCH_STATUS<>0  SELECT @PP = 0
      
                  SET @PP = @PP + 1
                  SET @PPROGRESSIVO = cast(@PESERCIZIO AS VARCHAR(4))+@SIGLARAPPORTI+right('000000'+cast(@PP as varchar(6)),6)+@SIGLASOCIETA

                  UPDATE      TABCONTATORI 
                  SET         PROGR = @PP, UTENTEMODIFICA = @PUTENTE, DATAMODIFICA = GETDATE() 
                  WHERE CURRENT OF CUR_ICONT

            CLOSE CUR_ICONT
            DEALLOCATE CUR_ICONT
      END
print @PPROGRESSIVO
END


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[NUOVORAPPORTO] TO [Metodo98]
    AS [dbo];

