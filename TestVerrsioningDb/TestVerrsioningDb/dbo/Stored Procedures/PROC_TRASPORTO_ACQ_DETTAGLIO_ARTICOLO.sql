

CREATE PROCEDURE [dbo].[PROC_TRASPORTO_ACQ_DETTAGLIO_ARTICOLO](@RIFPROGRESSIVO DECIMAL(18,0)) AS

DECLARE @NDECIMALITOTALE INT

    SELECT @NDECIMALITOTALE = NDECIMALITOTALE FROM tabcambi WHERE CODICE = (select divisaeuro from TABVINCOLIGIC WHERE ESERCIZIO = (select esercizioattivo from tabutenti where userdb = USER_NAME()))

    DELETE FROM TP_TRASPORTOTOTALEARTICOLO WHERE RIFPROGRESSIVO = @RIFPROGRESSIVO
    DELETE FROM TP_TRASPORTOTOTALEARTICOLO_TMP WHERE RIFPROGRESSIVO = @RIFPROGRESSIVO
    
    /*CREO IL RECORDSET DEGLI ARTICOLI E LI INSERISCO IN UNA TABELLA TEMPORANEA*/
    INSERT INTO TP_TRASPORTOTOTALEARTICOLO_TMP(RIFPROGRESSIVO,ESERCIZIO,TIPODOC,NUMERODOC,CODDEPOSITO,CODART,TOTALEPEZZI,TOTALEPESO,TOTALEPEDANA,COSTOPEDANA,COSTOPEZZOXPEDANA,COSTOPEZZOXKG,UTENTEMODIFICA,DATAMODIFICA)
    SELECT
        @RIFPROGRESSIVO,
        ESERCIZIO,
        TIPODOC,
        NUMERODOC,
        CODDEPOSITO,
        CODART,
        TOTALEPEZZI,
        TOTALEPESO,
        TOTALEPEDANA,
        ROUND((PEDANECOSTOXFORNITORE * TOTALEPEDANA),@NDECIMALITOTALE)  AS COSTOPEDANA,
        (CASE WHEN (TOTALEPEZZI > 0) THEN ((PEDANECOSTOXFORNITORE * TOTALEPEDANA)  / TOTALEPEZZI)
                                     ELSE 0
         END) AS COSTOSUPEDANA,
        (CASE WHEN (TOTALEKG > 0 AND TOTALEPEZZI > 0) THEN ((COSTOTRASPORTOMEDIOKG + (PEDANECOSTOTOTALE / TOTALEKG)) * (TOTALEPESO / TOTALEPEZZI)) 
                                                       ELSE 0 
         END) AS COSTOPEZZOSUPESO,
        USER_NAME(),
        GETDATE()
    FROM
    (
        SELECT
            ESERCIZIO,
            TIPODOC,
            NUMERODOC,
            CODDEPOSITO,
            CODART,
            PEDANECOSTOXFORNITORE,
            TOTALEKG,
            PEDANECOSTOTOTALE,
            COSTOTRASPORTOMEDIOKG,
            SUM(QTACONV_QT) AS TOTALEPEZZI,
            SUM(QTACONV_KG) AS TOTALEPESO,
            SUM(QTACONV_PD) AS TOTALEPEDANA
        FROM
        (
            SELECT
                ARTICOLI.ESERCIZIO,
                ARTICOLI.TIPODOC,
                ARTICOLI.NUMERODOC,
                ARTICOLI.CODDEPOSITO,
                ARTICOLI.CODART,
                ARTICOLI.PEDANECOSTOXFORNITORE,
                ARTICOLI.PEDANECOSTOTOTALE,
                ARTICOLI.TOTALEKG,
                ARTICOLI.COSTOTRASPORTOMEDIOKG,
                dbo.FunCONVERTIUM(ARTICOLI.CODART,ARTICOLI.QTAGEST,ARTICOLI.UMGEST,PARAMETRI.UMTOTALEQTA) AS QTACONV_QT,
                dbo.FunCONVERTIUM(ARTICOLI.CODART,ARTICOLI.QTAGEST,ARTICOLI.UMGEST,PARAMETRI.UMTOTALEKG) AS QTACONV_KG,
                dbo.FunCONVERTIUM(ARTICOLI.CODART,ARTICOLI.QTAGEST,ARTICOLI.UMGEST,PARAMETRI.UMPEDANA) AS QTACONV_PD
            FROM
            (
                SELECT 
                    RD.ESERCIZIO,
                    RD.TIPODOC,
                    RD.NUMERODOC,
                    RD.CODDEPOSITO,
                    RD.CODART,
                    RD.UMGEST,
                    SUM(RD.QTAGEST) AS QTAGEST,
                    TTDA.PEDANECOSTOXFORNITORE,
                    TTDA.TOTALEKG,
                    TTDA.PEDANECOSTOTOTALE,
                    TTA.COSTOTRASPORTOMEDIOKG
                FROM 
                    RIGHEDOCUMENTI RD,
                    TP_TRASPORTODETTAGLIOACQ TTDA,
                    TP_TRASPORTOACQ TTA
                WHERE 
                    RD.ESERCIZIO =  TTDA.ESERCIZIO AND 
                    RD.TIPODOC = TTDA.TIPODOC AND 
                    RD.NUMERODOC = TTDA.NUMERODOC AND
                    RD.CODART <> '' AND
                    RD.CODDEPOSITO = TTA.CODDEPOSITO AND
                    TTDA.RIFPROGRESSIVO = TTA.PROGRESSIVO AND
                    TTA.PROGRESSIVO = @RIFPROGRESSIVO
                GROUP BY
                    RD.ESERCIZIO,
                    RD.TIPODOC,
                    RD.NUMERODOC,
                    RD.CODDEPOSITO,
                    RD.CODART,
                    RD.UMGEST,
                    TTDA.PEDANECOSTOXFORNITORE,
                    TTDA.TOTALEKG,
                    TTDA.PEDANECOSTOTOTALE,
                    TTA.COSTOTRASPORTOMEDIOKG
            ) ARTICOLI,
              TP_TRASPORTOPARAMETRIACQ PARAMETRI
        ) ARTICOLIQTACONVERTITE
        GROUP BY
            ESERCIZIO,
            TIPODOC,
            NUMERODOC,
            CODDEPOSITO,
            CODART,
            PEDANECOSTOXFORNITORE,
            TOTALEKG,
            PEDANECOSTOTOTALE,
            COSTOTRASPORTOMEDIOKG
    ) ARTICOLICOSTICALCOLATI
        
    /*CALCOLO UNA EVENTUALE MEDIA ED INSERISCO I VALORI FINALI NELLA TABELLA*/
    INSERT INTO TP_TRASPORTOTOTALEARTICOLO(RIFPROGRESSIVO,ESERCIZIO,TIPODOC,NUMERODOC,CODDEPOSITO,CODART,TOTALEPEZZI,TOTALEPESO,TOTALEPEDANA,COSTOPEDANA,COSTOPEZZOXPEDANA,COSTOPEZZOXKG,UTENTEMODIFICA,DATAMODIFICA)
    SELECT
        TTTAT.RIFPROGRESSIVO,
        TTTAT.ESERCIZIO,
        TTTAT.TIPODOC,
        TTTAT.NUMERODOC,
        TTTAT.CODDEPOSITO,
        TTTAT.CODART,
        TTTAT.TOTALEPEZZI,
        TTTAT.TOTALEPESO,
        TTTAT.TOTALEPEDANA,
        TTTAT.COSTOPEDANA,
        TTTAT.COSTOPEZZOXPEDANA,
        TTTAT.COSTOPEZZOXKG,
        USER_NAME(),
        GETDATE()
    FROM
        TP_TRASPORTOTOTALEARTICOLO_TMP TTTAT
    WHERE
        TTTAT.RIFPROGRESSIVO = @RIFPROGRESSIVO


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[PROC_TRASPORTO_ACQ_DETTAGLIO_ARTICOLO] TO [Metodo98]
    AS [dbo];

