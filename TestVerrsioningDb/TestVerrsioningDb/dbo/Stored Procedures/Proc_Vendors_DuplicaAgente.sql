

CREATE PROCEDURE [dbo].[Proc_Vendors_DuplicaAgente](@CodAgente_Cur Varchar(7),
                                                     @CodAgente_Tmp Varchar(7),
                                                      @CodAgente_New Varchar(7) OUTPUT)
AS

BEGIN

SET NOCOUNT ON;
    
    BEGIN TRAN  
    
    SET @CodAgente_New = ''
    
    IF EXISTS(SELECT [CODAGENTE] FROM [dbo].[ANAGRAFICAAGENTI] WHERE [CODAGENTE] = @CodAgente_Tmp) AND
       NOT EXISTS(SELECT [CODAGENTE] FROM [dbo].[TP_TRASFAGENTI] WHERE [CODAGENTE] = @CodAgente_Tmp)
        BEGIN
            INSERT INTO [dbo].[TP_TRASFAGENTI]([CODAGENTE],[DSCAGENTE],[ORARIOCOLLEGAMENTO],[ULTPREPAR],[ULTTRASF],[ULTRIC],[ATTIVO],[TIPOELABORAZIONE],[PRIORITA],[VARPRZSCT],[RANGEDA],[RANGEA],[TIPOCODIFICA]
                                              ,[PATHR],[PATHT],[TIPOEXPDATI],[CODMASTRO],[CODLISTINO],[TIPOMSG],[RANGEIDDA],[RANGEIDA],[CONTATTO1],[IDMSG1],[CONTATTO2],[IDMSG2],[CONTATTO3],[IDMSG3],[IDMSG4],[CODAGERAPPR]
                                              ,[PATHOLAP],[GESTGIACAG],[GESTREDD],[LSTREDD],[PATHSTP],[CODPAG],[SCNTAGG],[USAPRZPART],[USAPRZPARTFORTABLET],[CANCSTORICODOC],[TIPOSTPRESOCONTO],[EXPSTORICOPRZ],[EXPDATADOC]
                                              ,[GESTASSORT],[GSTSCTMERCE],[GRIDSMALL],[ESPTUTTILISTINI],[RICPRZSCTRICPOKET],[LISTINO],[PREZZOUNITARIO],[SCONTOBASE],[SCONTOAGGIUNTIVO],[SOSTCLIARTXPOCKET],[TUTTIDOCUMENTI]
                                              ,[UTENTEMODIFICA],[DATAMODIFICA])
            SELECT @CodAgente_Tmp,(SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=@CodAgente_Tmp),[ORARIOCOLLEGAMENTO],[ULTPREPAR],[ULTTRASF],[ULTRIC],[ATTIVO],[TIPOELABORAZIONE],[PRIORITA],[VARPRZSCT],[RANGEDA],[RANGEA],[TIPOCODIFICA]
                  ,[PATHR],[PATHT],[TIPOEXPDATI],[CODMASTRO],[CODLISTINO],[TIPOMSG],[RANGEIDDA],[RANGEIDA],[CONTATTO1],[IDMSG1],[CONTATTO2],[IDMSG2],[CONTATTO3],[IDMSG3],[IDMSG4],[CODAGERAPPR]
                  ,[PATHOLAP],[GESTGIACAG],[GESTREDD],[LSTREDD],[PATHSTP],[CODPAG],[SCNTAGG],[USAPRZPART],[USAPRZPARTFORTABLET],[CANCSTORICODOC],[TIPOSTPRESOCONTO],[EXPSTORICOPRZ],[EXPDATADOC]
                  ,[GESTASSORT],[GSTSCTMERCE],[GRIDSMALL],[ESPTUTTILISTINI],[RICPRZSCTRICPOKET],[LISTINO],[PREZZOUNITARIO],[SCONTOBASE],[SCONTOAGGIUNTIVO],[SOSTCLIARTXPOCKET],[TUTTIDOCUMENTI]
                  ,USER_NAME(),GETDATE()
            FROM [dbo].[TP_TRASFAGENTI]
            WHERE [CODAGENTE] = @CodAgente_Cur
            
            IF NOT EXISTS(SELECT [CODICE] FROM [dbo].[TP_CONFIGESPORTAZ] WHERE [CODICE] = @CodAgente_Tmp)
            INSERT INTO [dbo].[TP_CONFIGESPORTAZ]([TIPO],[CODICE],[TABELLEINESPORTAZIONE],[GRUPPO],[CATEGORIA],[CATEGORIASTATISTICA],[ARTICOLICONTIPOLOGIA],[TIPORIGA],[FAMIGLIAPOS],[REPARTOPOS],[UTENTEMODIFICA],[DATAMODIFICA])
            SELECT [TIPO],@CodAgente_Tmp,[TABELLEINESPORTAZIONE],[GRUPPO],[CATEGORIA],[CATEGORIASTATISTICA],[ARTICOLICONTIPOLOGIA],[TIPORIGA],[FAMIGLIAPOS],[REPARTOPOS],USER_NAME(),GETDATE()
            FROM [dbo].[TP_CONFIGESPORTAZ]
            WHERE [CODICE] = @CodAgente_Cur
            
            IF NOT EXISTS(SELECT [CODAGENTE] FROM [dbo].[TP_DOCTRASFAG] WHERE [CODAGENTE] = @CodAgente_Tmp)
            INSERT INTO [dbo].[TP_DOCTRASFAG]([CODAGENTE],[CODICEDOC],[TipoGriglia],[GiacDisp],[TIPO],[TIPODOCEXP],[DESCDOCEXP],[DOCPREDEF],[ORDINETABLET],[RISPETTADOCORIGINE],[PRELEVABILE],[UTENTEMODIFICA],[DATAMODIFICA])
            SELECT @CodAgente_Tmp,[CODICEDOC],[TipoGriglia],[GiacDisp],[TIPO],[TIPODOCEXP],[DESCDOCEXP],[DOCPREDEF],[ORDINETABLET],[RISPETTADOCORIGINE],[PRELEVABILE],USER_NAME(),GETDATE()
            FROM [dbo].[TP_DOCTRASFAG]
            WHERE [CODAGENTE] = @CodAgente_Cur
            
            IF NOT EXISTS(SELECT [Entita] FROM [dbo].[TP_TIPIAGPV] WHERE [Entita] = @CodAgente_Tmp)
            INSERT INTO [dbo].[TP_TIPIAGPV]([Entita],[Priorita])
            SELECT @CodAgente_Tmp,[Priorita] 
            FROM [dbo].[TP_TIPIAGPV]
            WHERE [Entita] = @CodAgente_Cur
            
            IF NOT EXISTS(SELECT [CODAGENTE] FROM [dbo].[TP_DOCSTATAG]  WHERE [CODAGENTE] = @CodAgente_Tmp)
            INSERT INTO [dbo].[TP_DOCSTATAG]([CODAGENTE],[DOCUMENTI_RG1],[DOCUMENTI_RG2],[DOCUMENTI_RG3],[CAUSALI_RG1],[CAUSALI_RG2],[CAUSALI_RG3],[UTENTEMODIFICA],[DATAMODIFICA])
            SELECT @CodAgente_Tmp,[DOCUMENTI_RG1],[DOCUMENTI_RG2],[DOCUMENTI_RG3],[CAUSALI_RG1],[CAUSALI_RG2],[CAUSALI_RG3],USER_NAME(),GETDATE()
            FROM [dbo].[TP_DOCSTATAG]
            WHERE [CODAGENTE] = @CodAgente_Cur
            
            IF NOT EXISTS(SELECT [CodAgente] FROM [dbo].[TP_UMAG] WHERE [CodAgente] = @CodAgente_Tmp)
            INSERT INTO [dbo].[TP_UMAG]([CodAgente],[UM],[UtenteModifica],[DataModifica])
            SELECT @CodAgente_Tmp,[UM],[UtenteModifica],[DataModifica]
            FROM [dbo].[TP_UMAG]
            WHERE [CodAgente] = @CodAgente_Cur

            SET @CodAgente_New = @CodAgente_Tmp
        END
        
    IF @@ERROR <> 0 GOTO ErrorHandler
    COMMIT TRAN
    RETURN(0)
  
ErrorHandler:
    ROLLBACK TRAN
    PRINT @@ERROR
    SET @CodAgente_New = ''
    RETURN(@@ERROR)
END




GO
GRANT EXECUTE
    ON OBJECT::[dbo].[Proc_Vendors_DuplicaAgente] TO [Metodo98]
    AS [dbo];

