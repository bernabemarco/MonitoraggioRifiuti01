
CREATE FUNCTION FunUltimoPrz(@CodArticolo varchar(50),
				   @CodCliente varchar(7),
				   @Esercizio Int)
	RETURNS @Results TABLE (Progressivo numeric(10, 0) IDENTITY (1, 1),
				CODART varchar(50)  COLLATE SQL_Latin1_General_CP850_CI_AS,
				CODCLIFOR varchar(7)  COLLATE SQL_Latin1_General_CP850_CI_AS,
				DATADOC DateTime,
				ESERCIZIO decimal(5,0),
				TIPODOC varchar(3)  COLLATE SQL_Latin1_General_CP850_CI_AS,
				NUMERODOC decimal(10,0),
				PREZZOUNITNETTOVALUTA decimal(19,4),
				QTAGEST decimal(19,6),
				UMGEST varchar(5)  COLLATE SQL_Latin1_General_CP850_CI_AS,
				DESCCAMP varchar(50)  COLLATE SQL_Latin1_General_CP850_CI_AS,
				DESCPROMO varchar(50) COLLATE SQL_Latin1_General_CP850_CI_AS)
AS

    BEGIN
	DECLARE @CODART varchar(50)
	DECLARE @CODCLIFOR varchar(50)
	DECLARE @ESERCIZIOATTIVO varchar(50)

	DECLARE Articoli_Cursor CURSOR FOR
			SELECT DISTINCT 
				VISTADOCUMENTIBASE.CODART,
				VISTADOCUMENTIBASE.CODCLIFOR,
				VISTADOCUMENTIBASE.ESERCIZIO
			FROM VISTADOCUMENTIBASE  
			INNER JOIN TP_ASSOCIAZIONI_DOC 
				ON VISTADOCUMENTIBASE.TIPODOC = TP_ASSOCIAZIONI_DOC.Cod_Doc AND 
				   TP_ASSOCIAZIONI_DOC.Tipo IN(1, 2, 3, 8, 10, 11, 12, 15, 16, 17, 18)
			LEFT OUTER JOIN  TP_EXTRARIGHEDOC ON TP_EXTRARIGHEDOC.IDTESTA = VISTADOCUMENTIBASE.IDTESTA AND
				   TP_EXTRARIGHEDOC.IDRiga = VISTADOCUMENTIBASE.PROGRIGADOC
			WHERE VISTADOCUMENTIBASE.TIPORIGA='N' AND 
			      VISTADOCUMENTIBASE.CODART=@CodArticolo AND 
			      VISTADOCUMENTIBASE.CODCLIFOR=@CodCliente
	OPEN Articoli_Cursor
		
	FETCH NEXT FROM Articoli_Cursor 
		INTO @CODART,@CODCLIFOR,@ESERCIZIOATTIVO

	WHILE @@FETCH_STATUS = 0
		BEGIN
		    INSERT INTO @Results 
			SELECT TOP 1 VISTADOCUMENTIBASE.CODART,
				      VISTADOCUMENTIBASE.CODCLIFOR,
				      VISTADOCUMENTIBASE.DATADOC,
				      VISTADOCUMENTIBASE.ESERCIZIO,
				      VISTADOCUMENTIBASE.TIPODOC,
				      VISTADOCUMENTIBASE.NUMERODOC,
				      VISTADOCUMENTIBASE.PREZZOUNITNETTOVALUTA,
				      VISTADOCUMENTIBASE.QTAGEST,
				      VISTADOCUMENTIBASE.UMGEST,
				      TP_EXTRARIGHEDOC.DescCampagna AS DescrizioneCampagna,
				      TP_EXTRARIGHEDOC.DescPromozione AS DescrizionePromozione
			 FROM VISTADOCUMENTIBASE 
	 			INNER JOIN TP_ASSOCIAZIONI_DOC 
					ON VISTADOCUMENTIBASE.TIPODOC = TP_ASSOCIAZIONI_DOC.Cod_Doc AND 
					   TP_ASSOCIAZIONI_DOC.Tipo IN(1, 2, 3, 8, 10, 11, 12, 15, 16, 17, 18)
				LEFT OUTER JOIN  TP_EXTRARIGHEDOC 
					ON TP_EXTRARIGHEDOC.IDTESTA = VISTADOCUMENTIBASE.IDTESTA AND
					   TP_EXTRARIGHEDOC.IDRiga = VISTADOCUMENTIBASE.PROGRIGADOC  
			 WHERE VISTADOCUMENTIBASE.CODART = @CODART AND VISTADOCUMENTIBASE.CODART<>''  AND
				  VISTADOCUMENTIBASE.UMGEST<>'' AND VISTADOCUMENTIBASE.TIPORIGA='N' AND
				  VISTADOCUMENTIBASE.SCONTORIGA<>100 AND VISTADOCUMENTIBASE.CODCLIFOR=@CODCLIFOR
			 ORDER BY VISTADOCUMENTIBASE.DATADOC DESC

		    FETCH NEXT FROM Articoli_Cursor 
					INTO @CODART,@CODCLIFOR,@ESERCIZIOATTIVO
		END

	CLOSE Articoli_Cursor

	DEALLOCATE Articoli_Cursor
    
    RETURN
END


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[FunUltimoPrz] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[FunUltimoPrz] TO [Metodo98]
    AS [dbo];

