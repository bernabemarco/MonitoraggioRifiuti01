CREATE TABLE [dbo].[TP_TRASFAGENTI] (
    [CODAGENTE]           VARCHAR (7)   NOT NULL,
    [DSCAGENTE]           VARCHAR (80)  NULL,
    [ORARIOCOLLEGAMENTO]  VARCHAR (8)   NULL,
    [ULTPREPAR]           DATETIME      NULL,
    [ULTTRASF]            DATETIME      NULL,
    [ULTRIC]              DATETIME      NULL,
    [ATTIVO]              SMALLINT      NULL,
    [TIPOELABORAZIONE]    CHAR (3)      NULL,
    [PRIORITA]            SMALLINT      NULL,
    [VARPRZSCT]           SMALLINT      NULL,
    [RANGEDA]             INT           NULL,
    [RANGEA]              INT           NULL,
    [TIPOCODIFICA]        CHAR (1)      NULL,
    [PATHR]               VARCHAR (100) NULL,
    [PATHT]               VARCHAR (100) NULL,
    [UTENTEMODIFICA]      VARCHAR (25)  NULL,
    [DATAMODIFICA]        DATETIME      NULL,
    [TIPOEXPDATI]         SMALLINT      NULL,
    [CODMASTRO]           DECIMAL (5)   NULL,
    [CODLISTINO]          DECIMAL (5)   NULL,
    [TIPOMSG]             SMALLINT      NULL,
    [RANGEIDDA]           DECIMAL (19)  NULL,
    [RANGEIDA]            DECIMAL (19)  NULL,
    [CONTATTO1]           VARCHAR (50)  NULL,
    [IDMSG1]              DECIMAL (10)  NULL,
    [CONTATTO2]           VARCHAR (50)  NULL,
    [IDMSG2]              DECIMAL (10)  NULL,
    [CONTATTO3]           VARCHAR (50)  NULL,
    [IDMSG3]              DECIMAL (10)  NULL,
    [IDMSG4]              DECIMAL (10)  NULL,
    [CODAGERAPPR]         VARCHAR (7)   NULL,
    [PATHOLAP]            VARCHAR (100) NULL,
    [GESTGIACAG]          SMALLINT      CONSTRAINT [DF_TP_TRASFAGENTI_GESTGIACAG] DEFAULT (0) NOT NULL,
    [GESTREDD]            SMALLINT      CONSTRAINT [DF_TP_TRASFAGENTI_GESTREDD] DEFAULT (0) NOT NULL,
    [LSTREDD]             DECIMAL (5)   CONSTRAINT [DF_TP_TRASFAGENTI_LSTREDD] DEFAULT (0) NOT NULL,
    [PATHSTP]             VARCHAR (100) NULL,
    [CODPAG]              VARCHAR (4)   NULL,
    [SCNTAGG]             SMALLINT      CONSTRAINT [DF_TP_TRASFAGENTI_SCNTAGG] DEFAULT (0) NULL,
    [USAPRZPART]          SMALLINT      CONSTRAINT [DF_TP_TRASFAGENTI_USAPRZPART] DEFAULT (0) NULL,
    [USAPRZPARTFORTABLET] SMALLINT      DEFAULT (0) NULL,
    [CANCSTORICODOC]      SMALLINT      DEFAULT (0) NULL,
    [TIPOSTPRESOCONTO]    SMALLINT      DEFAULT (0) NULL,
    [EXPSTORICOPRZ]       SMALLINT      DEFAULT (0) NULL,
    [EXPDATADOC]          DATETIME      DEFAULT ('1990-01-01') NULL,
    [GESTASSORT]          SMALLINT      DEFAULT (0) NULL,
    [GSTSCTMERCE]         SMALLINT      NULL,
    [GRIDSMALL]           SMALLINT      NULL,
    [ESPTUTTILISTINI]     SMALLINT      NULL,
    [RICPRZSCTRICPOKET]   SMALLINT      NULL,
    [LISTINO]             SMALLINT      DEFAULT (0) NULL,
    [PREZZOUNITARIO]      SMALLINT      DEFAULT (0) NULL,
    [SCONTOBASE]          SMALLINT      DEFAULT (0) NULL,
    [SCONTOAGGIUNTIVO]    SMALLINT      DEFAULT (0) NULL,
    [SOSTCLIARTXPOCKET]   SMALLINT      DEFAULT (0) NOT NULL,
    [TUTTIDOCUMENTI]      SMALLINT      DEFAULT ((0)) NULL,
    [IDDEVICE]            VARCHAR (5)   DEFAULT ('00000') NULL,
    [CODCAUSALEMAG]       DECIMAL (5)   DEFAULT ((0)) NULL,
    [CODDEPOSITO]         VARCHAR (10)  DEFAULT ('') NULL,
    [GESTTIPOSCONTO]      SMALLINT      DEFAULT ((0)) NULL,
    CONSTRAINT [PK_TP_TRASFAGENTI] PRIMARY KEY CLUSTERED ([CODAGENTE] ASC) WITH (FILLFACTOR = 90)
);


GO
CREATE TRIGGER TD_TP_TRASFAGENTI ON TP_TRASFAGENTI 
FOR DELETE 
AS
begin
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255),
       @strCodAgente varchar(7)	

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN
    
 Select @strCodAgente=CodAgente From Deleted

    /*  DELETE ALL CHILDREN IN "TP_DOCTRASFAG"  */
    DELETE TP_DOCTRASFAG
        WHERE  CODAGENTE =@strCodAgente
    
   /*  DELETE ALL CHILDREN IN "TP_DOCTRASFAG"  */
    DELETE TP_TIPIAGPV
    FROM   TP_TIPIAGPV T2, DELETED T1
    WHERE  T2.ENTITA = T1.CODAGENTE

/*  DELETE ALL CHILDREN IN "TP_PUNTIVENDITA"  */
    DELETE TP_CONFIGESPORTAZ
    FROM   TP_CONFIGESPORTAZ T2, DELETED T1
    WHERE  T2.CODICE = T1.CODAGENTE

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
end


GO
GRANT DELETE
    ON OBJECT::[dbo].[TP_TRASFAGENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[TP_TRASFAGENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[TP_TRASFAGENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_TRASFAGENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[TP_TRASFAGENTI] TO [Metodo98]
    AS [dbo];

