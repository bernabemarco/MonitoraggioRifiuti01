CREATE TABLE [dbo].[PROGPRODUZIONE] (
    [NOMEPIANIF]        VARCHAR (30)    NOT NULL,
    [PROG_ID]           DECIMAL (20)    NOT NULL,
    [LIVELLO]           VARCHAR (1)     NULL,
    [CODART]            VARCHAR (50)    NULL,
    [DATACONS]          DATETIME        NOT NULL,
    [DATAINIZPROD]      DATETIME        NULL,
    [RIFERIMENTI]       VARCHAR (100)   NULL,
    [TIPO]              SMALLINT        NULL,
    [QTAIMP]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTAORD]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTDOCEMESSO]       DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [SCMINIMA]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [SCMASSIMA]         DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [LIVRIORDINO]       DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [SITUAZIONE]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTADOCUMENTO]      DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [UMDOCUMENTO]       VARCHAR (3)     NOT NULL,
    [UMARTICOLO]        VARCHAR (3)     NOT NULL,
    [ANNODOC]           SMALLINT        NULL,
    [VERDBA]            VARCHAR (10)    NULL,
    [PROVENIENZA]       SMALLINT        NULL,
    [TIPOGESTIONE]      SMALLINT        NULL,
    [CODFOR]            VARCHAR (7)     NULL,
    [DATAORD]           DATETIME        NULL,
    [CONSIDERA]         SMALLINT        DEFAULT (0) NULL,
    [RAGGRUPPA]         VARCHAR (100)   NULL,
    [CODDEPOSITO]       VARCHAR (10)    NULL,
    [RIFID]             DECIMAL (10)    NULL,
    [TIPOMAGGIAC]       SMALLINT        DEFAULT (0) NULL,
    [IDTESTADOC]        DECIMAL (10)    NULL,
    [IDRIGADOC]         INT             NULL,
    [UTENTEMODIFICA]    VARCHAR (25)    NOT NULL,
    [DATAMODIFICA]      DATETIME        NOT NULL,
    [RIF_PROP]          DECIMAL (10)    NULL,
    [RIFCOMMCLI]        VARCHAR (30)    NULL,
    [ORDINELETTURA]     DECIMAL (10)    NULL,
    [TIPODOC]           VARCHAR (3)     NULL,
    [GESTIONEMATERIALI] SMALLINT        DEFAULT (0) NULL,
    [IDIMPEGNO]         INT             NULL,
    [QTARISERVATA]      DECIMAL (16, 6) NULL,
    [TIPOPRODOTTO]      SMALLINT        NULL,
    [ARTICOLOGHOST]     SMALLINT        NULL,
    [VARESPLICITE]      VARCHAR (255)   NULL,
    [QTADOCBASE]        DECIMAL (16, 6) NULL,
    [FILTRO]            SMALLINT        DEFAULT ((0)) NULL,
    [DARILASCIARE]      SMALLINT        DEFAULT ((0)) NULL,
    [GGORIZZONTEART]    INT             DEFAULT ((0)) NULL,
    [ORIG_CODFOR]       VARCHAR (7)     NULL,
    [ORIG_CODART]       VARCHAR (50)    NULL,
    [ORIG_DATACONS]     DATETIME        NULL,
    [ORIG_QTADOCUMENTO] DECIMAL (16, 6) NULL,
    [ORIG_UMDOCUMENTO]  VARCHAR (3)     NULL,
    [ORIG_VERDBA]       VARCHAR (10)    NULL,
    [FlgLocked]         SMALLINT        CONSTRAINT [DF_PROGPRODUZIONE_FLGLOCKED] DEFAULT ((0)) NOT NULL,
    CONSTRAINT [PK_PROGPRODUZIONE] PRIMARY KEY CLUSTERED ([NOMEPIANIF] ASC, [PROG_ID] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CKC_CONSIDERA_PROGPROD] CHECK ([CONSIDERA] = 0 or [CONSIDERA] = 1)
);


GO
CREATE NONCLUSTERED INDEX [PROGPROD_FK]
    ON [dbo].[PROGPRODUZIONE]([NOMEPIANIF] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [PROGPROD_ORDINELETTURA]
    ON [dbo].[PROGPRODUZIONE]([NOMEPIANIF] ASC, [LIVELLO] ASC, [CODART] ASC, [RIFCOMMCLI] ASC, [DATAINIZPROD] ASC, [PROG_ID] ASC, [VERDBA] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [PROGPROD_ORDINESCRITTURA]
    ON [dbo].[PROGPRODUZIONE]([NOMEPIANIF] ASC, [ORDINELETTURA] ASC, [PROG_ID] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [PROGPROD_LIVELLOART]
    ON [dbo].[PROGPRODUZIONE]([NOMEPIANIF] ASC, [LIVELLO] ASC, [CODART] ASC) WITH (FILLFACTOR = 90);


GO

/*  INSERT TRIGGER "TI_PROGPRODUZIONE" FOR TABLE "PROGPRODUZIONE"  */
CREATE TRIGGER TI_PROGPRODUZIONE ON PROGPRODUZIONE FOR INSERT AS
BEGIN
    DECLARE
       @MAXCARD  INT,
       @NUMROWS  INT,
       @NUMNULL  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  PARENT "IMPOSTAZIONIPROGPROD" MUST EXIST WHEN INSERTING A CHILD IN "PROGPRODUZIONE"  */
    IF UPDATE(NOMEPIANIF)
    BEGIN
       IF (SELECT COUNT(*)
           FROM   IMPOSTAZIONIPROGPROD T1, INSERTED T2
           WHERE  T1.NOMEPIANIF = T2.NOMEPIANIF) != @NUMROWS
          BEGIN
             SELECT @ERRNO  = 30002,
                    @ERRMSG = 'Parent does not exist in "IMPOSTAZIONIPROGPROD". Cannot create child in "PROGPRODUZIONE".'
             GOTO ERROR
          END
    END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  UPDATE TRIGGER "TU_PROGPRODUZIONE" FOR TABLE "PROGPRODUZIONE"  */
CREATE TRIGGER TU_PROGPRODUZIONE ON PROGPRODUZIONE FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  PARENT "IMPOSTAZIONIPROGPROD" MUST EXIST WHEN UPDATING A CHILD IN "PROGPRODUZIONE"  */
      IF UPDATE(NOMEPIANIF)
      BEGIN
         IF (SELECT COUNT(*)
             FROM   IMPOSTAZIONIPROGPROD T1, INSERTED T2
             WHERE  T1.NOMEPIANIF = T2.NOMEPIANIF) != @NUMROWS
            BEGIN
               SELECT @ERRNO  = 30003,
                      @ERRMSG = '"IMPOSTAZIONIPROGPROD" does not exist. Cannot modify child in "PROGPRODUZIONE".'
               GOTO ERROR
            END
      END

      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO


------------------------------------------------------------------------------------------------------------------------------------------------
-- FINE SVILUPPO 3772 
------------------------------------------------------------------------------------------------------------------------------------------------



/*
    rif.a#12651 - eseguo due query al posto di una con OR
*/
CREATE TRIGGER [dbo].[TD_PROGPRODUZIONE] ON [dbo].[PROGPRODUZIONE] FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)
 
    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN
    
    /*  DELETE ALL CHILDREN IN "PROGPRODUZIONEDOC"  */
    DELETE PROGPRODUZIONEDOC
    FROM   PROGPRODUZIONEDOC T2, DELETED T1
    WHERE  (T2.NOMEPIANIF=T1.NOMEPIANIF and T2.PROG_ID=T1.PROG_ID);

    DELETE PROGPRODUZIONEDOC
    FROM   PROGPRODUZIONEDOC T2, DELETED T1
    WHERE  (T2.NOMEPIANIF=T1.NOMEPIANIF and T2.RIF_ID = T1.PROG_ID);

    /*  DELETE ALL CHILDREN IN "PROGPRODUZIONEFASI"  */
    DELETE PROGPRODUZIONEFASI
    FROM   PROGPRODUZIONEFASI T2, DELETED T1
    WHERE  (T2.NOMEPIANIF=T1.NOMEPIANIF and T2.PROG_ID=T1.PROG_ID)

    RETURN
 
/*  ERRORS HANDLING  */
ERROR:
    raiserror (@errmsg, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[PROGPRODUZIONE] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[PROGPRODUZIONE] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[PROGPRODUZIONE] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[PROGPRODUZIONE] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[PROGPRODUZIONE] TO [Metodo98]
    AS [dbo];

