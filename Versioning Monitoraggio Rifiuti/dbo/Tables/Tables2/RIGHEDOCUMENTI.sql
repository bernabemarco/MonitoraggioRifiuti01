CREATE TABLE [dbo].[RIGHEDOCUMENTI] (
    [IDTESTA]                 DECIMAL (10)    NOT NULL,
    [IDRIGA]                  INT             NOT NULL,
    [ESERCIZIO]               DECIMAL (5)     NOT NULL,
    [TIPODOC]                 VARCHAR (3)     NOT NULL,
    [NUMERODOC]               DECIMAL (10)    NOT NULL,
    [BIS]                     CHAR (1)        NULL,
    [POSIZIONE]               INT             NULL,
    [TIPORIGA]                CHAR (1)        NULL,
    [CODART]                  VARCHAR (50)    DEFAULT ('') NULL,
    [IDARTBASE]               INT             NULL,
    [CODARTBASE]              VARCHAR (50)    DEFAULT ('') NOT NULL,
    [VARIANTI]                VARCHAR (100)   DEFAULT ('') NOT NULL,
    [DESCRIZIONEART]          VARCHAR (255)   DEFAULT ('') NULL,
    [NUMLISTINO]              DECIMAL (5)     NULL,
    [UMGEST]                  VARCHAR (3)     DEFAULT ('') NOT NULL,
    [QTAGEST]                 DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTAGESTRES]              DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTAGESTPRELEVATA]        DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTA1MAG]                 DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTA1MAGMAN]              SMALLINT        DEFAULT (0) NULL,
    [QTA1MAGRES]              DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTA2MAG]                 DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTA2MAGMAN]              SMALLINT        DEFAULT (0) NULL,
    [QTA2MAGRES]              DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [UMPREZZO]                VARCHAR (3)     DEFAULT ('') NOT NULL,
    [QTAPREZZO]               DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [QTAPREZZOMAN]            SMALLINT        DEFAULT (0) NULL,
    [QTAPREZZORES]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [NRRIFPARTITA]            VARCHAR (15)    DEFAULT ('') NULL,
    [PREZZOUNITLORDO]         DECIMAL (19, 6) DEFAULT (0) NOT NULL,
    [PREZZOUNITLORDOEURO]     DECIMAL (19, 6) DEFAULT (0) NOT NULL,
    [PREZZOUNITLORDOIVATO]    DECIMAL (19, 6) DEFAULT (0) NOT NULL,
    [PREZZOUNITNETTO]         DECIMAL (19, 6) DEFAULT (0) NOT NULL,
    [PREZZOUNITNETTOEURO]     DECIMAL (19, 6) DEFAULT (0) NOT NULL,
    [SCONTORIGA]              DECIMAL (8, 5)  DEFAULT (0) NOT NULL,
    [SCONTIESTESI]            VARCHAR (20)    DEFAULT ('') NULL,
    [CODIVA]                  DECIMAL (5)     NULL,
    [TOTLORDORIGA]            DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTLORDORIGARES]         DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTLORDORIGAEURO]        DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTLORDORIGAEURORES]     DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTNETTORIGA]            DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTNETTORIGARES]         DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTNETTORIGAEURO]        DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTNETTORIGAEURORES]     DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [RIGACHIUSA]              SMALLINT        DEFAULT (0) NULL,
    [DATACONSEGNA]            DATETIME        NULL,
    [PROVVAG1]                VARCHAR (20)    DEFAULT ('') NULL,
    [TOTPROVVAG1]             DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAG1RES]          DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO1]         DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO1RES]      DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [PROVVAG2]                VARCHAR (20)    DEFAULT ('') NULL,
    [TOTPROVVAG2]             DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAG2RES]          DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO2]         DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO2RES]      DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [PROVVAG3]                VARCHAR (20)    DEFAULT ('') NULL,
    [TOTPROVVAG3]             DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAG3RES]          DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO3]         DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [TOTPROVVAGEURO3RES]      DECIMAL (19, 4) DEFAULT (0) NOT NULL,
    [NUMCOLLI]                DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [GENCONTROP]              VARCHAR (7)     DEFAULT ('') NULL,
    [VERSIONEDIBA]            VARCHAR (10)    DEFAULT ('') NULL,
    [PESONETTO]               DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [PESOLORDO]               DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [PESOLORDORES]            DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [PESOIMBALLO]             DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [SUPERFICIE]              DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [VOLUME]                  DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [ANNOTAZIONI]             VARCHAR (100)   DEFAULT ('') NULL,
    [NRPEZZIIMBALLO]          DECIMAL (16, 6) DEFAULT (0) NOT NULL,
    [CODIMBALLO]              VARCHAR (10)    DEFAULT ('') NULL,
    [NOMENCLCOMBINATA]        VARCHAR (8)     DEFAULT ('') NULL,
    [CONTOCDC]                VARCHAR (10)    DEFAULT ('') NULL,
    [CONTOCDCMOVCOLL]         VARCHAR (10)    DEFAULT ('') NULL,
    [ANNOINIZIOCOMP]          SMALLINT        DEFAULT (0) NULL,
    [ANNOFINECOMP]            SMALLINT        DEFAULT (0) NULL,
    [MESEINIZIOCOMP]          SMALLINT        DEFAULT (0) NULL,
    [MESEFINECOMP]            SMALLINT        DEFAULT (0) NULL,
    [RIGAPRELEVABILE]         SMALLINT        DEFAULT (1) NULL,
    [RIFGPSCONTO]             DECIMAL (10)    NULL,
    [RIFGPPREZZO]             DECIMAL (10)    NULL,
    [CAUSALEMAG]              DECIMAL (5)     NULL,
    [CODDEPOSITO]             VARCHAR (10)    DEFAULT ('') NULL,
    [CAUSALEMAGCOLL]          DECIMAL (5)     NULL,
    [CODDEPOSITOCOLL]         VARCHAR (10)    DEFAULT ('') NULL,
    [CAUSALEMAGCOMP]          DECIMAL (5)     NULL,
    [CODDEPCOMP]              VARCHAR (10)    DEFAULT ('') NULL,
    [CAUSALEMAGCOMPCOLL]      DECIMAL (5)     NULL,
    [CODDEPCOMPCOLL]          VARCHAR (10)    DEFAULT ('') NULL,
    [RIFCOMMCLI]              VARCHAR (30)    NULL,
    [NOMECOMMESSAPROD]        VARCHAR (30)    DEFAULT ('') NULL,
    [PROVENIENZAINTRA]        VARCHAR (3)     DEFAULT ('') NULL,
    [IDTESTARP]               DECIMAL (10)    NULL,
    [IDRIGARP]                INT             NULL,
    [RIGABLOCCATA]            SMALLINT        DEFAULT (0) NULL,
    [FLAGS]                   INT             DEFAULT (0) NULL,
    [UBICAZIONE]              VARCHAR (10)    DEFAULT ('') NULL,
    [UBICAZIONECOLL]          VARCHAR (10)    DEFAULT ('') NULL,
    [UBICAZIONECOMP]          VARCHAR (10)    DEFAULT ('') NULL,
    [UBICAZIONECOMPCOLL]      VARCHAR (10)    DEFAULT ('') NULL,
    [UTENTEMODIFICA]          VARCHAR (25)    NOT NULL,
    [DATAMODIFICA]            DATETIME        NOT NULL,
    [IDCONSEGNA]              VARCHAR (10)    NULL,
    [flgImpExp]               SMALLINT        NULL,
    [RifRelazioneCF]          VARCHAR (50)    DEFAULT ('') NULL,
    [RiportaDescPL]           SMALLINT        CONSTRAINT [DF_RIGHEDOCUMENTI_RIPORTADESCPL] DEFAULT (0) NULL,
    [NomeStampaConf]          VARCHAR (50)    NULL,
    [ANNOBOLLACLF]            SMALLINT        NULL,
    [NUMEROBOLLACLF]          INT             NULL,
    [OPERAZIONECLF]           VARCHAR (5)     NULL,
    [FLAGNETTIFICAMPS]        SMALLINT        NULL,
    [ORIGINEINTRA]            VARCHAR (2)     CONSTRAINT [DF_RIGHEDOC_ORIGINEINTRA] DEFAULT ('') NULL,
    [IMPTOTPROVVRIGA]         DECIMAL (19, 4) CONSTRAINT [DF_RIGHEDOCUMENTI_IMPTOTPROVVRIGA] DEFAULT (0) NOT NULL,
    [IMPTOTPROVVRIGARES]      DECIMAL (19, 4) CONSTRAINT [DF_RIGHEDOCUMENTI_IMPTOTPROVVRES] DEFAULT (0) NOT NULL,
    [TOTLORDOPREL]            DECIMAL (19, 4) CONSTRAINT [DF_RIGHEDOCUMENTI_TOTLORDOPREL] DEFAULT (0) NOT NULL,
    [IDCDC]                   VARCHAR (80)    CONSTRAINT [DF_RIGHEDOCUMENTI_IDCDC] DEFAULT ('') NULL,
    [QTAPLRES]                DECIMAL (16, 6) NULL,
    [DATABASEIE]              VARCHAR (15)    NULL,
    [IDTESTAIE]               DECIMAL (10)    NULL,
    [IDRIGAIE]                INT             NULL,
    [STATOOPERAZIONECLF]      SMALLINT        CONSTRAINT [DF_RIGHEDOCUMENTI_STATOOPERAZIONECLF] DEFAULT (0) NULL,
    [CAUSALEVERSAMENTOCLF]    DECIMAL (5)     CONSTRAINT [DF_RIGHEDOCUMENTI_CAUSALEVERSAMENTOCLF] DEFAULT (0) NULL,
    [CAUSALETRASFERIMENTOCLF] DECIMAL (5)     CONSTRAINT [DF_RIGHEDOCUMENTI_CAUSALETRASFERIMENTOCLF] DEFAULT (0) NULL,
    [COMPONENTEKIT]           SMALLINT        CONSTRAINT [DF_RIGHEDOCUMENTI_COMPONENTEKIT] DEFAULT (0) NULL,
    [NOTEMAG]                 VARCHAR (256)   NULL,
    [NOTECOMM]                VARCHAR (256)   NULL,
    [NOTEALTRO]               VARCHAR (256)   NULL,
    [DAPIANIFICARE]           SMALLINT        DEFAULT ((0)) NULL,
    [RIFCONTRATTO]            VARCHAR (50)    NULL,
    [DATACONSEGNARICHIESTA]   DATETIME        NULL,
    [DETTAGLIOSCONTI]         XML             NULL,
    [NOTEDOCALTERN]           VARCHAR (200)   NULL,
    [IDTESTAMB]               DECIMAL (10)    NULL,
    [GSTART62]                VARCHAR (1)     NULL,
    [TIPOLOGIERAGGR]          VARCHAR (7)     CONSTRAINT [DF_RIGHEDOCUMENTI_TIPOLOGIERAGGR] DEFAULT ('') NULL,
    [DATAINIZIOCOMP]          DATETIME        NULL,
    [DATAFINECOMP]            DATETIME        NULL,
    [IDTESTACP]               DECIMAL (10)    NULL,
    [IDRIGACP]                DECIMAL (10)    NULL,
    CONSTRAINT [PK_RIGHEDOCUMENTI] PRIMARY KEY CLUSTERED ([IDTESTA] ASC, [IDRIGA] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CHK_FLAGNETTIFICAMPS] CHECK ([FLAGNETTIFICAMPS] = 1 or [FLAGNETTIFICAMPS] = 0),
    CONSTRAINT [CHK_RD_flgImpExp] CHECK ([flgImpExp] is null or [flgImpExp] = 2 or [flgImpExp] = 1 or [flgImpExp] = 0),
    CONSTRAINT [CHK_RIGHEDOCUMENTI_TIPORIGA] CHECK ([TIPORIGA] = 'R' or ([TIPORIGA] = 'D' or ([TIPORIGA] = 'S' or ([TIPORIGA] = 'O' or [TIPORIGA] = 'N' or [TIPORIGA] = 'V')))),
    CONSTRAINT [CKC_QTA1MAGMAN_RIGHEDOC] CHECK ([QTA1MAGMAN] = 0 or [QTA1MAGMAN] = 1),
    CONSTRAINT [CKC_QTA2MAGMAN_RIGHEDOC] CHECK ([QTA2MAGMAN] = 0 or [QTA2MAGMAN] = 1),
    CONSTRAINT [CKC_QTAPREZZOMAN_RIGHEDOC] CHECK ([QTAPREZZOMAN] = 0 or [QTAPREZZOMAN] = 1),
    CONSTRAINT [CKC_RIGABLOCCATA_RIGHEDOC] CHECK ([RIGABLOCCATA] = 0 or [RIGABLOCCATA] = 1),
    CONSTRAINT [CKC_RIGACHIUSA_RIGHEDOC] CHECK ([RIGACHIUSA] = 0 or [RIGACHIUSA] = 1),
    CONSTRAINT [CKC_RIGAPRELEVABILE_RIGHEDOC] CHECK ([RIGAPRELEVABILE] = 2 or [RIGAPRELEVABILE] = 1 or [RIGAPRELEVABILE] = 0),
    CONSTRAINT [FK_RIGHEDOCUMENTI_IDTESTA] FOREIGN KEY ([IDTESTA]) REFERENCES [dbo].[TESTEDOCUMENTI] ([PROGRESSIVO]) ON DELETE CASCADE ON UPDATE CASCADE
);


GO
CREATE NONCLUSTERED INDEX [RIGHEDOC_CODART]
    ON [dbo].[RIGHEDOCUMENTI]([CODART] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [RIGHEDOC_IDRP]
    ON [dbo].[RIGHEDOCUMENTI]([IDTESTARP] ASC, [IDRIGARP] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [RIGHEDOCUMENTO_IDRP]
    ON [dbo].[RIGHEDOCUMENTI]([IDTESTARP] ASC, [IDRIGARP] ASC, [IDTESTA] ASC, [IDRIGA] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [Ald_RIGHEDOC_RicDocCommessa]
    ON [dbo].[RIGHEDOCUMENTI]([TIPODOC] ASC, [RIFCOMMCLI] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [RIGHEDOC_DSCART]
    ON [dbo].[RIGHEDOCUMENTI]([DESCRIZIONEART] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_RIGHEDOCUMENTI_1]
    ON [dbo].[RIGHEDOCUMENTI]([CODART] ASC, [CODDEPOSITO] ASC, [CAUSALEMAG] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_ORDINEFORNITORE_RIGHEDOCUMENTI_1]
    ON [dbo].[RIGHEDOCUMENTI]([ESERCIZIO] ASC)
    INCLUDE([IDTESTA], [CODART], [CAUSALEMAG], [CODDEPOSITO]);


GO
CREATE NONCLUSTERED INDEX [_dta_index_RIGHEDOCUMENTI_9_1872725724__K1_K96_K97]
    ON [dbo].[RIGHEDOCUMENTI]([IDTESTA] ASC, [IDTESTARP] ASC, [IDRIGARP] ASC);


GO

CREATE TRIGGER [dbo].[TD_RIGHEDOCUMENTI_CONSUMICLAV] ON [dbo].[RIGHEDOCUMENTI] FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    DELETE FROM ConsumiCLavorazione WHERE PROGRESSIVO IN (
        SELECT PROGRESSIVO
        FROM ConsumiCLavorazione CL INNER JOIN DELETED D ON D.IDTESTA=CL.IDTESTA_RESOCL AND D.IDRIGA=CL.IDRIGA_RESOCL
    )
    
    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

CREATE TRIGGER [dbo].[TD_RIGHEDOCUMENTIFORPRELEVATI] ON [dbo].[RIGHEDOCUMENTI] FOR DELETE AS

BEGIN
    
    DECLARE
       @NUMROWS  INT
 
       SELECT  @NUMROWS = @@ROWCOUNT
       IF @NUMROWS = 0
          RETURN    

       DELETE Tp_DocumentiPrelevati 
       FROM Tp_DocumentiPrelevati T2, DELETED T1         
       WHERE T2.PROGRESSIVO = T1.IDTESTA AND T2.IDRIGA = T1.IDRIGA
        

    RETURN
 

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR ('Errore Cancellazione RIGHEDOCUMENTIFORPRELEVATI.', 16, 1);
    ROLLBACK  TRANSACTION
END


GO



/*
    rif.s#3474 - aggiorno le quantit� legate tramite legami di produzione
*/
CREATE TRIGGER [dbo].[TD_RIGHEDOCUMENTI] ON [dbo].[RIGHEDOCUMENTI] FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)
    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    /*  DELETE ALL CHILDREN IN "STORICOMAG"  */
    DELETE STORICOMAG
    FROM   STORICOMAG T2, DELETED T1
    WHERE  T2.IDTESTA = T1.IDTESTA
     AND   T2.RIGADOC = T1.IDRIGA
     AND   T2.TIPOMOV BETWEEN 1 AND 4

    /* rif.s#3474 - aggiorno i legami di produzione */
    DECLARE @IDTESTADOC DECIMAL(10,0)
    DECLARE @IDRIGADOC INT
    DECLARE @QTAGEST DECIMAL(16,6)
    DECLARE @IDTESTALEG DECIMAL(10,0)
    DECLARE @IDRIGALEG INT
    DECLARE @IDIMPEGNOLEG INT
    DECLARE @TIPOLEGAME SMALLINT
    DECLARE CUR_LEGP CURSOR FAST_FORWARD READ_ONLY FOR
    SELECT 
        DELETED.IDTESTA AS IDTESTADOC
        ,DELETED.IDRIGA AS IDRIGADOC
        ,DELETED.QTAGEST
        ,LEG.IDTESTA AS IDTESTALEG
        ,LEG.IDRIGA AS IDRIGALEG
        ,LEG.IDIMPEGNO AS IDIMPEGNOLEG
        ,LEG.TIPOLEGAME
    FROM DELETED 
        INNER JOIN TABLEGAMIPRODUZIONE LEG ON LEG.RIFTESTA=DELETED.IDTESTA AND LEG.RIFRIGA=DELETED.IDRIGA AND LEG.TIPOLEGAME IN (8,9)
    OPEN CUR_LEGP
    FETCH NEXT FROM CUR_LEGP INTO @IDTESTADOC, @IDRIGADOC, @QTAGEST, @IDTESTALEG, @IDRIGALEG, @IDIMPEGNOLEG, @TIPOLEGAME
    WHILE @@FETCH_STATUS=0
    BEGIN
        IF (@TIPOLEGAME = 8)
        BEGIN
            -- aggiorno la quantit� ordinata del ciclo
            UPDATE RIGHECICLOORDINE
            SET QTATERZISTA=QTATERZISTA-@QTAGEST
            WHERE PROGRESSIVO=@IDTESTALEG AND NUMEROFASE=@IDRIGALEG
        END
        ELSE IF (@TIPOLEGAME = 9)
        BEGIN
            -- aggiorno la quantit� trasferita di fase
            UPDATE RIGHECICLOORDINE
            SET QTATRASFERITA=QTATRASFERITA-@QTAGEST
            WHERE PROGRESSIVO=@IDTESTALEG AND NUMEROFASE=@IDRIGALEG
        END

        FETCH NEXT FROM CUR_LEGP INTO @IDTESTADOC, @IDRIGADOC, @QTAGEST, @IDTESTALEG, @IDRIGALEG, @IDIMPEGNOLEG, @TIPOLEGAME
    END
    CLOSE CUR_LEGP
    DEALLOCATE CUR_LEGP


    /* DELETE ALL CHILDREN IN "TABLEGAMIPRODUZIONE" */
    DELETE TABLEGAMIPRODUZIONE
    FROM   TABLEGAMIPRODUZIONE T2, DELETED T1
    WHERE  T2.RIFTESTA = T1.IDTESTA AND T2.RIFRIGA = T1.IDRIGA AND TIPOLEGAME IN (1,3,4,8,9)
    
    DELETE TABLEGAMIPRODUZIONE
    FROM   TABLEGAMIPRODUZIONE T2, DELETED T1
    WHERE  T2.IDTESTA = T1.IDTESTA AND T2.IDRIGA = T1.IDRIGA AND TIPOLEGAME IN (6,7)
    
    RETURN
/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[RIGHEDOCUMENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[RIGHEDOCUMENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[RIGHEDOCUMENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[RIGHEDOCUMENTI] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[RIGHEDOCUMENTI] TO [Metodo98]
    AS [dbo];

