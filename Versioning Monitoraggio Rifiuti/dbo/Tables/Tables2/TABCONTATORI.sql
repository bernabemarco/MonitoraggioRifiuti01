CREATE TABLE [dbo].[TABCONTATORI] (
    [ESERCIZIO]        DECIMAL (5)  NOT NULL,
    [CODICE]           DECIMAL (5)  NOT NULL,
    [DESCRIZIONE]      VARCHAR (25) NULL,
    [PROGR]            DECIMAL (10) NOT NULL,
    [CONTINUA]         SMALLINT     DEFAULT (0) NULL,
    [UTENTEMODIFICA]   VARCHAR (25) NOT NULL,
    [DATAMODIFICA]     DATETIME     NOT NULL,
    [ContIVAAnnoNuovo] DECIMAL (5)  NULL,
    [AldSezionale]     VARCHAR (1)  DEFAULT ('') NULL,
    [TIPVAR]           SMALLINT     DEFAULT ((0)) NULL,
    CONSTRAINT [PK_TABCONTATORI] PRIMARY KEY CLUSTERED ([ESERCIZIO] ASC, [CODICE] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CKC_CONTINUA_TABCONTA] CHECK ([CONTINUA] = 0 or [CONTINUA] = 1)
);


GO


CREATE TRIGGER TD_TABCONTATORI ON TABCONTATORI FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN
    
    /* CANNOT DELETE PARENT "TABCONTATORI" IF CHILDREN STILL EXIST IN "TABTIPOLOGIE"  */
    IF EXISTS (SELECT 1
               FROM   TABTIPOLOGIE T2, DELETED T1
               WHERE  T2.CODICE_CONTATORE = T1.CODICE AND T2.TIP_CONTATORE=1)
       BEGIN
          SELECT @ERRMSG = 'Children still exist in "TABTIPOLOGIE". Cannot delete parent "TABCONTATORI".'
          GOTO ERROR
       END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END


GO
GRANT DELETE
    ON OBJECT::[dbo].[TABCONTATORI] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[TABCONTATORI] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[TABCONTATORI] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[TABCONTATORI] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[TABCONTATORI] TO [Metodo98]
    AS [dbo];

