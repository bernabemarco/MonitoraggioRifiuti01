CREATE TABLE [dbo].[TESTEORDINIPROD] (
    [PROGRESSIVO]             DECIMAL (10)    NOT NULL,
    [ESERCIZIO]               DECIMAL (5)     NOT NULL,
    [TIPOCOM]                 VARCHAR (3)     NOT NULL,
    [NUMEROCOM]               INT             NOT NULL,
    [DATAEMISSIONE]           DATETIME        NULL,
    [DATAINIZIOPIANO]         DATETIME        NULL,
    [DATAFINEPIANO]           DATETIME        NULL,
    [PIANOPRODRIF]            VARCHAR (30)    NULL,
    [CODCLIENTE]              VARCHAR (7)     NULL,
    [ANNOTAZIONI]             VARCHAR (255)   NULL,
    [STATOCHIUSO]             SMALLINT        DEFAULT (0) NULL,
    [STATOBLOCCATO]           SMALLINT        DEFAULT (0) NULL,
    [TOTCOSTOMATPREV]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVINTPREV]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVESTPREV]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOINDPREV]         DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOSCARTOPREV]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOUNITORDPREV]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOTOTORDPREV]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOMATEFF]          DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVINTEFF]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVESTEFF]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOINDEFF]          DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOSCARTOEFF]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOUNITORDEFF]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOTOTORDEFF]       DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOMATPREVEURO]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVINTPREVEURO]  DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVESTPREVEURO]  DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOINDPREVEURO]     DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOSCARTOPREVEURO]  DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOUNITORDPREVEURO] DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOTOTORDPREVEURO]  DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOMATEFFEURO]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVINTEFFEURO]   DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOLAVESTEFFEURO]   DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOINDEFFEURO]      DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOSCARTOEFFEURO]   DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOUNITORDEFFEURO]  DECIMAL (19, 6) DEFAULT (0) NULL,
    [TOTCOSTOTOTORDEFFEURO]   DECIMAL (19, 6) DEFAULT (0) NULL,
    [DATAMODIFICA]            DATETIME        NOT NULL,
    [UTENTEMODIFICA]          VARCHAR (25)    NOT NULL,
    [RIFCOMMCLI]              VARCHAR (30)    NULL,
    [FLAGGESTIONECICLI]       SMALLINT        DEFAULT (0) NULL,
    CONSTRAINT [PK_TESTEORDINIPROD] PRIMARY KEY CLUSTERED ([PROGRESSIVO] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [CKC_STATOBLOCCATO_TESTEORD] CHECK ([STATOBLOCCATO] = 2 or [STATOBLOCCATO] = 1 or [STATOBLOCCATO] = 0),
    CONSTRAINT [CKC_STATOCHIUSO_TESTEORD] CHECK ([STATOCHIUSO] = 0 or [STATOCHIUSO] = 1)
);


GO

/*  INSERT TRIGGER "TI_TESTEORDINIPROD" FOR TABLE "TESTEORDINIPROD"  */
CREATE TRIGGER TI_TESTEORDINIPROD ON TESTEORDINIPROD FOR INSERT AS
BEGIN
    DECLARE
       @MAXCARD  INT,
       @NUMROWS  INT,
       @NUMNULL  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  PARENT "PARAMETRICOMMPROD" MUST EXIST WHEN INSERTING A CHILD IN "TESTEORDINIPROD"  */
    IF UPDATE(TIPOCOM)
    BEGIN
       IF (SELECT COUNT(*)
           FROM   PARAMETRICOMMPROD T1, INSERTED T2
           WHERE  T1.CODICE = T2.TIPOCOM) != @NUMROWS
          BEGIN
             SELECT @ERRNO  = 30002,
                    @ERRMSG = 'Parent does not exist in "PARAMETRICOMMPROD". Cannot create child in "TESTEORDINIPROD".'
             GOTO ERROR
          END
    END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  UPDATE TRIGGER "TU_TESTEORDINIPROD" FOR TABLE "TESTEORDINIPROD"  */
CREATE TRIGGER TU_TESTEORDINIPROD ON TESTEORDINIPROD FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  PARENT "PARAMETRICOMMPROD" MUST EXIST WHEN UPDATING A CHILD IN "TESTEORDINIPROD"  */
      IF UPDATE(TIPOCOM)
      BEGIN
         IF (SELECT COUNT(*)
             FROM   PARAMETRICOMMPROD T1, INSERTED T2
             WHERE  T1.CODICE = T2.TIPOCOM) != @NUMROWS
            BEGIN
               SELECT @ERRNO  = 30003,
                      @ERRMSG = '"PARAMETRICOMMPROD" does not exist. Cannot ALTER COLUMN child in "TESTEORDINIPROD".'
               GOTO ERROR
            END
      END
      
      /*  ALTER COLUMN PARENT CODE OF "TESTEORDINIPROD" FOR ALL CHILDREN IN "EXTRATESTECOMM"  */
      IF UPDATE(PROGRESSIVO)
      BEGIN
         UPDATE EXTRATESTECOMM
          SET   IDTESTA = I1.PROGRESSIVO
         FROM   EXTRATESTECOMM T2, INSERTED I1, DELETED D1
         WHERE  T2.IDTESTA = D1.PROGRESSIVO
          AND  (I1.PROGRESSIVO != D1.PROGRESSIVO)
      END
      
      /*  ALTER COLUMN PARENT CODE OF "TESTEORDINIPROD" FOR ALL CHILDREN IN "RIGHEORDPROD"  */
      IF UPDATE(PROGRESSIVO)
      BEGIN
         UPDATE RIGHEORDPROD
          SET   IDTESTA = I1.PROGRESSIVO
         FROM   RIGHEORDPROD T2, INSERTED I1, DELETED D1
         WHERE  T2.IDTESTA = D1.PROGRESSIVO
          AND  (I1.PROGRESSIVO != D1.PROGRESSIVO)
      END

      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  DELETE TRIGGER "TD_TESTEORDINIPROD" FOR TABLE "TESTEORDINIPROD"  */
CREATE TRIGGER TD_TESTEORDINIPROD ON TESTEORDINIPROD FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  DELETE ALL CHILDREN IN "EXTRATESTECOMM"  */
    DELETE EXTRATESTECOMM
    FROM   EXTRATESTECOMM T2, DELETED T1
    WHERE  T2.IDTESTA = T1.PROGRESSIVO
    
    /*  DELETE ALL CHILDREN IN "RIGHEORDPROD"  */
    DELETE RIGHEORDPROD
    FROM   RIGHEORDPROD T2, DELETED T1
    WHERE  T2.IDTESTA = T1.PROGRESSIVO

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[TESTEORDINIPROD] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[TESTEORDINIPROD] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[TESTEORDINIPROD] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[TESTEORDINIPROD] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[TESTEORDINIPROD] TO [Metodo98]
    AS [dbo];

