CREATE TABLE [dbo].[ANAGRAFICAARTICOLICOMM] (
    [CODICEART]                   VARCHAR (50)    NOT NULL,
    [ESERCIZIO]                   DECIMAL (5)     NOT NULL,
    [CODIVA]                      DECIMAL (5)     NULL,
    [SCONTO1]                     VARCHAR (10)    NULL,
    [SCONTO2]                     VARCHAR (10)    NULL,
    [SCONTO3]                     VARCHAR (10)    NULL,
    [GRUPPOPRZPART]               DECIMAL (5)     NULL,
    [GRUPPOPRVPART]               DECIMAL (5)     NULL,
    [PROVV]                       VARCHAR (10)    NULL,
    [BARCODE]                     VARCHAR (50)    NULL,
    [BARCODETYPE]                 SMALLINT        NULL,
    [BARCODESTRING]               VARCHAR (80)    NULL,
    [CODICEALT1]                  VARCHAR (50)    NULL,
    [CODICEALT2]                  VARCHAR (50)    NULL,
    [SCGENVENDITEITA]             VARCHAR (7)     NULL,
    [SCGENVENDITEEST]             VARCHAR (7)     NULL,
    [SCGENACQUISTIITA]            VARCHAR (7)     NULL,
    [SCGENACQUISTIEST]            VARCHAR (7)     NULL,
    [INESAURIMENTO]               SMALLINT        DEFAULT (0) NULL,
    [ESAURITO]                    SMALLINT        DEFAULT (0) NULL,
    [QTAMINCONS]                  DECIMAL (16, 6) DEFAULT (0) NULL,
    [USAPREZZIPART]               SMALLINT        DEFAULT (0) NULL,
    [UTENTEMODIFICA]              VARCHAR (25)    NOT NULL,
    [DATAMODIFICA]                DATETIME        NOT NULL,
    [FlagCauzioni]                SMALLINT        DEFAULT (0) NOT NULL,
    [FLGBARCODEGENDAPROCAUTOMSTD] SMALLINT        CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_FLGBARCODEGENDAPROCAUTOMSTD] DEFAULT (0) NULL,
    [OLDBARCODE]                  VARCHAR (50)    NULL,
    [OLDBARCODETYPE]              SMALLINT        NULL,
    [OLDBARCODESTRING]            VARCHAR (80)    NULL,
    [PEZZIPERPALLET]              DECIMAL (16, 6) CONSTRAINT [DF_ARTICOLI_PEZZIPERPALLET] DEFAULT (0) NULL,
    [EXPORTECOMMERCE]             SMALLINT        CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_EXPORTECOMMERCE] DEFAULT ((0)) NULL,
    [CODIVAINTRA]                 DECIMAL (5)     CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_CODIVAINTRA] DEFAULT ((0)) NULL,
    [AICFARMACO]                  VARCHAR (9)     CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_AICFARMACO] DEFAULT ('') NULL,
    [UMFARMACO]                   VARCHAR (10)    CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_UMFARMACO] DEFAULT ('') NULL,
    [TIPOCARBURANTE]              VARCHAR (10)    CONSTRAINT [DF_ANAGRAFICAARTICOLICOMM_TIPOCARBURANTE] DEFAULT ('') NULL,
    CONSTRAINT [PK_ANAGRAFICAARTICOLICOMM] PRIMARY KEY CLUSTERED ([CODICEART] ASC, [ESERCIZIO] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [Chk_FlagCauzioni] CHECK ([FlagCauzioni] = 1 or [FlagCauzioni] = 0),
    CONSTRAINT [CKC_ESAURITO_ANAGRAFI] CHECK ([ESAURITO] = 0 or [ESAURITO] = 1),
    CONSTRAINT [CKC_INESAURIMENTO_ANAGRAFI] CHECK ([INESAURIMENTO] = 0 or [INESAURIMENTO] = 1),
    CONSTRAINT [CKC_USAPREZZIPART_ANAGRAFI] CHECK ([USAPREZZIPART] = 0 or [USAPREZZIPART] = 1)
);


GO
CREATE NONCLUSTERED INDEX [BARCODE]
    ON [dbo].[ANAGRAFICAARTICOLICOMM]([BARCODE] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [ALTERNATIVO1]
    ON [dbo].[ANAGRAFICAARTICOLICOMM]([CODICEALT1] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [ALTERNATIVO2]
    ON [dbo].[ANAGRAFICAARTICOLICOMM]([CODICEALT2] ASC) WITH (FILLFACTOR = 90);


GO
CREATE NONCLUSTERED INDEX [IDX_ORF_ANAGRAFICAARTICOLICOMM_CMP_1]
    ON [dbo].[ANAGRAFICAARTICOLICOMM]([ESERCIZIO] ASC, [GRUPPOPRZPART] ASC)
    INCLUDE([CODICEART]);


GO

/*  INSERT TRIGGER "TI_ANAGRAFICAARTICOLICOMM" FOR TABLE "ANAGRAFICAARTICOLICOMM"  */
CREATE TRIGGER TI_ANAGRAFICAARTICOLICOMM ON ANAGRAFICAARTICOLICOMM FOR INSERT AS
BEGIN
    DECLARE
       @MAXCARD  INT,
       @NUMROWS  INT,
       @NUMNULL  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  PARENT "ANAGRAFICAARTICOLI" MUST EXIST WHEN INSERTING A CHILD IN "ANAGRAFICAARTICOLICOMM"  */
    IF UPDATE(CODICEART)
    BEGIN
       IF (SELECT COUNT(*)
           FROM   ANAGRAFICAARTICOLI T1, INSERTED T2
           WHERE  T1.CODICE = T2.CODICEART) != @NUMROWS
          BEGIN
             SELECT @ERRNO  = 30002,
                    @ERRMSG = 'Parent does not exist in "ANAGRAFICAARTICOLI". Cannot create child in "ANAGRAFICAARTICOLICOMM".'
             GOTO ERROR
          END
    END

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  UPDATE TRIGGER "TU_ANAGRAFICAARTICOLICOMM" FOR TABLE "ANAGRAFICAARTICOLICOMM"  */
CREATE TRIGGER TU_ANAGRAFICAARTICOLICOMM ON ANAGRAFICAARTICOLICOMM FOR UPDATE AS
BEGIN
   DECLARE
      @MAXCARD  INT,
      @NUMROWS  INT,
      @NUMNULL  INT,
      @ERRNO    INT,
      @ERRMSG   VARCHAR(255)

      SELECT  @NUMROWS = @@ROWCOUNT
      IF @NUMROWS = 0
         RETURN

      
      /*  PARENT "ANAGRAFICAARTICOLI" MUST EXIST WHEN UPDATING A CHILD IN "ANAGRAFICAARTICOLICOMM"  */
      IF UPDATE(CODICEART)
      BEGIN
         IF (SELECT COUNT(*)
             FROM   ANAGRAFICAARTICOLI T1, INSERTED T2
             WHERE  T1.CODICE = T2.CODICEART) != @NUMROWS
            BEGIN
               SELECT @ERRNO  = 30003,
                      @ERRMSG = '"ANAGRAFICAARTICOLI" does not exist. Cannot modify child in "ANAGRAFICAARTICOLICOMM".'
               GOTO ERROR
            END
      END
      
      /*  MODIFY PARENT CODE OF "ANAGRAFICAARTICOLICOMM" FOR ALL CHILDREN IN "CONTROPARTARTICOLI"  */
      IF UPDATE(CODICEART) OR
         UPDATE(ESERCIZIO)
      BEGIN
         UPDATE CONTROPARTARTICOLI
          SET   CODART = I1.CODICEART,
                ESERCIZIO = I1.ESERCIZIO
         FROM   CONTROPARTARTICOLI T2, INSERTED I1, DELETED D1
         WHERE  T2.CODART = D1.CODICEART
          AND   T2.ESERCIZIO = D1.ESERCIZIO
          AND  (I1.CODICEART != D1.CODICEART OR
                I1.ESERCIZIO != D1.ESERCIZIO)
      END

      RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO

/*  DELETE TRIGGER "TD_ANAGRAFICAARTICOLICOMM" FOR TABLE "ANAGRAFICAARTICOLICOMM"  */
CREATE TRIGGER TD_ANAGRAFICAARTICOLICOMM ON ANAGRAFICAARTICOLICOMM FOR DELETE AS
BEGIN
    DECLARE
       @NUMROWS  INT,
       @ERRNO    INT,
       @ERRMSG   VARCHAR(255)

    SELECT  @NUMROWS = @@ROWCOUNT
    IF @NUMROWS = 0
       RETURN

    
    /*  DELETE ALL CHILDREN IN "CONTROPARTARTICOLI"  */
    DELETE CONTROPARTARTICOLI
    FROM   CONTROPARTARTICOLI T2, DELETED T1
    WHERE  T2.CODART = T1.CODICEART
     AND   T2.ESERCIZIO = T1.ESERCIZIO

    RETURN

/*  ERRORS HANDLING  */
ERROR:
    RAISERROR (@ERRMSG, 1, 1)
    ROLLBACK  TRANSACTION
END

GO
GRANT DELETE
    ON OBJECT::[dbo].[ANAGRAFICAARTICOLICOMM] TO [Metodo98]
    AS [dbo];


GO
GRANT INSERT
    ON OBJECT::[dbo].[ANAGRAFICAARTICOLICOMM] TO [Metodo98]
    AS [dbo];


GO
GRANT REFERENCES
    ON OBJECT::[dbo].[ANAGRAFICAARTICOLICOMM] TO [Metodo98]
    AS [dbo];


GO
GRANT SELECT
    ON OBJECT::[dbo].[ANAGRAFICAARTICOLICOMM] TO [Metodo98]
    AS [dbo];


GO
GRANT UPDATE
    ON OBJECT::[dbo].[ANAGRAFICAARTICOLICOMM] TO [Metodo98]
    AS [dbo];

