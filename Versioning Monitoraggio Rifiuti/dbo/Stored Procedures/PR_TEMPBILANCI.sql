CREATE PROCEDURE PR_TEMPBILANCI(@strW NVARCHAR(1000), @Esercizio SMALLINT, @IncludiSI SMALLINT, @NTerm SMALLINT, @DareAvere SMALLINT) AS
BEGIN
  DECLARE @SQL NVARCHAR(2000) 
  DECLARE @TIPOSI SMALLINT
  DECLARE @STRWHERE NVARCHAR(1000)
    
  --Nel caso di campi data rimetto un apice singolo, altrimenti và in errore la query
  SET @STRWHERE = Replace(@strW, '{d '+char(39)+char(39), '{d '+char(39))
  SET @STRWHERE = Replace(@STRWHERE, char(39)+char(39)+'}', char(39)+'}')

  /* CREO UNA TABELLA TEMPORANEA SQL PER I DATI INTERMEDI */
  CREATE TABLE #TEMPSALDIBILANCIOCONTI
  (
      CODMASTRO          DECIMAL(5, 0) NOT NULL,
      CODCONTO           VARCHAR(7) NOT NULL,
      SALDO              DECIMAL(19, 4) DEFAULT 0,
      SALDOEURO          DECIMAL(19, 4) DEFAULT 0,
      DAREAVERE          SMALLINT NOT NULL,
      CONSTRAINT PK_TEMPSALDIBILANCIOCONTI PRIMARY KEY (CODMASTRO,CODCONTO,DAREAVERE),
  )

  /* DETERMINO IL TIPO DI SALDOINIZIALE E LA VISTA DA USARE */
  DECLARE CURCONT CURSOR FOR
  SELECT Progressivo FROM TesteContabilita WHERE Causale=(SELECT CausContAP FROM TabVincoliGIC WHERE Esercizio=@Esercizio) AND Esercizio=@Esercizio
  OPEN CURCONT
  
  FETCH NEXT FROM CURCONT 
  
  IF @@FETCH_STATUS = 0
     SET @TIPOSI=1
  ELSE
     BEGIN
        CLOSE CURCONT
	DEALLOCATE CURCONT
  
        DECLARE CURCONT CURSOR FOR
        SELECT Progressivo FROM TesteContabilita WHERE Causale=(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=@Esercizio) AND Esercizio=@Esercizio-1
	OPEN CURCONT
  
	FETCH NEXT FROM CURCONT 
  
  	IF @@FETCH_STATUS = 0
  	   SET @TIPOSI=2
  	ELSE
  	   SET @TIPOSI=3
     END
     
  IF @TIPOSI<>1
     CLOSE CURCONT
     
  DEALLOCATE CURCONT

  DECLARE @NOMEVISTA NVARCHAR(20)
  
  SET @NOMEVISTA='VISTABILANCI' + CAST(@TIPOSI AS NVARCHAR(1))
  
  
  /* INSERISCO I DATI PARZIALI CON I SALDI PER CONTO */
  SET @SQL = 'INSERT INTO #TEMPSALDIBILANCIOCONTI (CODMASTRO,CODCONTO,SALDO,SALDOEURO,DAREAVERE) '
  
  IF @IncludiSI=0   -- IncludiSI contiene l'indice del combo del filtro, quindi se zero significa Includi Saldi Iniziali=SI
     SET @SQL = @SQL + 'SELECT CODMASTRO,CODCONTO,(SUM(CASE WHEN SALDO IS NULL THEN 0 ELSE SALDO END) + SUM(CASE WHEN DARE IS NULL THEN 0 ELSE DARE END) - SUM(CASE WHEN AVERE IS NULL THEN 0 ELSE AVERE END)),(SUM(CASE WHEN SALDOEURO IS NULL THEN 0 ELSE SALDOEURO END) + SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)),' + CAST(@DAREAVERE AS NVARCHAR(1)) + ' FROM ' + @NOMEVISTA + ' VISTABILANCI WHERE ' + @STRWHERE
  ELSE
     SET @SQL = @SQL + 'SELECT CODMASTRO,CODCONTO,(SUM(CASE WHEN DARE IS NULL THEN 0 ELSE DARE END) - SUM(CASE WHEN AVERE IS NULL THEN 0 ELSE AVERE END)),(SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)),' + CAST(@DAREAVERE AS NVARCHAR(1)) + ' FROM ' + @NOMEVISTA + ' VISTABILANCI WHERE ' + @STRWHERE
     
  SET @SQL = @SQL + ' GROUP BY CODMASTRO,CODCONTO'

  IF @IncludiSI=0
     BEGIN
        IF @DAREAVERE = 0    -- 0=Dare 1=Avere
           SET @SQL = @SQL + ' HAVING (SUM(CASE WHEN SALDOEURO IS NULL THEN 0 ELSE SALDOEURO END) + SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)) > 0'
        ELSE
           SET @SQL = @SQL + ' HAVING (SUM(CASE WHEN SALDOEURO IS NULL THEN 0 ELSE SALDOEURO END) + SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)) < 0'
     END
  ELSE
     BEGIN
        IF @DAREAVERE = 0 
           SET @SQL = @SQL + ' HAVING (SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)) > 0'
        ELSE
           SET @SQL = @SQL + ' HAVING (SUM(CASE WHEN DAREEURO IS NULL THEN 0 ELSE DAREEURO END) - SUM(CASE WHEN AVEREEURO IS NULL THEN 0 ELSE AVEREEURO END)) < 0'
     END
  
  EXEC(@SQL)
  
  /* INSERISCO I DATI EFFETTIVI CON I SALDI PER MASTRO */
  SET @SQL = 'INSERT INTO TEMPSALDIBILANCIO (CODMASTRO,SALDO,SALDOEURO,NRTERMINALE,DAREAVERE) '
  SET @SQL = @SQL + 'SELECT CODMASTRO,SUM(SALDO),SUM(SALDOEURO),' + CAST(@NTerm AS NVARCHAR(5)) + ',' + CAST(@DAREAVERE AS NVARCHAR(1)) 
  SET @SQL = @SQL + ' FROM #TEMPSALDIBILANCIOCONTI GROUP BY CODMASTRO'
  
  EXEC(@SQL)
END

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[PR_TEMPBILANCI] TO [Metodo98]
    AS [dbo];

