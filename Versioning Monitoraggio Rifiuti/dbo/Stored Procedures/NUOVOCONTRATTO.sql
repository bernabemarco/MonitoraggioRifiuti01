
CREATE PROCEDURE [dbo].[NUOVOCONTRATTO] @PESERCIZIO DECIMAL(5), @PUTENTE VARCHAR(25), @PAGGIORNA SMALLINT, @PPROGRESSIVO VARCHAR(13) OUTPUT AS
BEGIN
  DECLARE @PP       DECIMAL(10);
  DECLARE @SIGLASOCIETA VARCHAR(2)

  SET @PP=-1
  SET @PPROGRESSIVO = ''
  SET @SIGLASOCIETA = ''

  IF @PAGGIORNA=0
  BEGIN
    DECLARE CUR_ICONT CURSOR FOR
    SELECT  PROGR,SIGLASOCIETA
    FROM  TABCONTATORI JOIN GEM_TabParametriAziendaGemma ON (CODICE=CONTATORECONTRATTI and ESERCIZIO=@PESERCIZIO)

    OPEN CUR_ICONT FETCH NEXT FROM CUR_ICONT INTO @PP,@SIGLASOCIETA

      IF @@FETCH_STATUS<>0   SET  @PP = 0

      SET @PP=@PP + 1
      SET @PPROGRESSIVO = cast(@PESERCIZIO AS VARCHAR(4))+'-'+right('000000'+cast(@PP as varchar(6)),6)+@SIGLASOCIETA

    CLOSE CUR_ICONT
    DEALLOCATE CUR_ICONT
  END
      ELSE
      BEGIN
    DECLARE CUR_ICONT CURSOR SCROLL SCROLL_LOCKS FOR
          SELECT  PROGR,SIGLASOCIETA
    FROM  TABCONTATORI JOIN GEM_TabParametriAziendaGemma ON (CODICE=CONTATORECONTRATTI and ESERCIZIO=@PESERCIZIO)
          FOR UPDATE

    OPEN CUR_ICONT FETCH FROM CUR_ICONT INTO @PP,@SIGLASOCIETA

      IF @@FETCH_STATUS<>0  SELECT @PP = 0

      SET @PP = @PP + 1
      SET @PPROGRESSIVO = cast(@PESERCIZIO AS VARCHAR(4))+'-'+right('000000'+cast(@PP as varchar(6)),6)+@SIGLASOCIETA

      UPDATE  TABCONTATORI
      SET   PROGR = @PP, UTENTEMODIFICA = @PUTENTE, DATAMODIFICA = GETDATE()
      WHERE CURRENT OF CUR_ICONT

    CLOSE CUR_ICONT
    DEALLOCATE CUR_ICONT
  END
print @PPROGRESSIVO
END

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[NUOVOCONTRATTO] TO [Metodo98]
    AS [dbo];

