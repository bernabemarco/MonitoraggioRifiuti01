CREATE PROCEDURE VISTAUNIONSCADENZE AS
SELECT TIPOREC=1,SC.PROGRESSIVO,
  SC.ESERCIZIO,
  SC.ANNODOC,
  SC.TIPODOC,

  SC.NUMDOC,
  SC.BIS,
  SC.NUMSCAD,
  SC.DATASCADENZA,
  SC.CODCLIFOR,
  SC.DATAFATTURA,
  SC.BANCAINC,
  SC.BANCAAPPOGGIO,
  SC.NUMRIF,
  SC.NUMEROPROT,
  SC.CODAGE1,
  SC.CODAGE2,
  SC.CODAGE3,
  SC.IMPPROVLIT1,
  SC.IMPPROVLIT2,
  SC.IMPPROVLIT3,
  SC.IMPPROVVAL1,
  SC.IMPPROVVAL2,
  SC.IMPPROVVAL3,
  SC.IMPPROVEURO1,
  SC.IMPPROVEURO2,
  SC.IMPPROVEURO3,
  SC.LIQPROV1,
  SC.LIQPROV2,SC.LIQPROV3,
  SC.IMPORTOSCLIT,
  SC.IMPORTOSCVAL,
  SC.IMPORTOSCEURO,SC.IMPONIBSCLIT,SC.IMPONIBSCVAL,
  SC.IMPONIBSCEURO,
  SC.TOTFATTLIT,
  SC.TOTFATTVAL,
  SC.TOTFATTEURO,
  SC.IMPFATTLIT,
  SC.IMPFATTVAL,
  SC.IMPFATTEURO,
  SC.FLAGCONT,SC.TIPOEFFETTO,
  SC.ESITO,
  SC.LIVSOLL,
  SC.LIQINS1,SC.LIQINS2,
  SC.LIQINS3,
  SC.CODCAMBIO,
  SC.VALCAMBIO,
  SC.NRDISTINTA,
  SC.NUMRAGGR,
  SC.DATAPAGEFF,
  SC.SCADATTPASS,
  SC.NUMRIFPARTCONT,SC.CODPAG,
  SC.DATADEC,
  SC.NOTE,
  SC.NRGIORNALE,
  SC.UTENTEMODIFICA,
  SC.DATAMODIFICA,
  EFFETTO=(SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SC.TIPOEFFETTO),
  ATTPASS=(CASE WHEN((SC.SCADATTPASS<>0 AND SUBSTRING(CODCLIFOR,1,1)<>'C') OR (SC.SCADATTPASS=0 AND SUBSTRING(CODCLIFOR,1,1)='C')) THEN -1 ELSE 1 END),TDOC=' ',
  MESE=MONTH(SC.DATASCADENZA),
  SALDOBANCA=(SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SC.NRGIORNALE AND PROVVISORIO=0),
  SALDOBANCAVALUTA=(SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SC.NRGIORNALE AND PROVVISORIO=0),
  SALDOBANCAEURO=(SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SC.NRGIORNALE AND PROVVISORIO=0)
  FROM TABSCADENZE SC
UNION ALL
  SELECT TIPOREC=2,SP.PROGRESSIVO,
  SP.ESERCIZIO,
  SP.ANNODOC,
  SP.TIPODOC,
  SP.NUMDOC,
  SP.BIS,
  SP.NUMSCAD,
  SP.DATASCADENZA,
  SP.CODCLIFOR,
  SP.DATAFATTURA,
  SP.BANCAINC,
  SP.BANCAAPPOGGIO,
  SP.NUMRIF,
  SP.NUMEROPROT,
  SP.CODAGE1,
  SP.CODAGE2,
  SP.CODAGE3,
  SP.IMPPROVLIT1,
  SP.IMPPROVLIT2,
  SP.IMPPROVLIT3,
  SP.IMPPROVVAL1,
  SP.IMPPROVVAL2,
  SP.IMPPROVVAL3,
  SP.IMPPROVEURO1,
  SP.IMPPROVEURO2,
  SP.IMPPROVEURO3,
  SP.LIQPROV1,
  SP.LIQPROV2,SP.LIQPROV3,
  SP.IMPORTOSCLIT,
  SP.IMPORTOSCVAL,
  SP.IMPORTOSCEURO,SP.IMPONIBSCLIT,SP.IMPONIBSCVAL,
  SP.IMPONIBSCEURO,
  SP.TOTFATTLIT,
  SP.TOTFATTVAL,
  SP.TOTFATTEURO,
  SP.IMPFATTLIT,
  SP.IMPFATTVAL,
  SP.IMPFATTEURO,
  SP.FLAGCONT,SP.TIPOEFFETTO,
  SP.ESITO,
  SP.LIVSOLL,
  SP.LIQINS1,SP.LIQINS2,
  SP.LIQINS3,
  SP.CODCAMBIO,
  SP.VALCAMBIO,
  SP.NRDISTINTA,
  SP.NUMRAGGR,
  SP.DATAPAGEFF,
  SP.SCADATTPASS,
  SP.NUMRIFPARTCONT,SP.CODPAG,
  SP.DATADEC,
  SP.NOTE,
  SP.NRGIORNALE,
  SP.UTENTEMODIFICA,
  SP.DATAMODIFICA,
  EFFETTO=(SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SP.TIPOEFFETTO),
  ATTPASS=(CASE WHEN((SP.SCADATTPASS<>0 AND SUBSTRING(CODCLIFOR,1,1)<>'C') OR (SP.SCADATTPASS=0 AND SUBSTRING(CODCLIFOR,1,1)='C')) THEN -1 ELSE 1 END),
  TDOC=(SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=SP.TIPODOC),
  MESE=MONTH(SP.DATASCADENZA),
  SALDOBANCA=(SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SP.NRGIORNALE AND PROVVISORIO=0),
  SALDOBANCAVALUTA=(SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SP.NRGIORNALE AND PROVVISORIO=0),
  SALDOBANCAEURO=(SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND NRGIORNALE=SP.NRGIORNALE AND PROVVISORIO=0)
  FROM SCADENZEPREVISIONALI SP


GRANT EXECUTE ON VISTAUNIONSCADENZE TO METODO98
