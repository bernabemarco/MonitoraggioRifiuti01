



CREATE PROCEDURE [dbo].[MYTHO_Merge] 
       -- Add the parameters for the stored procedure here
       @Oggetto int,
       @RecordChanged int=0 OUTPUT,
       @ErrorMessage VARCHAR(MAX)  =''  OUTPUT 
       

AS
BEGIN
      DECLARE @tableVar TABLE (MergeAction VARCHAR(20), InsertedID int, DeletedID  int)

       SET NOCOUNT ON;
       IF @Oggetto= 2
             BEGIN TRY
                    BEGIN TRAN [Tran2];


					EXEC MYTHO_SETCODUSER;


                    MERGE [MYTHO_UserEntities] AS T
                    USING [VISTA_MYTHO_Users_TMP] AS S
                    ON (T.[UserEntityId] = S.[IdUser]                  
                    
                    ) 
                    WHEN NOT MATCHED BY TARGET 
                           THEN INSERT([ActionCode]
										   ,[UserEntityId]
										   ,[Email]
                                           ,[ExecutedDate]
                                           ,[UserOxID]
                                           ,[BillingAddress]
                                           ,[BillingAddressFloor]
                                           ,[BillingAddressL1]
                                           ,[BillingAddressL2]
                                           ,[BillingAddressL3]
                                           ,[BillingAddressL4]
                                           ,[BillingAddressOtherInfo]
                                           ,[BillingAddressStreet]
                                           ,[BillingCellPhone]
                                           ,[BillingCity]
                                           ,[BillingCountryISOCode]
                                           ,[BillingCountryName]
                                           ,[BillingFax]
                                           ,[BillingPhone]
                                           ,[BillingState]
                                           ,[BillingZipCode]
                                           ,[BirthDate]
                                           ,[Category1Name]
                                           ,[Category1OxId]
                                           ,[Category1Language]
                                           ,[Category1ParentOxId]
                                           ,[Category2Name]
                                           ,[Category2OxId]
                                           ,[Category2Language]
                                           ,[Category2ParentOxId]
                                           ,[Category3Name]
                                           ,[Category3OxId]
                                           ,[Category3Language]
                                           ,[Category3ParentOxId]
                                           ,[Category4Name]
                                           ,[Category4OxId]
                                           ,[Category4Language]
                                           ,[Category4ParentOxId]
                                           ,[Comments]
                                           ,[Company]
                                           ,[CustomerAccount]
                                           ,[Discount]
                                           ,[DiscountGridCode]
                                           ,[FirstName]
                                           ,[LastName]
                                           ,[Password]
                                           ,[PriceIndex]
                                           ,[RewardPoints]
                                           ,[SalesRepCode]
                                           ,[ShippingAddress]
                                           ,[ShippingAddressBuilding]
                                           ,[ShippingAddressFloor]
                                           ,[ShippingAddressL1]
                                           ,[ShippingAddressL2]
                                           ,[ShippingAddressL3]
                                           ,[ShippingAddressL4]
                                           ,[ShippingAddressOtherInfo]
                                           ,[ShippingAddressStreet]
                                           ,[ShippingCity]
                                           ,[ShippingCompany]
                                           ,[ShippingCountryISOCode]
                                           ,[ShippingCountryName]
                                           ,[ShippingFirstName]
                                           ,[ShippingLastName]
                                           ,[ShippingPhone]
                                           ,[ShippingState]
                                           ,[ShippingTitle]
                                           ,[ShippingZipCode]
                                           ,[SubscribeToNewsLetters]
                                           ,[SubscribeToSMSCampaign]
                                           ,[UserLanguage]
                                           ,[VATNumber])
                                  VALUES( 1
										   ,S.[IdUser]
                                           ,S.[Email]
                                           ,S.[ExecutedDate]
                                           ,S.[UserOxID]
                                           ,S.[BillingAddress]
                                           ,S.[BillingAddressFloor]
                                           ,S.[BillingAddressL1]
                                           ,S.[BillingAddressL2]
                                           ,S.[BillingAddressL3]
                                           ,S.[BillingAddressL4]
                                           ,S.[BillingAddressOtherInfo]
                                           ,S.[BillingAddressStreet]
                                           ,S.[BillingCellPhone]
                                           ,S.[BillingCity]
                                           ,S.[BillingCountryISOCode]
                                           ,S.[BillingCountryName]
                                           ,S.[BillingFax]
                                           ,S.[BillingPhone]
                                           ,S.[BillingState]
                                           ,S.[BillingZipCode]
                                           ,S.[BirthDate]
                                           ,S.[Category1Name]
                                           ,S.[Category1OxId]
                                           ,S.[Category1Language]
                                           ,S.[Category1ParentOxId]
                                           ,S.[Category2Name]
                                           ,S.[Category2OxId]
                                           ,S.[Category2Language]
                                           ,S.[Category2ParentOxId]
                                           ,S.[Category3Name]
                                           ,S.[Category3OxId]
                                           ,S.[Category3Language]
                                           ,S.[Category3ParentOxId]
                                           ,S.[Category4Name]
                                           ,S.[Category4OxId]
                                           ,S.[Category4Language]
                                           ,S.[Category4ParentOxId]
                                           ,S.[Comments]
                                           ,S.[Company]
                                           ,S.[CustomerAccount]
                                           ,S.[Discount]
                                           ,S.[DiscountGridCode]
                                           ,S.[FirstName]
                                           ,S.[LastName]
                                           ,S.[Password]
                                           ,S.[PriceIndex]
                                           ,S.[RewardPoints]
                                           ,S.[SalesRepCode]
                                           ,S.[ShippingAddress]
                                           ,S.[ShippingAddressBuilding]
                                           ,S.[ShippingAddressFloor]
                                           ,S.[ShippingAddressL1]
                                           ,S.[ShippingAddressL2]
                                           ,S.[ShippingAddressL3]
                                           ,S.[ShippingAddressL4]
                                           ,S.[ShippingAddressOtherInfo]
                                           ,S.[ShippingAddressStreet]
                                           ,S.[ShippingCity]
                                           ,S.[ShippingCompany]
                                           ,S.[ShippingCountryISOCode]
                                           ,S.[ShippingCountryName]
                                           ,S.[ShippingFirstName]
                                           ,S.[ShippingLastName]
                                           ,S.[ShippingPhone]
                                           ,S.[ShippingState]
                                           ,S.[ShippingTitle]
                                           ,S.[ShippingZipCode]
                                           ,S.[SubscribeToNewsLetters]
                                           ,S.[SubscribeToSMSCampaign]
                                           ,S.[UserLanguage]
                                           ,S.[VATNumber]
                                           )
                           WHEN MATCHED 
                           --AND (T.[ExecutedDate] <> S.[ExecutedDate]
                           --                OR T.[UserOxID] <> S.[UserOxID]
                           --                OR T.[BillingAddress] <> S.[BillingAddress]
                           --                OR T.[BillingAddressFloor] <> S.[BillingAddressFloor]
                           --                OR T.[BillingAddressL1] <> S.[BillingAddressL1]
                           --                OR T.[BillingAddressL2] = S.[BillingAddressL2]
                           --                OR T.[BillingAddressL3] <> S.[BillingAddressL3]
                           --                OR T.[BillingAddressL4] <> S.[BillingAddressL4]
                           --                OR T.[BillingAddressOtherInfo] <> S.[BillingAddressOtherInfo]
                           --                OR T.[BillingAddressStreet] <> S.[BillingAddressStreet]
                           --                OR T.[BillingCellPhone] <> S.[BillingCellPhone]
                           --                OR T.[BillingCity] <> S.[BillingCity]
                           --                OR T.[BillingCountryISOCode] <> S.[BillingCountryISOCode]
                           --                OR T.[BillingCountryName] <> S.[BillingCountryName]
                           --                OR T.[BillingFax] <> S.[BillingFax]
                           --                OR T.[BillingPhone] <> S.[BillingPhone]
                           --                OR T.[BillingState] <> S.[BillingState]
                           --                OR T.[BillingZipCode] <> S.[BillingZipCode]
                           --                OR T.[BirthDate] <> S.[BirthDate]
                           --                OR T.[Category1Name] <> S.[Category1Name]
                           --                OR T.[Category1OxId] <> S.[Category1OxId]
                           --                OR T.[Category1Language] <> S.[Category1Language]
                           --                OR T.[Category1ParentOxId] <> S.[Category1ParentOxId]
                           --                OR T.[Category2Name] <> S.[Category2Name]
                           --                OR T.[Category2OxId] <> S.[Category2OxId]
                           --                OR T.[Category2Language] <> S.[Category2Language]
                           --                OR T.[Category2ParentOxId] <> S.[Category2ParentOxId]
                           --                OR T.[Category3Name] <> S.[Category3Name]
                           --                OR T.[Category3OxId] <> S.[Category3OxId]
                           --                OR T.[Category3Language] <> S.[Category3Language]
                           --                OR T.[Category3ParentOxId] <> S.[Category3ParentOxId]
                           --                OR T.[Category4Name] <> S.[Category4Name]
                           --                OR T.[Category4OxId] <> S.[Category4OxId]
                           --                OR T.[Category4Language] <> S.[Category4Language]
                           --                OR T.[Category4ParentOxId] <> S.[Category4ParentOxId]
                           --                OR T.[Comments] <> S.[Comments]
                           --                OR T.[Company] <> S.[Company]
                           --                OR T.[CustomerAccount] <> S.[CustomerAccount]
                           --                OR T.[Discount] <> S.[Discount]
                           --                OR T.[DiscountGridCode] <> S.[DiscountGridCode]
                           --                OR T.[FirstName] <> S.[FirstName]
                           --                OR T.[LastName] <> S.[LastName]
                           --                OR T.[Password] <> S.[Password]
                           --                OR T.[PriceIndex] <> S.[PriceIndex]
                           --                OR T.[RewardPoints] <> S.[RewardPoints]
                           --                OR T.[SalesRepCode] <> S.[SalesRepCode]
                           --                OR T.[ShippingAddress] <> S.[ShippingAddress]
                           --                OR T.[ShippingAddressBuilding] <> S.[ShippingAddressBuilding]
                           --                OR T .[ShippingAddressFloor] <> S .[ShippingAddressFloor]
                           --                OR T.[ShippingAddressL1] <> S.[ShippingAddressL1]
                           --                OR T.[ShippingAddressL2] <> S.[ShippingAddressL2]
                           --                OR T.[ShippingAddressL3] <> S.[ShippingAddressL3]
                           --                OR T.[ShippingAddressL4] <> S.[ShippingAddressL4]
                           --                OR T.[ShippingAddressOtherInfo] <> S.[ShippingAddressOtherInfo]
                           --                OR T.[ShippingAddressStreet] <> S.[ShippingAddressStreet]
                           --                OR T.[ShippingCity] <> S.[ShippingCity]
                           --                OR T.[ShippingCompany] <> S.[ShippingCompany]
                           --                OR T.[ShippingCountryISOCode] <> S.[ShippingCountryISOCode]
                           --                OR T.[ShippingCountryName] <> S.[ShippingCountryName]
                           --                OR T.[ShippingFirstName] <> S.[ShippingFirstName]
                           --                OR T.[ShippingLastName] <> S.[ShippingLastName]
                           --                OR T.[ShippingPhone] <> S.[ShippingPhone]
                           --                OR T.[ShippingState] <> S.[ShippingState]
                           --                OR T.[ShippingTitle] <> S.[ShippingTitle]
                           --                OR T.[ShippingZipCode] <> S.[ShippingZipCode]
                           --                OR T.[SubscribeToNewsLetters] <> S.[SubscribeToNewsLetters]
                           --                OR T.[SubscribeToSMSCampaign] <> S.[SubscribeToSMSCampaign]
                           --                OR T.[UserLanguage] <> S.[UserLanguage]
                           --                OR T.[VATNumber] <> S.[VATNumber])
                                  THEN UPDATE SET T.[ActionCode] = 2
                                                  ,T.[UserOxID] = NULL
												  ,T.[StatusCode] = NULL
												  ,T.[ErrorDetails] = NULL
												  ,T.[ExecutedDate] = NULL
                                                  ,T.[BillingAddress] = S.[BillingAddress]
                                                  ,T.[BillingAddressFloor] = S.[BillingAddressFloor]
                                                  ,T.[BillingAddressL1] = S.[BillingAddressL1]
                                                  ,T.[BillingAddressL2] = S.[BillingAddressL2]
                                                  ,T.[BillingAddressL3] = S.[BillingAddressL3]
                                                  ,T.[BillingAddressL4] = S.[BillingAddressL4]
                                                  ,T.[BillingAddressOtherInfo] = S.[BillingAddressOtherInfo]
                                                  ,T.[BillingAddressStreet] = S.[BillingAddressStreet]
                                                  ,T.[BillingCellPhone] = S.[BillingCellPhone]
                                                  ,T.[BillingCity] = S.[BillingCity]
                                                  ,T.[BillingCountryISOCode] = S.[BillingCountryISOCode]
                                                  ,T.[BillingCountryName] = S.[BillingCountryName]
                                                  ,T.[BillingFax] = S.[BillingFax]
                                                  ,T.[BillingPhone] = S.[BillingPhone]
                                                  ,T.[BillingState] = S.[BillingState]
                                                  ,T.[BillingZipCode] = S.[BillingZipCode]
                                                  ,T.[BirthDate] = S.[BirthDate]
                                                  ,T.[Category1Name] = S.[Category1Name]
                                                  ,T.[Category1OxId] = S.[Category1OxId]
                                                  ,T.[Category1Language] = S.[Category1Language]
                                                  ,T.[Category1ParentOxId] = S.[Category1ParentOxId]
                                                  ,T.[Category2Name] = S.[Category2Name]
                                                  ,T.[Category2OxId] = S.[Category2OxId]
                                                  ,T.[Category2Language] = S.[Category2Language]
                                                  ,T.[Category2ParentOxId] = S.[Category2ParentOxId]
                                                  ,T.[Category3Name] = S.[Category3Name]
                                                  ,T.[Category3OxId] = S.[Category3OxId]
                                                  ,T.[Category3Language] = S.[Category3Language]
                                                  ,T.[Category3ParentOxId] = S.[Category3ParentOxId]
                                                  ,T.[Category4Name] = S.[Category4Name]
                                                  ,T.[Category4OxId] = S.[Category4OxId]
                                                  ,T.[Category4Language] = S.[Category4Language]
                                                  ,T.[Category4ParentOxId] = S.[Category4ParentOxId]
                                                  ,T.[Comments] = S.[Comments]
                                                  ,T.[Company] = S.[Company]
                                                  ,T.[CustomerAccount] = S.[CustomerAccount]
                                                  ,T.[Discount] = S.[Discount]
                                                  ,T.[DiscountGridCode] = S.[DiscountGridCode]
                                                  ,T.[FirstName] = S.[FirstName]
                                                  ,T.[LastName] = S.[LastName]
                                                  ,T.[Password] = S.[Password]
                                                  ,T.[PriceIndex] = S.[PriceIndex]
                                                  ,T.[RewardPoints] = S.[RewardPoints]
                                                  ,T.[SalesRepCode] = S.[SalesRepCode]
                                                  ,T.[ShippingAddress] = S.[ShippingAddress]
                                                  ,T.[ShippingAddressBuilding] = S.[ShippingAddressBuilding]
                                                  ,T .[ShippingAddressFloor] = S .[ShippingAddressFloor]
                                                  ,T.[ShippingAddressL1] = S.[ShippingAddressL1]
                                                  ,T.[ShippingAddressL2] = S.[ShippingAddressL2]
                                                  ,T.[ShippingAddressL3] = S.[ShippingAddressL3]
                                                  ,T.[ShippingAddressL4] = S.[ShippingAddressL4]
                                                  ,T.[ShippingAddressOtherInfo] = S.[ShippingAddressOtherInfo]
                                                  ,T.[ShippingAddressStreet] = S.[ShippingAddressStreet]
                                                  ,T.[ShippingCity] = S.[ShippingCity]
                                                  ,T.[ShippingCompany] = S.[ShippingCompany]
                                                  ,T.[ShippingCountryISOCode] = S.[ShippingCountryISOCode]
                                                  ,T.[ShippingCountryName] = S.[ShippingCountryName]
                                                  ,T.[ShippingFirstName] = S.[ShippingFirstName]
                                                  ,T.[ShippingLastName] = S.[ShippingLastName]
                                                  ,T.[ShippingPhone] = S.[ShippingPhone]
                                                  ,T.[ShippingState] = S.[ShippingState]
                                                  ,T.[ShippingTitle] = S.[ShippingTitle]
                                                  ,T.[ShippingZipCode] = S.[ShippingZipCode]
                                                  ,T.[SubscribeToNewsLetters] = S.[SubscribeToNewsLetters]
                                                  ,T.[SubscribeToSMSCampaign] = S.[SubscribeToSMSCampaign]
                                                  ,T.[UserLanguage] = S.[UserLanguage]
                                                  ,T.[VATNumber] = S.[VATNumber]
                           WHEN NOT MATCHED BY SOURCE 
                                  THEN UPDATE SET T.[ActionCode] = 3
                           OUTPUT
                               $action, inserted.[UserEntityId] 'inserted', deleted.[UserEntityId] 'deleted' INTO @tableVar
                                          ;

                    SELECT @RecordChanged = COUNT(*) 
                    FROM @tableVar  
                    --GROUP BY MergeAction


                    COMMIT TRAN [Tran2]

             END TRY
             BEGIN CATCH
                           
                    ROLLBACK TRAN;
             END CATCH

       IF (@Oggetto= 1 OR @Oggetto = 3)
             BEGIN TRY
                    BEGIN TRAN [Tran1];

					EXEC MYTHO_SETSKU;

                    MERGE [MYTHO_ProductEntities] AS T
                    USING [VISTA_MYTHO_Articoli_TMP] AS S
                    ON (T.[ITEMSKU] = S.[ITEMSKU] 
                                          
                    
                    ) 
                    WHEN NOT MATCHED BY TARGET 
                           THEN INSERT([ITEMSKU]
										   ,[ProductEntityId]
                                           ,[ActionCode]
                                           ,[ExecutedDate]
                                           ,[ParentItemID]
                                           ,[ParentItemSKU]
                                           ,[ProductLanguage]
                                           ,[ProductType]
                                           ,[AdditionalImagesHeight]
                                           ,[AdditionalImagesThumbnailChangeMode]
                                           ,[AdditionalImagesThumbnailWidth]
                                           ,[AdditionalImagesWidth]
                                           ,[AdditionalImagesZoomHeight]
                                           ,[AdditionalImagesZoomPosition]
                                           ,[AdditionalImagesZoomWidth]
                                           ,[BigImageFileName]
                                           ,[BrandName]
                                           ,[BrandOxID]
                                           ,[CanonicalURLCustomizedContent]
                                           ,[Category1Name]
                                           ,[Category1OxId]
                                           ,[Category1Language]
                                           ,[Category1ParentOxId]
                                           ,[Category2Name]
                                           ,[Category2OxId]
                                           ,[Category2Language]
                                           ,[Category2ParentOxId]
                                           ,[Category3Name]
                                           ,[Category3OxId]
                                           ,[Category3Language]
                                           ,[Category3ParentOxId]
                                           ,[Cost]
                                           ,[DaysToShip]
                                           ,[Description]
                                           ,[DimensionHeight]
                                           ,[DimensionLength]
                                           ,[DimensionWidth]
                                           ,[DiscountGridCode]
                                           ,[EANCode]
                                           ,[EcotaxTI]
                                           ,[Guarantee]
                                           ,[HandlingSurcharge1ST]
                                           ,[HandlingSurchargeOthers]
                                           ,[ItemCondition]
                                           ,[LinkedItemID]
                                           ,[LinkedItemLanguage]
                                           ,[LinkedItemSKU]
                                           ,[LinkedUpdating]
                                           ,[LongDescription]
                                           ,[MetaDescription]
                                           ,[MetaKeywords]
                                           ,[MetaTitle]
                                           ,[MPN]
                                           ,[Name]
                                           ,[OptionIsDefault]
                                           ,[OptionTypes1OxId]
                                           ,[OptionTypes1Name]
                                           ,[OptionTypes1SystemName]
                                           ,[OptionTypes2OxId]
                                           ,[OptionTypes2Name]
                                           ,[OptionTypes2SystemName]
                                           ,[OptionTypes3OxId]
                                           ,[OptionTypes3Name]
                                           ,[OptionTypes3SystemName]
                                           ,[OptionValues1OxId]
                                           ,[OptionValues1Code]
                                           ,[OptionValues1Name]
                                           ,[OptionValues2OxId]
                                           ,[OptionValues2Code]
                                           ,[OptionValues2Name]
                                           ,[OptionValues3OxId]
                                           ,[OptionValues3Code]
                                           ,[OptionValues3Name]
                                           ,[Position]
                                           ,[PriceValue]
                                           ,[PriceVATIncluded]
                                           ,[Price1Value]
                                           ,[Price1VATIncluded]
                                           ,[Price2Value]
                                           ,[Price2VATIncluded]
                                           ,[Price3Value]
                                           ,[Price3VATIncluded]
                                           ,[Price4Value]
                                           ,[Price4VATIncluded]
                                           ,[ReviewCount]
                                           ,[ReviewRating]
                                           ,[QuantityInstockValue]
                                           ,[QuantityInstockAppend]
                                           ,[QuantityReorderValue]
                                           ,[QuantityReorderAppend]
                                           ,[SaleIfOutOfStock]
                                           ,[SaleIfOutOfStockScenario]
                                           ,[ShipPrice]
                                           ,[ShowDaysToship]
                                           ,[ShowIfOutOfStock]
                                           ,[ShowInStockNote]
                                           ,[ShowStockLevel]
                                           ,[SmallImgFileName]
                                           ,[StrikethroughPriceValue]
                                           ,[StrikethroughPriceVATIncluded]
                                           ,[StrikethroughPrice1Value]
                                           ,[StrikethroughPrice1VATIncluded]
                                           ,[StrikethroughPrice2Value]
                                           ,[StrikethroughPrice2VATIncluded]
                                           ,[StrikethroughPrice3Value]
                                           ,[StrikethroughPrice3VATIncluded]
                                           ,[StrikethroughPrice4Value]
                                           ,[StrikethroughPrice4VATIncluded]
                                           ,[TaxCountryISOCode]
                                           ,[TaxRate]
                                           ,[UnitsForSale]
                                           ,[UnitsForSale1]
                                           ,[UnitsForSale2]
                                           ,[UnitsForSale3]
                                           ,[UnitsForSale4]
                                           ,[Visible]
                                           ,[Weight] ) 
                           VALUES(S.[ITEMSKU]
										   ,S.[ProductEntityId]
                                           ,1
                                           ,S.[ExecutedDate]
                                           ,S.[ParentItemID]
                                           ,S.[ParentItemSKU]
                                           ,S.[ProductLanguage]
                                           ,S.[ProductType]
                                           ,S.[AdditionalImagesHeight]
                                           ,S.[AdditionalImagesThumbnailChangeMode]
                                           ,S.[AdditionalImagesThumbnailWidth]
                                           ,S.[AdditionalImagesWidth]
                                           ,S.[AdditionalImagesZoomHeight]
                                           ,S.[AdditionalImagesZoomPosition]
                                           ,S.[AdditionalImagesZoomWidth]
                                           ,S.[BigImageFileName]
                                           ,S.[BrandName]
                                           ,S.[BrandOxID]
                                           ,S.[CanonicalURLCustomizedContent]
                                           ,S.[Category1Name]
                                           ,S.[Category1OxId]
                                           ,S.[Category1Language]
                                           ,S.[Category1ParentOxId]
                                           ,S.[Category2Name]
                                           ,S.[Category2OxId]
                                           ,S.[Category2Language]
                                           ,S.[Category2ParentOxId]
                                           ,S.[Category3Name]
                                           ,S.[Category3OxId]
                                           ,S.[Category3Language]
                                           ,S.[Category3ParentOxId]
                                           ,S.[Cost]
                                           ,S.[DaysToShip]
                                           ,S.[Description]
                                           ,S.[DimensionHeight]
                                           ,S.[DimensionLength]
                                           ,S.[DimensionWidth]
                                           ,S.[DiscountGridCode]
                                           ,S.[EANCode]
                                           ,S.[EcotaxTI]
                                           ,S.[Guarantee]
                                           ,S.[HandlingSurcharge1ST]
                                           ,S.[HandlingSurchargeOthers]
                                           ,S.[ItemCondition]
                                           ,S.[LinkedItemID]
                                           ,S.[LinkedItemLanguage]
                                           ,S.[LinkedItemSKU]
                                           ,S.[LinkedUpdating]
                                           ,S.[LongDescription]
                                           ,S.[MetaDescription]
                                           ,S.[MetaKeywords]
                                           ,S.[MetaTitle]
                                           ,S.[MPN]
                                           ,S.[Name]
                                           ,S.[OptionIsDefault]
                                           ,S.[OptionTypes1OxId]
                                           ,S.[OptionTypes1Name]
                                           ,S.[OptionTypes1SystemName]
                                           ,S.[OptionTypes2OxId]
                                           ,S.[OptionTypes2Name]
                                           ,S.[OptionTypes2SystemName]
                                           ,S.[OptionTypes3OxId]
                                           ,S.[OptionTypes3Name]
                                           ,S.[OptionTypes3SystemName]
                                           ,S.[OptionValues1OxId]
                                           ,S.[OptionValues1Code]
                                           ,S.[OptionValues1Name]
                                           ,S.[OptionValues2OxId]
                                           ,S.[OptionValues2Code]
                                           ,S.[OptionValues2Name]
                                           ,S.[OptionValues3OxId]
                                           ,S.[OptionValues3Code]
                                           ,S.[OptionValues3Name]
                                           ,S.[Position]
                                           ,S.[PriceValue]
                                           ,S.[PriceVATIncluded]
                                           ,S.[Price1Value]
                                           ,S.[Price1VATIncluded]
                                           ,S.[Price2Value]
                                           ,S.[Price2VATIncluded]
                                           ,S.[Price3Value]
                                           ,S.[Price3VATIncluded]
                                           ,S.[Price4Value]
                                           ,S.[Price4VATIncluded]
                                           ,S.[ReviewCount]
                                           ,S.[ReviewRating]
                                           ,S.[QuantityInstockValue]
                                           ,S.[QuantityInstockAppend]
                                           ,S.[QuantityReorderValue]
                                           ,S.[QuantityReorderAppend]
                                           ,S.[SaleIfOutOfStock]
                                           ,S.[SaleIfOutOfStockScenario]
                                           ,S.[ShipPrice]
                                           ,S.[ShowDaysToship]
                                           ,S.[ShowIfOutOfStock]
                                           ,S.[ShowInStockNote]
                                           ,S.[ShowStockLevel]
                                           ,S.[SmallImgFileName]
                                           ,S.[StrikethroughPriceValue]
                                           ,S.[StrikethroughPriceVATIncluded]
                                           ,S.[StrikethroughPrice1Value]
                                           ,S.[StrikethroughPrice1VATIncluded]
                                           ,S.[StrikethroughPrice2Value]
                                           ,S.[StrikethroughPrice2VATIncluded]
                                           ,S.[StrikethroughPrice3Value]
                                           ,S.[StrikethroughPrice3VATIncluded]
                                           ,S.[StrikethroughPrice4Value]
                                           ,S.[StrikethroughPrice4VATIncluded]
                                           ,S.[TaxCountryISOCode]
                                           ,S.[TaxRate]
                                           ,S.[UnitsForSale]
                                           ,S.[UnitsForSale1]
                                           ,S.[UnitsForSale2]
                                           ,S.[UnitsForSale3]
                                           ,S.[UnitsForSale4]
                                           ,S.[Visible]
                                           ,S.[Weight])
                    WHEN MATCHED 
                           --AND ( T.[ExecutedDate] <> S.[ExecutedDate]
                           --                OR T.[ParentItemID] <> S.[ParentItemID]
                           --                OR T.[ParentItemSKU] <> S.[ParentItemSKU] 
                           --                OR T.[ProductLanguage] <> S.[ProductLanguage]
                           --                OR T.[ProductType] <> S.[ProductType]
                           --                OR T.[AdditionalImagesHeight] <> S.[AdditionalImagesHeight]
                           --                OR T.[AdditionalImagesThumbnailChangeMode] <> S.[AdditionalImagesThumbnailChangeMode]
                           --                OR T.[AdditionalImagesThumbnailWidth]  <> S.[AdditionalImagesThumbnailWidth] 
                           --                OR T.[AdditionalImagesWidth] <> S.[AdditionalImagesWidth]
                           --                OR T.[AdditionalImagesZoomHeight] <> S.[AdditionalImagesZoomHeight] 
                           --                OR T.[AdditionalImagesZoomPosition] <> S.[AdditionalImagesZoomPosition]
                           --                OR T.[AdditionalImagesZoomWidth] <> S.[AdditionalImagesZoomWidth] 
                           --                OR T.[BigImageFileName] <> S.[BigImageFileName] 
                           --                OR T.[BrandName] <> S.[BrandName]
                           --                OR T.[BrandOxID] <> S.[BrandOxID] 
                           --                OR T.[CanonicalURLCustomizedContent] <> S.[CanonicalURLCustomizedContent]
                           --                OR T.[Category1Name] <> S.[Category1Name]
                           --                OR T.[Category1OxId] <> S.[Category1OxId]
                           --                OR T.[Category1Language] <> S.[Category1Language] 
                           --                OR T.[Category1ParentOxId] <> S.[Category1ParentOxId]
                           --                OR T.[Category2Name] <> S.[Category2Name]
                           --                OR T.[Category2OxId] <> S.[Category2OxId]
                           --                OR T.[Category2Language] <> S.[Category2Language]
                           --                OR T.[Category2ParentOxId] <> S.[Category2ParentOxId]
                           --                OR T.[Category3Name] <> S.[Category3Name]
                           --                OR T.[Category3OxId] <> S.[Category3OxId]
                           --                OR T.[Category3Language] <> S.[Category3Language]
                           --                OR T.[Category3ParentOxId] <> S.[Category3ParentOxId]
                           --                OR T.[Cost] <> S.[Cost]
                           --                OR T.[DaysToShip] <> S.[DaysToShip]
                           --                OR T.[Description] <> S.[Description]
                           --                OR T.[DimensionHeight] <> S.[DimensionHeight]
                           --                OR T.[DimensionLength] <> S.[DimensionLength]
                           --                OR T.[DimensionWidth] <> S.[DimensionWidth]
                           --                OR T.[DiscountGridCode] <> S.[DiscountGridCode]
                           --                OR T.[EANCode] <> S.[EANCode]
                           --                OR T.[EcotaxTI] <> S.[EcotaxTI]
                           --                OR T.[Guarantee] <> S.[Guarantee]
                           --                OR T.[HandlingSurcharge1ST] <> S.[HandlingSurcharge1ST]
                           --                OR T.[HandlingSurchargeOthers] <> S.[HandlingSurchargeOthers]
                           --                OR T.[ItemCondition] <> S.[ItemCondition]
                           --                OR T.[LinkedItemID] <> S.[LinkedItemID]
                           --                OR T.[LinkedItemLanguage] <> S.[LinkedItemLanguage]
                           --                OR T.[LinkedItemSKU] <> S.[LinkedItemSKU]
                           --                OR T.[LinkedUpdating] <> S.[LinkedUpdating]
                           --                OR T.[LongDescription] <> S.[LongDescription]
                           --                OR T.[MetaDescription] <> S.[MetaDescription]
                           --                OR T.[MetaKeywords] <> S.[MetaKeywords]
                           --                OR T.[MetaTitle] <> S.[MetaTitle]
                           --                OR T.[MPN] <> S.[MPN]
                           --                OR T.[Name] <> S.[Name]
                           --                OR T.[OptionIsDefault] <> S.[OptionIsDefault]
                           --                OR T.[OptionTypes1OxId] <> S.[OptionTypes1OxId]
                           --                OR T.[OptionTypes1Name] <> S.[OptionTypes1Name]
                           --                OR T.[OptionTypes1SystemName] <> S.[OptionTypes1SystemName]
                           --                OR T.[OptionTypes2OxId] <> S.[OptionTypes2OxId]
                           --                OR T.[OptionTypes2Name] <> S.[OptionTypes2Name]
                           --                OR T.[OptionTypes2SystemName] <> S.[OptionTypes2SystemName]
                           --                OR T.[OptionTypes3OxId] <> S.[OptionTypes3OxId]
                           --                OR T.[OptionTypes3Name] <> S.[OptionTypes3Name]
                           --                OR T.[OptionTypes3SystemName] <> S.[OptionTypes3SystemName]
                           --                OR T.[OptionValues1OxId] <> S.[OptionValues1OxId]
                           --                OR T.[OptionValues1Code] <> S.[OptionValues1Code]
                           --                OR T.[OptionValues1Name] <> S.[OptionValues1Name]
                           --                OR T.[OptionValues2OxId] <> S.[OptionValues2OxId]
                           --                OR T.[OptionValues2Code] <> S.[OptionValues2Code]
                           --                OR T.[OptionValues2Name] <> S.[OptionValues2Name]
                           --                OR T.[OptionValues3OxId] <> S.[OptionValues3OxId]
                           --                OR T.[OptionValues3Code] <> S.[OptionValues3Code]
                           --                OR T.[OptionValues3Name] <> S.[OptionValues3Name]
                           --                OR T.[Position] <> S.[Position]
                           --                OR T.[PriceValue] <> S.[PriceValue]
                           --                OR T.[PriceVATIncluded] <> S.[PriceVATIncluded]
                           --                OR T.[Price1Value] <> S.[Price1Value]
                           --                OR T.[Price1VATIncluded] <> S.[Price1VATIncluded]
                           --                OR T.[Price2Value] <> S.[Price2Value]
                           --                OR T.[Price2VATIncluded] <> S.[Price2VATIncluded]
                           --                OR T.[Price3Value] <> S.[Price3Value]
                           --                OR T.[Price3VATIncluded] <> S.[Price3VATIncluded]
                           --                OR T.[Price4Value] <> S.[Price4Value]
                           --                OR T.[Price4VATIncluded] <> S.[Price4VATIncluded]
                           --                OR T.[ReviewCount] <> S.[ReviewCount]
                           --                OR T.[ReviewRating] <> S.[ReviewRating]
                           --                OR T.[QuantityInstockValue] <> S.[QuantityInstockValue]
                           --                OR T.[QuantityInstockAppend] <> S.[QuantityInstockAppend]
                           --                OR T.[QuantityReorderValue] <> S.[QuantityReorderValue]
                           --                OR T.[QuantityReorderAppend] <> S.[QuantityReorderAppend]
                           --                OR T.[SaleIfOutOfStock] <> S.[SaleIfOutOfStock]
                           --                OR T.[SaleIfOutOfStockScenario] <> S.[SaleIfOutOfStockScenario]
                           --                OR T.[ShipPrice] <> S.[ShipPrice]
                           --                OR T.[ShowDaysToship] <> S.[ShowDaysToship]
                           --                OR T.[ShowIfOutOfStock] <> S.[ShowIfOutOfStock]
                           --                OR T.[ShowInStockNote] <> S.[ShowInStockNote]
                           --                OR T.[ShowStockLevel] <> S.[ShowStockLevel]
                           --                OR T.[SmallImgFileName] <> S.[SmallImgFileName]
                           --                OR T.[StrikethroughPriceValue] <> S.[StrikethroughPriceValue]
                           --                OR T.[StrikethroughPriceVATIncluded] <> S.[StrikethroughPriceVATIncluded]
                           --                OR T.[StrikethroughPrice1Value] <> S.[StrikethroughPrice1Value]
                           --                OR T.[StrikethroughPrice1VATIncluded] <> S.[StrikethroughPrice1VATIncluded]
                           --                OR T.[StrikethroughPrice2Value] <> S.[StrikethroughPrice2Value]
                           --                OR T.[StrikethroughPrice2VATIncluded] <> S.[StrikethroughPrice2VATIncluded]
                           --                OR T.[StrikethroughPrice3Value] <> S.[StrikethroughPrice3Value]
                           --                OR T.[StrikethroughPrice3VATIncluded] <> S.[StrikethroughPrice3VATIncluded]
                           --                OR T.[StrikethroughPrice4Value] <> S.[StrikethroughPrice4Value]
                           --                OR T.[StrikethroughPrice4VATIncluded] <> S.[StrikethroughPrice4VATIncluded]
                           --                OR T.[TaxCountryISOCode] <> S.[TaxCountryISOCode]
                           --                OR T.[TaxRate] <> S.[TaxRate]
                           --                OR T.[UnitsForSale] <> S.[UnitsForSale]
                           --                OR T.[UnitsForSale1] <> S.[UnitsForSale1]
                           --                OR T.[UnitsForSale2] <> S.[UnitsForSale2]
                           --                OR T.[UnitsForSale3] <> S.[UnitsForSale3]
                           --                OR T.[UnitsForSale4] <> S.[UnitsForSale4]
                           --                OR T.[Visible] <> S.[Visible]
                           --                OR T.[Weight] <> S.[Weight])

--						   UPDATE dbo.Mytho_UserEntities SET 
 --StatusCode=NULL,
 --ExecutedDate=NULL,
 --ErrorDetails=NULL,
 --UserOxID=NULL

                           THEN UPDATE SET T.[ActionCode] = 2
										   ,T.[StatusCode] = NULL
										   ,T.[ErrorDetails] = NULL
                                           ,T.[ExecutedDate] = NULL
										   --,T.[ProductEntityID] = NULL
                                           ,T.[ParentItemID] = S.[ParentItemID]
                                           ,T.[ParentItemSKU] = S.[ParentItemSKU] 
                                           ,T.[ProductLanguage] = S.[ProductLanguage]
                                           ,T.[ProductType] = S.[ProductType]
                                           ,T.[AdditionalImagesHeight] = S.[AdditionalImagesHeight]
                                           ,T.[AdditionalImagesThumbnailChangeMode] = S.[AdditionalImagesThumbnailChangeMode]
                                           ,T.[AdditionalImagesThumbnailWidth]  = S.[AdditionalImagesThumbnailWidth] 
                                           ,T.[AdditionalImagesWidth] = S.[AdditionalImagesWidth]
                                           ,T.[AdditionalImagesZoomHeight] = S.[AdditionalImagesZoomHeight] 
                                           ,T.[AdditionalImagesZoomPosition] = S.[AdditionalImagesZoomPosition]
                                           ,T.[AdditionalImagesZoomWidth] = S.[AdditionalImagesZoomWidth] 
                                           ,T.[BigImageFileName] = S.[BigImageFileName] 
                                           ,T.[BrandName] = S.[BrandName]
                                           ,T.[BrandOxID] = S.[BrandOxID] 
                                           ,T.[CanonicalURLCustomizedContent] = S.[CanonicalURLCustomizedContent]
                                           ,T.[Category1Name] = S.[Category1Name]
                                           ,T.[Category1OxId] = S.[Category1OxId]
                                           ,T.[Category1Language] = S.[Category1Language] 
                                           ,T.[Category1ParentOxId] = S.[Category1ParentOxId]
                                           ,T.[Category2Name] = S.[Category2Name]
                                           ,T.[Category2OxId] = S.[Category2OxId]
                                           ,T.[Category2Language] = S.[Category2Language]
                                           ,T.[Category2ParentOxId] = S.[Category2ParentOxId]
                                           ,T.[Category3Name] = S.[Category3Name]
                                           ,T.[Category3OxId] = S.[Category3OxId]
                                           ,T.[Category3Language] = S.[Category3Language]
                                           ,T.[Category3ParentOxId] = S.[Category3ParentOxId]
                                           ,T.[Cost] = S.[Cost]
                                           ,T.[DaysToShip] = S.[DaysToShip]
                                           ,T.[Description] = S.[Description]
                                           ,T.[DimensionHeight] = S.[DimensionHeight]
                                           ,T.[DimensionLength] = S.[DimensionLength]
                                           ,T.[DimensionWidth] = S.[DimensionWidth]
                                           ,T.[DiscountGridCode] = S.[DiscountGridCode]
                                           ,T.[EANCode] = S.[EANCode]
                                           ,T.[EcotaxTI] = S.[EcotaxTI]
                                           ,T.[Guarantee] = S.[Guarantee]
                                           ,T.[HandlingSurcharge1ST] = S.[HandlingSurcharge1ST]
                                           ,T.[HandlingSurchargeOthers] = S.[HandlingSurchargeOthers]
                                           ,T.[ItemCondition] = S.[ItemCondition]
                                           ,T.[LinkedItemID] = S.[LinkedItemID]
                                           ,T.[LinkedItemLanguage] = S.[LinkedItemLanguage]
                                           ,T.[LinkedItemSKU] = S.[LinkedItemSKU]
                                           ,T.[LinkedUpdating] = S.[LinkedUpdating]
                                           ,T.[LongDescription] = S.[LongDescription]
                                           ,T.[MetaDescription] = S.[MetaDescription]
                                           ,T.[MetaKeywords] = S.[MetaKeywords]
                                           ,T.[MetaTitle] = S.[MetaTitle]
                                           ,T.[MPN] = S.[MPN]
                                           ,T.[Name] = S.[Name]
                                           ,T.[OptionIsDefault] = S.[OptionIsDefault]
                                           ,T.[OptionTypes1OxId] = S.[OptionTypes1OxId]
                                           ,T.[OptionTypes1Name] = S.[OptionTypes1Name]
                                           ,T.[OptionTypes1SystemName] = S.[OptionTypes1SystemName]
                                           ,T.[OptionTypes2OxId] = S.[OptionTypes2OxId]
                                           ,T.[OptionTypes2Name] = S.[OptionTypes2Name]
                                           ,T.[OptionTypes2SystemName] = S.[OptionTypes2SystemName]
                                           ,T.[OptionTypes3OxId] = S.[OptionTypes3OxId]
                                           ,T.[OptionTypes3Name] = S.[OptionTypes3Name]
                                           ,T.[OptionTypes3SystemName] = S.[OptionTypes3SystemName]
                                           ,T.[OptionValues1OxId] = S.[OptionValues1OxId]
                                           ,T.[OptionValues1Code] = S.[OptionValues1Code]
                                           ,T.[OptionValues1Name] = S.[OptionValues1Name]
                                           ,T.[OptionValues2OxId] = S.[OptionValues2OxId]
                                           ,T.[OptionValues2Code] = S.[OptionValues2Code]
                                           ,T.[OptionValues2Name] = S.[OptionValues2Name]
                                           ,T.[OptionValues3OxId] = S.[OptionValues3OxId]
                                           ,T.[OptionValues3Code] = S.[OptionValues3Code]
                                           ,T.[OptionValues3Name] = S.[OptionValues3Name]
                                           ,T.[Position] = S.[Position]
                                           ,T.[PriceValue] = S.[PriceValue]
                                           ,T.[PriceVATIncluded] = S.[PriceVATIncluded]
                                           ,T.[Price1Value] = S.[Price1Value]
                                           ,T.[Price1VATIncluded] = S.[Price1VATIncluded]
                                           ,T.[Price2Value] = S.[Price2Value]
                                           ,T.[Price2VATIncluded] = S.[Price2VATIncluded]
                                           ,T.[Price3Value] = S.[Price3Value]
                                           ,T.[Price3VATIncluded] = S.[Price3VATIncluded]
                                           ,T.[Price4Value] = S.[Price4Value]
                                           ,T.[Price4VATIncluded] = S.[Price4VATIncluded]
                                           ,T.[ReviewCount] = S.[ReviewCount]
                                           ,T.[ReviewRating] = S.[ReviewRating]
                                           ,T.[QuantityInstockValue] = S.[QuantityInstockValue]
                                           ,T.[QuantityInstockAppend] = S.[QuantityInstockAppend]
                                           ,T.[QuantityReorderValue] = S.[QuantityReorderValue]
                                           ,T.[QuantityReorderAppend] = S.[QuantityReorderAppend]
                                           ,T.[SaleIfOutOfStock] = S.[SaleIfOutOfStock]
                                           ,T.[SaleIfOutOfStockScenario] = S.[SaleIfOutOfStockScenario]
                                           ,T.[ShipPrice] = S.[ShipPrice]
                                           ,T.[ShowDaysToship] = S.[ShowDaysToship]
                                           ,T.[ShowIfOutOfStock] = S.[ShowIfOutOfStock]
                                           ,T.[ShowInStockNote] = S.[ShowInStockNote]
                                           ,T.[ShowStockLevel] = S.[ShowStockLevel]
                                           ,T.[SmallImgFileName] = S.[SmallImgFileName]
                                           ,T.[StrikethroughPriceValue] = S.[StrikethroughPriceValue]
                                           ,T.[StrikethroughPriceVATIncluded] = S.[StrikethroughPriceVATIncluded]
                                           ,T.[StrikethroughPrice1Value] = S.[StrikethroughPrice1Value]
                                           ,T.[StrikethroughPrice1VATIncluded] = S.[StrikethroughPrice1VATIncluded]
                                           ,T.[StrikethroughPrice2Value] = S.[StrikethroughPrice2Value]
                                           ,T.[StrikethroughPrice2VATIncluded] = S.[StrikethroughPrice2VATIncluded]
                                           ,T.[StrikethroughPrice3Value] = S.[StrikethroughPrice3Value]
                                           ,T.[StrikethroughPrice3VATIncluded] = S.[StrikethroughPrice3VATIncluded]
                                           ,T.[StrikethroughPrice4Value] = S.[StrikethroughPrice4Value]
                                           ,T.[StrikethroughPrice4VATIncluded] = S.[StrikethroughPrice4VATIncluded]
                                           ,T.[TaxCountryISOCode] = S.[TaxCountryISOCode]
                                           ,T.[TaxRate] = S.[TaxRate]
                                           ,T.[UnitsForSale] = S.[UnitsForSale]
                                           ,T.[UnitsForSale1] = S.[UnitsForSale1]
                                           ,T.[UnitsForSale2] = S.[UnitsForSale2]
                                           ,T.[UnitsForSale3] = S.[UnitsForSale3]
                                           ,T.[UnitsForSale4] = S.[UnitsForSale4]
                                           ,T.[Visible] = S.[Visible]
                                           ,T.[Weight] = S.[Weight]
                    WHEN NOT MATCHED BY SOURCE 
                           THEN UPDATE SET T.[ActionCode] = 3
                    
                    OUTPUT
                               $action, inserted.[ProductEntityId] 'inserted', deleted.[ProductEntityId] 'deleted' INTO @tableVar;



       
                    SELECT @RecordChanged = COUNT(*) 
                    FROM @tableVar  
                    --GROUP BY MergeAction
					IF @Oggetto = 3
						BEGIN
							UPDATE MYTHO_ProductEntities Set QuantityInstockValue = Giacenza FROM MYTHO_ProductEntities PE
							INNER JOIN
							(SELECT  CA.ProductEntityId
							,(CARICO - SCARICO + RESODASCARICO - RESODACARICO)  AS GIACENZA
							,(CARICO - SCARICO + RESODASCARICO - RESODACARICO + ORDINATO - IMPEGNATO) AS DISPONIBILITA
							FROM [dbo].[VISTAGIACENZETOT] VT INNER JOIN MYTHO_Codici_Articoli CA  ON VT.[CODART] = CA.CODICEMETODO ) Stock ON Stock.ProductEntityId = PE.ProductEntityId
						END

                    COMMIT TRAN [Tran1]

             END TRY
             BEGIN CATCH
                           
                    ROLLBACK TRAN;

                    SET @ErrorMessage = ERROR_MESSAGE()
             END CATCH


       If @Oggetto = 4
		   BEGIN TRY
				BEGIN TRAN [Tran4];
					Update MYTHO_ProductEntities Set QuantityInstockValue = Giacenza FROM MYTHO_ProductEntities PE
					INNER JOIN
					(SELECT  CA.ProductEntityId
					,(CARICO - SCARICO + RESODASCARICO - RESODACARICO)  AS GIACENZA
					,(CARICO - SCARICO + RESODASCARICO - RESODACARICO + ORDINATO - IMPEGNATO) AS DISPONIBILITA
					FROM [dbo].[VISTAGIACENZETOT] VT INNER JOIN MYTHO_Codici_Articoli CA  ON VT.[CODART] = CA.CODICEMETODO ) Stock ON Stock.ProductEntityId = PE.ProductEntityId



				COMMIT TRAN [Tran4]
		   END TRY
		   BEGIN CATCH
				ROLLBACK TRAN;

					SET @ErrorMessage = ERROR_MESSAGE()
		   END CATCH

END

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[MYTHO_Merge] TO [Metodo98]
    AS [dbo];

