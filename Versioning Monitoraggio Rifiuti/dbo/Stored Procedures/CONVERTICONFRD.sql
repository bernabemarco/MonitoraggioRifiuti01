
CREATE PROCEDURE CONVERTICONFRD AS
BEGIN
DECLARE @NOMEUTENTE VARCHAR(25)
DECLARE @NOMEUTENTEPREC VARCHAR(25)
DECLARE @NOMEIMPOSTAZIONE VARCHAR(50)
DECLARE @NOMEIMPOSTAZIONEPREC VARCHAR(50)
DECLARE @NOMEDBIMP VARCHAR(50)
DECLARE @TIPORIGA SMALLINT
DECLARE @TIPORIGAPREC SMALLINT
DECLARE @NRCOLHIDE SMALLINT
DECLARE @PREDEFINITA SMALLINT
DECLARE @PPROG DECIMAL(10,0)

DECLARE CONF_CURSOR CURSOR FOR SELECT NOMEUTENTE,NOMEIMPOSTAZIONE,TIPORIGA,NRCOLHIDE,PREDEFINITA FROM IMPRIGHEDOC ORDER BY TIPORIGA,NOMEUTENTE,NOMEIMPOSTAZIONE,NRCOLHIDE

OPEN CONF_CURSOR
FETCH NEXT FROM CONF_CURSOR INTO @NOMEUTENTE,@NOMEIMPOSTAZIONE,@TIPORIGA,@NRCOLHIDE,@PREDEFINITA
SET @NOMEIMPOSTAZIONEPREC=''
WHILE @@FETCH_STATUS = 0
BEGIN
    IF (@NOMEIMPOSTAZIONE<>@NOMEIMPOSTAZIONEPREC) OR (@NOMEUTENTE<>@NOMEUTENTEPREC) OR (@TIPORIGA<>@TIPORIGAPREC)
    BEGIN
        EXEC DBO.NUOVOPROGRESSIVO 'TESTECONFRD', 1, @PPROG OUTPUT

        SET @NOMEDBIMP = @NOMEIMPOSTAZIONE
        IF @NOMEUTENTE='TRM' 
            BEGIN
            SET @NOMEDBIMP = @NOMEIMPOSTAZIONE + '_COMUNE'
            END
        INSERT INTO TESTECONFRD(PROGRESSIVO,NOMEIMPOSTAZIONE,TIPORIGA,ESEGUITAB,VAITAB,CONVERTI,UTENTEMODIFICA,DATAMODIFICA) 
        VALUES (@PPROG,@NOMEDBIMP,@TIPORIGA,0,0,1,'dbo',GetDate())
        
        IF @NOMEUTENTE='TRM' 
            BEGIN
            INSERT INTO UTENTICONFRD(RIFPROGRESSIVO,UTENTE,IMPPREDEFINITA,UTENTEMODIFICA,DATAMODIFICA) 
            SELECT @PPROG,USERID,@PREDEFINITA,'dbo',GetDate() FROM TABUTENTI WHERE (NRTERMINALE BETWEEN 1 AND 200) OR (NRTERMINALE >=1001)
            END
        ELSE
            BEGIN
            INSERT INTO UTENTICONFRD(RIFPROGRESSIVO,UTENTE,IMPPREDEFINITA,UTENTEMODIFICA,DATAMODIFICA) 
            VALUES (@PPROG,@NOMEUTENTE,@PREDEFINITA,'dbo',GetDate())
            END

        INSERT INTO PARAMETRICONFRD(RIFPROGRESSIVO,PARAMETRO,UTENTEMODIFICA,DATAMODIFICA) 
        SELECT @PPROG,CODICE,'dbo',GetDate() FROM PARAMETRIDOC WHERE TIPORIGHE=@TIPORIGA
            
        SET @NOMEIMPOSTAZIONEPREC=@NOMEIMPOSTAZIONE
        SET @NOMEUTENTEPREC=@NOMEUTENTE
        SET @TIPORIGAPREC=@TIPORIGA
    END
    INSERT INTO RIGHECONFRD(RIFPROGRESSIVO,IDCOL,NASCONDI,ESEGUI,PERCORSO,IDCOL_A,OBBLIGATORIO,UTENTEMODIFICA,DATAMODIFICA) 
    VALUES (@PPROG,@NRCOLHIDE,1,'','',0,0,'dbo',GetDate())
    
    FETCH NEXT FROM CONF_CURSOR INTO @NOMEUTENTE,@NOMEIMPOSTAZIONE,@TIPORIGA,@NRCOLHIDE,@PREDEFINITA
END
CLOSE CONF_CURSOR
DEALLOCATE CONF_CURSOR
END

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[CONVERTICONFRD] TO [Metodo98]
    AS [dbo];

