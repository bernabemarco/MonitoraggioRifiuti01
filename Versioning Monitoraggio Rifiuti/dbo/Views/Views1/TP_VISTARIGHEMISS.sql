
CREATE VIEW TP_VISTARIGHEMISS AS

SELECT 
 TabTesteDocumentiMiss.PROGRESSIVO,
 TabTesteDocumentiMiss.PROGRESSDOC,
 TabTesteDocumentiMiss.RIFPROGRTESTAMISS, 
 TabTesteDocumentiMiss.CODCLI,
 TabTesteDocumentiMiss.CODDESTINAZIONE, 
 TabTesteDocumentiMiss.RAGSOCDDM,
 TabTesteDocumentiMiss.CODICESPED,
 TabRigheDocumentiMiss.IDRIGA,
 TabRigheDocumentiMiss.IDRIGADOC,
 TabRigheDocumentiMiss.CODART,
 TabRigheDocumentiMiss.DESCART,
 TabRigheDocumentiMiss.UM,
 TabRigheDocumentiMiss.QTACONSEG,
 TabRigheDocumentiMiss.NRRIFPARTITA,
 TabRigheDocumentiMiss.DATACONSEGNA,
 TabRigheDocumentiMiss.IDRIGAPADRE,
 TabRigheDocumentiMiss.CODUBICAZIONE,
 TabRigheDocumentiMiss.TIPOUBICAZIONE,
 ANAGRAFICAARTICOLI.NRPEZZIIMBALLO, 
 ARTICOLIFATTORICONVERSIONE.FATTORE, 
 ARTICOLIFATTORICONVERSIONE.UM2 AS UMBASE,
 (TabRigheDocumentiMiss.QTACONSEG * ARTICOLIFATTORICONVERSIONE.FATTORE) AS QTABASE, 
(SELECT ARROTNUMCOLLI FROM PARAMETRIDOC  WHERE PARAMETRIDOC.CODICE = TESTEDOCUMENTI .TIPODOC) AS ARROTNUMCOLLI , 

(CASE WHEN ANAGRAFICAARTICOLI.NRPEZZIIMBALLO=0 THEN 
  0 
 ELSE
   (CASE WHEN (SELECT ARROTNUMCOLLI FROM PARAMETRIDOC  WHERE PARAMETRIDOC.CODICE = TESTEDOCUMENTI .TIPODOC) = 0 THEN
     ((TabRigheDocumentiMiss.QTACONSEG * ARTICOLIFATTORICONVERSIONE.FATTORE)/ANAGRAFICAARTICOLI.NRPEZZIIMBALLO) 
   ELSE
     ABS(FLOOR(((TabRigheDocumentiMiss.QTACONSEG * ARTICOLIFATTORICONVERSIONE.FATTORE)/ANAGRAFICAARTICOLI.NRPEZZIIMBALLO) *-1) ) --ARROTONDAMENTO PER ECCESSO
   END)
END) AS NRCOLLI   

FROM TabTesteDocumentiMiss 
INNER JOIN TabRigheDocumentiMiss
 ON TabTesteDocumentiMiss.PROGRESSIVO=TabRigheDocumentiMiss.IDTESTA
INNER JOIN TESTEDOCUMENTI ON 
TabTesteDocumentiMiss.PROGRESSDOC=TESTEDOCUMENTI.PROGRESSIVO
INNER JOIN ANAGRAFICAARTICOLI  
 ON ANAGRAFICAARTICOLI.CODICE=TabRigheDocumentiMiss.CODART
INNER JOIN ARTICOLIFATTORICONVERSIONE 
 ON ARTICOLIFATTORICONVERSIONE.CODART=TabRigheDocumentiMiss.CODART
 AND 
 ARTICOLIFATTORICONVERSIONE.UM1=TabRigheDocumentiMiss.UM
 AND 
 ARTICOLIFATTORICONVERSIONE.UM2=(SELECT UM FROM ARTICOLIUMPREFERITE WHERE CODART=TabRigheDocumentiMiss.CODART AND TIPOUM=1)


GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTARIGHEMISS] TO [Metodo98]
    AS [dbo];

