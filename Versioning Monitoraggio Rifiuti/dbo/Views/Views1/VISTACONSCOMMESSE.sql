CREATE VIEW VISTACONSCOMMESSE AS
SELECT 
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	IDTESTADOC AS RIFTESTA,
	IDRIGADOC AS RIFRIGA,
	ORIGINEEVENTO,
	IDTESTADOC AS RIFTESTA_DEST,
	IDRIGADOC AS RIFRIGA_DEST,
	ORIGINEEVENTO AS ORIGINEEVENTO_DEST,
	'' AS CODICE,
	DESCRIZIONE AS DESCRIZIONECC,
	1 AS QTABASE,
	'NR' AS UMBASE,
	1 AS QTAVAL,
	'NR' AS UMVAL,
	IMPORTO AS COSTOUNILIRE,
	IMPORTOEURO AS COSTOUNIEURO,
	IMPORTO AS COSTOTOTLIRE,
	IMPORTOEURO AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTO ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTO ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTO ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTO ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTOEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTOEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTOEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTOEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTO ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTO ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTO ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTO ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTOEURO ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTOEURO ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTOEURO ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTOEURO ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSCOSTIDIRDOC

UNION

SELECT
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	NRREG AS RIFTESTA,
	NRRIGAPN AS RIFRIGA,
	ORIGINEEVENTO,
	NRREG AS RIFTESTA_DEST,
	NRRIGAPN AS RIFRIGA_DEST,
	ORIGINEEVENTO AS ORIGINEEVENTO_DEST,
	(CASE CONTOCDC WHEN '' THEN CONTOGEN ELSE CONTOGEN + ' - ' + CONTOCDC END) AS CODICE,
	DESCRIZIONE AS DESCRIZIONECC,
	1 AS QTABASE,
	'NR' AS UMBASE,
	1 AS QTAVAL,
	'NR' AS UMVAL,
	IMPORTO AS COSTOUNILIRE,
	IMPORTOEURO AS COSTOUNIEURO,
	IMPORTO AS COSTOTOTLIRE,
	IMPORTOEURO AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTO ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTO ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTO ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTO ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTOEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTOEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTOEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTOEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTO ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTO ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTO ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTO ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN IMPORTOEURO ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN IMPORTOEURO ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN IMPORTOEURO ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN IMPORTOEURO ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSCOSTIDIRPN

UNION

SELECT
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	IDTESTADOC AS RIFTESTA,
	IDRIGADOC AS RIFRIGA,
	ORIGINEEVENTO,
	IDTESTA_DEST AS RIFTESTA_DEST,
	IDRIGA_DEST AS RIFRIGA_DEST,
	ORIGINEEVENTO_DEST,
	CODART AS CODICE,
	AA.DESCRIZIONE AS DESCRIZIONECC,
	QUANTITA AS QTABASE,
	UMBASE,
	QTAVAL,
	UMVAL,
	COSTOUNITARIO AS COSTOUNILIRE,
	COSTOUNITARIOEURO AS COSTOUNIEURO,
	(COSTOUNITARIO * QTAVAL) AS COSTOTOTLIRE,
	(COSTOUNITARIOEURO * QTAVAL) AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNITARIO ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNITARIO ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNITARIO ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNITARIO ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNITARIOEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNITARIOEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNITARIOEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNITARIOEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN (COSTOUNITARIO * QTAVAL) ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN (COSTOUNITARIO * QTAVAL) ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN (COSTOUNITARIO * QTAVAL) ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN (COSTOUNITARIO * QTAVAL) ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN (COSTOUNITARIOEURO * QTAVAL) ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN (COSTOUNITARIOEURO * QTAVAL) ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN (COSTOUNITARIOEURO * QTAVAL) ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN (COSTOUNITARIOEURO * QTAVAL) ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSCOSTIMATERIALE CM LEFT OUTER JOIN ANAGRAFICAARTICOLI AA ON CM.CODART=AA.CODICE
	
UNION

SELECT
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	IDTESTADOC AS RIFTESTA,
	IDRIGADOC AS RIFRIGA,
	ORIGINEEVENTO,
	IDTESTADOC AS RIFTESTA_DEST,
	IDRIGADOC AS RIFRIGA_DEST,
	ORIGINEEVENTO AS ORIGINEEVENTO_DEST,
	CODART AS CODICE,
	DSCARTICOLO AS DESCRIZIONECC,
	QUANTITA AS QTABASE,
	UMBASE AS UM,
	QUANTITA AS QTAVAL,
	UMBASE AS UMVAL,	
	COSTOUNILAV AS COSTOUNILIRE,
	COSTOUNILAVEURO AS COSTOUNIEURO,
	COSTOTOTLAV AS COSTOTOTLIRE,
	COSTOTOTLAVEURO AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNILAV ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNILAV ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNILAV ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNILAV ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNILAVEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNILAVEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNILAVEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNILAVEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTLAV ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTLAV ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTLAV ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTLAV ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTLAVEURO ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTLAVEURO ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTLAVEURO ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTLAVEURO ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSLAVEST

UNION

SELECT
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	IDCOMMPROD AS RIFTESTA,
	IDORDPROD AS RIFRIGA,
	ORIGINEEVENTO,
	IDCOMMPROD AS RIFTESTA_DEST,
	IDORDPROD AS RIFRIGA_DEST,
	ORIGINEEVENTO AS ORIGINEEVENTO_DEST,
	CODART AS CODICE,
	CODOPERAZIONE + ' - ' + OP.DESCRIZIONE AS DESCRIZIONECC,
	1 AS QTABASE,
	'NR' AS UMBASE,
	1 AS QTAVAL,
	'NR' AS UMVAL,
	COSTOTOTALE AS COSTOUNILIRE,
	COSTOTOTALEEURO AS COSTOUNIEURO,
	COSTOTOTALE AS COSTOTOTLIRE,
	COSTOTOTALEEURO AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTALE ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTALE ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTALE ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTALE ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTALEEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTALEEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTALEEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTALEEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTALE ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTALE ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTALE ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTALE ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTALEEURO ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTALEEURO ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTALEEURO ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTALEEURO ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSLAVINT CI INNER JOIN TABELLAOPERAZIONI OP ON CI.CODOPERAZIONE=OP.CODICE
	
UNION

SELECT
	IDCOMMCLI,
	NRRIGA,
	TIPOREC,TIPORECDETT,
	IDTESTADOC AS RIFTESTA,
	IDRIGADOC AS RIFRIGA,
	ORIGINEEVENTO,
	IDTESTADOC AS RIFTESTA_DEST,
	IDRIGADOC AS RIFRIGA_DEST,
	ORIGINEEVENTO AS ORIGINEEVENTO_DEST,
	CODART AS CODICE,
	DSCARTICOLO AS DESCRIZIONECC,
	QUANTITA AS QTABASE,
	UMBASE,
	QTAVAL,
	UMVAL,
	COSTOUNILAV AS COSTOUNILIRE,
	COSTOUNILAVEURO AS COSTOUNIEURO,
	COSTOTOTLAV AS COSTOTOTLIRE,
	COSTOTOTLAVEURO AS COSTOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNILAV ELSE 0 END) CONSUNTIVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNILAV ELSE 0 END) RISERVATOUNI,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNILAV ELSE 0 END) ORDINATOUNI,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNILAV ELSE 0 END) PREVISTOUNI,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOUNILAVEURO ELSE 0 END) CONSUNTIVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOUNILAVEURO ELSE 0 END) RISERVATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOUNILAVEURO ELSE 0 END) ORDINATOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOUNILAVEURO ELSE 0 END) PREVISTOUNIEURO,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTLAV ELSE 0 END) CONSUNTIVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTLAV ELSE 0 END) RISERVATOTOT,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTLAV ELSE 0 END) ORDINATOTOT,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTLAV ELSE 0 END) PREVISTOTOT,
	(CASE NATURARILEVAZIONE WHEN 1 THEN COSTOTOTLAVEURO ELSE 0 END) CONSUNTIVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 2 THEN COSTOTOTLAVEURO ELSE 0 END) RISERVATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 3 THEN COSTOTOTLAVEURO ELSE 0 END) ORDINATOTOTEURO,
	(CASE NATURARILEVAZIONE WHEN 4 THEN COSTOTOTLAVEURO ELSE 0 END) PREVISTOTOTEURO,
	NATURARILEVAZIONE,
	ISNULL(VOCEBASE,'') AS VOCEBASE,
	ISNULL(IDVOCE,'') AS IDVOCE,
	TIPOCOSTO,
	IDTABELLA,
	(IDTABELLA+CAST(IDCOMMCLI AS VARCHAR)+CAST(NRRIGA AS VARCHAR)) AS IDRECORD
FROM
	CCBILANCIOCONSLAVINTDOC

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTACONSCOMMESSE] TO [Metodo98]
    AS [dbo];

