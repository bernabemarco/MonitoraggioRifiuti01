CREATE VIEW [dbo].[ADIUTO_DATI_FLUSSO_NON_CONFORMITA]
AS
--------------------------------------------------------------
-- Dati relativi alla gestione del flusso della NON CONFORMITA
--		dati utilizzati nell'import di ADIFEED per l'Arricchimento Indici
--------------------------------------------------------------
SELECT 
	(CASE WHEN ISNULL(TESTEDOCUMENTI.PROGRESSIVO, 0) <> 0 
			THEN ADIGEST_DOCUMENTI.PREFISSO + '-' + LTRIM(RTRIM(CONVERT(VARCHAR(20), TESTEDOCUMENTI.PROGRESSIVO))) + ISNULL(ADIGEST_DOCUMENTI.SUFFISSO,'') 
			ELSE '' 
	END)  as KEYUNIQUE, 

	EXTRATESTEDOC.IDTESTA, 

	CASE WHEN ISNULL(EXTRATESTEDOC.RISOLTACONFORMITA, 0)	= 1 THEN 'X' ELSE ' ' END as Flag_RisoltaConformita, 
	CASE WHEN ISNULL(EXTRATESTEDOC.SCADENZEBLOCCATE, 0)		= 1 THEN 'X' ELSE ' ' END as Flag_ScadenzeBloccate, 
	EXTRATESTEDOC.NOTESCADENZEBLOCCATE	as Nota_ScadenzeBloccate, 

	EXTRATESTEDOC.RefAcquisti, 
	TABRESPONSABILI_1.DESCRIZIONE		as Descr_RefAcquisti, 
	CASE WHEN ISNULL(EXTRATESTEDOC.flagNonFFConforme, 0)	= 1 THEN 'X' ELSE ' ' END as Flag_NonConformeAcq, 
	
	EXTRATESTEDOC.RespConformitaACQ, 
	TABRESPONSABILI.DESCRIZIONE			as Descr_RespConformitaAcq, 
	
	EXTRATESTEDOC.DataConformitaACQ, 
    
	PARAMETRIDOC.TIPO, 
    PARAMETRIDOC.CLIFOR, 
	PARAMETRIDOC.CODICE, 
	TESTEDOCUMENTI.ESERCIZIO, 
	AdiGest_Documenti.FAMIGLIA


FROM EXTRATESTEDOC 
		INNER JOIN TESTEDOCUMENTI ON EXTRATESTEDOC.IDTESTA = TESTEDOCUMENTI.PROGRESSIVO 
		INNER JOIN PARAMETRIDOC ON TESTEDOCUMENTI.TIPODOC = PARAMETRIDOC.CODICE 
		INNER JOIN ADIGEST_DOCUMENTI ON PARAMETRIDOC.CODICE = ADIGEST_DOCUMENTI.CODICE 
		LEFT OUTER JOIN TABRESPONSABILI ON EXTRATESTEDOC.RespConformitaACQ = TABRESPONSABILI.CODICE 
		LEFT OUTER JOIN TABRESPONSABILI AS TABRESPONSABILI_1 ON EXTRATESTEDOC.RefAcquisti = TABRESPONSABILI_1.CODICE

WHERE   
	PARAMETRIDOC.TIPO IN ('F', 'N') AND 
	PARAMETRIDOC.CLIFOR = 'F' AND 
	TESTEDOCUMENTI.ESERCIZIO > 2015


