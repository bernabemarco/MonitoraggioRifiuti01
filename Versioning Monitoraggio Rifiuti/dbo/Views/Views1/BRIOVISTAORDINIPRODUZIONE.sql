CREATE VIEW dbo.BRIOVISTAORDINIPRODUZIONE
AS
SELECT     TESTEORDINIPROD.TIPOCOM, TESTEORDINIPROD.TIPOCOM + '/' + cast(TESTEORDINIPROD.ESERCIZIO AS varchar) 
                      + '/' + RIGHT('0000000000' + cast(TESTEORDINIPROD.NUMEROCOM AS varchar), 10) + '/' + RIGHT('00000' + cast(RIGHEORDPROD.IDRIGA AS varchar),
                       5) AS RIFORDINE, TESTEORDINIPROD.NUMEROCOM, TESTEORDINIPROD.ESERCIZIO, TESTEORDINIPROD.STATOBLOCCATO, TESTEORDINIPROD.DATAEMISSIONE,
                      (CASE WHEN TESTEORDINIPROD.STATOCHIUSO=0 THEN 'Aperto' ELSE 'Chiuso' END) AS STATOCHIUSO, 
RIGHEORDPROD.IDTESTA, 
RIGHEORDPROD.IDRIGA, 
RIGHEORDPROD.CODICEORD,
                          (CASE WHEN (SELECT     TIPOORDINE
                            FROM          PARAMETRIORDPROD
                            WHERE      PARAMETRIORDPROD.CODICE = RIGHEORDPROD.CODICEORD)=0 THEN 'Ordine produzione interna' ELSE (CASE WHEN(SELECT     TIPOORDINE
                            FROM          PARAMETRIORDPROD
                            WHERE      PARAMETRIORDPROD.CODICE = RIGHEORDPROD.CODICEORD)=1 THEN 'Ordine conto lavoro attivo' ELSE 'Ordine conto lavoro passivo' END) END) AS TIPOORD, RIGHEORDPROD.CODART AS CODARTORD,
RIGHEORDPROD.DESCRIZIONEART, 
RIGHEORDPROD.VERSIONEDBA, 
RIGHEORDPROD.VERSIONECICLO, 
RIGHEORDPROD.UMGEST, 
RIGHEORDPROD.UM1MAG AS UMBASE,
RIGHEORDPROD.QTAGESTIONE, 
RIGHEORDPROD.QTAGESTIONEVERS, 
RIGHEORDPROD.QTAGESTIONERES, 
RIGHEORDPROD.QTAPREZZO, 
RIGHEORDPROD.UMPREZZO, 
RIGHEORDPROD.QTA1MAG, 
(RIGHEORDPROD.QTAGESTIONEVERS*(CASE WHEN(RIGHEORDPROD.QTAGESTIONE=0) THEN 0 ELSE(
				RIGHEORDPROD.QTA1MAG/RIGHEORDPROD.QTAGESTIONE) END
			       )) AS QTA1MAGVERS,
RIGHEORDPROD.QTA2MAG, 
RIGHEORDPROD.QTA1MAGRES, 
RIGHEORDPROD.QTA2MAGRES, 
RIGHEORDPROD.QTASCARTO, 
RIGHEORDPROD.UMSCARTO, 
                      (CASE WHEN RIGHEORDPROD.QTAGESTIONE <> 0 THEN RIGHEORDPROD.QTAGESTIONEVERS / RIGHEORDPROD.QTAGESTIONE * 100 ELSE 0 END) 
                      AS AVANZQTA, 
                      (CASE WHEN RIGHEORDPROD.COSTOTOTORDPREV <> 0 THEN RIGHEORDPROD.COSTOTOTORDEFF / RIGHEORDPROD.COSTOTOTORDPREV * 100 ELSE
                       0 END) AS AVANZCOSTI,
RIGHEORDPROD.RIFCOMMCLI,
RIGHEORDPROD.UM1MAG AS UM1, 
RIGHEORDPROD.UM2MAG AS UM2,
RIGHEORDPROD.CODCLIDEST,
RIGHEORDPROD.PARTITAASSEGNATA, 
RIGHEORDPROD.CODFORDEST,
RIGHEORDPROD.DATAEMISSIONE AS DATAEMISSIONEORD,
YEAR(RIGHEORDPROD.DATAEMISSIONE) AS ANNOORD,
STR(MONTH(RIGHEORDPROD.DATAEMISSIONE), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATAEMISSIONE) AS MESEORD,
(CASE WHEN RIGHEORDPROD.STATOORDINE=0 THEN 'Aperto' ELSE (CASE WHEN RIGHEORDPROD.STATOORDINE=1 THEN 'Prelevato' ELSE (CASE WHEN RIGHEORDPROD.STATOORDINE=2 THEN 'Versato' ELSE 'Chiuso' END) END) END) AS STATOORDINE  , 
(CASE WHEN RIGHEORDPROD.FASERILASCIO=0 THEN 'Emesso' ELSE (CASE WHEN RIGHEORDPROD.FASERILASCIO=1 THEN 'Lanciato' ELSE 'Chiuso' END) END) AS FASERILASCIO,
RIGHEORDPROD.DATARILASCIO,
YEAR(RIGHEORDPROD.DATARILASCIO) AS ANNORILASCIO,
STR(MONTH(RIGHEORDPROD.DATARILASCIO), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATARILASCIO) AS MESERILASCIO,
RIGHEORDPROD.DATAINIZIOSCHED, 
RIGHEORDPROD.DATAFINESCHED,
RIGHEORDPROD.DATAINIZIORICH, 
YEAR(RIGHEORDPROD.DATAINIZIORICH) AS ANNOINIZIORICH,
STR(MONTH(RIGHEORDPROD.DATAINIZIORICH), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATAINIZIORICH) AS MESEINIZIORICH,
RIGHEORDPROD.DATAFINERICH,
YEAR(RIGHEORDPROD.DATAFINERICH) AS ANNOFINERICH,
STR(MONTH(RIGHEORDPROD.DATAFINERICH), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATAFINERICH) AS MESEFINERICH,
RIGHEORDPROD.DATAINIZIOEFF,
YEAR(RIGHEORDPROD.DATAINIZIOEFF) AS ANNOINIZIOEFF,
STR(MONTH(RIGHEORDPROD.DATAINIZIOEFF), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATAINIZIOEFF) AS MESEINIZIOEFF, 
RIGHEORDPROD.DATAFINEEFF,
YEAR(RIGHEORDPROD.DATAFINEEFF) AS ANNOFINEEFF,
STR(MONTH(RIGHEORDPROD.DATAFINEEFF), 2, 0) + ' - ' + DATENAME(MM, RIGHEORDPROD.DATAFINEEFF) AS MESEFINEEFF,
RIGHEORDPROD.DATAULTATTIVITA, 
RIGHEORDPROD.DEPOSITO, 
RIGHEORDPROD.CONTOCDC, 
RIGHEORDPROD.VALOREPRIORITA, 
RIGHEORDPROD.COSTOMATPREV, 
RIGHEORDPROD.COSTOLAVINTPREV, 
RIGHEORDPROD.COSTOLAVESTPREV, 
RIGHEORDPROD.COSTOINDPREV, 
RIGHEORDPROD.COSTOUNITORDPREV, 
RIGHEORDPROD.COSTOTOTORDPREV, 
RIGHEORDPROD.COSTOMATPREVEURO,               
RIGHEORDPROD.COSTOLAVINTPREVEURO, 
RIGHEORDPROD.COSTOLAVESTPREVEURO, 
RIGHEORDPROD.COSTOINDPREVEURO, 
RIGHEORDPROD.COSTOUNITORDPREVEURO, 
RIGHEORDPROD.COSTOTOTORDPREVEURO, 
RIGHEORDPROD.COSTOMATEFF, 
RIGHEORDPROD.COSTOLAVINTEFF, 
RIGHEORDPROD.COSTOLAVESTEFF, 
RIGHEORDPROD.COSTOINDEFF, 
RIGHEORDPROD.COSTOUNITORDEFF, 
RIGHEORDPROD.COSTOTOTORDEFF, 
RIGHEORDPROD.COSTOMATEFFEURO, 
RIGHEORDPROD.COSTOLAVINTEFFEURO, 
RIGHEORDPROD.COSTOLAVESTEFFEURO, 
RIGHEORDPROD.COSTOINDEFFEURO, 
RIGHEORDPROD.COSTOUNITORDEFFEURO, 
RIGHEORDPROD.COSTOTOTORDEFFEURO, 
VISTAANAGRAFICAARTICOLI.GRUPPO, 
VISTAANAGRAFICAARTICOLI.CATEGORIA, 
VISTAANAGRAFICAARTICOLI.VARESPLICITE, 
VISTAANAGRAFICAARTICOLI.TIPOGESTIONE, 
RIGHEORDPROD.STATOLANCIO, 
RIGHEORDPROD.DATALANCIO
FROM         (TESTEORDINIPROD LEFT OUTER JOIN
                      (RIGHEORDPROD LEFT OUTER JOIN
                      VISTAANAGRAFICAARTICOLI ON VISTAANAGRAFICAARTICOLI.CODICE = RIGHEORDPROD.CODART) ON 
                      TESTEORDINIPROD.PROGRESSIVO = RIGHEORDPROD.IDTESTA)

GO
GRANT SELECT
    ON OBJECT::[dbo].[BRIOVISTAORDINIPRODUZIONE] TO [Metodo98]
    AS [dbo];

