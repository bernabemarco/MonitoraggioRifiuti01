

Create view [dbo].[TP_VISTAINDICISTAGIONALIZZAZIONE] 
as 

Select
    codart,
    coddeposito,
    cod,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([1] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s1,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([2] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s2,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([3] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s3,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([4] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s4,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([5] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s5,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([6] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s6,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([7] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s7,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([8] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s8,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([9] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s9,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([10] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s10,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([11] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s11,
    (CASE WHEN ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12]) > 0 
          THEN ([12] / ([1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12])) / 12
          ELSE 0
          END) AS s12,
    z1,
    z2 ,
    tipo
From
(
    select 
        codart,
        coddeposito,
        6000 as cod,
        avg([1]) AS [1],
        avg([2]) AS [2],
        avg([3]) AS [3],
        avg([4]) AS [4],
        avg([5]) AS [5],
        avg([6]) AS [6],
        avg([7]) AS [7],
        avg([8]) AS [8],
        avg([9]) AS [9],
        avg([10]) AS [10],
        avg([11]) AS [11],
        avg([12]) AS [12],
        0 as z1,
        0 as z2 ,
        'Indici_Stag' as tipo
    from 
        TP_VISTAVENDITEANNIPRECEDENTI 
    where  
        esercizio<year(getdate())
    group by 
        codart,
        coddeposito
) Base


GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTAINDICISTAGIONALIZZAZIONE] TO [Metodo98]
    AS [dbo];

