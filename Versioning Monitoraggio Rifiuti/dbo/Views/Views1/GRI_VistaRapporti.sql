

-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ GRI_VistaRapporti
CREATE VIEW [dbo].[GRI_VistaRapporti] AS SELECT
			GRI.IDRAPPORTO, GRI.IDCONTRATTO, GRI.RIFCOMMCLI, GRI.CODCLIENTE, GRI.CODCLIFAT, GRI.NOTE_GestioneRapporto, 
			GRI.REFERENTE, GRI.TEL_REF, GRI.ELIMINATO, GRI.DataEliminazione, GRI.AZRIF, GRI.Stato, GRI.BLOCCOSYNC, GRI.DATABLOCCO, GRI.FLAGBLOCCO,
			GRI.EMAIL_RESPONSABILE, ISNULL(GRI.CodAgente1, '') AS CodAgente1, ISNULL(AG1.DSCAGENTE, '') 
			AS DscAgente1, ISNULL(GRI.CodAgente2, '') AS CodAgente2, ISNULL(AG2.DSCAGENTE, '') AS DscAgente2, 
			GRI.SEZIONECONTRATTO, SC.OLD_RifSezioneGemma, GRI.CODDEST, SC.DESCRIZIONESEZIONE, 
			SC.idTipoFatt AS SEZ_idTipoFatt, SC.idTipologMezzo, TMSez.Descrizione AS DescTipologMezzoSC, SC.IdStrutturaOpPr, SC.Revisione, GRI.CodiceMezzo, 
			SC.CodTecnicoRisorsa, AASez.DSCAGENTE AS DescTecnicoRisorsa, SC.PAGAMENTO AS SEZ_PAGAMENTO, SC.DATAPVISITA AS SEZ_DATAPVISITA, 
			SC.FLG_OperDeroga, SC.NrOperazInDeroga, SC.CadenzeInDeroga, SC.NOTE AS SEZ_NOTE, GRI.NOTE_TECNICO, SC.REFERENTE AS SEZ_REFERENTE, 
			SC.FLAG_ELIMINATO AS SEZ_FLAG_ELIMINATO, SC.DATAEliminato, SC.RESP_MANU AS SEZ_RESP_MANU, SC.RESP_CONTR AS SEZ_RESP_CONTR, 
			GRI.TIPO_PIATTAFORMA, SC.REPARTO, GRI.OreIntPreviste AS ORE_INT, GRI.GIORNI_PIATT, SC.flg_mat_dafatt AS SEZ_flg_mat_dafatt, 
			SC.FLG_RIC_SCA_AUTO AS SEZ_FLG_RIC_SCA_AUTO, GRI.RIFCLIENTE, SC.FLGUSAPRZGEMMA AS SEZ_FLGUSAPRZGEMMA, SC.idGListinoContr, 
			SC.FLAG_PROV AS SEZ_FLAG_PROV, SC.CodSezioniAggregate, SC.SezioneAggrPrimaria, SC.ImportoContrattoSezione, SC.Provvigione1, 
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN ACF.dscconto1 ELSE DD.ragioneSociale END AS SedeRagSoc,
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN ACF.Indirizzo ELSE DD.Indirizzo END AS SedeIndirizzo,
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN ACF.Localita ELSE DD.Localita END AS SedeLocalita,
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN ACF.Provincia ELSE DD.Provincia END AS SedeProvincia,
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN ACF.CAP ELSE DD.CAP END AS SedeCAP,
			CASE ISNULL(GRI.coddest, 0) WHEN 0 THEN XC.CodSettoreGiriVisite ELSE DD.CodSettoreGiriVisite END AS SedeGiriVisite,
			ACF.TELEFONO, ACF.FAX, ACF.TELEX, ISNULL(SC.TEL_REF, '') AS SEZ_Tel_Ref, ISNULL(SC.EMAIL_RESPONSABILE, '') AS SEZ_Email_Responsabile, ISNULL(GRI.IdDivisione, 0) AS IdDivisione, 
			ISNULL(DIV.DscDivisione, '') AS DscDivisione, SC.IdDivisione AS idDivisioneSez, DIVSez.DscDivisione AS DscDivisioneSez, SC.NrVisiteTot
		FROM	GRI_RAPPORTI AS GRI
		INNER JOIN ANAGRAFICACF AS ACF ON GRI.CODCLIENTE = ACF.CODCONTO 
		LEFT OUTER JOIN EXTRACLIENTI AS XC ON XC.CODCONTO = ACF.CODCONTO
		LEFT OUTER JOIN DESTINAZIONIDIVERSE AS DD ON GRI.CODCLIENTE = DD.CODCONTO AND GRI.CODDEST=DD.CODICE
		LEFT OUTER JOIN ANAGRAFICAAGENTI AS AG1 ON GRI.CodAgente1 = AG1.CODAGENTE
		LEFT OUTER JOIN ANAGRAFICAAGENTI AS AG2 ON GRI.CodAgente2 = AG2.CODAGENTE
		LEFT OUTER JOIN GEM_SEZIONICONTRATTO AS SC ON GRI.IDCONTRATTO = SC.IDCONTRATTO  AND GRI.SEZIONECONTRATTO = SC.SEZIONECONTRATTO
		LEFT OUTER JOIN GEM_Vista_TipologMezzo AS TMSez ON SC.idTipologMezzo = TMSez.idTipologMezzo
		LEFT OUTER JOIN Ald_TabDivisioni AS DIVSez ON SC.IdDivisione = DIVSez.IdDivisione
		LEFT OUTER JOIN ANAGRAFICAAGENTI AS AASez ON SC.CodTecnicoRisorsa = AASez.CODAGENTE
		LEFT OUTER JOIN Ald_TabDivisioni AS DIV ON DIV.IdDivisione = GRI.IdDivisione


GO
GRANT SELECT
    ON OBJECT::[dbo].[GRI_VistaRapporti] TO [Metodo98]
    AS [dbo];

