
CREATE VIEW VISTAGIACENZE AS 
SELECT STMAG.BIS,
    STMAG.CODART,
    STMAG.CODCAMBIO,
    STMAG.CODCAUSALE,    
    STMAG.CODCLIFOR,
    STMAG.CODCOMMESSA,
    STMAG.CODDEPOSITO,
    STMAG.CODPAG,
    STMAG.CODUBICAZIONE,
    STMAG.CONTOCDCMOV,
    STMAG.DATAMOV,
    STMAG.DATARIFDOC,
    STMAG.DESTDIV,
    STMAG.GENVENACQ,
    STMAG.IDDISTINTABASE,
    STMAG.IDTESTA,
    STMAG.IMPORTOTOTLORDO,
    STMAG.IMPORTOTOTLORDOEURO,
    STMAG.IMPORTOTOTLORDOVAL,
    (CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTO ELSE STMAG.IMPORTOTOTNETTO+STMAG.SPESERIPMAG END) AS IMPORTOTOTNETTO,
    (CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTOEURO ELSE STMAG.IMPORTOTOTNETTOEURO+STMAG.SPESERIPMAGEURO END) AS IMPORTOTOTNETTOEURO,
    (CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTOVAL ELSE STMAG.IMPORTOTOTNETTOVAL+STMAG.SPESERIPMAGVAL END) AS IMPORTOTOTNETTOVAL,
    STMAG.SPESERIPMAG,
    STMAG.SPESERIPMAGEURO,
    STMAG.SPESERIPMAGVAL,
    STMAG.LISTINO,
    STMAG.NRIFDOC,
    STMAG.NRIFPARTITA,
    STMAG.NUMERODOC,
    STMAG.PROGRCOLLEGATO,
    STMAG.PROGRESSIVO,
    STMAG.QTA1UM,
    STMAG.QTA2UM,
    STMAG.RIFERIMENTI,
    STMAG.RIGACOMP,
    STMAG.RIGADOC,
    STMAG.SCONTO,
    STMAG.TIPODOC,
    STMAG.TIPOMOV,
    STMAG.VALCAMBIO,
    STMAG.VARIANTE,
    STMAG.ESERCIZIO,
    STMAG.DATADISP,
    STMAG.RESO,
    (STMAG.QTA1UM*STMAG.ORDINATO) AS ORDINATO,
    (STMAG.QTA1UM*STMAG.IMPEGNATO) AS IMPEGNATO,
    (STMAG.QTA2UM*STMAG.ORDINATO2UM) AS ORDINATO2UM,
    (STMAG.QTA2UM*STMAG.IMPEGNATO2UM) AS IMPEGNATO2UM,
    (STMAG.QTA1UM*STMAG.QUANTITACARICO) AS QTACARICO,
    (STMAG.QTA1UM*STMAG.QUANTITASCARICO) AS QTASCARICO,
    (STMAG.QTA2UM*STMAG.QUANTITACARICO) AS QTACARICO2UM,
    (STMAG.QTA2UM*STMAG.QUANTITASCARICO) AS QTASCARICO2UM,
    ((CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTO ELSE STMAG.IMPORTOTOTNETTO+STMAG.SPESERIPMAG END)*STMAG.VALORECARICO) AS VALORECARICO,
    ((CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTO ELSE STMAG.IMPORTOTOTNETTO+STMAG.SPESERIPMAG END)*STMAG.VALORESCARICO) AS VALORESCARICO,
    ((CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTOEURO ELSE STMAG.IMPORTOTOTNETTOEURO+STMAG.SPESERIPMAGEURO END)*STMAG.VALORECARICO) AS VALORECARICOEURO,
    ((CASE WHEN TVG.INCLUDISPRIP=0 THEN STMAG.IMPORTOTOTNETTOEURO ELSE STMAG.IMPORTOTOTNETTOEURO+STMAG.SPESERIPMAGEURO END)*STMAG.VALORESCARICO) AS VALORESCARICOEURO,
    (CASE WHEN STMAG.GIACENZA=1 and STMAG.RESO = 0 THEN STMAG.QTA1UM ELSE 0 END) AS CARICO,
    (CASE WHEN STMAG.GIACENZA2UM=1 and STMAG.RESO = 0 THEN STMAG.QTA2UM ELSE 0 END) AS CARICO2UM,
    (CASE WHEN STMAG.GIACENZA=-1 and STMAG.RESO = 0 THEN STMAG.QTA1UM ELSE 0 END) AS SCARICO,
    (CASE WHEN STMAG.GIACENZA2UM=-1 and STMAG.RESO = 0 THEN STMAG.QTA2UM ELSE 0 END) AS SCARICO2UM,
    (CASE WHEN STMAG.GIACENZA=-1 and STMAG.RESO = 1 THEN STMAG.QTA1UM ELSE 0 END) AS RESODACARICO,
    (CASE WHEN STMAG.GIACENZA2UM=-1 and STMAG.RESO = 1 THEN STMAG.QTA2UM ELSE 0 END) AS RESODACARICO2UM,
    (CASE WHEN STMAG.GIACENZA=1 and STMAG.RESO = 1 THEN STMAG.QTA1UM ELSE 0 END) AS RESODASCARICO,
    (CASE WHEN STMAG.GIACENZA2UM=1 and STMAG.RESO = 1 THEN STMAG.QTA2UM ELSE 0 END) AS RESODASCARICO2UM,
    STMAG.QUANTITACARICO AS FLGQTACARICO,
    STMAG.ORDINATO AS FLGORDINATO,
    STMAG.IMPEGNATO AS FLGIMPEGNATO,
    STMAG.ORDINATO2UM AS FLGORDINATO2UM,
    STMAG.IMPEGNATO2UM AS FLGIMPEGNATO2UM,
    STMAG.RIPVALGIAC0
    FROM STORICOMAG AS STMAG INNER JOIN TABVINCOLIGIC AS TVG ON STMAG.ESERCIZIO=TVG.ESERCIZIO

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAGIACENZE] TO [Metodo98]
    AS [dbo];

