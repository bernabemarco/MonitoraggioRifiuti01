CREATE VIEW VISTAANALISIDISP AS
SELECT 
	TMP.NRMOVIMENTO,
	TMP.CODART,
	SM.CODCAUSALE,
	(CASE WHEN TMP.NRMOVIMENTO<>0 THEN (SELECT DESCRIZIONE FROM TABCAUSALIMAG TCM WHERE SM.CODCAUSALE=TCM.CODICE) ELSE 'GIACENZA' END) AS DESCAUSALE,
	(CASE WHEN SM.TIPOMOV=0 
		THEN 
			SM.RIFERIMENTI 
		ELSE 
			(CASE WHEN (SM.TIPOMOV>=1 AND SM.TIPOMOV<=4) 
				THEN 
					(SM.TIPODOC+'/'+CAST(SM.ESERCIZIO AS VARCHAR)+'/'+CAST(SM.NUMERODOC AS VARCHAR)+'/'+SM.BIS) 
				ELSE 
					(CASE WHEN (SM.TIPOMOV=5 OR SM.TIPOMOV=6 OR SM.TIPOMOV=9 OR SM.TIPOMOV=10) 
						THEN 
							(SM.TIPODOC+'/'+CAST(SM.ESERCIZIO AS VARCHAR)+'/'+CAST(SM.NUMERODOC AS VARCHAR)+'/'+CAST(SM.RIGADOC AS VARCHAR)) 
						ELSE 
							(CASE WHEN (SM.TIPOMOV=7 OR SM.TIPOMOV=8 OR SM.TIPOMOV=11 OR SM.TIPOMOV=12) 
								THEN 
									(SM.TIPODOC+'/'+CAST(SM.ESERCIZIO AS VARCHAR)+'/'+CAST(SM.NUMERODOC AS VARCHAR)+'/'+CAST(SM.RIGADOC AS VARCHAR)+'/'+CAST(SM.RIGACOMP AS VARCHAR)) 
								ELSE 
									''
								END)
						END)
				END)
		END) AS "RIFERIMENTO",
	SM.CODCLIFOR,
	SM.CODCOMMESSA,
	SM.CODDEPOSITO,
	SM.NRIFPARTITA,
	TMP.DATADISP,
	(SELECT UM1 FROM VISTAARTICOLIUMBASE WHERE CODICE=TMP.CODART) AS UM1,
	(SELECT UM2 FROM VISTAARTICOLIUMBASE WHERE CODICE=TMP.CODART) AS UM2,
	TMP.QUANTITA AS QTAUM1,
	TMP.QUANTITA2UM AS QTAUM2,
	TMP.SITUAZIONE AS DISPUM1,
	TMP.SITUAZIONE2UM AS DISPUM2,
	TMP.GGSCOPERTO,
	VAA.DESCRIZIONE AS DESART,
	VAA.PROVENIENZA,
	VAA.TIPOGESTIONE,
	VAA.LIVPRODUZIONE,
	VAA.SCORTAMIN,
	VAA.CATEGORIA,
	VAA.CODCATEGORIASTAT,
	VAA.GRUPPO,
	AD.DISPONIBILE,
	AD.TIPODEPOSITO,
	TMP.IDSESSIONE,
	TMP.ORDINELETTURA,
	TMP.SCADUTO
	FROM (TEMPANALISIDISPARTICOLO TMP LEFT OUTER JOIN 
			(STORICOMAG SM INNER JOIN ANAGRAFICADEPOSITI AD ON SM.CODDEPOSITO=AD.CODICE) 
			ON TMP.NRMOVIMENTO=SM.PROGRESSIVO)
		INNER JOIN VISTAANAGRAFICAARTICOLI VAA ON TMP.CODART=VAA.CODICE

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAANALISIDISP] TO [Metodo98]
    AS [dbo];

