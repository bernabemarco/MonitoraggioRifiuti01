
--MANCANTI
CREATE VIEW TP_VISTACCVMMANCANTI AS
SELECT
RIGHEDOCUMENTI.CODDEPOSITO AS DEPOSITO,
YEAR(TESTEDOCUMENTI.DATADOC) AS ANNO,
MONTH(TESTEDOCUMENTI.DATADOC) AS MESE,
TESTEDOCUMENTI.ESERCIZIO,
RIGHEDOCUMENTI.CODART AS ARTICOLO,
SUM(TP_EXTRARIGHEDOC.MANCANTI) AS QUANTITA,
(SELECT ARTICOLIUMPREFERITE.UM FROM ARTICOLIUMPREFERITE WHERE ARTICOLIUMPREFERITE.CODART=RIGHEDOCUMENTI.CODART AND ARTICOLIUMPREFERITE.TIPOUM=1) UM1,
(SELECT ARTICOLIUMPREFERITE.UM FROM ARTICOLIUMPREFERITE WHERE ARTICOLIUMPREFERITE.CODART=RIGHEDOCUMENTI.CODART AND ARTICOLIUMPREFERITE.TIPOUM=2) UM2
FROM TP_EXTRARIGHEDOC
INNER JOIN RIGHEDOCUMENTI ON TP_EXTRARIGHEDOC.IDTESTA=RIGHEDOCUMENTI.IDTESTA 
	AND TP_EXTRARIGHEDOC.IDRIGA = RIGHEDOCUMENTI.IDRIGA
INNER JOIN TP_EXTRAMAG
	ON RIGHEDOCUMENTI.CODART=TP_EXTRAMAG.CODART AND TP_EXTRAMAG.CONSIDACQ=1
INNER JOIN TESTEDOCUMENTI on RIGHEDOCUMENTI.IDTESTA=TESTEDOCUMENTI.PROGRESSIVO 
	AND TP_EXTRARIGHEDOC.MANCANTI IS NOT NULL 
	AND TP_EXTRARIGHEDOC.MANCANTI <> 0
	AND TESTEDOCUMENTI.TIPODOC IN (SELECT (items ) AS DOC FROM SplitCCVMDOC('MAN'))
GROUP BY RIGHEDOCUMENTI.CODDEPOSITO,RIGHEDOCUMENTI.CODART,
YEAR(TESTEDOCUMENTI.DATADOC),MONTH(TESTEDOCUMENTI.DATADOC),TESTEDOCUMENTI.ESERCIZIO

GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTACCVMMANCANTI] TO [Metodo98]
    AS [dbo];

