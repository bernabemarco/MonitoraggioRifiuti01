
CREATE VIEW TP_VISTADOCPREVSUPRENOTATI
AS

SELECT
	MERCERICEVUTA.*
FROM
(
	SELECT
		TDOCP.*,
		RDOCP.IDTESTA AS RDOCP_TESTA,
		RDOCP.IDRIGA AS RDOCP_RRIGA,
		TDOFP.CODCLIFOR AS TDOFP_CODCLIFOR,
		TDOFP.TIPODOC AS TDOFP_TIPODOC,
		TDOFP.NUMERODOC AS TDOFP_NUMERODOC,
		TDOFP.DATADOC AS TDOFP_DATADOC,
		RDOFP.IDTESTA AS RDOFP_TESTA,
		RDOFP.IDRIGA AS RDOFP_RIGA,
		TDRMP.CODCLIFOR AS TDRMP_CODCLIFOR,
		TDRMP.TIPODOC AS TDRMP_TIPODOC,
		TDRMP.NUMERODOC AS TDRMP_NUMERODOC,
		TDRMP.DATADOC AS TDRMP_DATADOC,
		RDRMP.IDTESTA AS RDRMP_TESTA,
		RDRMP.IDRIGA AS RDRMP_RIGA
	FROM
		RIGHEDOCUMENTI RDOCP,
		RIGHEDOCUMENTI RDOFP,
		RIGHEDOCUMENTI RDRMP,
		TESTEDOCUMENTI TDRMP,
		TESTEDOCUMENTI TDOFP,
		TESTEDOCUMENTI TDOCP,
		TP_PRENOTATI TPP
	WHERE
		RDOCP.IDTESTA = TPP.IDTESTAP AND
		RDOCP.IDRIGA = TPP.IDRIGAP AND
		RDOFP.IDTESTARP = RDOCP.IDTESTA AND
		RDOFP.IDRIGARP = RDOCP.IDRIGA AND
		RDOFP.IDTESTA = TPP.IDTESTAO AND
		RDOFP.IDRIGA = TPP.IDRIGAO AND
		RDRMP.IDTESTARP = RDOFP.IDTESTA AND
		RDRMP.IDRIGARP = RDOFP.IDRIGA AND
		TDRMP.PROGRESSIVO = RDRMP.IDTESTA AND
		TDRMP.DOCCHIUSO = 0 AND		
		TDOFP.PROGRESSIVO = RDOFP.IDTESTA AND
		TDOCP.PROGRESSIVO = RDOCP.IDTESTA
) MERCERICEVUTA
LEFT JOIN
	TP_BOLLESUPRENPRELEVATE TBPP
ON
	TBPP.IDTESTADOCCAR = RDRMP_TESTA AND
	TBPP.IDRIGADOCCAR = RDRMP_RIGA
WHERE
	((TBPP.IDTESTADOCCAR IS NULL AND
	  TBPP.IDRIGADOCCAR IS NULL))

GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTADOCPREVSUPRENOTATI] TO [Metodo98]
    AS [dbo];

