
CREATE VIEW [dbo].[TP_VISTAORDINEFORNITOREPRODUZIONE]
AS

SELECT DISTINCT 
    PROGPRODUZIONE.CODART,
    PROGPRODUZIONE.CODART AS CODICE,
    ANAGRAFICAARTICOLI.DESCRIZIONE AS DESCARTICOLO,
    ANAGRAFICAARTICOLI.GRUPPO,
    ANAGRAFICAARTICOLI.CATEGORIA,
    ANAGRAFICAARTICOLI.CODCATEGORIASTAT,
    ANAGRAFICAARTICOLICOMM.GRUPPOPRZPART,
    TP_EXTRAMAG.CODFAMIGLIAPOS,
    TP_EXTRAMAG.CODREPARTOPOS,
    ANAGRAFICAARTICOLI.VARESPLICITE,
    (SELECT TOP 1 TLA.CODLIVELLOINTERNO FROM TP_LIVELLIARTICOLI TLA WHERE TLA.CODICE = PROGPRODUZIONE.CODART) AS LIVELLOMERCEOLOGICO,
    ANAGRAFICAARTICOLI.NRPEZZIIMBALLO,
    TABIMBALLI.PESOIMBALLO,
    ANAGRAFICAARTICOLI.PESONETTO,
    ANAGRAFICAARTICOLICOMM.CODIVA AS IVAART,
    TRATTAMENTOIVAART.ALIQUOTA AS ALIQUOTAART,
    ARTICOLIUMPREFERITE.UM AS UMBASE,  
    TP_PERIODO_OSSERVAZIONE.PROGRESSIVO AS PERIODOOSSERVAZIONE,
    TP_PERIODO_OSSERVAZIONE.GIORNI AS GIORNILAVOROPREVISTI,
    TP_PERIODO_OSSERVAZIONE.DESCRIZIONE AS DESCRIZIONEPERIODO,
    TP_EXTRAMAG.TP_TSICUR AS TEMPOSICUREZZA,
    ANAGRAFICAARTICOLIPROD.FATTORESICUREZZA,
    TP_EXTRAMAG.TP_SCORPORO,
    TP_EXTRAMAG.TP_CODICEINTERNO,
    TP_EXTRAMAG.CODICEOMOGENEOPASSIVO,
    TP_EXTRAMAG.GESTSTAG,
    TP_EXTRAMAG.OFTIPOPREVISIONALE,
    TP_EXTRAMAG.OFSMOOTHINGSTAGIONALE,
    TP_STATO_ARTICOLI.DESCRIZIONE AS STATOARTICOLO,
    ISNULL(TP_EXTRAMAG.OFARRQTAINORD,1) AS OFARRQTAINORD,
    TP_EXTRAMAG.RAEEGESTIONE,
    TP_EXTRAMAG.RAEEVALORE,
    TP_EXTRAMAG.RAEEUM,
    TP_EXTRAMAG.RAEEGENERICOACQ,
    TP_EXTRAMAG.RAEEGENERICOVEN,
    PROGPRODUZIONE.SCMINIMA AS SCORTAMINIMA,
    PROGPRODUZIONE.SCMASSIMA AS SCORTAMASSIMA,
    PROGPRODUZIONE.LIVRIORDINO AS LIVELLORIORDINO,
    ANAGRAFICAARTICOLIPROD.LOTTORIORDINO AS LOTTORIORDINO,  
    PROGPRODUZIONE.CODFOR AS TP_FORNFATTURAZIONE,
    FORNITOREFATTURAZIONE.DSCCONTO1 AS DESCFORNITOREFATTURAZIONE,
    PROGPRODUZIONE.CODFOR,
    FORNITORE.DSCCONTO1 AS DESCFORNITORE,
    FORNITORECF.CODIVA AS IVAFOR,
    TRATTAMENTOIVA.ALIQUOTA AS ALIQUOTAFOR,
    FORNITORECF.LISTINO AS LISTINOFOR,
    LISTINIFORNITORE.DESCRIZIONE AS DESCRIZIONELISTINOFOR,
    FORNITORECF.CODCAMBIO,
    CAMBIFORNITORE.DIVISA AS CODDIVISA,
    CAMBIFORNITORE.DESCRIZIONE AS DSCDIVISA,
    CAMBIFORNITORE.NDECIMALIUNITARIO AS NDECIMALIUNITARIOFOR,
    CAMBIFORNITORE.NDECIMALITOTALE AS NDECIMALITOTALEFOR,
    CAMBIFORNITORE.CAMBIOEURO AS VALCAMBIO,
    CAMBIFORNITORE.TIPOEURO,
    FORNITORECF.CODZONA AS CODZONAFOR,
    FORNITORECF.CODSETTORE AS CODSETTOREFOR,
    FORNITORECF.CODCATEGORIA AS CODCATEGORIACF, 
    FORNITORECF.CODPAG AS CODPAGCF,  
    FORNITORECF.RIVIVAOMAGGI,
    PROGPRODUZIONE.CODDEPOSITO AS TP_CODDEP,
    ANAGRAFICADEPOSITI.DESCRIZIONE AS DESCMAGAZZINO,
    0 as DISPONIBILE,
    TLR.GGAPPROVV,
    TLR.GGAPPRONT,
    TLR.QTAMASSIMA,
    TLR.QTAMINIMA,
    TP_TABMAGAZZINI.PROGRESSIVO AS PROGRMULTIDEPOSITO,  
    TP_EXTRAFORNITORI.TP_FMCASA AS MOLTIPLICATIVOFORNITORE,
    TP_EXTRAFORNITORI.TP_FMTAB AS MOLTIPLICATIVOTABELLA,
    TP_EXTRAFORNITORI.TP_TREV AS TEMPOREVISIONE, 
    TP_EXTRAFORNITORI.TP_TIPOFOR,
    TP_EXTRAFORNITORI.TP_OFPREZSCM,
    ISNULL(TP_EXTRAFORNITORI.TP_USAPREZZIPART,0) AS TP_USAPREZZIPART,
    (
        CASE TP_EXTRAMAG.MODALITACALCOLO
            WHEN 0 THEN EOQ.SCORTASICUREZZA
            WHEN 1 THEN PFR.SCORTASICUREZZA
            WHEN 2 THEN SCRT.SCORTASICUREZZA
            WHEN 3 THEN PERS.SCORTASICUREZZA
        END
    ) AS SCORTASICUREZZAMAG,
    (
        CASE TP_EXTRAMAG.MODALITACALCOLO
            WHEN 0 THEN EOQ.LOTTORIORDINO
            WHEN 1 THEN PFR.LOTTORIORDINO
            WHEN 2 THEN TLR.LOTTORIF
            WHEN 3 THEN PERS.LOTTORIORDINO
        END
    ) AS LOTTORIORDINOMAG,
    (
        CASE TP_EXTRAMAG.MODALITACALCOLO
            WHEN 0 THEN EOQ.LIVELLORIORDINO
            WHEN 1 THEN PFR.LIVELLORIORDINO
            WHEN 2 THEN SCRT.LIVELLORIORDINO
            WHEN 3 THEN PERS.LIVELLORIORDINO
        END
    ) AS LIVELLORIORDINOMAG,
    TP_EXTRAMAG.LIVELLOSERVIZIO AS LIVELLOSERVIZIOMAG,
    ISNULL(
                (
                CASE TP_EXTRAMAG.MODALITACALCOLO
                    WHEN 0 THEN EOQ.CodFornPref
                    WHEN 1 THEN PFR.CodFornPref
                    WHEN 2 THEN SCRT.CodFornPref
                    WHEN 3 THEN PERS.CodFornPref
                END
                )
            ,'') AS FORNITOREPREFERENZIALEMAG,
    TP_EXTRAMAG.MODALITACALCOLO,
    PROGPRODUZIONE.NOMEPIANIF,
    PROGPRODUZIONE.PROG_ID,
    PROGPRODUZIONE.DATACONS AS DATACONSEGNA,
    PROGPRODUZIONE.RIFCOMMCLI as RIFCOMMESSA,
    PROGPRODUZIONE.QTAORD-PROGPRODUZIONE.QTDOCEMESSO as QTAPROPOSTA,
    0 AS PREVISIONE,
    TP_EXTRAMAG.USAPREVISIONIFORZATE,
    TP_EXTRAMAG.QTAPREVISIONIFORZATE,
    TP_EXTRAMAG.UMPREVISIONIFORZATE,
    TP_EXTRAMAG.UTENTEPREVISIONIFORZATE,
    TP_EXTRAMAG.DATAPREVISIONIFORZATE,
    TP_EXTRAMAG.CODMARCHIO,
    TP_ORF_EXTRAMAG.*,
    TP_ORF_EXTRAFOR.*
FROM PROGPRODUZIONE
INNER JOIN TABLOTTIRIORDINO TLR
    ON TLR.CODART = PROGPRODUZIONE.CODART AND TLR.TP_CODDEP = PROGPRODUZIONE.CODDEPOSITO AND TLR.CODFOR = PROGPRODUZIONE.CODFOR
INNER JOIN ANAGRAFICAARTICOLI 
    ON ANAGRAFICAARTICOLI.CODICE=PROGPRODUZIONE.CODART  AND ANAGRAFICAARTICOLI.ARTTIPOLOGIA=0
INNER JOIN ANAGRAFICAARTICOLICOMM 
    ON ANAGRAFICAARTICOLICOMM.CODICEART=PROGPRODUZIONE.CODART AND ESERCIZIO =  (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME())
INNER JOIN ANAGRAFICAARTICOLIPROD 
    ON ANAGRAFICAARTICOLIPROD.CODICEART=PROGPRODUZIONE.CODART AND ANAGRAFICAARTICOLIPROD.ESERCIZIO= (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME())
LEFT JOIN TRATTAMENTOIVA AS TRATTAMENTOIVAART
    ON TRATTAMENTOIVAART.CODICE = ANAGRAFICAARTICOLICOMM.CODIVA
INNER JOIN TP_EXTRAMAG 
    ON TP_EXTRAMAG.CODART = PROGPRODUZIONE.CODART AND TP_EXTRAMAG.CONSIDACQ=1 
INNER JOIN TP_PERIODO_OSSERVAZIONE 
    ON TP_PERIODO_OSSERVAZIONE.PROGRESSIVO=TP_EXTRAMAG.TP_PERIODODIOSSERVAZIONE AND TP_EXTRAMAG.CODART=PROGPRODUZIONE.CODART  
INNER JOIN ARTICOLIUMPREFERITE 
    ON ARTICOLIUMPREFERITE.TIPOUM=1 AND ARTICOLIUMPREFERITE.CODART = PROGPRODUZIONE.CODART  
INNER JOIN ANAGRAFICACF AS FORNITOREFATTURAZIONE 
    ON FORNITOREFATTURAZIONE.CODCONTO=PROGPRODUZIONE.CODFOR 
INNER JOIN ANAGRAFICARISERVATICF AS FORNITOREFATTCF
    ON FORNITOREFATTCF.CODCONTO = FORNITOREFATTURAZIONE.CODCONTO AND FORNITOREFATTCF.ESERCIZIO = (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME())
INNER JOIN ANAGRAFICACF AS FORNITORE
    ON FORNITORE.CODCONTO=PROGPRODUZIONE.CODFOR
INNER JOIN ANAGRAFICARISERVATICF AS FORNITORECF
    ON FORNITORECF.CODCONTO = FORNITORE.CODCONTO AND FORNITORECF.ESERCIZIO = (SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = USER_NAME())
LEFT JOIN TABLISTINI AS LISTINIFORNITORE
    ON LISTINIFORNITORE.NRLISTINO = FORNITORECF.LISTINO AND LISTINIFORNITORE.CODCAMBIO = FORNITORECF.CODCAMBIO
LEFT JOIN TRATTAMENTOIVA
    ON TRATTAMENTOIVA.CODICE = FORNITORECF.CODIVA
LEFT JOIN TP_EXTRAFORNITORI
    ON TP_EXTRAFORNITORI.CODCONTO = FORNITORE.CODCONTO
LEFT OUTER JOIN ANAGRAFICADEPOSITI
    ON ANAGRAFICADEPOSITI.CODICE=PROGPRODUZIONE.CODDEPOSITO
INNER JOIN TP_TABMAGAZZINI
    ON TP_TABMAGAZZINI.CODDEPOSITO=PROGPRODUZIONE.CODDEPOSITO AND TP_TABMAGAZZINI.USAPERORDINE = 1
LEFT JOIN EXTRAMAG
    ON EXTRAMAG.CODART=PROGPRODUZIONE.CODART
LEFT JOIN TABCAMBI AS CAMBIFORNITORE
    ON CAMBIFORNITORE.CODICE = LISTINIFORNITORE.CODCAMBIO
LEFT JOIN   TP_STATO_ARTICOLI
    ON TP_STATO_ARTICOLI.CODICE = TP_EXTRAMAG.STATO_REV_SOS_ESA
LEFT JOIN TABIMBALLI
    ON TABIMBALLI.CODICE = ANAGRAFICAARTICOLI.RIFERIMIMBALLO
LEFT JOIN
    TP_ConfigSconti ScontiListino
ON
    ScontiListino.Attiva = 1 And ScontiListino.CodFor = PROGPRODUZIONE.CODFOR AND ((GETDATE() BETWEEN ScontiListino.DaData AND ScontiListino.AData) OR (GETDATE() >= ScontiListino.DaData and ScontiListino.AData IS NULL))
LEFT JOIN
    (
    SELECT
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTAMINIMACALCOLATA ELSE SCORTAMINIMAFORZATO END) AS SCORTASICUREZZA,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LOTTORIORDINOCALCOLATO ELSE LOTTORIORDINOFORZATO END) AS LOTTORIORDINO,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LIVELLORIORDINOCALCOLATO ELSE LIVELLORIORDINOFORZATO END) AS LIVELLORIORDINO
    FROM TP_APPROVV_DEPOSITI
    ) EOQ
ON
    EOQ.CODARTICOLO = PROGPRODUZIONE.CODART AND
    EOQ.CODDEPOSITO = PROGPRODUZIONE.CODDEPOSITO
LEFT JOIN
    (
    SELECT 
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTASICUREZZACALCOLATA ELSE SCORTASICUREZZAFORZATO END) AS SCORTASICUREZZA,
        0 AS LOTTORIORDINO,
        (CASE WHEN USAVALOREFORZATO = 0 THEN QTAOBIETTIVOCALCOLATA ELSE QTAOBIETTIVOFORZATO END) AS LIVELLORIORDINO
    FROM TP_PUNTOFISSORIORDINO
    ) PFR
ON
    PFR.CODARTICOLO = PROGPRODUZIONE.CODART AND
    PFR.CODDEPOSITO = PROGPRODUZIONE.CODDEPOSITO
LEFT JOIN
    (
    SELECT
        CodArticolo,
        CodDeposito,
        CodFornPref,
        (CASE WHEN USAVALOREFORZATO = 0 THEN SCORTASICUREZZA ELSE SCORTASICUREZZAFORZATO END) AS SCORTASICUREZZA,
        (CASE WHEN USAVALOREFORZATO = 0 THEN LIVELLORIORDINOCALCOLATO ELSE LIVELLORIORDINOFORZATO END) AS LIVELLORIORDINO
    FROM TP_SCORTA
    ) SCRT
ON
    SCRT.CODARTICOLO = PROGPRODUZIONE.CODART AND
    SCRT.CODDEPOSITO = PROGPRODUZIONE.CODDEPOSITO
LEFT JOIN
    (
    SELECT 
        CodArticolo,
        CodDeposito,
        CodFornPref,
        0 AS SCORTASICUREZZA,
        0 AS LOTTORIORDINO,
        0 AS LIVELLORIORDINO
    FROM TP_PERSONALIZZATOLIBERO
    ) PERS
ON
    PERS.CODARTICOLO = PROGPRODUZIONE.CODART AND
    PERS.CODDEPOSITO = PROGPRODUZIONE.CODDEPOSITO
LEFT JOIN TP_ORF_EXTRAMAG
    ON  TP_ORF_EXTRAMAG.TOEM_CODARTICOLO = PROGPRODUZIONE.CODART AND
        TP_ORF_EXTRAMAG.TOEM_CODDEPOSITO = PROGPRODUZIONE.CODDEPOSITO
LEFT JOIN TP_ORF_EXTRAFOR
    ON  TP_ORF_EXTRAFOR.TOEF_CODARTICOLO = PROGPRODUZIONE.CODART AND
        TP_ORF_EXTRAFOR.TOEF_CODFORNITORE = PROGPRODUZIONE.CODFOR
WHERE ((PROGPRODUZIONE.QTAORD>PROGPRODUZIONE.QTADOCUMENTO)) AND 
        PROGPRODUZIONE.TIPO = 1

GO
GRANT SELECT
    ON OBJECT::[dbo].[TP_VISTAORDINEFORNITOREPRODUZIONE] TO [Metodo98]
    AS [dbo];

