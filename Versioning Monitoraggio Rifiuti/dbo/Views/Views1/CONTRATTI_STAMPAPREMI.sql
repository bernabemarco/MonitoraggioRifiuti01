

CREATE VIEW CONTRATTI_STAMPAPREMI
AS

SELECT  DISTINCT  

     0 AS TIPO,   -- INCONDIZIONATI
     (CASE INC.TIPOLOGIA
        WHEN  'VALORE' THEN 0 -- 'PREMIO A VALORE FISSO' 
        WHEN  'PERCENTUALE' THEN 1 -- 'PREMIO A PERCENTUALE' 
        WHEN  'MERCEVALORE' THEN 2 -- 'PREMIO IN MERCE A VALORE'  
        WHEN  'MERCEQTA' THEN 3 -- 'PREMIO IN MERCE A QUANTITA'''
      END) AS TIPOLOGIA,
     INC.NOTA,
     (CASE WHEN INC.DADATA = '' THEN TC.DATAINIZIOCONTRATTO ELSE CAST(RIGHT(INC.DADATA,4) + '' + RIGHT(LEFT(INC.DADATA,5),2) + ''+ LEFT(INC.DADATA,2) AS DATETIME) END)  AS DADATA,
     (CASE WHEN INC.ADATA = '' THEN TC.DATAFINECONTRATTO ELSE CAST(RIGHT(INC.ADATA,4) + '' + RIGHT(LEFT(INC.ADATA,5),2) + ''+ LEFT(INC.ADATA,2) AS DATETIME) END) AS ADATA, 

     (CASE WHEN
            (CASE WHEN INC.ADATA = '' THEN TC.DATAFINECONTRATTO ELSE CAST(RIGHT(INC.ADATA,4) + '' + RIGHT(LEFT(INC.ADATA,5),2) + ''+ LEFT(INC.ADATA,2) AS DATETIME) END) > CONVERT(DATETIME , CAST(DAY(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2)) + '/'+ CAST(MONTH(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2))+ '/'+ CAST(YEAR(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(4)),103)
           THEN  CONVERT(DATETIME , CAST(DAY(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2)) + '/'+ CAST(MONTH(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2))+ '/'+ CAST(YEAR(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(4)),103)  
           ELSE (CASE WHEN INC.ADATA = '' THEN TC.DATAFINECONTRATTO ELSE CAST(RIGHT(INC.ADATA,4) + '' + RIGHT(LEFT(INC.ADATA,5),2) + ''+ LEFT(INC.ADATA,2) AS DATETIME) END) END) AS ADATA_2,
   
     INC.RIFCONTRIBUTO,
     INC.RIFSOTTORIGA AS NRRIGA,
     INC.BUDGETQTA, 
     INC.BUDGETVALORE, 
     INC.CONSUNTIVATOVALORE, 
     INC.CONSUNTIVATOQTA, 
     INC.PREMIOPERCENTUALE AS PERCENTUALE,
     ISNULL(INC.PREMIOMATURATO,0) AS PREMIOMATURATO,
     ISNULL(INCCONDATA.VALOREEFFETTIVO,0) AS PREMIOLIQUIDATO,
     ISNULL(INCCONDATA.RIFPROGRESSIVODOC,0) AS PROGRESSDOCLIQ,
     ISNULL(INCCONDATA.RIGARATA,0) AS NRRIGALIQ,
     TST.TIPODOC AS TIPODOCLIQ,
     TST.NUMERODOC AS NUMERODOCLIQ,
     TST.ESERCIZIO AS ESERCIZIOLIQ,
     TST.DATADOC AS DATADOCLIQ, 
     ISNULL(CL.CODSCONTO,'') AS CLASSIFICAZIONE,
     ISNULL(SC.DESCRIZIONE,'') AS DESCRIZ_CLASSIF,
     TC.PROGRESSIVO AS PROGR_CONTRATTO,
     TC.ESERCIZIO,
     TC.NUMEROCONTRATTO,
     TC.DESCRIZIONECONTRATTO,
     TC.CODICE,
     (SELECT DSCCONTO1 FROM ANAGRAFICACF CF WHERE CF.CODCONTO=TC.CODICE) AS DSCCONTO,
     TC.DATAINIZIOCONTRATTO,   
     TC.DATAFINECONTRATTO,
     TC.PERIODOULTIMOCALCAVANZ,
     TC.INDICEALBERO
   
FROM       
TESTE_CONTRATTI TC INNER JOIN CONTRATTILIQUIDAZIONE_UNIONEINCONDIZIONATI_PRINT INC ON 
TC.PROGRESSIVO = INC.RIFCONTRATTO 
LEFT JOIN CONTRATTILIQUIDAZIONE_UNIONEINCONDIZIONATICONDATA INCCONDATA ON 
INC.RIFCONTRATTO = INCCONDATA.RIFCONTRATTO AND INC.RIFCONTRIBUTO = INCCONDATA.RIFCONTRIBUTO AND INC.RIFSOTTORIGA = INCCONDATA.RIFSOTTORIGA 
AND INCCONDATA.EMESSO = 1 
LEFT JOIN contratti_Cl CL ON 
INC.RIFCONTRATTO = CL.RIFPROGRESSIVO AND
INC.RIFCONTRIBUTO = CL.NRRIGA 
LEFT JOIN CONTRATTI_CONFIGSCONTI SC ON 
CL.CODSCONTO = SC.CODICE
LEFT JOIN TESTEDOCUMENTI TST ON 
INCCONDATA.RIFPROGRESSIVODOC = TST.PROGRESSIVO
WHERE TC.TIPONODO <> 5

UNION ALL

SELECT  DISTINCT
     
     1 AS TIPO,   --CONDIZIONATI
     -1 AS TIPOLOGIA,
     CC.NOTE,
     CC.DADATA,
     CC.ADATA,
     (CASE WHEN CC.ADATA > CONVERT(DATETIME , CAST(DAY(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2)) + '/'+ CAST(MONTH(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2))+ '/'+ CAST(YEAR(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(4)),103) 
           THEN  CONVERT(DATETIME , CAST(DAY(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2)) + '/'+ CAST(MONTH(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(2))+ '/'+ CAST(YEAR(TC.PERIODOULTIMOCALCAVANZ) as VARCHAR(4)),103) 
           ELSE CC.ADATA END) AS ADATA_2,   
     CC.PROGRESSIVO AS RIFCONTRIBUTO,
     CCDATELIQ.NRRIGA,
     CC.BUDGET_QTA AS BUDGETQTA, 
     CC.BUDGET_VALORE AS BUDGETVALORE, 
     ISNULL((SELECT TOP 1 CONSUNTIVATOVALORE FROM CONTRATTIRANGE_CON CCR WHERE CCR.RIFPROGRESSIVO = CC.PROGRESSIVO),0) as  CONSUNTIVATOVALORE, 
     ISNULL((SELECT TOP 1 CONSUNTIVATOQTA FROM CONTRATTIRANGE_CON CCR WHERE CCR.RIFPROGRESSIVO = CC.PROGRESSIVO),0) as  CONSUNTIVATOQTA, 
     ISNULL((SELECT TOP 1 PREMIOPERCENT FROM CONTRATTIRANGE_CON CCR WHERE CCR.RIFPROGRESSIVO = CC.PROGRESSIVO),0) as  PERCENTUALE,
     (SELECT SUM(PREMIOMATURATO) FROM CONTRATTIRANGE_CON CCR 
      WHERE CCR.RIFPROGRESSIVO = CC.PROGRESSIVO) AS PREMIOMATURATO,
     ISNULL(CCDATELIQ.VALOREEFFETTIVO,0) AS PREMIOLIQUIDATO,
     ISNULL(CCDATELIQ.RIFPROGRESSIVODOC,0) AS PROGRESSDOCLIQ,
     ISNULL(CCDATELIQ.NRRIGA,0) AS NRRIGALIQ,  
     TST.TIPODOC AS TIPODOCLIQ,
     TST.NUMERODOC AS NUMERODOCLIQ,
     TST.ESERCIZIO AS ESERCIZIOLIQ,
     TST.DATADOC AS DATADOCLIQ,
     ISNULL(CC.CODSCONTO,'') AS CLASSIFICAZIONE,
     ISNULL(SC.DESCRIZIONE,'') AS DESCRIZ_CLASSIF,
     TC.PROGRESSIVO AS PROGR_CONTRATTO,
     TC.ESERCIZIO,
     TC.NUMEROCONTRATTO,
     TC.DESCRIZIONECONTRATTO,
     TC.CODICE,
     (SELECT DSCCONTO1 FROM ANAGRAFICACF CF WHERE CF.CODCONTO=TC.CODICE) AS DSCCONTO,
     TC.DATAINIZIOCONTRATTO,   
     TC.DATAFINECONTRATTO,
     TC.PERIODOULTIMOCALCAVANZ,
     TC.INDICEALBERO           

FROM 
    TESTE_CONTRATTI TC INNER JOIN CONTRATTI_CON CC ON
    TC.PROGRESSIVO = CC.RIFCONTRATTO 
    LEFT JOIN CONTRATTICC_DATELIQ CCDATELIQ ON 
    CC.RIFCONTRATTO=CCDATELIQ.RIFPROGRESSIVO AND CC.PROGRESSIVO=CCDATELIQ.RIFPROGRESSIVOCC AND CCDATELIQ.EMESSO=1
    LEFT JOIN CONTRATTI_CONFIGSCONTI SC ON 
    CC.CODSCONTO = SC.CODICE
    LEFT JOIN TESTEDOCUMENTI TST ON 
    CCDATELIQ.RIFPROGRESSIVODOC = TST.PROGRESSIVO
WHERE TC.TIPONODO <> 5 



GO
GRANT SELECT
    ON OBJECT::[dbo].[CONTRATTI_STAMPAPREMI] TO [Metodo98]
    AS [dbo];

