CREATE VIEW VISTASCADENZEPREVSTP
  AS SELECT 1 AS TIPOREC,SP.PROGRESSIVO,
    SP.ESERCIZIO,
    SP.ANNODOC,
    SP.TIPODOC,
    SP.NUMDOC,
    SP.BIS,
    SP.NUMSCAD,
    SP.DATASCADENZA,
    SP.CODCLIFOR,
    SP.DATAFATTURA,
    SP.BANCAINC,
    SP.BANCAAPPOGGIO,
    SP.NUMRIF,
    SP.NUMEROPROT,
    SP.CODAGE1,
    SP.CODAGE2,
    SP.CODAGE3,
    SP.IMPPROVLIT1,
    SP.IMPPROVLIT2,
    SP.IMPPROVLIT3,
    SP.IMPPROVVAL1,
    SP.IMPPROVVAL2,
    SP.IMPPROVVAL3,
    SP.IMPPROVEURO1,
    SP.IMPPROVEURO2,
    SP.IMPPROVEURO3,
    SP.LIQPROV1,
    SP.LIQPROV2,SP.LIQPROV3,
    SP.IMPORTOSCLIT,
    SP.IMPORTOSCVAL,
    SP.IMPORTOSCEURO,SP.IMPONIBSCLIT,SP.IMPONIBSCVAL,
    SP.IMPONIBSCEURO,
    SP.TOTFATTLIT,
    SP.TOTFATTVAL,
    SP.TOTFATTEURO,
    SP.IMPFATTLIT,
    SP.IMPFATTVAL,
    SP.IMPFATTEURO,
    SP.FLAGCONT,SP.TIPOEFFETTO,
    SP.ESITO,
    SP.LIVSOLL,
    SP.LIQINS1,SP.LIQINS2,
    SP.LIQINS3,
    SP.CODCAMBIO,
    SP.VALCAMBIO,
    SP.NRDISTINTA,
    SP.NUMRAGGR,
    SP.DATAPAGEFF,
    SP.SCADATTPASS,
    SP.NUMRIFPARTCONT,SP.CODPAG,
    SP.DATADEC,
    SP.NOTE,
    SP.NRGIORNALE,
    SP.UTENTEMODIFICA,
    SP.DATAMODIFICA,
    (SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS CONTORIFBANCA,
    (SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO=CODCLIFOR) AS DSCCONTO1,
    (SELECT DSCBANCA FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AS DSCBANCA,
    (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE1) AS DSCAGENTE1,
    (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE2) AS DSCAGENTE2,
    (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE3) AS DSCAGENTE3,
    (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SP.TIPOEFFETTO) AS DSCEFFETTO,
    (SELECT DESCRIZIONE FROM ESITI WHERE ESITI.ESITO=SP.ESITO) AS DSCESITO,
    (CASE WHEN ((SP.SCADATTPASS<>0 AND SUBSTRING(SP.CODCLIFOR,1,1)='F') OR(SP.SCADATTPASS=0 AND SUBSTRING(SP.CODCLIFOR,1,1)<>'F')) THEN(SP.IMPORTOSCLIT*-1) ELSE SP.IMPORTOSCLIT END) AS IMPORTOSCADLIRE,
    (CASE WHEN ((SP.SCADATTPASS<>0 AND SUBSTRING(SP.CODCLIFOR,1,1)='F') OR(SP.SCADATTPASS=0 AND SUBSTRING(SP.CODCLIFOR,1,1)<>'F')) THEN(SP.IMPORTOSCEURO*-1) ELSE SP.IMPORTOSCEURO END) AS IMPORTOSCADEURO,
    (CASE WHEN ((SP.SCADATTPASS<>0 AND SUBSTRING(SP.CODCLIFOR,1,1)='F') OR(SP.SCADATTPASS=0 AND SUBSTRING(SP.CODCLIFOR,1,1)<>'F')) THEN(SP.IMPORTOSCVAL*-1) ELSE SP.IMPORTOSCVAL END) AS IMPORTOSCADVALUTA,
    (SELECT CODNAZIONE FROM ANAGRAFICACF WHERE CODCONTO=CODCLIFOR) AS NAZIONE,
    (SELECT CODSETTORE FROM ANAGRAFICARISERVATICF WHERE CODCONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SETTORE,
    (SELECT CODZONA FROM ANAGRAFICARISERVATICF WHERE CODCONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS ZONA,
    (SELECT CODCATEGORIA FROM ANAGRAFICARISERVATICF WHERE CODCONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS CATEGORIA,
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOPN,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOPNVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOPNEURO,
    (SELECT SALDO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOBANCA,
    (SELECT SALDOVALUTA FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOBANCAVALUTA,
    (SELECT SALDOEURO FROM VISTASALDOCONTIPN WHERE CONTO=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=BANCAINC) AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SALDOBANCAEURO
    FROM SCADENZEPREVISIONALI SP


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASCADENZEPREVSTP] TO [Metodo98]
    AS [dbo];

