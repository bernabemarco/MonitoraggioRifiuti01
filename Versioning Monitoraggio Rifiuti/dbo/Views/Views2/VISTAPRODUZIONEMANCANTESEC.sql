create view VISTAPRODUZIONEMANCANTESEC as
	select 
		IMP.IDTESTA as RIFTESTA,IMP.IDRIGA as RIFRIGA,IMP.IDIMPEGNO as RIFIMPEGNO,
		IMP.CODART,DEPOSITO,UM.UM2 as UM,
		QTA2MAGRES as FABBISOGNO,
		(select sum(GIAC.ORDINATO2UM) from VISTAGIACENZE GIAC WHERE IMP.CODART=GIAC.CODART AND IMP.DEPOSITO=GIAC.CODDEPOSITO) as ORDINATO,
		(select sum(GIAC.IMPEGNATO2UM) from VISTAGIACENZE GIAC WHERE IMP.CODART=GIAC.CODART AND IMP.DEPOSITO=GIAC.CODDEPOSITO) as IMPEGNATO,
		(select sum(GIAC.CARICO2UM)+sum(GIAC.RESODASCARICO2UM) from VISTAGIACENZE GIAC WHERE IMP.CODART=GIAC.CODART AND IMP.DEPOSITO=GIAC.CODDEPOSITO) as CARICHI,
		(select sum(GIAC.SCARICO2UM)+sum(GIAC.RESODACARICO2UM) from VISTAGIACENZE GIAC WHERE IMP.CODART=GIAC.CODART AND IMP.DEPOSITO=GIAC.CODDEPOSITO) as SCARICHI,
		((select sum(GIAC.IMPEGNATO2UM) from VISTAGIACENZE GIAC WHERE IMP.CODART=GIAC.CODART AND IMP.DEPOSITO=GIAC.CODDEPOSITO) - QTA2MAGRES) as ALTRIIMPEGNI
	from 
		IMPEGNIORDPROD IMP inner join VISTAARTICOLIUMBASE UM
		on IMP.CODART=UM.CODICE

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAPRODUZIONEMANCANTESEC] TO [Metodo98]
    AS [dbo];

