
CREATE VIEW VISTASITUAZIONECASTELLETTOBAN AS
  SELECT TS.PROGRESSIVO,TS.BANCAINC,DATEPART(YEAR,TS.DATASCADENZA) AS ANNO, DATEPART(MONTH,(SELECT DATAEMISS FROM dbo.DISTINTEEFFETTI WHERE PROGRESSIVO=TS.NRDISTINTA)) AS MESEEMISS,DATEPART(YEAR,(SELECT DATAEMISS FROM dbo.DISTINTEEFFETTI WHERE PROGRESSIVO=TS.NRDISTINTA)) AS ANNOEMISS,DATEPART(MONTH,TS.DATASCADENZA) AS MESE,TS.DATASCADENZA,TS.IMPORTOSCLIT,TS.IMPORTOSCEURO,TS.IMPORTOSCVAL,
   (SELECT SUM(CASTELLETTO) FROM CASTELLETTOBANCHE AS CB WHERE CB.CODBANCA = TS.BANCAINC AND TS.DATASCADENZA >= CB.DATAINIVALIDITA AND TS.DATASCADENZA <= CB.DATAFINEVALIDITA) AS CASTELLETTO,
   (SELECT SUM(CASTELLETTOEURO) FROM CASTELLETTOBANCHE AS CB WHERE CB.CODBANCA = TS.BANCAINC AND TS.DATASCADENZA >= CB.DATAINIVALIDITA AND TS.DATASCADENZA <= CB.DATAFINEVALIDITA) AS CASTELLETTOEURO,
   (SELECT SUM(IMPORTOSCADLIRE) FROM VISTASCADENZE WHERE (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) <= CAST(CAST(YEAR(TS.DATASCADENZA) AS VARCHAR(4))+'-01-01' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOLITPREC,
   (SELECT SUM(IMPORTOSCADEURO) FROM VISTASCADENZE WHERE (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) <= CAST(CAST(YEAR(TS.DATASCADENZA) AS VARCHAR(4))+'-01-01' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOEUROPREC,
   (SELECT SUM(IMPORTOSCADVALUTA) FROM VISTASCADENZE WHERE (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) <= CAST(CAST(YEAR(TS.DATASCADENZA) AS VARCHAR(4))+'-01-01' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOVALPREC,
   (SELECT SUM(IMPORTOSCADLIRE) FROM VISTASCADENZE WHERE VISTASCADENZE.DATASCADENZA BETWEEN (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) AND CAST(CAST(YEAR(TS.DATASCADENZA)-1 AS VARCHAR(4))+'-12-31' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOLITDICPREC,
   (SELECT SUM(IMPORTOSCADEURO) FROM VISTASCADENZE WHERE VISTASCADENZE.DATASCADENZA BETWEEN (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) AND CAST(CAST(YEAR(TS.DATASCADENZA)-1 AS VARCHAR(4))+'-12-31' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOEURODICPREC,
   (SELECT SUM(IMPORTOSCADVALUTA) FROM VISTASCADENZE WHERE VISTASCADENZE.DATASCADENZA BETWEEN (SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE PROGRESSIVO=VISTASCADENZE.NRDISTINTA) AND CAST(CAST(YEAR(TS.DATASCADENZA)-1 AS VARCHAR(4))+'-12-31' AS DATE) AND VISTASCADENZE.BANCAINC = TS.BANCAINC AND VISTASCADENZE.ESITO = 1 AND VISTASCADENZE.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(VISTASCADENZE.CODCLIFOR,1)='C') AS TOTEMESSOVALDICPREC,
   (SELECT SUM(SS.IMPORTOSCADLIRE) FROM VISTASCADENZE AS SS WHERE SS.NRDISTINTA=TS.NRDISTINTA AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOLIT,
   (SELECT SUM(SS.IMPORTOSCADEURO) FROM VISTASCADENZE AS SS WHERE SS.NRDISTINTA=TS.NRDISTINTA AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOEURO,
   (SELECT SUM(SS.IMPORTOSCADVALUTA) FROM VISTASCADENZE AS SS WHERE SS.NRDISTINTA=TS.NRDISTINTA AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOVAL,
   (SELECT SUM(SS.IMPORTOSCADLIRE) FROM VISTASCADENZE AS SS WHERE YEAR((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=YEAR(TS.DATASCADENZA) AND MONTH((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOLITDISTINTA,
   (SELECT SUM(SS.IMPORTOSCADEURO) FROM VISTASCADENZE AS SS WHERE YEAR((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=YEAR(TS.DATASCADENZA) AND MONTH((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOEURODISTINTA,
   (SELECT SUM(SS.IMPORTOSCADVALUTA) FROM VISTASCADENZE AS SS WHERE YEAR((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=YEAR(TS.DATASCADENZA) AND MONTH((SELECT DATAEMISS FROM DISTINTEEFFETTI WHERE DISTINTEEFFETTI.PROGRESSIVO=SS.NRDISTINTA))=MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS TOTEMESSOVALDISTINTA,
   (SELECT SUM(SS.IMPORTOSCADLIRE) FROM VISTASCADENZE AS SS WHERE YEAR(SS.DATASCADENZA)=YEAR(TS.DATASCADENZA) AND MONTH(SS.DATASCADENZA) = MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS EMESSOLIT,
   (SELECT SUM(SS.IMPORTOSCADEURO) FROM VISTASCADENZE AS SS WHERE YEAR(SS.DATASCADENZA)=YEAR(TS.DATASCADENZA) AND MONTH(SS.DATASCADENZA) = MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS EMESSOEURO,
   (SELECT SUM(SS.IMPORTOSCADVALUTA) FROM VISTASCADENZE AS SS WHERE YEAR(SS.DATASCADENZA)=YEAR(TS.DATASCADENZA) AND MONTH(SS.DATASCADENZA) = MONTH(TS.DATASCADENZA) AND SS.BANCAINC = TS.BANCAINC AND SS.ESITO = 1 AND SS.tipoeffetto IN (SELECT Effetto FROM TipiEffetti WHERE Tipo IN ('R','T')) AND LEFT(SS.CODCLIFOR,1)='C') AS EMESSOVAL FROM
   TABSCADENZE AS TS WHERE TS.ESITO = 1 AND ISNULL(TS.NRDISTINTA,0)<>0

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASITUAZIONECASTELLETTOBAN] TO [Metodo98]
    AS [dbo];

