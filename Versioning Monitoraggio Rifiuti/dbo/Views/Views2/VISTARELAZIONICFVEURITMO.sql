

CREATE VIEW VISTARELAZIONICFVEURITMO AS
SELECT 
    CODCLIFOR AS CODCLIFOR,
    '' AS RIFERIMENTO,
    '' AS ARTICOLO,
    '' AS VARIANTI,
    '' AS DESCRIZIONE,
    '' AS TIPOREL,
    '' AS MOSTRAVARIANTI,
    USER_NAME() AS UTENTEMODIFICA,
    GETDATE() AS DATAMODIFICA,
    '' AS DSCART,
    '' AS ARTTIPOLOGIA,
    '' AS CODICEPRIMARIO,
    '' AS CODICERIF,
    '' AS CODARTICOLO,
    '' AS VARESPLICITE 
FROM
    RELAZIONICFV
WHERE CODCLIFOR IN(SELECT CODICE FROM TABCLIFOREURITMO)/*AND TIPOREL = 4 */
GROUP BY CODCLIFOR,UTENTEMODIFICA
UNION
SELECT 
    CODCLIFOR,
    RIFERIMENTO,
    ARTICOLO,
    VARIANTI,
    DESCRIZIONE,
    TIPOREL,
    MOSTRAVARIANTI,
    UTENTEMODIFICA,
    DATAMODIFICA,
  (CASE WHEN VARIANTI = '' OR VARIANTI IS NULL OR CHARINDEX('?', VARIANTI) > 0 THEN
      (SELECT     DESCRIZIONE
       FROM      ANAGRAFICAARTICOLI
       WHERE     CODICE = ARTICOLO) 
   ELSE 
       CASE WHEN VARESPLICITE = '' THEN
          (SELECT     DESCRIZIONE
           FROM       ANAGRAFICAARTICOLI
           WHERE      CODICE = ARTICOLO + '#' + VARIANTI) 
       ELSE     
          (SELECT DESCRIZIONE 
           FROM   ANAGRAFICAARTICOLI 
           WHERE  CODICE =  (select dbo.FUSRicercaArticolo_Varianti(RELAZIONICFV.ARTICOLO,RELAZIONICFV.VARESPLICITE)))
       END
   END) AS DSCART, 
 
  (CASE WHEN VARIANTI = '' OR VARIANTI IS NULL OR CHARINDEX('?', VARIANTI) > 0 THEN
      (SELECT    ARTTIPOLOGIA
       FROM      ANAGRAFICAARTICOLI
       WHERE     CODICE = ARTICOLO) 
   ELSE
      CASE WHEN VARESPLICITE = '' THEN 
       (SELECT    ARTTIPOLOGIA
        FROM      ANAGRAFICAARTICOLI
        WHERE     CODICE = ARTICOLO + '#' + VARIANTI) 
      ELSE   
        (SELECT    ARTTIPOLOGIA
         FROM      ANAGRAFICAARTICOLI
         WHERE CODICE = (select dbo.FUSRicercaArticolo_Varianti(RELAZIONICFV.ARTICOLO,RELAZIONICFV.VARESPLICITE)))   
      END
   END) AS ARTTIPOLOGIA, 
 
 (CASE WHEN VARIANTI = '' OR VARIANTI IS NULL OR CHARINDEX('?', VARIANTI) > 0 THEN
      (SELECT    CODICE
       FROM      ANAGRAFICAARTICOLI
       WHERE     CODICE = ARTICOLO) 
  ELSE
      CASE WHEN VARESPLICITE = '' THEN   
        (SELECT     CODICEPRIMARIO
         FROM       ANAGRAFICAARTICOLI
         WHERE      CODICE = ARTICOLO + '#' + VARIANTI) 
      ELSE
        (SELECT     CODICEPRIMARIO
         FROM       ANAGRAFICAARTICOLI
         WHERE      CODICE = (select dbo.FUSRicercaArticolo_Varianti(RELAZIONICFV.ARTICOLO,RELAZIONICFV.VARESPLICITE)))
      END      
  END) AS CODICEPRIMARIO,
  (CASE WHEN (TIPOREL=1 OR TIPOREL=4) THEN ARTICOLO ELSE REPLACE(RIFERIMENTO,'.','') END) AS CODICERIF, /* unico codice riferimento per pi� articoli in metodo */
  (CASE WHEN Varianti = '' OR VARIANTI IS NULL THEN 
    Articolo 
   ELSE 
     CASE WHEN VARESPLICITE = ''  THEN   
       (Articolo + '#' + replace(Varianti, '?', '%')) 
     ELSE
       (select dbo.FUSRicercaArticolo_Varianti(RELAZIONICFV.ARTICOLO,RELAZIONICFV.VARESPLICITE))
     END
   END) CodArticolo,VARESPLICITE    

FROM
    RELAZIONICFV
WHERE CODCLIFOR IN(SELECT CODICE FROM TABCLIFOREURITMO)/* AND TIPOREL = 4 */



GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTARELAZIONICFVEURITMO] TO [Metodo98]
    AS [dbo];

