CREATE VIEW VISTASCADENZESALDO2 AS 
SELECT
    SC.*,
    (CASE WHEN (SELECT SALDO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILE,
    (CASE WHEN (SELECT SALDOEURO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDOEURO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDOEURO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDOEURO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILEEURO,
    (CASE WHEN (SELECT SALDOVALUTA FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDOVALUTA FROM VISTASALDIFINALIPN WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDOVALUTA) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDOVALUTA) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILEVALUTA,
    (CASE WHEN (SELECT SALDO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILECONTORIF,
    (CASE WHEN (SELECT SALDOEURO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDOEURO FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDOEURO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDOEURO) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILECONTORIFEURO,
    (CASE WHEN (SELECT SALDOVALUTA FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SALDOVALUTA FROM VISTASALDIFINALIPN WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25)))-1 AND PROVVISORIO=0) END) + (CASE WHEN (SELECT SUM(SALDOVALUTA) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) IS NULL THEN 0 ELSE (SELECT SUM(SALDOVALUTA) FROM VISTASALDICONTABILITA WHERE CONTO=SC.CONTORIFBANCA AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB = CAST(USER_NAME() AS VARCHAR(25))) AND PROVVISORIO=0) END) AS SALDOCONTABILECONTORIFVALUTA
FROM
    VISTASCADENZE SC


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASCADENZESALDO2] TO [Metodo98]
    AS [dbo];

