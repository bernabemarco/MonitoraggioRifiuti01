
CREATE VIEW [dbo].[zzCodiciPrimaProduzione]
AS
SELECT     dbo.RIGHEDOCUMENTI.CODART, dbo.TESTEDOCUMENTI.CODCLIFOR, MIN(dbo.TESTEDOCUMENTI.DATADOC) AS DATADOC,
                          (SELECT     COUNT(DISTINCT CODCLIFOR) AS Expr1
                            FROM          dbo.VISTADOCUMENTIBASE
                            WHERE      (TIPODOC IN ('orc', 'ocr')) AND (CODART = dbo.RIGHEDOCUMENTI.CODART)) AS Nr
FROM         dbo.TESTEDOCUMENTI INNER JOIN
                      dbo.RIGHEDOCUMENTI ON dbo.TESTEDOCUMENTI.PROGRESSIVO = dbo.RIGHEDOCUMENTI.IDTESTA INNER JOIN
                      dbo.ANAGRAFICAARTICOLIPROD ON dbo.RIGHEDOCUMENTI.CODART = dbo.ANAGRAFICAARTICOLIPROD.CODICEART
WHERE     ((SELECT     COUNT(*) AS Expr1
                         FROM         dbo.VISTADOCUMENTIBASE AS VISTADOCUMENTIBASE_1
                         WHERE     (TIPODOC IN ('orc. ocr')) AND (CODCLIFOR <> dbo.TESTEDOCUMENTI.CODCLIFOR) AND (CODART = dbo.RIGHEDOCUMENTI.CODART) AND 
                                               (DATADOC < dbo.TESTEDOCUMENTI.DATADOC)) = 0) AND (dbo.ANAGRAFICAARTICOLIPROD.ESERCIZIO = YEAR(GETDATE())) AND 
                      (dbo.ANAGRAFICAARTICOLIPROD.PROVENIENZA = 1) AND (dbo.TESTEDOCUMENTI.TIPODOC = 'orc' OR
                      dbo.TESTEDOCUMENTI.TIPODOC = 'ocr')
GROUP BY dbo.RIGHEDOCUMENTI.CODART, dbo.TESTEDOCUMENTI.CODCLIFOR

GO
GRANT SELECT
    ON OBJECT::[dbo].[zzCodiciPrimaProduzione] TO [Metodo98]
    AS [dbo];

