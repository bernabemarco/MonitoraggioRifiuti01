CREATE VIEW VISTAUNIONSCADENZE3 AS
SELECT TIPOREC=1,SC.PROGRESSIVO,
  SC.ESERCIZIO,
  SC.ANNODOC,
  SC.TIPODOC,
  SC.NUMDOC,
  SC.BIS,
  SC.NUMSCAD,
  SC.DATASCADENZA,
  SC.CODCLIFOR,
  SC.DATAFATTURA,
  SC.BANCAINC,
  SC.BANCAAPPOGGIO,
  SC.NUMRIF,
  SC.NUMEROPROT,
  SC.CODAGE1,
  SC.CODAGE2,
  SC.CODAGE3,
  SC.IMPPROVLIT1,
  SC.IMPPROVLIT2,
  SC.IMPPROVLIT3,
  SC.IMPPROVVAL1,
  SC.IMPPROVVAL2,
  SC.IMPPROVVAL3,
  SC.IMPPROVEURO1,
  SC.IMPPROVEURO2,
  SC.IMPPROVEURO3,
  SC.LIQPROV1,
  SC.LIQPROV2,SC.LIQPROV3,
  SC.IMPORTOSCLIT,
  SC.IMPORTOSCVAL,
  SC.IMPORTOSCEURO,SC.IMPONIBSCLIT,SC.IMPONIBSCVAL,
  SC.IMPONIBSCEURO,
  SC.TOTFATTLIT,
  SC.TOTFATTVAL,
  SC.TOTFATTEURO,
  SC.IMPFATTLIT,
  SC.IMPFATTVAL,
  SC.IMPFATTEURO,
  SC.FLAGCONT,SC.TIPOEFFETTO,
  SC.ESITO,
  SC.LIVSOLL,
  SC.LIQINS1,SC.LIQINS2,
  SC.LIQINS3,
  SC.CODCAMBIO,
  SC.VALCAMBIO,
  SC.NRDISTINTA,
  SC.NUMRAGGR,
  SC.DATAPAGEFF,
  SC.SCADATTPASS,
  SC.NUMRIFPARTCONT,SC.CODPAG,
  SC.DATADEC,
  SC.NOTE,
  SC.NRGIORNALE,
  SC.UTENTEMODIFICA,
  SC.DATAMODIFICA,
  (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SC.TIPOEFFETTO) AS EFFETTO,
  (CASE WHEN((SC.SCADATTPASS<>0 AND SUBSTRING(SC.CODCLIFOR,1,1)='F') OR(SC.SCADATTPASS=0 AND SUBSTRING(SC.CODCLIFOR,1,1)<>'F')) THEN -1 ELSE 1 END) AS ATTPASS, 
  ' ' AS TDOC,
  MONTH(SC.DATASCADENZA) AS MESE,
  (SELECT SUM(ISNULL(Saldo,0))+SUM(ISNULL(Dare,0))-SUM(ISNULL(Avere,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCA,
  (SELECT SUM(ISNULL(SaldoValuta,0))+SUM(ISNULL(DareValuta,0))-SUM(ISNULL(AvereValuta,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCAVALUTA,
  (SELECT SUM(ISNULL(SaldoEuro,0))+SUM(ISNULL(DareEuro,0))-SUM(ISNULL(AvereEuro,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SC.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCAEURO
  FROM TABSCADENZE SC
UNION ALL
  SELECT TIPOREC=2,SP.PROGRESSIVO,
  SP.ESERCIZIO,
  SP.ANNODOC,
  SP.TIPODOC,
  SP.NUMDOC,
  SP.BIS,
  SP.NUMSCAD,
  SP.DATASCADENZA,
  SP.CODCLIFOR,
  SP.DATAFATTURA,
  SP.BANCAINC,
  SP.BANCAAPPOGGIO,
  SP.NUMRIF,
  SP.NUMEROPROT,
  SP.CODAGE1,
  SP.CODAGE2,
  SP.CODAGE3,
  SP.IMPPROVLIT1,
  SP.IMPPROVLIT2,
  SP.IMPPROVLIT3,
  SP.IMPPROVVAL1,
  SP.IMPPROVVAL2,
  SP.IMPPROVVAL3,
  SP.IMPPROVEURO1,
  SP.IMPPROVEURO2,
  SP.IMPPROVEURO3,
  SP.LIQPROV1,
  SP.LIQPROV2,SP.LIQPROV3,
  SP.IMPORTOSCLIT,
  SP.IMPORTOSCVAL,
  SP.IMPORTOSCEURO,SP.IMPONIBSCLIT,SP.IMPONIBSCVAL,
  SP.IMPONIBSCEURO,
  SP.TOTFATTLIT,
  SP.TOTFATTVAL,
  SP.TOTFATTEURO,
  SP.IMPFATTLIT,
  SP.IMPFATTVAL,
  SP.IMPFATTEURO,
  SP.FLAGCONT,SP.TIPOEFFETTO,
  SP.ESITO,
  SP.LIVSOLL,
  SP.LIQINS1,SP.LIQINS2,
  SP.LIQINS3,
  SP.CODCAMBIO,
  SP.VALCAMBIO,
  SP.NRDISTINTA,
  SP.NUMRAGGR,
  SP.DATAPAGEFF,
  SP.SCADATTPASS,
  SP.NUMRIFPARTCONT,SP.CODPAG,
  SP.DATADEC,
  SP.NOTE,
  SP.NRGIORNALE,
  SP.UTENTEMODIFICA,
  SP.DATAMODIFICA,
  (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=SP.TIPOEFFETTO) AS EFFETTO,
  (CASE WHEN((SP.SCADATTPASS<>0 AND SUBSTRING(SP.CODCLIFOR,1,1)='F') OR(SP.SCADATTPASS=0 AND SUBSTRING(SP.CODCLIFOR,1,1)<>'F')) THEN -1 ELSE 1 END) AS ATTPASS, 
  (SELECT TIPO FROM PARAMETRIDOC WHERE CODICE=SP.TIPODOC) AS TDOC,
  MONTH(SP.DATASCADENZA) AS MESE,
  (SELECT SUM(ISNULL(Saldo,0))+SUM(ISNULL(Dare,0))-SUM(ISNULL(Avere,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCA,
  (SELECT SUM(ISNULL(SaldoValuta,0))+SUM(ISNULL(DareValuta,0))-SUM(ISNULL(AvereValuta,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCAVALUTA,
  (SELECT SUM(ISNULL(SaldoEuro,0))+SUM(ISNULL(DareEuro,0))-SUM(ISNULL(AvereEuro,0)) FROM VistaBilanci3 WHERE CodConto=(SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=SP.BANCAINC) AND Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25))) AND (Causale<>(SELECT CausContCH FROM TabVincoliGIC WHERE Esercizio=(SELECT EsercizioAttivo FROM TabUtenti WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) OR Causale IS NULL)) AS SALDOBANCAEURO
  FROM SCADENZEPREVISIONALI SP


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAUNIONSCADENZE3] TO [Metodo98]
    AS [dbo];

