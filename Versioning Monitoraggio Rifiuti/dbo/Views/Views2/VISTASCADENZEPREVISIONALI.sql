CREATE VIEW VISTASCADENZEPREVISIONALI AS
SELECT 1 AS TIPOREC,
    TS.PROGRESSIVO,
    TS.ESERCIZIO,
    TS.ANNODOC,
    TS.TIPODOC,
    TS.NUMDOC,
    TS.BIS,
    TS.NUMSCAD,
    TS.DATASCADENZA,
    TS.CODCLIFOR,
    TS.DATAFATTURA,
    TS.BANCAINC,
    TS.BANCAAPPOGGIO,
    TS.NUMRIF,
    TS.NUMEROPROT,
    TS.CODAGE1,
    TS.CODAGE2,
    TS.CODAGE3,
    TS.IMPPROVLIT1,
    TS.IMPPROVLIT2,
    TS.IMPPROVLIT3,
    TS.IMPPROVVAL1,
    TS.IMPPROVVAL2,
    TS.IMPPROVVAL3,
    TS.IMPPROVEURO1,
    TS.IMPPROVEURO2,
    TS.IMPPROVEURO3,
    TS.LIQPROV1,
    TS.LIQPROV2,
    TS.LIQPROV3,
    TS.IMPORTOSCLIT,
    TS.IMPORTOSCVAL,
    TS.IMPORTOSCEURO,
    TS.IMPONIBSCLIT,
    TS.IMPONIBSCVAL,
    TS.IMPONIBSCEURO,
    TS.TOTFATTLIT,
    TS.TOTFATTVAL,
    TS.TOTFATTEURO,
    TS.IMPFATTLIT,
    TS.IMPFATTVAL,
    TS.IMPFATTEURO,
    TS.FLAGCONT,
    TS.TIPOEFFETTO,
    TS.ESITO,
    TS.LIVSOLL,
    TS.LIQINS1,
    TS.LIQINS2,
    TS.LIQINS3,
    TS.CODCAMBIO,
    TS.VALCAMBIO,
    TS.NRDISTINTA,
    TS.NUMRAGGR,
    TS.DATAPAGEFF,
    TS.SCADATTPASS,
    TS.NUMRIFPARTCONT,
    TS.CODPAG,
    TS.DATADEC,
    TS.NOTE,
    TS.NRGIORNALE,
    TS.UTENTEMODIFICA,
    TS.DATAMODIFICA,
    (SELECT CODCONTORIF FROM ANAGRAFICABANCHE WHERE CODBANCA=TS.BANCAINC) AS CONTORIFBANCA,
    (CASE WHEN SUBSTRING(TS.CODCLIFOR,1,1)<>'G' THEN(SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO=TS.CODCLIFOR) ELSE(SELECT DSCCONTO1 FROM ANAGRAFICAGENERICI WHERE CODCONTO=TS.CODCLIFOR) END) AS DSCCONTO1,
    (SELECT DSCBANCA FROM ANAGRAFICABANCHE WHERE CODBANCA=TS.BANCAINC) AS DSCBANCA,
    (SELECT DESCRIZIONE FROM TIPIEFFETTI WHERE EFFETTO=TS.TIPOEFFETTO) AS DSCTIPOEFFETTO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCLIT*-1) ELSE TS.IMPORTOSCLIT END) AS IMPORTOSCADLIRE,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCEURO*-1) ELSE TS.IMPORTOSCEURO END) AS IMPORTOSCADEURO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.IMPORTOSCVAL*-1) ELSE TS.IMPORTOSCVAL END) AS IMPORTOSCADVALUTA,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTLIT*-1) ELSE TS.TOTFATTLIT END) AS TOTFATTURALIRE,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTEURO*-1) ELSE TS.TOTFATTEURO END) AS TOTFATTURAEURO,
    (CASE WHEN ((TS.SCADATTPASS<>0 AND SUBSTRING(TS.CODCLIFOR,1,1)='F') OR(TS.SCADATTPASS=0 AND SUBSTRING(TS.CODCLIFOR,1,1)<>'F')) THEN(TS.TOTFATTVAL*-1) ELSE TS.TOTFATTVAL END) AS TOTFATTURAVALUTA,
    (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE1) AS DSCAGENTE1,
	(SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE2) AS DSCAGENTE2,
    (SELECT DSCAGENTE FROM ANAGRAFICAAGENTI WHERE CODAGENTE=CODAGE3) AS DSCAGENTE3,
	(SELECT CODNAZIONE FROM ANAGRAFICACF WHERE CODCONTO=TS.CODCLIFOR) AS NAZIONE,
    (SELECT CODSETTORE FROM ANAGRAFICARISERVATICF WHERE CODCONTO=TS.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS SETTORE,
    (SELECT CODZONA FROM ANAGRAFICARISERVATICF WHERE CODCONTO=TS.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS ZONA,
    (SELECT CODCATEGORIA FROM ANAGRAFICARISERVATICF WHERE CODCONTO=TS.CODCLIFOR AND ESERCIZIO=(SELECT ESERCIZIOATTIVO FROM TABUTENTI WHERE USERDB=CAST(USER_NAME() AS VARCHAR(25)))) AS CATEGORIA,
    (SELECT TIPO FROM TIPIEFFETTI WHERE EFFETTO=TS.TIPOEFFETTO) AS DSCEFFETTO,
    (SELECT DESCRIZIONE FROM ESITI WHERE ESITI.ESITO=TS.ESITO) AS DSCESITO
    FROM SCADENZEPREVISIONALI TS


GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTASCADENZEPREVISIONALI] TO [Metodo98]
    AS [dbo];

