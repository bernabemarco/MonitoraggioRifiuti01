
/*
    rif.14/09/2016 - creata 
*/
CREATE VIEW [VISTAPROGPRODUZIONEFASIWORKLOAD] AS
    SELECT
        PF.NOMEPIANIF
        ,PF.PROG_ID
        ,PF.FASE_ID
        ,PF.TIPO
        ,PF.RIFPROGRESSIVO
        ,PF.RIFNUMEROFASE
        ,PF.CDLAVORO
        ,PF.MACCHINA
        ,PF.DATAINIZIO
        ,PF.ORAINIZIO
        ,PF.DATAFINE
        ,PF.ORAFINE
        -- dati per filtro di stampa
        ,(CASE WHEN PP.TIPO <> 2 THEN TP.TIPOCOM ELSE NULL END) AS TIPOCOM
        ,(CASE WHEN PP.TIPO <> 2 THEN TP.ESERCIZIO ELSE NULL END) AS ESERCIZIO
        ,(CASE WHEN PP.TIPO <> 2 THEN TP.NUMEROCOM ELSE NULL END) AS NUMEROCOM
        ,(CASE WHEN PP.TIPO <> 2 THEN TP.DATAEMISSIONE ELSE NULL END) AS DATAEMISSIONE              
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.CODCLIDEST ELSE NULL END) AS CODCLIDEST
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.RIFCOMMCLI ELSE PP.RIFCOMMCLI END) AS RIFCOMMCLI
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.CODART ELSE PP.CODART END) AS CODART
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.CODFORDEST ELSE PP.CODFOR END) AS CODFORDEST
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.DATAINIZIORICH ELSE PP.DATAINIZPROD END) AS DATAINIZIORICH
        ,(CASE WHEN PP.TIPO <> 2 THEN RP.DATAFINERICH ELSE PP.DATACONS END) AS DATAFINERICH
        ,(CASE WHEN PP.TIPO <> 2 THEN RC.OPERAZIONE ELSE PF.OPERAZIONE END) AS OPERAZIONE
        ,PF.DATAINIZIO AS DATAINIZIOOPSCHEDULATA
        ,PF.DATAFINE AS DATAFINEOPSCHEDULATA
    FROM PROGPRODUZIONEFASI PF
        inner join PROGPRODUZIONE PP on PP.NOMEPIANIF=PF.NOMEPIANIF AND PP.PROG_ID=PF.PROG_ID
        left outer join TESTACICLOORDINE TC on TC.PROGRESSIVO=PF.RIFPROGRESSIVO
        left outer join TESTEORDINIPROD TP on TP.PROGRESSIVO=TC.IDTESTACOMM
        left outer join RIGHEORDPROD RP on RP.IDTESTA=TC.IDTESTACOMM and RP.IDRIGA=TC.IDRIGACOMM
        left outer join RIGHECICLOORDINE RC on RC.PROGRESSIVO=PF.RIFPROGRESSIVO and RC.NUMEROFASE=PF.RIFNUMEROFASE

GO
GRANT SELECT
    ON OBJECT::[dbo].[VISTAPROGPRODUZIONEFASIWORKLOAD] TO [Metodo98]
    AS [dbo];

