

CREATE FUNCTION [dbo].[Fun_Vendors_UltimiPrezzi](@IdSessione DECIMAL(5,0),
                                                  @CodAgente nVARCHAR(7),
                                                   @Esercizio DECIMAL(5,0),
                                                    @TuttiDocumenti SmallInt,
                                                     @NPrezzi INT)
RETURNS TABLE 
AS
RETURN 
(
    
    WITH ULTIMI5PREZZI 
    AS 
    ( 
        SELECT    
            ROW_NUMBER() OVER (PARTITION BY VISTADOCUMENTIBASE.CODART,VISTADOCUMENTIBASE.CODCLIFOR,VISTADOCUMENTIBASE.TIPODOC ORDER BY DATADOC DESC) AS 'ROWNUMBER',    
            VISTADOCUMENTIBASE.*,
            TP_EXTRARIGHEDOC.DescPromozione 
        FROM     
            [VISTADOCUMENTIBASE] 
        LEFT JOIN 
            [TP_EXTRARIGHEDOC] 
        ON 
            TP_EXTRARIGHEDOC.IDTESTA = VISTADOCUMENTIBASE.IDTESTA AND TP_EXTRARIGHEDOC.IdRiga = VISTADOCUMENTIBASE.ProgRigaDoc 
        WHERE     
            VISTADOCUMENTIBASE.ESERCIZIO IN( @Esercizio, (@Esercizio - 1)) 
            AND    VISTADOCUMENTIBASE.TIPORIGA = 'N' 
            AND    VISTADOCUMENTIBASE.SCONTORIGA <> 100 
            AND    VISTADOCUMENTIBASE.CODART IN(SELECT DISTINCT CODICE FROM [TP_ELENCOVARIAZIONIFULL] WHERE MODCHIAVE = @IdSessione)
            AND    VISTADOCUMENTIBASE.CODCLIFOR IN(SELECT TP_CLIENTIEXPORT.CODCONTO FROM [TP_CLIENTIEXPORT] WHERE Left(TP_CLIENTIEXPORT.CODCONTO,1)='C' And TP_CLIENTIEXPORT.MODCHIAVE = @IdSessione) 
            AND    ((@TuttiDocumenti = 0 AND (VISTADOCUMENTIBASE.CODAGENTE1 = @CodAgente OR VISTADOCUMENTIBASE.CODAGENTE2 = @CodAgente OR VISTADOCUMENTIBASE.CODAGENTE3 = @CodAgente)) OR (@TuttiDocumenti = 1))
            AND    VISTADOCUMENTIBASE.TIPODOC IN(SELECT CODICE FROM [DOCULTIMI5PREZZI] WHERE DOCUMENTO IN(Select CODICEDOC From [TP_DOCTRASFAG] Where CODAGENTE=@CodAgente)) 
    ) 
    SELECT    
        ULTIMI5PREZZI.IDTESTA AS PROGRESSIVO,   
        ULTIMI5PREZZI.CODART AS CODICE,   
        ULTIMI5PREZZI.CODCLIFOR,   
        ULTIMI5PREZZI.DATADOC,   
        ULTIMI5PREZZI.ESERCIZIO,   
        ULTIMI5PREZZI.TIPODOC,   
        ULTIMI5PREZZI.NUMERODOC,   
        ULTIMI5PREZZI.PREZZOUNITNETTO,   
        ULTIMI5PREZZI.PREZZOUNITNETTOEURO,   
        ULTIMI5PREZZI.PREZZOUNITLORDO,   
        ULTIMI5PREZZI.PREZZOUNITLORDOEURO,
        ULTIMI5PREZZI.SCONTIESTESI,
        ULTIMI5PREZZI.UMGEST,
        ULTIMI5PREZZI.QTAGEST,
        ISNULL(ULTIMI5PREZZI.DescPromozione,'') AS DESCRIZIONEPROMOZIONE 
    FROM 
        ULTIMI5PREZZI 
    LEFT JOIN 
        [TP_EXTRARIGHEDOC]                                                
    ON 
        TP_EXTRARIGHEDOC.IDTESTA = ULTIMI5PREZZI.IDTESTA AND TP_EXTRARIGHEDOC.IDRIGA = ULTIMI5PREZZI.PROGRIGADOC 
    WHERE 
        ULTIMI5PREZZI.ROWNUMBER <= @NPrezzi 
    --ORDER BY ULTIMI5PREZZI.CODART,ULTIMI5PREZZI.IDTESTA

)




GO
GRANT SELECT
    ON OBJECT::[dbo].[Fun_Vendors_UltimiPrezzi] TO [Metodo98]
    AS [dbo];

