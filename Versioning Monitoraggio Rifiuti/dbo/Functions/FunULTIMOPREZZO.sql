
/****** Oggetto: funzione definita dall'utente dbo.FunModifOfn  Data dello script: 22/04/2005 10.39.49 ******/
CREATE FUNCTION [dbo].[FunULTIMOPREZZO](@AGENTE AS nVARCHAR(7))
	RETURNS @Results TABLE (CODAGENTE nVARCHAR(7) ,
				CODCONTO nVARCHAR(7) ,
				CODARTICOLO nVARCHAR(50) ,
				TIPODOC nVARCHAR(3) ,
				ESERCIZIO DECIMAL(10,0),
				NUMERODOC DECIMAL(10,0),
				NUMRIFDOC nVARCHAR(15) ,
				UMGEST nVARCHAR(3) ,
				QTAGEST DECIMAL(19,6),
				DATADOC DATETIME,
				UTENTEMODIFICA nVARCHAR(25) ,
				DATAMODIFICA DATETIME)
AS

    BEGIN
		WITH ULTIMIPREZZI AS
		(
			SELECT 
				ROW_NUMBER() OVER (PARTITION BY VISTADOCUMENTIBASE.CODART,VISTADOCUMENTIBASE.CODCLIFOR,VISTADOCUMENTIBASE.TIPODOC ORDER BY DATADOC DESC) AS 'ROWNUMBER',
				VISTADOCUMENTIBASE.*
			FROM 
				VISTADOCUMENTIBASE  
			WHERE 
				VISTADOCUMENTIBASE.TIPODOC  IN(SELECT TP_DOCTRASFAG.CODICEDOC FROM TP_DOCTRASFAG WHERE TP_DOCTRASFAG.CODAGENTE  = @AGENTE AND TP_DOCTRASFAG.TIPO = 'R') AND
				VISTADOCUMENTIBASE.TIPORIGA = 'N' AND
                VISTADOCUMENTIBASE.SCONTORIGA <> 100 AND
				((VISTADOCUMENTIBASE.CODAGENTE1 = @AGENTE OR
				  VISTADOCUMENTIBASE.CODAGENTE2 = @AGENTE OR
				  VISTADOCUMENTIBASE.CODAGENTE3 = @AGENTE))

		)
		INSERT INTO @Results
		SELECT
			@AGENTE,
			ULTIMIPREZZI.CODCLIFOR,
			ULTIMIPREZZI.CODART,
			ULTIMIPREZZI.TIPODOC,
			ULTIMIPREZZI.ESERCIZIO,
			ULTIMIPREZZI.NUMERODOC,
			ULTIMIPREZZI.NUMRIFDOC,
			ULTIMIPREZZI.UMGEST,
			ULTIMIPREZZI.QTAGEST,
			ULTIMIPREZZI.DATADOC,
			(SELECT USERID FROM TABUTENTI WHERE USERDB = USER_NAME()) AS UTENTEMODIFICA,
			GETDATE() AS DATAMODIFICA
		FROM ULTIMIPREZZI	
		WHERE ULTIMIPREZZI.ROWNUMBER <= 1	
		ORDER BY ULTIMIPREZZI.CODART,ULTIMIPREZZI.IDTESTA,ULTIMIPREZZI.PROGRIGADOC	

    RETURN
END

GO
GRANT SELECT
    ON OBJECT::[dbo].[FunULTIMOPREZZO] TO [Metodo98]
    AS [dbo];

