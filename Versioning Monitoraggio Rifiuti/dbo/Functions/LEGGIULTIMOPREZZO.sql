CREATE  FUNCTION LEGGIULTIMOPREZZO (@ARTICOLO VARCHAR(50), @DATA DATETIME)  
RETURNS DECIMAL(19,2)  AS
BEGIN 
	DECLARE @PREZZO AS DECIMAL(19,2)
	DECLARE @UMSTAT AS VARCHAR(3)

	-- DETERMINO L'UM STATISTICA DELL'ARTICOLO PASSATO
	DECLARE CUR_UM_STAT CURSOR SCROLL SCROLL_LOCKS FOR	
		SELECT UM FROM ARTICOLIUMPREFERITE WHERE TIPOUM=8 AND CODART=@ARTICOLO
	OPEN CUR_UM_STAT
	FETCH NEXT FROM CUR_UM_STAT INTO @UMSTAT
 	CLOSE CUR_UM_STAT
	DEALLOCATE CUR_UM_STAT

	-- DETERMINO IL COSTO ULTIMO RISPETTO ALLA DATA DOCUMENTO PASSATA
	DECLARE CUR_STORICO_PREZZI CURSOR SCROLL SCROLL_LOCKS FOR
		SELECT TOP 1 (PRZ.PREZZOEURO*FC.FATTORE) AS PREZZO
		FROM STORICOPREZZIARTICOLO PRZ LEFT OUTER JOIN ARTICOLIFATTORICONVERSIONE FC
			ON FC.CODART=PRZ.CODARTICOLO AND FC.UM2=PRZ.UM
		WHERE PRZ.CODARTICOLO=@ARTICOLO 
			AND PRZ.TIPOPREZZO = 'F'
			AND PRZ.DATA<=@DATA
			AND FC.UM1=@UMSTAT
		ORDER BY DATA DESC
	OPEN CUR_STORICO_PREZZI	
	FETCH NEXT FROM CUR_STORICO_PREZZI INTO @PREZZO
	IF @@FETCH_STATUS<>0 SELECT @PREZZO = 0

  	CLOSE CUR_STORICO_PREZZI
	DEALLOCATE CUR_STORICO_PREZZI 

	RETURN @PREZZO
END

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[LEGGIULTIMOPREZZO] TO [Metodo98]
    AS [dbo];

